<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>热力图</title>

  <link rel="stylesheet" href="http://ditu.fuwu.io:7020/arcgis/quanzhou/dijit/themes/claro/claro.css">
  <link rel="stylesheet" href="http://ditu.fuwu.io:7020/arcgis/quanzhou/esri/css/esri.css">
  <style>
    html,
    body,
    #heatmap,
    #map {
      height: 100%;
      margin: 0;
      padding: 0;
      width: 100%;
      overflow: hidden;
    }
  </style>

  <script src="http://ditu.fuwu.io:7020/arcgis/quanzhou/init.js"></script>
  <script type="text/javascript" src="http://ditu.fuwu.io:7020/arcgis/quanzhou/cw/heatmap/heatmap.js"></script>
  <script>
      var map,
          draw,
          editToolbar,
          ctxMenuForGraphics,
          ctxMenuForMap,
          current,
          currentLocation,
          selected,
          heatLayer;

      require([
          "cw/HeatmapLayer",
          "esri/map",
          "esri/Color",
          "esri/graphic",
          "esri/geometry/Point",
          "esri/geometry/Polygon",
          "esri/toolbars/draw",
          "esri/toolbars/edit",
          "esri/layers/FeatureLayer",
          "esri/layers/ArcGISTiledMapServiceLayer",
          "esri/layers/ArcGISDynamicMapServiceLayer",
          "esri/symbols/SimpleMarkerSymbol",
          "esri/symbols/SimpleLineSymbol",
          "esri/symbols/SimpleFillSymbol",
          "esri/symbols/PictureMarkerSymbol",
          "esri/geometry/jsonUtils",
          "esri/tasks/query",
          "esri/geometry/Extent",
          "dojo/_base/array",
          "dojo/parser",
          "dijit/Menu",
          "dijit/MenuItem",
          "dijit/MenuSeparator",
          "dijit/form/Button",
          "dijit/layout/BorderContainer",
          "dijit/layout/ContentPane",
          "dojo/domReady!"
      ], function (
          HeatmapLayer,
          Map,
          Color,
          Graphic,
          Point,
          Polygon,
          Draw,
          Edit,
          FeatureLayer,
          ArcGISTiledMapServiceLayer,
          ArcGISDynamicMapServiceLayer,
          SimpleMarkerSymbol,
          SimpleLineSymbol,
          SimpleFillSymbol,
          PictureMarkerSymbol,
          geometryJsonUtils,
          Query,
          Extent,
          array,
          parser,
          Menu,
          MenuItem,
          MenuSeparator

          ) {
          //parser.parse();
          map = new Map("map", {
              //basemap: "streets", //显示的地图样式 此处为地图，basemap: "satellite", //实景图
              // 泉州 坐标
              center: [118.596703, 24.900576], //地图加载后，初始位置
              zoom: 17,        //放大级别，值越大放大的比例就越大
              maxZoom: 19,     // 地图最大缩放级别
              minZoom: 1,      // 地图最小缩放级别
              slider: true,   // 设置显示地图缩放按钮
              logo: false      // 不显示Esri的logo
          });

          // 加载地图服务
          var tiledMapServiceLayer = new ArcGISTiledMapServiceLayer('http://192.168.10.35:6080/arcgis/rest/services/qz/QZMapService/MapServer');
          map.addLayer(tiledMapServiceLayer);

          // 热力图图层
          heatLayer = new HeatmapLayer({
              config: {
                  "useLocalMaximum": false,
                  "radius": 40,
                  "gradient": {
                      0.45: "rgb(000,000,255)",
                      0.55: "rgb(000,255,255)",
                      0.65: "rgb(000,255,000)",
                      0.95: "rgb(255,255,000)",
                      1.00: "rgb(255,000,000)"
                  }
              },
              "map": map,
              "opacity": 0.85
          }, "heatLayer");
          map.addLayer(heatLayer);

          // 加载相机要素服务
          var featureLayer = new FeatureLayer("http://192.168.10.35:6080/arcgis/rest/services/qz/QZFeatureService/FeatureServer/0", {
              mode: FeatureLayer.MODE_SNAPSHOT,
              outFields: ["*"]
          });
//          featureLayer.on("update-end", function (evt) {
//              array.forEach(featureLayer.graphics, function (node, index) {
//                  var color = new Color(node.attributes.PATHCOLOR);
//                  // 定义符号
//                  var polygonSymbol = new SimpleFillSymbol(
//                      SimpleFillSymbol.STYLE_SOLID,
//                      new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, color, 2),
//                      new Color([color.r, color.g, color.b, 0.6])
//                  );
//                  node.setSymbol(polygonSymbol);
//              });
//          });

          //map.addLayer(featureLayer);

          // 热力图刷新
          map.on("extent-change",getFeatures);

          function getFeatures() {
              //console.log("getFeature!");
              // set up query
              var q = new Query();
              // only within extent
              q.geometry = map.extent;
              // give me all of them!
              q.where = "1=1";
              // make sure I get them back in my spatial reference
              q.outSpatialReference = map.spatialReference;
              // get em!
              featureLayer.queryFeatures(q, function (featureSet) {
                  var data = [];
                  // if we get results back
                  if (featureSet && featureSet.features && featureSet.features.length) {
                      // set data to features
                      data = featureSet.features;
                  }
                  // set heatmap data
                  heatLayer.setData(data);
              });
          }


      });
  </script>
</head>

<body class="claro" >
<div id="heatmap">
  <div id="heatLayer"></div>
  <div id="map"></div>
</div>
</body>

</html>
