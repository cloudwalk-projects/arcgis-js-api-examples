// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(n,t){var h;return function(){h&&clearTimeout(h);var f=this,g=arguments;h=setTimeout(function(){n.apply(f,g)},t)}}})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(n,t,h,f){var g=function(f,l){return f-l},x={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(f){var l=String(f),k=l.match(x._reNumber);f={integer:0,fractional:0};k&&k[1]?(f.integer=k[1].split("").length,
f.fractional=k[3]?k[3].split("").length:0):-1<l.toLowerCase().indexOf("e")&&(k=l.split("e"),l=k[0],k=k[1],l&&k&&(l=Number(l),k=Number(k),(f=0<k)||(k=Math.abs(k)),l=x.getDigits(l),f?(l.integer+=k,l.fractional=k>l.fractional?0:l.fractional-k):(l.fractional+=k,l.integer=k>l.integer?1:l.integer-k),f=l));return f},getFixedNumbers:function(f,l){var k,h;k=Number(f.toFixed(l));k<f?h=k+1/Math.pow(10,l):(h=k,k-=1/Math.pow(10,l));k=Number(k.toFixed(l));h=Number(h.toFixed(l));return[k,h]},getPctChange:function(f,
l,k,h){var g={prev:null,next:null},r;null!=k&&(r=f-k,k=l-k-r,g.prev=Math.floor(Math.abs(100*k/r)));null!=h&&(r=h-f,k=h-l-r,g.next=Math.floor(Math.abs(100*k/r)));return g},round:function(f,h){var k=f.slice(0),n,t,r,A,q,c,u,G,B,s=!h||null==h.tolerance?2:h.tolerance,F=h&&h.indexes,w=!h||null==h.strictBounds?!1:h.strictBounds;if(F)F.sort(g);else{F=[];for(c=0;c<k.length;c++)F.push(c)}for(c=0;c<F.length;c++)if(B=F[c],n=k[B],t=0===B?null:k[B-1],r=B===k.length-1?null:k[B+1],A=x.getDigits(n),A=A.fractional){u=
0;for(G=!1;u<=A&&!G;)q=x.getFixedNumbers(n,u),q=w&&0===c?q[1]:q[0],G=x.hasMinimalChange(n,q,t,r,s),u++;G&&(k[B]=q)}return k},hasMinimalChange:function(f,h,k,g,n){f=x.getPctChange(f,h,k,g);h=null==f.prev||f.prev<=n;k=null==f.next||f.next<=n;return h&&k||f.prev+f.next<=2*n},_reAllZeros:RegExp("\\"+h.decimal+"0+$","g"),_reSomeZeros:RegExp("(\\d)0*$","g"),format:function(f,h){h=h||{places:20,round:-1};var k=t.format(f,h);k&&(k=k.replace(x._reSomeZeros,"$1").replace(x._reAllZeros,""));return k}};n("extend-esri")&&
(f.numberUtils=x);return x})},"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!../nls/jsapi dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(n,t,h,f,g,x,C,l,k){function R(c){return c&&t.map(c,function(c){return new C(c)})}function L(c,f,h){var k="";0===f?k=A.lt+" ":f===h&&(k=A.gt+" ");return k+c}var r={},A={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},q={millisecond:0,second:1,minute:2,
hour:3,day:4,month:5,year:6},c={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},
u={formatLength:"short",fullYear:!0},G={formatLength:"short"};n.mixin(r,{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(c,s){var h,w=[];null!=c&&!(c instanceof Date)&&(c=new Date(c));s=s||{};s=n.mixin({},s);var g=s.selector?s.selector.toLowerCase():null;h=!g||-1<g.indexOf("time");g=!g||-1<g.indexOf("date");h&&(s.timeOptions=s.timeOptions||G,s.timeOptions&&(s.timeOptions=n.mixin({},s.timeOptions),s.timeOptions.selector=s.timeOptions.selector||
"time",w.push(s.timeOptions)));g&&(s.dateOptions=s.dateOptions||u,s.dateOptions&&(s.dateOptions=n.mixin({},s.dateOptions),s.dateOptions.selector=s.dateOptions.selector||"date",w.push(s.dateOptions)));w&&w.length?(w=t.map(w,function(s){return f.format(c,s)}),h=1==w.length?w[0]:k["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(c,f){return w[f]})):h=f.format(c);return h},createColorStops:function(c){var f=c.values,h=c.colors,k=c.labelIndexes,g=c.isDate,l=c.dateFormatOptions;
c=[];return c=t.map(f,function(c,B){var n=null;if(!k||-1<t.indexOf(k,B)){var q;(q=g?r.formatDate(c,l):x.format(c))&&(n=L(q,B,f.length-1))}return{value:c,color:h[B],label:n}})},updateColorStops:function(c){var f=c.stops,h=c.changes,k=c.isDate,g=c.dateFormatOptions,l=[],n,q=t.map(f,function(c){return c.value});t.forEach(h,function(c){l.push(c.index);q[c.index]=c.value});n=x.round(q,{indexes:l});t.forEach(f,function(c,h){c.value=q[h];if(null!=c.label){var B,l=null;(B=k?r.formatDate(n[h],g):x.format(n[h]))&&
(l=L(B,h,f.length-1));c.label=l}})},createClassBreakLabel:function(c){var f=c.minValue,h=c.maxValue,k=c.isFirstBreak?"":A.gt+" ";c="percent-of-total"===c.normalizationType?A.pct:"";f=null==f?"":x.format(f);h=null==h?"":x.format(h);return k+f+c+" "+l.smartMapping.minToMax+" "+h+c},setLabelsForClassBreaks:function(c){var f=c.classBreaks,h=c.classificationMethod,k=c.normalizationType,g=[];f&&f.length&&("standard-deviation"===h?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):
c.round?(g.push(f[0].minValue),t.forEach(f,function(c){g.push(c.maxValue)}),g=x.round(g),t.forEach(f,function(c,f){c.label=r.createClassBreakLabel({minValue:0===f?g[0]:g[f],maxValue:g[f+1],isFirstBreak:0===f,normalizationType:k})})):t.forEach(f,function(c,f){c.label=r.createClassBreakLabel({minValue:c.minValue,maxValue:c.maxValue,isFirstBreak:0===f,normalizationType:k})}))},updateClassBreak:function(c){var f=c.classBreaks,h=c.normalizationType,k=c.change,g=k.index,k=k.value,l=-1,n=-1,q=f.length;"standard-deviation"===
c.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):(0===g?l=g:g===q?n=g-1:(n=g-1,l=g),-1<l&&l<q&&(c=f[l],c.minValue=k,c.label=r.createClassBreakLabel({minValue:c.minValue,maxValue:c.maxValue,isFirstBreak:0===l,normalizationType:h})),-1<n&&n<q&&(c=f[n],c.maxValue=k,c.label=r.createClassBreakLabel({minValue:c.minValue,maxValue:c.maxValue,isFirstBreak:0===n,normalizationType:h})))},calculateDateFormatInterval:function(c){var f,
h,k=c.length,g,l,n,u,r,x,C=Infinity,A;c=t.map(c,function(c){return new Date(c)});for(f=0;f<k-1;f++){g=c[f];n=[];r=Infinity;x="";for(h=f+1;h<k;h++)l=c[h],l=g.getFullYear()!==l.getFullYear()&&"year"||g.getMonth()!==l.getMonth()&&"month"||g.getDate()!==l.getDate()&&"day"||g.getHours()!==l.getHours()&&"hour"||g.getMinutes()!==l.getMinutes()&&"minute"||g.getSeconds()!==l.getSeconds()&&"second"||"millisecond",u=q[l],u<r&&(r=u,x=l),n.push(l);r<C&&(C=r,A=x)}return A},createUniqueValueLabel:function(f){var h=
f.value,k=f.fieldInfo,g=f.domain;f=f.dateFormatInterval;var l=String(h);(g=g&&g.codedValues?g.getName(h):null)?l=g:"number"===typeof h&&(l=k&&"esriFieldTypeDate"===k.type?r.formatDate(h,f&&c[f]):x.format(h));return l},cloneColorInfo:function(c){var f;c&&(f=n.mixin({},c),f.colors=R(f.colors),f.stops=f.stops&&t.map(f.stops,function(c){c=n.mixin({},c);c.color&&(c.color=new C(c.color));return c}),f.legendOptions&&(f.legendOptions=n.mixin({},f.legendOptions)));return f},cloneOpacityInfo:function(c){var f;
if(c){f=n.mixin({},c);if(c=f.opacityValues)f.opacityValues=c.slice(0);if(c=f.stops)f.stops=t.map(c,function(c){return n.mixin({},c)});if(c=f.legendOptions)f.legendOptions=n.mixin({},c)}return f},cloneSizeInfo:function(c){var f;if(c){f=n.mixin({},c);f.stops&&(f.stops=t.map(f.stops,function(c){return n.mixin({},c)}));if((c=f.minSize)&&"object"===typeof c)f.minSize=r.cloneSizeInfo(c);if((c=f.maxSize)&&"object"===typeof c)f.maxSize=r.cloneSizeInfo(c);if(c=f.legendOptions)if(f.legendOptions=n.mixin({},
c),c=c.customValues)f.legendOptions.customValues=c.slice(0)}return f}});h("extend-esri")&&n.setObject("renderer.utils",r,g);return r})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleLineSymbol ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(n,
t,h,f,g,x,C,l,k,R,L,r,A,q,c,u,G,B,s,F,w,U,S,P,I,E,M,J,N,K,V,W,X,Q,Y,Z,$,O,aa,ba,T){var H=t([ba,B],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new C([64,64,64]),defaultText:"Aa",sizeRampLightColor:new C([255,255,255]),sizeRampDarkColor:new C([128,128,128]),layerConnects:[],gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,
_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(a,b){h.mixin(this,T.widgets.legend);this._i18n=T.widgets.legend;a=a||{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this.arrangement=a.arrangement===H.ALIGN_RIGHT?H.ALIGN_RIGHT:H.ALIGN_LEFT,this.arrangement===H.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=
[],this.hideLayersInLegend={},this.refresh=l(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b,e;for(b=0;b<a.length;b+=1)e=a[b],n.locale&&-1!==n.locale.indexOf(e)&&(-1!==n.locale.indexOf("-")?-1!==n.locale.indexOf(e+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=
this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments);this._initialize();9>k("ie")&&(this._repaintItems=h.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeHoverHandlers();this.inherited(arguments)},refresh:function(a){if(this.domNode){a?
(this.layerInfos=a,this.layers=[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=
this.layerInfos=null);for(a=this.domNode.children.length-1;0<=a;a--)c.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,
this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];f.forEach(this.map.layerIds,function(e){e=this.map.getLayer(e);var m;this._isSupportedLayerType(e)&&(e.arcgisProps&&e.arcgisProps.title&&(e._titleForLegend=e.arcgisProps.title),this.layers.push(e));"esri.layers.KMLLayer"==
e.declaredClass&&(m=e.getLayers(),f.forEach(m,function(b){a.push(b.id)},this));"esri.layers.GeoRSSLayer"==e.declaredClass&&(m=e.getFeatureLayers(),f.forEach(m,function(a){b.push(a.id)},this))},this);f.forEach(this.map.graphicsLayerIds,function(e){var m=this.map.getLayer(e);-1==f.indexOf(a,e)&&-1==f.indexOf(b,e)&&(this._isSupportedLayerType(m)&&m._params&&m._params.drawMode)&&(m.arcgisProps&&m.arcgisProps.title&&(m._titleForLegend=m.arcgisProps.title),this.layers.push(m))},this)}this._createLegend()},
_activate:function(){this._deactivate();this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=g.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=g.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers"),this._olrConnect=g.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=g.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),f.forEach(this.layers,function(a){var b={};b.ovcConnect=g.connect(a,"onVisibilityChange",
this,"_refreshLayers");b.oocConnect=g.connect(a,"onOpacityChange",this,"_refreshLayers");b.oscConnect=g.connect(a,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&(b.odcConnect=g.connect(a,"_onDynamicLayersChange",h.hitch(this,"_updateDynamicLayers",a)));"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&(b.oirConnect=g.connect(a,"onRenderingChange",h.partial(this._updateImageServiceLayers,this,a)));"esri.layers.ArcGISImageServiceVectorLayer"===
a.declaredClass&&(b.oivrConnect=g.connect(a,"onRendererChange",h.hitch(this,"_refreshLayers")));this.layerConnects[a.id]=b},this))},_deactivate:function(){this._ozeConnect&&g.disconnect(this._ozeConnect);this._olaConnect&&g.disconnect(this._olaConnect);this._olroConnect&&g.disconnect(this._olroConnect);this._olrConnect&&g.disconnect(this._olrConnect);f.forEach(this.layers,function(a){a=this.layerConnects[a.id]||{};a.ovcConnect&&g.disconnect(a.ovcConnect);a.oocConnect&&g.disconnect(a.oocConnect);a.oscConnect&&
g.disconnect(a.oscConnect);a.odcConnect&&g.disconnect(a.odcConnect);a.oirConnect&&g.disconnect(a.oirConnect);a.oivrConnect&&g.disconnect(a.oivrConnect)},this);this.layerConnects=[]},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];f.forEach(this.map.layerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&
this.layers.push(a)},this);f.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&(a._params&&a._params.drawMode)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,b=!1;u.set(this.domNode,"position","relative");c.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var e=[];f.forEach(this.layers,function(d){if("esri.layers.KMLLayer"==d.declaredClass||"esri.layers.GeoRSSLayer"==
d.declaredClass){var m;d.loaded?("esri.layers.KMLLayer"==d.declaredClass?m=d.getLayers():"esri.layers.GeoRSSLayer"==d.declaredClass&&(m=d.getFeatureLayers(),this.hideLayersInLegend[d.id]&&(m=f.filter(m,function(a){return-1==f.indexOf(this.hideLayersInLegend[d.id],a.id)},this))),f.forEach(m,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&d._titleForLegend&&(a._titleForLegend=d._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==
a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_polygons),e.push(a))},this)):g.connect(d,"onLoad",h.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===d.declaredClass)if(d.loaded){if((!this._respectVisibility||this._respectVisibility&&d.visible)&&0<d.layerInfos.length&&f.some(d.layerInfos,function(a){return a.legendURL})){var z=!1;f.forEach(d.layerInfos,function(b){if(b.legendURL&&-1<f.indexOf(d.visibleLayers,
b.name)){z||(c.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(d._titleForLegend||d.name||d.id)+"\x3c/span\x3e"},this.domNode),z=!0);var e;b=b.legendURL;if(d.customParameters||d.customLayerParameters){var m=h.clone(d.customParameters||{});h.mixin(m,d.customLayerParameters||{});for(e in m)b+=(-1===b.indexOf("?")?"?":"\x26")+e+"\x3d"+m[e]}c.create("div",{innerHTML:"\x3cimg src\x3d'"+b+"'/\x3e"},this.domNode);a=!0}},this)}}else g.connect(d,"onLoad",h.hitch(this,function(){this.refresh(this.layerInfos)}));
else"esri.layers.WFSLayer"===d.declaredClass&&!d.renderer?(m=c.create("div",{id:this.id+"_"+d.id,"class":"esriLegendService"}),c.create("span",{innerHTML:this._getServiceTitle(d),"class":"esriLegendServiceLabel"},c.create("td",{align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},m))))),c.place(m,this.id,"first"),tableNode=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},m),tableBody=c.create("tbody",{},tableNode),"esriGeometryComplex"===
d.geometryType?(this._buildRow_Renderer(d,d._pointSymbol,null,this.NLS_points,null,tableBody),this._buildRow_Renderer(d,d._lineSymbol,null,this.NLS_lines,null,tableBody),this._buildRow_Renderer(d,d._polygonSymbol,null,this.NLS_areas,null,tableBody)):"esriGeometryPoint"===d.geometryType?this._buildRow_Renderer(d,d._pointSymbol,null,"",null,tableBody):"esriGeometryPolyline"===d.geometryType?this._buildRow_Renderer(d,d._lineSymbol,null,"",null,tableBody):"esriGeometryPolygon"===d.geometryType&&this._buildRow_Renderer(d,
d._polygonSymbol,null,"",null,tableBody),b=!0):e.push(d)},this);var m=[];f.forEach(e,function(a){if(a.loaded){if((!this._respectVisibility||this._respectVisibility&&a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass)){var b=c.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});c.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},c.create("td",{align:this._align},c.create("tr",{},c.create("tbody",
{},c.create("table",{width:"95%"},b)))));c.place(b,this.id,"first");a.legendResponse||a.renderer?this._createLegendForLayer(a):this.isHostedTileService(a)?this._getLayerInfos(a).then(h.hitch(this,function(a){this._createLegendForLayer(a)}),h.hitch(this,function(a){m.push(this._legendRequest(a))})):m.push(this._legendRequest(a))}}else var e=g.connect(a,"onLoad",this,function(a){g.disconnect(e);e=null;this.refresh()})},this);0===m.length&&!a&&!b?(q.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate()):
(new r(m)).addCallback(h.hitch(this,function(e){!a&&!b?q.byId(this.id+"_msg").innerHTML=this.NLS_noLegend:q.byId(this.id+"_msg").innerHTML="";this._activate()}))},_createLegendForLayer:function(a){if(a.legendResponse||a.renderer||this.isHostedTileService(a)){var b=!1;if(a.legendResponse||this.isHostedTileService(a)){var e=a.dynamicLayerInfos||a.layerInfos;e&&e.length?f.forEach(e,function(e,d){if(!this.hideLayersInLegend[a.id]||-1===f.indexOf(this.hideLayersInLegend[a.id],e.id)){var c=this._buildLegendItems(a,
e,d);b=b||c}},this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(e=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:e,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(u.set(q.byId(this.id+"_"+a.id),"display","block"),u.set(q.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=
a.version?this._legendRequestServer(a):this._legendRequestTools(a);g.connect(a,"onLoad",h.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,e=b.indexOf("?"),b=-1<e?b.substring(0,e)+"/legend"+b.substring(e):b+"/legend";(e=a._getToken())&&(b+="?token\x3d"+e);var m=h.hitch(this,"_processLegendResponse"),d={f:"json"};a._params.dynamicLayers&&(d.dynamicLayers=A.stringify(this._createDynamicLayers(a)),"[{}]"===d.dynamicLayers&&(d.dynamicLayers="[]"));a._params.bandIds&&(d.bandIds=
a._params.bandIds);a._params.renderingRule?d.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&f.forEach(a.rasterFunctionInfos,function(a){a&&(a.name&&"none"===a.name.toLowerCase())&&(d.renderingRule=A.stringify({rasterFunction:a.name}))});return P({url:b,content:d,callbackParamName:"callback",load:function(b,e){m(a,b,e)},error:S.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,b)+
a.url.substring(b+5,a.url.length),b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!k("ie")||8<k("ie"))b+="\x26returnbytes\x3dtrue";var e=h.hitch(this,"_processLegendResponse");return P({url:b,content:{f:"json"},callbackParamName:"callback",load:function(b,d){e(a,b,d)},error:S.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,q.byId(this.id+"_"+a.id)&&c.empty(q.byId(this.id+"_"+a.id)),c.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},
c.create("td",{align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},q.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+x.toJson(b))},_buildLegendItems:function(a,b,e){var m=!1,d=q.byId(this.id+"_"+a.id),v=b.parentLayerId;if(b.subLayerIds)a=c.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==v?0<e?"esriLegendGroupLayer":"":this._legendAlign},-1==v?d:q.byId(this.id+
"_"+a.id+"_"+v+"_group")),c.create("td",{innerHTML:w.encode(b.name),align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(this._respectVisibility&&a.visibleLayers)if(e=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===f.indexOf(a.visibleLayers,b.id))return m}else{if(e=this._getReallyVisibleLayers(e,a.visibleLayers),-1===f.indexOf(e,b.id))return m}else if(-1===f.indexOf(a.visibleLayers,b.id))return m;
d=c.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<v?this._legendAlign:""},-1==v?d:q.byId(this.id+"_"+a.id+"_"+v+"_group"));c.create("td",{innerHTML:w.encode(b.name)||"",align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));e=a.dynamicLayerInfos||a.layerInfos;v=!1;e&&e.length&&(v=f.some(e,function(a){return!!a.drawingInfo}));if(a.legendResponse)m=m||this._buildLegendItems_Tools(a,b,d);else if(a.renderer||
v)m=m||this._buildLegendItems_Renderer(a,b,d)}return m},_getReallyVisibleLayers:function(a,b){if(!a||!b||!b.length)return[];var e=[],m=[],d;for(d=0;d<a.length;d++)if(a[d].subLayerIds){if(-1===f.indexOf(b,a[d].id)||-1<f.indexOf(m,a[d].id))m=m.concat(a[d].subLayerIds)}else-1<f.indexOf(b,a[d].id)&&-1===f.indexOf(m,a[d].id)&&e.push(a[d].id);return e},_buildLegendItems_Tools:function(a,b,e){var m=b.parentLayerId,d=this.map.getScale(),v=!1,z=function(a,b){var e,d;for(e=0;e<a.length;e++)if(b.dynamicLayerInfos)for(d=
0;d<b.dynamicLayerInfos[d].length;d++){if(b.dynamicLayerInfos[d].mapLayerId==a[e].layerId)return a[e]}else if(b.id==a[e].layerId)return a[e];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,b,d)){var h=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var y=this._getEffectiveScale(a,b);if(y.minScale&&y.minScale<d||y.maxScale&&y.maxScale>d)h=!1}if(h){var d=
z(a.legendResponse.layers,b),k=d.legendType,p=d.layerType,g=d.legend;if(g){"esri.layers.ArcGISImageServiceLayer"!==a.declaredClass&&this._sanitizeLegendResponse(a,d,b);e=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);var l=c.create("tbody",{},e);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,a,b);f.forEach(g,function(e){if(!(10.1<=a.version&&!e.values&&1<g.length&&(a._hideDefaultSymbol||"\x3call other values\x3e"===e.label||!e.label&&!("esri.layers.ArcGISImageServiceLayer"===
a.declaredClass&&10.3<=a.version||"Raster Layer"===p))))if(e.url&&0===e.url.indexOf("http")||e.imageData&&0<e.imageData.length)v=!0,this._buildRow_Tools(e,l,a,b.id,k)},this)}}}v&&(u.set(q.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<m&&(u.set(q.byId(this.id+"_"+a.id+"_"+m+"_group"),"display","block"),this._findParentGroup(a.id,a,m)));return v},_getLayerInfos:function(a){var b=new L,e=a.dynamicLayerInfos||a.layerInfos;if(e&&e.length)if(f.some(e,function(a){return!!a.drawingInfo}))b.resolve(a);
else{var m=a.url,d=m.indexOf("?"),m=-1==d?m+"/layers":m.substring(0,d)+"/layers"+m.substring(d,m.length);P({url:m,content:{f:"json"},callbackParamName:"callback",load:function(d,m){d.layers?(f.forEach(e,function(a){var b=f.filter(d.layers,function(b){return a.source?b.id===a.source.mapLayerId:b.id===a.id});b&&(b[0]&&b[0].drawingInfo)&&(a.drawingInfo=b[0].drawingInfo,a.fields=b[0].fields)}),b.resolve(a)):b.reject(a)},error:function(e){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,e){var m=
b.legend;if(10.1<=a.version&&1<m.length&&!b._sanitized){a=h.getObject("layerDefinition.drawingInfo.renderer",!1,e);var d,c;a||(a=h.getObject("drawingInfo.renderer",!1,e));f.some(m,function(a){if(a.values)return!0})&&f.some(m,function(a,b){a.values||(c=b,d=a);return!!d});a?"uniqueValue"===a.type?d&&(m.splice(c,1),m.push(d)):"classBreaks"===a.type&&(d&&m.splice(c,1),m.reverse(),d&&m.push(d)):d&&(m.splice(c,1),m.push(d));b._sanitized=!0}},_buildRow_Tools:function(a,b,e,m,d){var f=c.create("tr",{},b),
z;this.alignRight?(b=c.create("td",{align:this._isRightToLeft?"left":"right"},f),z=c.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(z=c.create("td",{width:35,align:"center"},f),b=c.create("td",{},f));f=a.url;(!k("ie")||9<=k("ie")||9>k("ie")&&"esri.layers.ArcGISImageServiceLayer"===e.declaredClass)&&a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=e.url+"/"+m+"/images/"+a.url,(m=e._getToken())&&(f+="?token\x3d"+m));m=c.create("img",
{src:f,border:0,style:"opacity:"+e.opacity},z);a=c.create("td",{innerHTML:w.encode(a.label),align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%",dir:"ltr"},b))));d&&("Stretched"===d&&10.3<=e.version&&"esri.layers.ArcGISImageServiceLayer"===e.declaredClass)&&(a.style.verticalAlign="top",a.style.lineHeight="1",m.style.marginBottom="-1px",m.style.display="block",b.style.verticalAlign="top");9>k("ie")&&(m.style.filter="alpha(opacity\x3d"+100*e.opacity+")")},_getVariable:function(a,
b,e){var m;a&&(m=(a=a.getVisualVariablesForType(b,e))&&a[0]);return m},_getVariables:function(a,b,e){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return b?f.filter(a,function(a){return!(!a||!(a.field===b&&a.normalizationField==e))}):a},_getFieldAlias:function(a,b,e){var m=b.infoTemplate,m=m&&m.getFieldInfo&&m.getFieldInfo(a);a=h.isFunction(a)?null:this.getField(b,a,e);b=m||a;e="";b&&(e=m&&m.label||a&&a.alias||b.name||b.fieldName);
return e},_getRampTitle:function(a,b,e){var m,d=a.field,c=a.normalizationField,f=!1,k=!1,y=!1,d=h.isFunction(d)?null:d,c=h.isFunction(c)?null:c;if(a.legendOptions&&a.legendOptions.title)m=a.legendOptions.title;else if(a.valueExpressionTitle)m=a.valueExpressionTitle;else{if(b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){var g=b.renderer.authoringInfo.visualVariables;for(a=0;a<g.length;a++){var p=g[a];if("colorInfo"===p.type&&"ratio"===p.style){f=!0;break}else if("colorInfo"===
p.type&&"percent"===p.style){k=!0;break}else if("colorInfo"===p.type&&"percentTotal"===p.style){y=!0;break}}}(f=y&&"showRatioPercentTotal"||k&&"showRatioPercent"||f&&"showRatio"||c&&"showNormField"||d&&"showField"||null)&&(m=I.substitute({field:d&&this._getFieldAlias(d,b,e),normField:c&&this._getFieldAlias(c,b,e)},this._i18n[f]))}return m},_getRendererTitle:function(a,b,e){var m;if(a){var d,c,f;a instanceof K&&(d=a.attributeField,c=a.normalizationField,f="percent-of-total"===a.normalizationType);
d=h.isFunction(d)?null:d;c=h.isFunction(c)?null:c;a.legendOptions&&a.legendOptions.title?m=a.legendOptions.title:a.valueExpressionTitle?m=a.valueExpressionTitle:(a=c&&"showNormField"||(f?"showNormPct":null)||d&&"showField"||null)&&(m=I.substitute({field:d&&this._getFieldAlias(d,b,e),normField:c&&this._getFieldAlias(c,b,e)},this._i18n[a]))}return m},_buildLegendItems_Renderer:function(a,b,e){var m=b.parentLayerId,d=this.map,v=d.getScale(),z,k=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,
b,v)){var y,g,p,l,n,r,s,x;p="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:b&&b.drawingInfo?aa.fromJson(h.clone(b.drawingInfo.renderer)):a.renderer;if(p instanceof V&&(p=(p="zoom"===p.rangeType?p.getRendererInfoByZoom(d.getZoom()):p.getRendererInfoByScale(v))&&p.renderer,!p))return!1;var D=this._getVariables(p),t=f.filter(D,function(a){return!!a}).length,v=D[0],d=D[1],D=D[2],B,C,A,E,F;v&&(l=this._getMedianColor(p,v),v.field&&(r=h.isFunction(v.field)?null:this.getField(a,
v.field,b)),B=!(v.legendOptions&&!1===v.legendOptions.showLegend));d&&(d.field&&(x=h.isFunction(d.field)?null:this.getField(a,d.field,b)),C=!(d.legendOptions&&!1===d.legendOptions.showLegend));D&&(D.field&&(s=h.isFunction(D.field)?null:this.getField(a,D.field,b)),A=!(D.legendOptions&&!1===D.legendOptions.showLegend));if(p instanceof Y)z=k=!0,this._showHeatRamp(a,b,p,e);else if(p instanceof W)z=k=!0,this._showDotDensityLegend(a,b,p,e);else if(p instanceof X)z=k=!0,g=c.create("table",{cellpadding:0,
cellspacing:0,width:"95%","class":"esriLegendLayer"},e),y=c.create("tbody",{},g),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(g,a,b),p.latestObservationRenderer&&p.latestObservationRenderer instanceof J&&this._buildRow_Renderer(a,p.latestObservationRenderer.symbol,l,w.encode(p.latestObservationRenderer.label)||this.NLS_currentObservations,null,y),p.observationRenderer&&p.observationRenderer instanceof J&&this._buildRow_Renderer(a,p.observationRenderer.symbol,l,w.encode(p.observationRenderer.label)||
this.NLS_previousObservations,null,y);else if(p instanceof N){if(p.infos&&0<p.infos.length){z=k=!0;if(p.legendOptions&&p.legendOptions.title||p.valueExpressionTitle)g=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e),y=c.create("tbody",{},g),t=p.legendOptions&&p.legendOptions.title?p.legendOptions.title:p.valueExpressionTitle,this._buildRow_Renderer(a,null,l,w.encode(t),null,y);g=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
e);y=c.create("tbody",{},g);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(g,a,b);p.attributeField&&D&&this._addSubHeader(y,this._getFieldAlias(p.attributeField,a,b));var G=[];f.forEach(p.infos,function(b){var e=null;a._editable&&a.types&&(e=this._getTemplateFromTypes(a.types,b.value));var d=b.label;null==d&&(d=b.value);-1===f.indexOf(G,d)&&(G.push(d),this._buildRow_Renderer(a,b.symbol,l,w.encode(d),e,y))},this)}F=this._displayDefaultSymbol(a,p,e)}else if(p instanceof K){if(p.infos&&0<p.infos.length||
"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass){z=k=!0;E=this._isUnclassedRenderer(p);!v&&1===p.infos.length&&(n=(n=p.infos[0])&&n.symbol);E||(g=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e),y=c.create("tbody",{},g),t=this._getRendererTitle(p,a,b),this._buildRow_Renderer(a,null,l,w.encode(t),null,y));g=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);y=c.create("tbody",{},g);(a._hoverLabel||a._hoverLabels)&&
this._createHoverAction(g,a,b);if(!E||!D||!A)t=p.infos.slice(0).reverse(),f.forEach(t,function(b){var e=b.label;null==e&&!E&&(e=b.minValue+" - "+b.maxValue);this._buildRow_Renderer(a,b.symbol,l,w.encode(e),null,y)},this);if("esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(a.renderer.style===Q.STYLE_SCALAR||a.renderer.style===Q.STYLE_SINGLE_ARROW))this._buildRow_Renderer(a,p.defaultSymbol,null,"",null,y),a._hideDefaultSymbol=!0}E||(F=this._displayDefaultSymbol(a,p,e))}else p instanceof
J&&(z=k=!0,g=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e),y=c.create("tbody",{},g),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(g,a,b),n=null,a._editable&&(a.templates&&0<a.templates.length)&&(n=a.templates[0]),g=1<t?null:r&&B||x&&C||s&&A,this._buildRow_Renderer(a,p.symbol,l,w.encode(g?this._getRampTitle(1<t?null:v||d||D,a,b):p.label),n,y),n=v?null:p.symbol,g&&(r=x=s=null));if(z){if(v&&B&&(v.field||v.valueExpression))this._showGradientRamp(a,
b,p,null,e,v,r,null,D&&A?!0:!1);if(D&&A&&(D.field||D.valueExpression))z=v&&B||p instanceof N?!1:!0,this._showSizeLegend(a,b,p,D,l,e,s,null,z);if(d&&C&&(d.field||d.valueExpression))s=n&&!n.url&&n.color?n.color:this.transparencyRampColor,this._showGradientRamp(a,b,p,s,e,d,x,null,!1)}if(!F&&(!E||B||A||C))F=this._displayDefaultSymbol(a,p,e);k=k||F}k&&(u.set(q.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<m&&(u.set(q.byId(this.id+"_"+a.id+"_"+m+"_group"),"display","block"),this._findParentGroup(a.id,
m)));return k},_isUnclassedRenderer:function(a,b){var e;if(a instanceof K&&a.infos&&1===a.infos.length){e=a.attributeField;var c=a.normalizationField;e=b?e===b:!!this._getVariables(a,e,c).length}return e},_displayDefaultSymbol:function(a,b,e){var m;!a._hideDefaultSymbol&&b.defaultSymbol&&(m=!0,e=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e),e=c.create("tbody",{},e),this._buildRow_Renderer(a,b.defaultSymbol,null,w.encode(b.defaultLabel)||"others",null,e));
return m},_showGradientRamp:function(a,b,e,m,d,f,z,k,g){g=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(!g?" esriLegendSubFragment":"")},d);d=c.create("tbody",{},g);(a._hoverLabel||a._hoverLabels||k)&&this._createHoverAction(g,a,b,k);(z||f.valueExpression)&&this._addSubHeader(d,this._getRampTitle(f,a,b));z=f.field;var l;z&&(l=h.isFunction(z)?null:this.getField(a,z,b));(b=this._getRampStops(e,f,m,l&&"esriFieldTypeDate"===l.type))&&b.length&&this._drawGradientRamp(d,
b,!0,a,this._getRampBorderColor(e),!!m)},_getMedianColor:function(a,b){var e,c;b.colors?(e=b.minDataValue,c=b.maxDataValue):b.stops&&(e=b.stops[0].value,c=b.stops[b.stops.length-1].value);return a.getColor(e+(c-e)/2,{colorInfo:b})},_getRampStops:function(a,b,e,c){var d,v,k,g,h=!1;b.colors||b.opacityValues?(v=b.maxDataValue-b.minDataValue,d=f.map([0,0.25,0.5,0.75,1],function(a){k=b.minDataValue+a*v;return Number(k.toFixed(6))}),this._checkPrecision(0,4,d)):b.stops&&(d=f.map(b.stops,function(a){return a.value}),
(h=f.some(b.stops,function(a){return!!a.label}))&&(g=f.map(b.stops,function(a){return a.label})));var l=d[0],p,n;v=d[d.length-1]-l;return f.map(d,function(f,k){e?(p=new C(e.toRgba()),n=a.getOpacity(f,{opacityInfo:b}),null!=n&&(p.a=n)):p=a.getColor(f,{colorInfo:b});var z="";if(h)z=g[k];else{var z=c?M.formatDate(f,M.timelineDateFormatOptions):E.format(f),q="";0===k?q=this._specialChars.lt+" ":k===d.length-1&&(q=this._specialChars.gt+" ");z=q+z}return{value:f,color:p,offset:1-(f-l)/v,label:z}},this).reverse()},
_checkPrecision:function(a,b,e){var c=a+(b-a)/2,d=e[a],f=e[c],k=e[b],g=Math.floor(d),h=Math.floor(f),l=Math.floor(k);g===d&&(l===k&&h!==f&&g!==h&&l!==h)&&(e[c]=h);a+1!==c&&this._checkPrecision(a,c,e);c+1!==b&&this._checkPrecision(c,b,e)},_getRampBorderColor:function(a){var b;if(a instanceof J)b=a.symbol;else if(a instanceof N||a instanceof K)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,b,e,m,d,h){var g=c.create("tr",{},
a),l,y,n,p,q,r=b.length-1,t;p=0;this.alignRight?(a=c.create("td",{align:this._isRightToLeft?"left":"right"},g),l=c.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},g)):(l=c.create("td",{width:this.gradientWidth,align:"center"},g),a=c.create("td",{},g));g=d&&0<d.a&&!(240<=d.r&&240<=d.g&&240<=d.b);y=c.create("div",{"class":g?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},l);l=c.create("div",{"class":"esriLegendColorRamp"+
(h?" esriLegendTransparencyRamp":"")},y);h=u.get(l,"width");g&&(d=9>k("ie")?d.toHex():"rgba("+d.toRgba().join(",")+")",u.set(l,"border",this.colorRampBorder+" "+d));e?(d=this.gradientHeight*r,u.set(l,"height",d+"px")):d=u.get(l,"height");u.set(y,"height",d+"px");g=s.createSurface(l,h,d);9>k("ie")&&(p=g.getEventSource(),u.set(p,"position","relative"),u.set(p.parentNode,"position","relative"),p=1);try{e&&f.forEach(b,function(a,b){a.offset=b/r}),q=g.createRect({x:-p,y:-p,width:h+p,height:d+p}),q.setFill({type:"linear",
x1:0,y1:0,x2:0,y2:d,colors:b}).setStroke(null),g.createRect({width:h,height:d}).setFill(new C([255,255,255,1-m.opacity])).setStroke(null),this._surfaceItems.push(g)}catch(x){g.clear(),g.destroy()}f.forEach(b,function(a,e){if(a.label){t="top:"+100*a.offset+"%;";var d="";0===e&&(d+=" esriLegendColorRampTickFirst");e===b.length-1&&(d+=" esriLegendColorRampTickLast");c.create("div",{"class":"esriLegendColorRampTick"+d,innerHTML:"\x26nbsp;",style:t},y)}});n=c.create("div",{"class":"esriLegendColorRampLabels",
style:{height:d+this.gradientHeight+"px"}},a);e?f.forEach(b,function(a){c.create("div",{"class":"esriLegendColorRampLabel",innerHTML:w.encode(a.label)||"\x26nbsp;"},n)}):(c.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},n),c.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(d+this.gradientHeight-2*this.gradientHeight)+"px;"},n))},_showHeatRamp:function(a,b,e,m,d){var f,g=e.field;f=c.create("table",{cellpadding:0,cellspacing:0,width:"95%",
"class":"esriLegendLayer"},m);m=c.create("tbody",{},f);(a._hoverLabel||a._hoverLabels||d)&&this._createHoverAction(f,a,b,d);(g=g&&this.getField(a,g,b))&&this._addSubHeader(m,this._getFieldAlias(g.name,a,b));b=this._getHeatmapStops(e);b.length&&this._drawGradientRamp(m,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var e,c,d,g;if(b&&b[0])if(e=b.length-1,a=b[0]&&null!=b[0].ratio){if((a=b[e])&&1!==a.ratio)b=b.slice(0),b.push({ratio:1,color:a.color}),e++}else c=b[0].value,d=b[e].value-
c,b=f.map(b,function(a){return{color:a.color,ratio:(a.value-c)/d}});else a&&a[0]&&(e=a.length-1,g=1/(a.length-1),b=f.map(a,function(a,b){return{color:a,ratio:b*g}}));b=f.map(b,function(a,b){var d="";0===b?d="Low":b===e&&(d="High");return{color:a.color,label:d,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,e,m){var d=e.legendOptions,g,k,l,y,n,p,q,r=this.dotDensitySwatchSize,s=Math.round(r/2);d&&(k=d.backgroundColor,l=d.outline,y=d.valueUnit,n=d.dotCoverage);n=(n||this.dotCoverage)/
100;q=Math.round(r*r/Math.pow(e.dotSize,2)*n);m=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},m);p=c.create("tbody",{},m);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(m,a,b);this._addSubHeader(p,I.substitute({value:e.dotValue,unit:y||""},this.NLS_dotValue));f.forEach(e.fields,function(d){d=h.mixin({},d);d.numPoints=q;g=new Z(e._generateImageSrc(r,r,[d],{x:0,y:0},{x:r,y:r},k),l||e.outline,r,r);d=this.getField(a,d.name,b)||d;this._buildRow_Renderer(a,
g,null,w.encode(this._getFieldAlias(d.name,a,b)),null,p,{type:"path",path:"M "+-s+","+-s+" L "+s+","+-s+" L "+s+","+s+" L "+-s+","+s+" L "+-s+","+-s+" E"})},this)},_showSizeLegend:function(a,b,e,m,d,f,g,k,l){var n=m.legendOptions,n=n&&n.customValues;d=this._getSizeSymbol(e,d);if(!(m.valueUnit&&"unknown"!==m.valueUnit||!d||!n&&(null==m.minSize||null==m.maxSize||null==m.minDataValue||null==m.maxDataValue)&&(!m.stops||1>=m.stops.length))){l=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+
(!l?" esriLegendSubFragment":"")},f);f=c.create("tbody",{},l);(a._hoverLabel||a._hoverLabels||k)&&this._createHoverAction(l,a,b,k);(g||m.valueExpression)&&this._addSubHeader(f,this._getRampTitle(m,a,b));g=m.field;var p;g&&(p=h.isFunction(g)?null:this.getField(a,g,b));b=p&&"esriFieldTypeDate"===p.type;n=n||this._getDataValues(e,d,m,b);for(p=l=n.length-1;0<=p;p--)g=n[p],d=O.fromJson(d.toJson()),this._applySize(d,e,m,g),g=b?M.formatDate(g,M.timelineDateFormatOptions):E.format(g),k="",p===l?k=this._specialChars.gt+
" ":0===p&&(k=this._specialChars.lt+" "),k="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+w.encode(k+g)+"\x3c/span\x3e",this._buildRow_Renderer(a,d,null,k,null,f)}},_getSizeSymbol:function(a,b){var e,c;if(a instanceof J)e=a.symbol;else if(a instanceof Q)e=a.defaultSymbol;else if(a instanceof N||a instanceof K)e=a.infos[0].symbol,c=1<a.infos.length;if(e=e&&-1!==e.type.indexOf("fillsymbol")?null:e)if(e=O.fromJson(e.toJson()),b||c)-1!==e.type.indexOf("linesymbol")?e.setColor(new C(this.sizeRampDarkColor)):
(e.setColor(new C(this.sizeRampLightColor)),e.setOutline&&(c=new $,c.setColor(new C(this.sizeRampDarkColor)),c.setWidth(1.5),e.setOutline(c)));return e},_getDataValues:function(a,b,e,c,d,g){d=null==d?5:d;g=null==g?20:g;var k=a.getSizeRangeAtScale(e,this.map.getScale());d=this._interpolateSizeRange(k,d);var h=this._getDataRange(e),l=f.map(d,function(a){return this._getDataValueFromSize(a,h,k)},this);if(!c){var n,l=E.round(l);for(c=1;c<l.length-1;c++)if(n=this._roundDataValue(a,b,e,l[c],l[c-1],g))l[c]=
n[0],d[c]=n[1]}return l},_getDataRange:function(a){var b=a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var e=a.minSize,c=(a.maxSize-e)/(b-1),d,f=[];for(d=0;d<b;d++)f.push(e+c*d);return f},_getDataValueFromSize:function(a,b,e){var c=e.minSize;e=e.maxSize;var d=b.min;b=b.max;return a=a<=c?d:a>=e?b:(a-c)/(e-c)*(b-d)+d},_roundDataValue:function(a,b,e,c,d,f){var g=this._getSize(b,a,e,c);d=this._getSize(b,a,e,d);var k,
h=E.getDigits(c),l=h.integer,h=h.fractional,p,n,q,r,s,t,u,x,w,A,B;0<c&&1>c&&(k=Math.pow(10,h),c*=k,l=E.getDigits(c).integer);for(l-=1;0<=l&&!(p=Math.pow(10,l),h=Math.floor(c/p)*p,p*=Math.ceil(c/p),null!=k&&(h/=k,p/=k),n=(h+p)/2,n=E.round([h,n,p],{indexes:[1]})[1],q=this._getSize(b,a,e,h),r=this._getSize(b,a,e,p),s=this._getSize(b,a,e,n),t=E.getPctChange(g,q,d,null),u=E.getPctChange(g,r,d,null),x=E.getPctChange(g,s,d,null),w=t.prev<=f,A=u.prev<=f,w&&A&&(t.prev<=u.prev?(w=!0,A=!1):(A=!0,w=!1)),w?B=
[h,q]:A?B=[p,r]:x.prev<=f&&(B=[n,s]),B);l--);return B},_applySize:function(a,b,e,c){var d=a.type;b=this._getSize(a,b,e,c);switch(d){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":d=a.width;e=a.height;a.setHeight(b);a.setWidth(b*(d/e));break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,b,e,c){return b.getSize(c,{sizeInfo:e,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?
a.style:null})},_buildRow_Renderer:function(a,b,e,f,d,g,k){var h=c.create("tr",{},g),l;this.alignRight?(g=c.create("td",{align:this._isRightToLeft?"left":"right"},h),b&&(l=c.create("td",{align:this._isRightToLeft?"left":"right",width:35},h))):(b&&(l=c.create("td",{width:35,align:"center"},h)),g=c.create("td",{},h));var n=h=30,p;if(b){if("simplemarkersymbol"==b.type)h=Math.min(Math.max(h,b.size+12),125),n=Math.min(Math.max(n,b.size+12),125);else if("picturemarkersymbol"==b.type)h=Math.min(Math.max(h,
b.width),125),n=Math.min(b.height||n,125);else if("textsymbol"==b.type){var q,r;b.text||(q=b.text,r=!0,b.setText(this.defaultText));h=Math.min(Math.max(h,b.getWidth()+12),125);n=Math.min(Math.max(n,b.getHeight()+12),125);r&&b.setText(q)}p=c.create("div",{style:"width:"+h+"px;height:"+n+"px;"},l)}I.isDefined(f)&&"number"===typeof f&&(f=""+f);c.create("td",{innerHTML:f||"",align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},g))));b&&(a=this._drawSymbol(p,b,e,h,n,d,
a,k),this._surfaceItems.push(a))},_addSubHeader:function(a,b){var e=c.create("tr",{},a),e=c.create("td",{align:this._align,colspan:2},e);c.create("td",{innerHTML:w.encode(b)||"",align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},e))))},_drawSymbol:function(a,b,e,c,d,f,g,l){b=O.fromJson(b.toJson());var n=g.opacity;e&&b.setColor(new C(e.toRgba()));if("simplelinesymbol"===b.type||"cartographiclinesymbol"===b.type||"textsymbol"===b.type){if(!b.color)return;e=b.color.toRgba();
e[3]*=n;b.color.setColor(e)}else"simplemarkersymbol"===b.type||"simplefillsymbol"===b.type?(b.color&&(e=b.color.toRgba(),e[3]*=n,b.color.setColor(e)),b.outline&&b.outline.color&&(e=b.outline.color.toRgba(),e[3]*=n,b.outline.color.setColor(e))):"picturemarkersymbol"===b.type&&(a.style.opacity=n,a.style.filter="alpha(opacity\x3d("+100*n+"))");a=s.createSurface(a,c,d);9>k("ie")&&(e=a.getEventSource(),u.set(e,"position","relative"),u.set(e.parentNode,"position","relative"));f=this._getDrawingToolShape(b,
f)||O.getShapeDescriptors(b);var q,n=(e=f.defaultShape)&&"text"===e.type;try{n&&!e.text&&(e.text=this.defaultText),q=a.createShape(l||e).setFill(f.fill).setStroke(f.stroke),n&&q.setFont(f.font)}catch(p){a.clear();a.destroy();return}var r=q.getBoundingBox();l=r.width;f=r.height;var n=-(r.x+l/2),t=-(r.y+f/2);e=a.getDimensions();n={dx:n+e.width/2,dy:t+e.height/2};if("simplemarkersymbol"===b.type&&"path"===b.style)c=g._getScaleMatrix(r,b.size),q.applyTransform(F.scaleAt(c.xx,c.yy,{x:e.width/2,y:e.height/
2}));else if(l>c||f>d)g=l/c>f/d,c=((g?c:d)-5)/(g?l:f),h.mixin(n,{xx:c,yy:c});q.applyTransform(n);return a},_getDrawingToolShape:function(a,b){var e;switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":e={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":e={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case "esriFeatureEditToolRectangle":e={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};
break;case "esriFeatureEditToolCircle":e={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":e={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:e,fill:a.getFill(),stroke:a.getStroke()}},_repaintItems:function(){f.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&h.isArray(a.children)&&
f.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,e,f){if(f=b._hoverLabel||b._hoverLabels&&b._hoverLabels[e.id]||f)f=w.encode(f),b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[e.id]=g.connect(a,"onmousemove",h.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,u.set(q.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(h.hitch(this,function(a,b,e){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=
!0,q.byId(this.id+"_hoverLabel")){var d=q.byId(this.id+"_hoverLabel");d.innerHTML="\x3cspan\x3e"+e+"\x3c/span\x3e";u.set(d,"top",b+"px");u.set(d,"left",a+15+"px");u.set(d,"display","")}else c.create("div",{innerHTML:"\x3cspan\x3e"+e+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,a),500)},f)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[e.id]=g.connect(a,"onmouseout",h.hitch(this,function(a){this.mouseY=
this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,u.set(q.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;f.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)g.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)g.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=[],e;f.forEach(a.dynamicLayerInfos||a.layerInfos,function(c){e={id:c.id};e.source=c.source&&c.source.toJson();
var d;a.layerDefinitions&&a.layerDefinitions[c.id]&&(d=a.layerDefinitions[c.id]);d&&(e.definitionExpression=d);var f;a.layerDrawingOptions&&a.layerDrawingOptions[c.id]&&(f=a.layerDrawingOptions[c.id]);f&&(e.drawingInfo=f.toJson());e.minScale=c.minScale||0;e.maxScale=c.maxScale||0;b.push(e)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var f,d=
b.dynamicLayerInfos||b.layerInfos;for(f=0;f<d.length;f++)if(c==d[f].id){-1<d[f].parentLayerId&&(u.set(q.byId(this.id+"_"+a+"_"+d[f].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,d[f].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,g){var d=a.layer.dynamicLayerInfos||a.layer.layerInfos,h,k;for(h=0;h<d.length;h++)if(d[h].id===c&&d[h].subLayerIds)for(k=0;k<d[h].subLayerIds.length;k++){var l=d[h].subLayerIds[k];-1===f.indexOf(g,l)&&(g.push(l),b(l,g))}}a.layer.layerInfos&&
f.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,c){var f,d=!0;if(a.legendResponse&&a.legendResponse.layers)for(f=0;f<a.legendResponse.layers.length;f++){var g=a.legendResponse.layers[f];if(b.id==g.layerId){var h,k;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==g.minScale&&a.tileInfo&&(h=a.tileInfo.lods[0].scale),0==g.maxScale&&a.tileInfo&&(k=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(h=Math.min(a.minScale,
g.minScale)||a.minScale||g.minScale,k=Math.max(a.maxScale,g.maxScale));if(0<h&&h<c||k>c)d=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)d=!1;return d},_getServiceTitle:function(a){var b=a._titleForLegend;b||((b=a.url)?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+
1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],I.isDefined(a)&&(b+=" ("+a+")"));return w.encode(b)},_getEffectiveScale:function(a,
b){var c=b.minScale,f=b.maxScale;if(I.isDefined(b.parentLayerId)){var d=a.layerInfos,g=b.parentLayerId,h;for(h=d.length-1;0<=h;h--)if(d[h].id==g)if(0==c&&0<d[h].minScale?c=d[h].minScale:0<c&&0==d[h].minScale||0<c&&0<d[h].minScale&&(c=Math.min(c,d[h].minScale)),f=Math.max(f||0,d[h].maxScale||0),-1<d[h].parentLayerId)g=d[h].parentLayerId;else break}return{minScale:c,maxScale:f}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===
a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1},isHostedTileService:function(a){var b=
/(https?:)?\/\/services.*\.arcgis\.com/i;return"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass&&b.test(a.url)?!0:!1},getField:function(a,b,c){if(a.getField)return a.getField(b);if(c&&c.fields){var g;f.forEach(c.fields,function(a){a.name===b&&(g=a)});return g}return null}});h.mixin(H,{ALIGN_LEFT:0,ALIGN_RIGHT:1});k("extend-esri")&&h.setObject("dijit.Legend",H,U);return H});