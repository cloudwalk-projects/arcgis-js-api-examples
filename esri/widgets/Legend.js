// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("./support/viewModelWiring ./Widgette ./Legend/LegendViewModel ./Legend/support/swatchUtils ../core/watchUtils ../core/HandleRegistry ../core/lang ../core/screenUtils dojox/gfx dojox/gfx/matrix dojo/_base/lang dojo/dom-construct dojo/dom-style dojo/dom-class dojo/i18n!./Legend/nls/Legend".split(" "),function(G,y,z,A,n,B,C,D,u,E,v,e,F,k,w){return y.createSubclass({declaredClass:"esri.widgets.Legend",baseClass:"esri-legend",constructor:function(){this._handles=new B;this._DOMByLayerId={}},postCreate:function(){this.inherited(arguments);
this._createLegend()},destroy:function(){this._handles.destroy();this._handles=null},properties:{activeLayerInfos:{aliasOf:"viewModel.activeLayerInfos"},layerInfos:{aliasOf:"viewModel.layerInfos"},basemapLegendVisible:{aliasOf:"viewModel.basemapLegendVisible"},groundLegendVisible:{aliasOf:"viewModel.groundLegendVisible"},view:{aliasOf:"viewModel.view"},viewModel:{type:z}},_createLegend:function(){var a=this._buildLegendDOM(),b=this.activeLayerInfos;b.length&&b.forEach(function(b){this._createLegendForLayer(b,
a)},this);b=b.on("change",function(b){var d,h=b.added;b.removed.forEach(function(a){(d=this._DOMByLayerId[a.layer.uid])&&this._setVisible(d,!1)},this);h.forEach(function(b){(d=this._DOMByLayerId[b.layer.uid])?this._setVisible(d,!0):this._createLegendForLayer(b,a)},this);this._sortDOMNodes(a)}.bind(this));this._handles.add(b,"activeLayerInfos-change")},_hasVisibleDOMNodes:function(){var a=this._DOMByLayerId,b=!1,c;for(c in a)if(!k.contains(a[c],"esri-hidden")){b=!0;break}return b},_isActiveLayerInfosReady:function(a){return!a.length||
1===a.length&&a.getItemAt(0).updating&&!this._hasVisibleDOMNodes()?!1:a.some(function(a){return a.ready||a.updating})},_sortDOMNodes:function(a){var b=this.activeLayerInfos,c=this.domNode,d=c.childNodes,h=[],f={},e=this.id+"_",g=this._isActiveLayerInfosReady(b);this._setVisible(a.message,!g);for(a=0;a<d.length;++a)g=d[a],g.id&&-1<g.id.indexOf(e)&&!k.contains(g,"esri-hidden")&&h.push(g);b.forEach(function(a,b){f[a.layer.uid]=b});b=h.sort(function(a,b){var c=f[a.id.split(e)[1]]||0,d=f[b.id.split(e)[1]]||
0;return c-d});for(a=0;a<b.length;++a)c.appendChild(b[a])},_buildLegendDOM:function(){var a=this.domNode,b=e.create("div",{id:this.id+"_msg",className:"esri-legend__message",textContent:w.noLegend},a);return{widget:a,message:b}},_createLegendForLayer:function(a,b){var c=n.init(a,"version",function(){var c=a.layer.uid,d=this._DOMByLayerId[c];d&&!a.updating&&(delete this._DOMByLayerId[c],e.destroy(d));a.ready&&(d=this._buildLegendDOMForLayer(a,b),this._DOMByLayerId[c]=d.root,c=this._createLegendElements(a,
d.layer).length&&-1!==this.activeLayerInfos.indexOf(a),this._setVisible(d.root,c));this._sortDOMNodes(b)}.bind(this)),d=n.init(a,"tearingDown",function(b){var c=a.layer.uid;if(b&&(b=this._DOMByLayerId[c]))this._handles.remove(c),delete this._DOMByLayerId[c],e.destroy(b)}.bind(this));this._handles.add([c,d],a.layer.uid)},_buildLegendDOMForLayer:function(a,b){var c=e.create("div",{id:b.widget.id+"_"+a.layer.uid,className:"esri-legend__service esri-hidden"},b.widget),d=e.create("p",{textContent:a.title,
className:"esri-legend__service-label"},c),h=e.create("div",{className:"esri-legend__layer"},c);return v.mixin(b,{root:c,title:d,layer:h})},_createLegendElements:function(a,b){var c=a.legendElements,d=a.layer;c.forEach(function(a){this._createLegendElement(a,b,d)},this);return c},_createLegendElement:function(a,b,c,d){var e="color-ramp"===a.type,f="opacity-ramp"===a.type,l="size-ramp"===a.type,g=this._buildDOMForElement(b,a.title,e||f,d);"symbol-table"===a.type||l?a.infos.forEach(function(a){a.type?
this._createLegendElement(a,g.body,c,!0):this._buildDOMForElementInfo(a,g,c,l)},this):(e||f)&&this._buildRampDOM(a.infos,g.body,a.overlayColor,f)},_buildDOMForElement:function(a,b,c,d){"string"!==typeof b&&b&&(c=this._getTitle(b,c),b=b.title?b.title+" ("+c+")":c);d=e.create("div",{className:d?"esri-legend__layer-child-table":"esri-legend__layer-table"},a);b=b?e.create("div",{className:"esri-legend__layer-caption",textContent:b},d):null;c=e.create("div",{className:"esri-legend__layer-body"},d);return{layer:a,
table:d,caption:b,body:c}},_buildDOMForElementInfo:function(a,b,c,d){var h=e.create("div",{className:"esri-legend__layer-row"},b.body);d=e.create("div",{className:d?"esri-legend__layer-cell esri-legend__layer-cell--symbols esri-legend__size-ramp":"esri-legend__layer-cell esri-legend__layer-cell--symbols"},h);(a.symbol?this._drawSymbol(d,a,c):this._drawImage(d,a,c))?(k.add(d.firstChild,"esri-legend__symbol"),e.create("div",{className:"esri-legend__layer-cell esri-legend__layer-cell--info"},h).textContent=
a.label||""):e.destroy(b.table)},_drawImage:function(a,b,c){var d=b.src,h=b.opacity,f=b.width;b=b.height;if(!d)return!1;a=e.create("img",{src:d,border:0},a);null!=f&&null!=b&&(a.width=f,a.height=b);a.style.opacity=null!=h?h:c.opacity;return!0},_drawSymbol:function(a,b,c){var d=b.symbol;b=b.swatchInfo;var e="simple-marker-symbol"===d.type&&"path"===d.style,f=A.isVolumetricSymbol(d);if(!d||!b)return!1;"picture-marker-symbol"===d.type&&(a.style.opacity=c.opacity);c=b.swatch;var l=b.sizes[0],g=b.sizes[1],
k=u.createSurface(a,l,g),x;try{if(null==c)throw"no shape descriptors!";c.forEach(function(a){var b=k.createGroup();a.forEach(function(a){var c=a.shape,d=a.fill,e=a.stroke;if(c){var f="text"===c.type;f&&!c.text&&(c.text="Aa");"image"===c.type&&(c.src&&"data:"!==c.src.substr(0,5))&&(c.src+=(-1===c.src.indexOf("?")?"?":"\x26")+"legend\x3d1");x=b.createShape(c).setFill(d).setStroke(e?e:{width:0});f&&x.setFont(a.font)}});var c=b.getBoundingBox();a=c.width;var q=c.height,r=-(c.x+a/2),m=-(c.y+q/2),s=k.getDimensions(),
r={dx:r+s.width/2,dy:m+s.height/2},m=!1;if((e||f)&&0!==c.width&&0!==c.height){var m=c.width/c.height,n=1,t=1,p=e?D.pt2px(d.size):(l>g?l:g)-2;isNaN(p)||(1<m?(n=p/c.width,t=p/m/c.height):(t=p/c.height,n=p*m/c.width));b.applyTransform(E.scaleAt(n,t,{x:s.width/2,y:s.height/2}));m=!0}if(!m&&(a>l||q>g))c=a/l>q/g,a=((c?l:g)-5)/(c?a:q),v.mixin(r,{xx:a,yy:a});b.applyTransform(r)})}catch(n){return k.clear(),k.destroy(),!1}return!0},_buildRampDOM:function(a,b,c,d){var h=a.length-1,f,l,g;b=e.create("div",{className:"esri-legend__layer-row"},
b);f=e.create("div",{className:"esri-legend__layer-cell esri-legend__layer-cell--symbols",style:"width:24px"},b);f=e.create("div",{className:"esri-legend__ramps"},f);f=e.create("div",{className:"esri-legend__color-ramp "+(d?"esri-legend__opacity-ramp":"")},f);d=e.create("div",{className:"esri-legend__layer-cell esri-legend__layer-cell--info"},b);b=2<h?25*h:50;F.set(f,"height",b+"px");f=u.createSurface(f,"100%",b);try{a.forEach(function(a,b){a.offset=b/h}),g=f.createRect({x:0,y:0,width:"100%",height:b}),
g.setFill({type:"linear",x1:0,y1:0,x2:0,y2:b,colors:a}).setStroke(null),c&&0<c.a&&f.createRect({width:"100%",height:b}).setFill(c).setStroke(null)}catch(k){f.clear(),f.destroy()}l=e.create("div",{className:"esri-legend__ramp-labels",style:{height:b+"px"}},d);a.forEach(function(a){a.label&&e.create("div",{className:"esri-legend__ramp-label",innerHTML:a.label},l)})},_getTitle:function(a,b){var c;return(c=b?a.ratioPercentTotal&&"showRatioPercentTotal"||a.ratioPercent&&"showRatioPercent"||a.ratio&&"showRatio"||
a.normField&&"showNormField"||a.field&&"showField"||null:a.normField&&"showNormField"||(a.normByPct?"showNormPct":null)||a.field&&"showField"||null)?C.substitute({field:a.field,normField:a.normField},w[c]):null},_setVisible:function(a,b){var c=k.contains(a,"esri-hidden");b&&c?k.remove(a,"esri-hidden"):!b&&!c&&k.add(a,"esri-hidden")}})});