// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/widgets/SymbolStyler/templates/MarkerSymbolPicker.html":'\x3cdiv\x3e\r\n  \x3cdiv data-dojo-type\x3d"dijit/form/Select" data-dojo-attach-point\x3d"dap_markerCategoryInput" class\x3d"${css.typeInput}"\x3e\x3c/div\x3e\r\n  \x3cdiv class\x3d"${css.container}" data-dojo-attach-point\x3d"dap_symbolViewport"\x3e\r\n    \x3cdiv class\x3d"${css.symbolGrid}" data-dojo-attach-point\x3d"dap_symbolGrid"\x3e\x3c!--symbols added dynamically--\x3e\x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n'}});
define("../../core/domUtils ../../core/promiseUtils ../../portal/Portal ../../symbols/support/gfxUtils ../../symbols/support/symbolUtils ./support/symbolFetcher ./support/symbolStorage ./support/symbolUtils dijit/_TemplatedMixin dijit/_WidgetBase dijit/_WidgetsInTemplateMixin dojo/dom-class dojo/dom-construct dojo/on dojo/promise/all dojo/store/Memory dojo/store/Observable dojo/i18n!./nls/SymbolStyler dojo/text!./templates/MarkerSymbolPicker.html dijit/form/Select".split(" "),function(p,q,s,t,u,k,
g,r,v,w,x,d,e,y,z,m,A,n,B){var h={id:"customTypes",keywords:"custom symbols",name:n.customImages,title:n.customImages},c={root:"esri-marker-symbol-picker",symbolGrid:"esri-symbol-grid",symbol:"esri-symbol",noSymbols:"esri-no-symbols",defaultSymbols:"esri-default-symbols",loadingIndicator:"esri-loading-indicator",loading:"esri-loading",typeInput:"esri-type-input",container:"esri-container",overlay:"esri-overlay",content:"esri-content",centerContainer:"esri-center-container",table:"esri-table",tableCell:"esri-table-cell",
centerBlock:"esri-center-block",loadingSymbolViewport:"esri-marker-symbol-picker__symbolViewport--loading",selectedSymbol:"esri-symbol--selected",dimensionalityFlat:"esri-marker-symbol-picker--dimensionality-flat",dimensionalityVolumetric:"esri-marker-symbol-picker--dimensionality-volumetric",blocked:"esri-marker-symbol-picker--blocked"};return w.createSubclass([v,x],{baseClass:c.root,declaredClass:"esri.dijit.SymbolStyler.MarkerSymbolPicker",templateString:B,css:c,postCreate:function(){this.inherited(arguments);
this._sourceSymbolTypesStore=new m;this._symbolTypesStore=new A(new m);this._symbolItemStore=new m;this._symbolItemSurfaces=[];this._activeSymbolFetch={};this.dap_markerCategoryInput.set({labelAttr:"name",sortByLabel:!1})},startup:function(){this.inherited(arguments);var a=this;y(this.dap_symbolGrid,".esri-symbol:click",function(){a._selectedNode&&d.remove(a._selectedNode,c.selectedSymbol);a._selectedNode=this;d.add(this,c.selectedSymbol);a.emit("symbol-select",{selection:this.symbol.clone()})});
this.dap_markerCategoryInput.on("change",function(a){this.clearSelection();this._fetchSymbols(a)}.bind(this));this.refresh()},_3dSymbolsFilter:"volumetric",_symbolTypesStore:null,_sourceSymbolTypesStore:null,_symbolItemStore:null,_symbolItemSurfaces:null,_noSymbolsOverlay:null,_symbolGrid:null,_portal:null,_portalLoadTimeoutInMs:3E3,_selectedNode:null,displayMode:"portal",portal:null,symbolSource:"symbol-set",addCustomImageSymbol:function(a){var b=a.clone();a=g.loadCustomItems()||[];var l=b.url.split("/").pop();
a.some(function(a){return a.url===b.url})||(b.type="esriPMS",b.name=l,a.push(b),this.dap_markerCategoryInput.set("value",h.id),this.clearSelection(),this._fetchSymbols(h.id))},_getDimensionality:function(){return this.symbolSource.split(":")[1]},_updateDisplay:function(){var a=this.dap_markerCategoryInput;this.clearSelection();"portal"===this.displayMode?(this._fetchSymbols(a.value),p.show(a.domNode),d.remove(this.domNode,c.defaultSymbols)):"default"===this.displayMode&&(this._updateSymbolOptions(k.getBasic()),
p.hide(a.domNode),d.add(this.domNode,c.defaultSymbols))},refresh:function(){this._blockInteraction(!0);this._setUpDimensionality();this._setUpSymbolCategories().then(this._updateDisplay.bind(this)).then(function(){this._blockInteraction(!1)}.bind(this))},_blockInteraction:function(a){this.dap_markerCategoryInput.set("disabled",a);d.toggle(this.domNode,c.blocked,a)},clearSelection:function(){e.empty(this.dap_symbolGrid)},_activeSymbolFetch:null,_fetchSymbols:function(a){var b;this._activeSymbolFetch.promise&&
(this._activeSymbolFetch.promise.cancel(),this._activeSymbolFetch.promise=null,this._activeSymbolFetch.id=null);if(b=this._symbolItemStore.query({id:a})[0])if(g.saveRecentItem(b),this._updateSymbolOptions(b.symbols),b.id!==h.id)return;b=this._symbolTypesStore.query({id:a})[0];this._activeSymbolFetch.id=a;this._showLoadingIndicator();this._activeSymbolFetch.promise=this._getSymbols(b).then(function(b){var f={id:a,symbols:b},c;this._symbolItemStore.put(f);g.saveRecentItem(f);(c=this._symbolTypesStore.query({defaultType:!0})[0])&&
c.id===a&&g.saveDefaultItem(f);return b}.bind(this)).then(function(b){a===this._activeSymbolFetch.id&&this._updateSymbolOptions(b)}.bind(this))},_showLoadingIndicator:function(){d.add(this.dap_symbolViewport,c.loadingSymbolViewport)},_hideLoadingIndicator:function(){d.remove(this.dap_symbolViewport,c.loadingSymbolViewport)},_showNoSymbolsMessage:function(){this._hideLoadingIndicator();d.add(this.domNode,c.noSymbols);this._placeNoSymbolsOverlay()},_placeNoSymbolsOverlay:function(){var a,b;this._noSymbolsOverlay||
(a=e.create("div",{"class":c.overlay}),b=e.create("div",{"class":c.centerContainer+" "+c.table},a),b=e.create("div",{"class":c.tableCell},b),b=e.create("div",{"class":c.centerBlock},b),e.create("div",{"class":c.content,innerHTML:n.symbolLoadError},b),e.place(a,this.domNode),this._noSymbolsOverlay=a)},_setUpSymbolCategories:function(){this._showLoadingIndicator();return this._initPortal().then(function(a){return 0===this.symbolSource.indexOf("symbol-set")?k.fetchSymbolSetSymbolSources(a):k.fetchWebStyleSymbolSources(a)}.bind(this)).then(function(a){var b=
this._webStyleItemKeywordBlacklist;return a.filter(function(a){return!a.portalItem.typeKeywords.some(function(a){return b[a]})})}.bind(this)).then(function(a){if(0===this.symbolSource.indexOf("symbol-set"))return a;var b=this._getDimensionality(),c=a.map(function(a){return a.portalItem.fetchData()});return q.eachAlways(c).then(function(c){var l=[k.getPrimitives(b)];c.forEach(function(c,f){var d=c.value;if(d&&d.items&&Array.isArray(d.items)&&0!==d.items.length){var e="EsriIconsStyle"===u.styleNameFromItem(a[f].portalItem)?
"flat":"volumetric";(d.items[0].dimensionality||e)===b&&l.push(a[f])}});return l})}.bind(this)).then(this._setUpSymbolSelect.bind(this)).otherwise(this._showNoSymbolsMessage.bind(this))},_webStyleItemKeywordBlacklist:{EsriThematicShapesStyle:!0},_setUpDimensionality:function(){var a="volumetric"===this._getDimensionality();d.toggle(this.domNode,c.dimensionalityVolumetric,a);d.toggle(this.domNode,c.dimensionalityFlat,!a)},_setUpSymbolSelect:function(a){var b=this._sourceSymbolTypesStore,c,f;b.setData(a);
a.forEach(function(a){a.defaultType&&(c=a.id)});if(a=g.loadRecentSymbolItem())if(f=b.query({id:a.id})[0])c=a.id;a=this._symbolTypesStore;a.setData(b.query());this.dap_markerCategoryInput.set("store",a);this.dap_markerCategoryInput.set("value",c,!1)},_injectCustomSymbolType:function(a){a.push(h);return a},_initPortal:function(){var a=this.portal||s.getDefault(),b;b=q.timeout(a.load().then(function(){return this._portal=a}.bind(this)),this._portalLoadTimeoutInMs);this.own(b);return b},_getSymbols:function(a){return a.id===
h.id?g.loadCustomItems():a.getSymbols().then(function(a){return 0===this.symbolSource.indexOf("symbol-set")?a:a.filter(function(a){a=r.getDimensionality(a);var b=this.symbolSource.split(":")[1];return!b||a===b},this)}.bind(this))},_updateSymbolOptions:function(a){this._symbolItemSurfaces.forEach(function(a){a&&a.destroy()});this._symbolItemSurfaces.length=0;var b="volumetric"===this._getDimensionality()?48:24;z(a.map(function(a){var d=e.create("div",{className:c.symbol});"point-symbol-3d"===a.type&&
a.symbolLayers.forEach(function(a){a.get("material.color")&&("Icon"===a.type?a.material.color=t.defaultThematicColor.clone():"Object"===a.type&&(a.material.color=[255,255,255]))});d.symbol=a;return r.renderOnSurface(a,d,b)})).then(function(a){var b=document.createDocumentFragment();a.forEach(function(a){b.appendChild(a._parent)});this.dap_symbolGrid.appendChild(b);this._hideLoadingIndicator()}.bind(this))}})});