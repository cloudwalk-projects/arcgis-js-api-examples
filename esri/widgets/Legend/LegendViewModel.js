// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["./support/ActiveLayerInfo","../../core/Accessor","../../core/Collection","../../core/HandleRegistry","../../core/watchUtils"],function(g,k,l,m,e){var n=["esri.layers.FeatureLayer","esri.layers.MapImageLayer","esri.layers.TileLayer","esri.layers.StreamLayer","esri.layers.SceneLayer"],p=["view.basemapView.baseLayerViews","view.groundView.layerViews","view.layerViews","view.basemapView.referenceLayerViews"];return k.createSubclass({declaredClass:"esri.widgets.Legend.LegendViewModel",constructor:function(){this._handles=
new m;this._layerInfosByLayerViewId={};this._activeLayerInfosByLayerViewId={};var a=e.watch(this,"view",function(a){this._handles.remove("view-ready-watcher");a&&this._handles.add(e.init(this,"state",function(c){this._handles.remove("allLayerViews-change");this._handles.remove("legendProperties-change");this._destroyViewActiveLayerInfos();this.activeLayerInfos.removeAll();"ready"===c&&this._updateActiveLayerInfos(a.allLayerViews)}.bind(this)),"view-ready-watcher")}.bind(this));this._handles.add(a,
"view-watcher")},getDefaults:function(){return{activeLayerInfos:[]}},destroy:function(){this._destroyViewActiveLayerInfos();this._handles.destroy();this._handles=null},properties:{activeLayerInfos:{type:l.ofType(g)},layerInfos:null,state:{value:"disabled",readOnly:!0,dependsOn:["view.ready"],get:function(){return this.get("view.ready")?"ready":"disabled"}},basemapLegendVisible:!1,groundLegendVisible:!1,view:null},_destroyViewActiveLayerInfos:function(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,
this)},_destroyViewActiveLayerInfo:function(a){this._handles.remove(a);var b=this._activeLayerInfosByLayerViewId[a];b&&(b.tearingDown=!0,delete this._activeLayerInfosByLayerViewId[a])},_updateActiveLayerInfos:function(a){a.length&&this._refresh();this._handles.add(a.on("change",function(a){a.removed.forEach(function(a){this._destroyViewActiveLayerInfo(a.uid)},this);this._refresh()}.bind(this)),"allLayerViews-change");this._handles.add(e.watch(this,"layerInfos, basemapLegendVisible, groundLegendVisible",
function(){this._destroyViewActiveLayerInfos();this._refresh()}.bind(this)),"legendProperties-change")},_refresh:function(){this._layerInfosByLayerViewId={};this.activeLayerInfos.removeAll();var a=this.layerInfos;this._generateLayerViews().filter(function(b){var c=b.layer.uid;return a&&a.length?a.some(function(a){return a.layer&&(this._hasLayerUID(a.layer.layers,c)||a.layer.uid===c)?(this._layerInfosByLayerViewId[b.uid]=a,!0):!1},this):!0},this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,
this)},_hasLayerUID:function(a,b){return!a?!1:a.some(function(a){return this._hasLayerUID(a.layers,b)||a.uid===b},this)},_isLayerViewSupported:function(a){return-1<n.indexOf(a.layer.declaredClass)},_generateLayerViews:function(){var a=[],b=this.basemapLegendVisible,c=this.groundLegendVisible;p.filter(function(a){var d=!c&&"view.groundView.layerViews"===a;return!(!b&&("view.basemapView.baseLayerViews"===a||"view.basemapView.referenceLayerViews"===a))&&!d}).map(this.get,this).filter(function(a){return null!=
a}).forEach(this._collectLayerViews("layerViews",a),this);return a.reverse()},_collectLayerViews:function(a,b){var c=function(e){e&&e.forEach(function(d){b.push(d);c(d[a])});return b};return c},_sortActiveLayerInfos:function(){var a={};this.view.allLayerViews.forEach(function(b,c){a[b.layer.uid]=c});this.activeLayerInfos.sort(function(b,c){return(a[c.layer.uid]||0)-(a[b.layer.uid]||0)})},_generateActiveLayerInfo:function(a){var b=a.uid;if(this._isLayerActive(a))this._buildActiveLayerInfo(a);else{this._handles.remove(b);
var c=e.watch(a,"suspended, layer.legendEnabled",function(){this._isLayerActive(a)&&(this._handles.remove(b),this._buildActiveLayerInfo(a))}.bind(this));this._handles.add(c,b)}},_buildActiveLayerInfo:function(a){var b=a.layer,c=a.uid,f=this._layerInfosByLayerViewId[c],d=this._activeLayerInfosByLayerViewId[c],h;d||(d=new g({layer:b,title:f&&f.title||b.title}),this._activeLayerInfosByLayerViewId[c]=d);this._handles.has(c)||(b=e.watch(b,"renderer, opacity, title, legendEnabled",function(b,c,e){"title"===
e&&(d.title=b);"legendEnabled"===e?b?this._addActiveLayerInfo(d,a):this.activeLayerInfos.remove(d):this._constructLegendElements(d,a)}.bind(this)),f=e.watch(a,"suspended",function(b){b?this.activeLayerInfos.remove(d):this._addActiveLayerInfo(d,a)}.bind(this)),h=e.whenTrue(this.view,"stationary",function(){d.scale!==this.view.scale&&this._constructLegendElements(d,a)}.bind(this)),this._handles.add([b,f,h],c));this._addActiveLayerInfo(d,a)},_addActiveLayerInfo:function(a,b){this._isLayerActive(b)&&
-1===this.activeLayerInfos.indexOf(a)&&(this.activeLayerInfos.add(a),this._sortActiveLayerInfos())},_constructLegendElements:function(a,b){var c=b.layer;a.updating=!0;a.ready=!1;a.legendElements=[];a.scale=this.view.scale;c.renderer?a.buildLegendElementsForRenderer():c.url&&a.buildLegendElementsForTools()},_isLayerActive:function(a){return!a.suspended&&a.layer.legendEnabled}})});