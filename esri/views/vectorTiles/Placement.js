// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["require","exports","./Geometry","./GeometryUtils","./Conflict"],function(y,n,r,e,B){y=function(){return function(e,a,b,f,c){void 0===b&&(b=0);void 0===f&&(f=-1);void 0===c&&(c=A);this.x=e;this.y=a;this.angle=b;this.segment=f;this.minzoom=c}}();n.Anchor=y;y=function(){return function(e,a,b){this.glyph=e;this.x=a;this.y=b}}();n.ShapedGlyph=y;var O=function(){return function(p,a,b,f,c,d){void 0===f&&(f=!1);void 0===c&&(c=A);void 0===d&&(d=e.C_INFINITY);this.anchor=p;this.labelAngle=a;this.glyphAngle=
b;this.upsideDown=f;this.minzoom=c;this.maxzoom=d}}(),P=function(){return function(e,a,b,f,c,d,v,q,r){this.tl=e;this.tr=a;this.bl=b;this.br=f;this.mosaicRect=c;this.labelAngle=d;this.anchor=v;this.minzoom=q;this.maxzoom=r}}();n.PlacedSymbol=P;var Q=function(){return function(e,a){this.footprint=e;this.shapes=a}}();n.Placement=Q;var A=0.5;y=function(){function p(a){this.mapAngle=a;this._conflictEngine=new B.ConflictEngine(a)}p.prototype.getIconPlacement=function(a,b,f,c,d,v){var q=b.width/b.pixelRatio,
G=b.height/b.pixelRatio;c=d.offset[0]-q/2;var w=d.offset[1]-G/2,q=c+q,G=w+G,C=b.rect,m=new r.Point(c,w),h=new r.Point(c+C.width/b.pixelRatio,w+C.height/b.pixelRatio),g=new r.Point(c,h.y),s=new r.Point(h.x,w),k=d.rotate*e.C_DEG_TO_RAD;b=1===d.rotationAlignment;0<=a.segment&&!b&&(k+=a.angle);if(0!==k){var l=Math.cos(k),t=Math.sin(k);m.rotate(l,t);h.rotate(l,t);g.rotate(l,t);s.rotate(l,t)}l=8*d.padding;t=new r.Point(a.x,a.y);a=new B.Footprint(this.mapAngle,l,b);a.addBox(t,new B.Box(c,w,q,G),f,k,A,e.C_INFINITY);
f=new P(m,s,g,h,C,0,t,A,e.C_INFINITY);f=new Q(a,[f]);c=A;d.allowOverlap||(c=this._conflictEngine.getMinZoom(f.footprint,c,v,b));a.minzoom=c;return f};p.prototype.getTextPlacement=function(a,b,f,c,d,v,q,G){for(var w=new r.Point(a.x,a.y),C=q.rotate*e.C_DEG_TO_RAD,m=0===q.rotationAlignment,h=q.keepUpright,g=A,s=!m,k=s?0:a.angle,l=0<=a.segment&&m,t=new B.Footprint(this.mapAngle,8*q.padding,s),p=[],y=!l,D=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,n=D,J=E,ba=l?h:m&&h,ca=[],R,S=0;S<f.length;S++){var z=
f[S],u=c[z.glyph];if(u){var H=u.rect;if(H&&!(0>=H.width||0>=H.height)){var F=u.metrics;y&&(R&&R!==z.y&&(t.addBox(w,new B.Box(D,n,E,J),d,C,A,e.C_INFINITY),D=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,n=D,J=E),R=z.y);var I=[];if(l){if(u=(b.x+z.x+F.left-3+0.5*u.metrics.width)*d,g=this._placeGlyph(a,g,u,v,a.segment,1,I),h&&(g=this._placeGlyph(a,g,u,v,a.segment,-1,I)),2<=g)break}else I.push(new O(w,k,k)),m&&h&&I.push(new O(w,k+e.C_PI,k+e.C_PI,!0));for(var u=z.x+b.x+F.left,z=z.y+b.y-F.top,T=u+
F.width,F=z+F.height,K=new r.Point(u-3,z-3),U=new r.Point(K.x+H.width,K.y+H.height),da=new r.Point(K.x,U.y),ea=new r.Point(U.x,K.y),V=0;V<I.length;V++){var x=I[V],Y=K.clone(),Z=da.clone(),$=ea.clone(),aa=U.clone(),W=z,X=F,L=x.glyphAngle+C;if(0!==L){var M=Math.cos(L),N=Math.sin(L);Y.rotate(M,N);aa.rotate(M,N);Z.rotate(M,N);$.rotate(M,N)}p.push(new P(Y,$,Z,aa,H,x.labelAngle,x.anchor,x.minzoom,x.maxzoom));if(!ba||this._legible(x.labelAngle))y?(u<D&&(D=u),W<n&&(n=W),T>E&&(E=T),X>J&&(J=X)):2>x.minzoom&&
t.addBox(x.anchor,new B.Box(u,W,T,X),d,L,x.minzoom,x.maxzoom);ca.push(x)}}}}if(2<=g)return null;y&&t.addBox(w,new B.Box(D,n,E,J),d,C,A,e.C_INFINITY);a=new Q(t,p);q.allowOverlap||(g=this._conflictEngine.getMinZoom(a.footprint,g,G,s));t.minzoom=g;return a};p.prototype.add=function(a){this._conflictEngine.add(a.footprint)};p.prototype._legible=function(a){a=e.radToByte(a);return 65>a||193<=a};p.prototype._placeGlyph=function(a,b,f,c,d,v,q){var n=0>v?e.positiveMod(a.angle+e.C_PI,e.C_2PI):a.angle,w=this._legible(n),
p=0;0>f&&(v*=-1,f*=-1,p=e.C_PI);0<v&&++d;a=new r.Point(a.x,a.y);var m=c[d],h=e.C_INFINITY;if(c.length<=d)return h;for(;;){var g=m.x-a.x,s=m.y-a.y,k=Math.sqrt(g*g+s*s),l=Math.max(f/k,b),g=e.positiveMod(Math.atan2(s/k,g/k)+p,e.C_2PI);q.push(new O(a,n,g,w,l,h));if(l<=b)return l;a=m.clone();do{d+=v;if(c.length<=d||0>d)return l;m=c[d]}while(a.isEqual(m));h=m.x-a.x;g=m.y-a.y;s=Math.sqrt(h*h+g*g);h*=k/s;g*=k/s;a.x-=h;a.y-=g;h=l}};return p}();n.PlacementEngine=y});