// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports dojo/promise/all ../../core/promiseUtils ../../core/executeAsync ../../core/pbf ./SourceLayerData ./Feature ./BackgroundBucket ./FillBucket ./LineBucket ./SymbolBucket ./TileClipper".split(" "),function(M,N,F,B,C,t,G,H,I,J,K,L,k){return function(){function c(b,a,e){this._pbfTile=new t(new Uint8Array(b),new DataView(b));this._tile=a;this._connection=e;this._layers=a.getLayers();e=a.tileKey.split("/").map(parseFloat);var f=e[0];b=e[1];e=e[2];this._level=f;a.refKey&&(a=a.refKey.split("/").map(parseFloat)[0],
a=f-a,0<a&&(f=(1<<a)-1,this._tileClipper=new k.TileClipper(a,b&f,e&f)));this._tileClipper||(this._tileClipper=new k.SimpleBuilder)}c.prototype.parse=function(){for(var b=this,a=this._parseTileData(this._pbfTile),e=this._layers,f=e.length,c=this._level,d,h=[],l={},k=new Set,f=f-1;0<=f;f--)if(d=e[f],!(d.minzoom&&c<d.minzoom)&&!(d.maxzoom&&c>=d.maxzoom)&&!(d.layout&&"none"===d.layout.visibility))if(0===d.type)d=this._createBucket(d),h.push(d);else{var q=d.sourceLayer,m=a[q];if(m&&(k.add(q),d=this._createBucket(d)))d.layerIndex=
f,d.layerExtent=m.extent,(m=l[q])||(m=l[q]=[]),m.push(d)}var t=10*(this._level+1),n=[],u=[],r=[],D=[],v=this._tileClipper,w=new Set,x={},y=[];k.forEach(function(b){return y.push(b)});var s=0,p=0,z=y.length;return C(function(){if(6===b._tile.status)return!0;switch(s){case 0:if(p<z)for(var d=y[p++],e=a[d],f=l[d],d=e.getData();d.next(2);){var c=new H(d.getMessage(),e),g=c.values;if(g&&(g=g._minzoom)&&g>=t)continue;for(var A=0,E=f;A<E.length;A++)g=E[A],g.pushFeature(c)}else{e=b._tile;for(d in l){f=l[d];
for(c=0;c<f.length;c++)g=f[c],g.hasFeatures()&&(3===g.layer.type?(n.push(g),e.addBucket(g)):g.layer.refLayerId?r.push(g):(u.push(g),D[g.layer.id]=g))}s=1;p=0;z=n.length}break;case 1:p<z?n[p++].getResources(v,w,x):s=2}return 2===s},50).then(function(){if(6===b._tile.status)return[];var a=[],d=b._tile.getWorkerTileHandler(),c;0<w.size&&(c=d.fetchSprites(w,b._connection),a.push(c));for(var e in x)c=x[e],0<c.size&&(c=d.fetchGlyphs(b._tile.tileKey,e,c,b._connection),a.push(c));return F(a).then(function(a){if(6===
b._tile.status)return[];var d=0,c=0,e=u.length;return C(function(){if(6===b._tile.status)return!0;switch(d){case 0:if(c<e){var a=u[c++];a.processFeatures(v,b._tile);h.push(a)}else d=1,c=0,e=r.length;break;case 1:for(var g=0;g<r.length;g++){var a=r[g],f=D[a.layer.refLayerId];f&&(f.assignBufferInfo(a),h.push(a))}d=2;c=0;e=n.length;break;case 2:c<e?(a=n[c++],a.processFeatures(v,b._tile),h.push(a)):d=3}return 3===d},50).then(function(){h.sort(function(a,b){return a.layerIndex-b.layerIndex});return h})}).otherwise(function(a){return B.reject(Error(a))})}).otherwise(function(a){return B.reject(Error(a))})};
c.prototype._parseTileData=function(b){for(var a={};b.next();)switch(b.tag()){case 3:var c=new G(b.getMessage());a[c.name]=c;break;default:b.skip()}return a};c.prototype._createBucket=function(b){switch(b.type){case 0:return this._createBackgroundBucket(b);case 1:return this._createFillBucket(b);case 2:return this._createLineBucket(b);case 3:return this._createSymbolBucket(b)}};c.prototype._createBackgroundBucket=function(b){return new I(b,this._level)};c.prototype._createFillBucket=function(b){var a=
this._tile;return new J(b,this._level,a.polygonVertexBuffer,a.polygonIndexBuffer,a.polygonOutlineVertexBuffer,a.polygonOutlineIndexBuffer)};c.prototype._createLineBucket=function(b){var a=this._tile;return new K(b,this._level,a.lineVertexBuffer,a.lineIndexBuffer,a.lineJoinVertexBuffer)};c.prototype._createSymbolBucket=function(b){var a=this._tile;return new L(b,this._level,a.markerVertexBuffer,a.markerIndexBuffer,a.textVertexBuffer,a.textIndexBuffer,a.placementEngine,a.getWorkerTileHandler())};return c}()});