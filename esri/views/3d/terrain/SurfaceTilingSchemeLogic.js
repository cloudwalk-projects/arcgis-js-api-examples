// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/Accessor ../../../core/HandleRegistry ./TilingScheme ./terrainUtils".split(" "),function(n,p,k,f,b,l,m,e,g){return function(h){function a(){h.call(this);this._changeHandles=new m}k(a,h);a.prototype.normalizeCtorArgs=function(c){this._layers=c.layers;this._extentHelper=c.extentHelper;this._manifold=c.manifold;return{viewSpatialReference:c.viewSpatialReference}};
a.prototype.initialize=function(){var c=this;this._changeHandles.add(this._layers.on("change",function(){return c._update()}));this._changeHandles.add(this._extentHelper.watch("layerViewsExtent",function(){return c._setAdHocTilingScheme()}));this._update();this.tilingSchemeLocked||this._setAdHocTilingScheme()};a.prototype.destroy=function(){this._changeHandles.destroy();this._changeHandles=null};a.prototype._update=function(){var c=this;this._waitTask=null;if(!this.tilingSchemeLocked){var a=this._layers.find(function(a){if(g.isTiledLayer(a))return a.isResolved()&&
!c._isTileInfoSupported(g.getTileInfo(a),a.fullExtent)?!1:!a.isRejected()});if(a)if(a.isResolved()){var d=new e(g.getTileInfo(a)),a=g.getKnownTiledServiceLevelCap(a.url);Infinity>a&&d.capMaxLod(a);this._lockTilingScheme(d)}else this._updateWhen(a)}};a.prototype._updateWhen=function(a){var b=this,d=a.always(function(){d===b._waitTask&&b._update()});this._waitTask=d};a.prototype._lockTilingScheme=function(a){var b=this;if("spherical"===this._manifold){var d=a.levels.length-1;a=a.spatialReference.isWebMercator?
e.makeWebMercatorAuxiliarySphere(d):e.makeWGS84WithTileSize(a.pixelSize[0],d)}this.tilingSchemeLocked=!0;this.tilingScheme=a;this._extentHelper.tilingScheme=this.tilingScheme;this._updateTiledLayerExtent();this._changeHandles.removeAll();this._changeHandles.add(this._extentHelper.watch("tiledLayersExtent",function(){return b._updateTiledLayerExtent()}))};a.prototype._updateTiledLayerExtent=function(){this.extent=this._extentHelper.tiledLayersExtent};a.prototype._setAdHocTilingScheme=function(){if("spherical"===
this._manifold)this.tilingScheme=this._extentHelper.spatialReference.isWebMercator?e.WebMercatorAuxiliarySphere:e.makeWGS84WithTileSize(256),this.extent=this._extentHelper.layerViewsExtent;else{var a=this._extentHelper.layerViewsExtent;a&&(this.tilingScheme=e.fromExtent(a,this._extentHelper.spatialReference),this.extent=a)}};a.prototype._isTileInfoSupported=function(a,b){return null==g.checkIfTileInfoSupportedForView(a,b,this.viewSpatialReference,this._manifold)};f([b.property()],a.prototype,"tilingScheme",
void 0);f([b.property()],a.prototype,"extent",void 0);f([b.property({value:!1})],a.prototype,"tilingSchemeLocked",void 0);f([b.property()],a.prototype,"viewSpatialReference",void 0);return a=f([b.subclass()],a)}(b.declared(l))});