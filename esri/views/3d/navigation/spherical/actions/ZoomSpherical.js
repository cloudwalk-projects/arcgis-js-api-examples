// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["./ActionSpherical","../../mixins/ZoomMixin","../../../lib/glMatrix","../../../support/earthUtils"],function(s,t,r,m){var u=r.vec2d,b=r.vec3d,p=r.mat4d,k=b.create(),g=b.create(),e=b.create(),l=p.create(),n=b.create(),q=b.create();return s.createSubclass([t],{declaredClass:"esri.views.3d.navigation.spherical.actions.ZoomSpherical",constructor:function(){},begin:function(c){this.inherited(arguments);this.pickPointInScreen(c,this._navPickPoint)?this._navSphereRadius=b.length(this._navPickPoint):
(this._navSphereRadius=b.length(this.targetCamera.center),this._navSphereRadius<0.9*m.earthRadius&&(this._navSphereRadius=m.earthRadius),this.createPickRay(c,c,this.currentCamera.viewMatrix,k,g),b.subtract(g,this.currentCamera.eye),this.intersectManifold(this.currentCamera.eye,g,this._navSphereRadius-m.earthUtils,this._navPickPoint)||(this._navSphereRadius=0));this._mouseDownCamera.copyFrom(this.targetCamera)},update:function(c){var a=this.targetCamera;a.eye=this._mouseDownCamera.eye;a.center=this._mouseDownCamera.center;
a.up=this._mouseDownCamera.up;b.subtract(a.center,a.eye,e);var d=b.length(e);this.normalizeCoordinate(c,k);var f=12*(k[1]-this.normalizedAnchorPoint[1]);c=d*Math.pow(2,f);0>f&&c<this.navigation.minPoiDist&&(c=this.navigation.minPoiDist);c=this.limitAltitude(c,a.center,e,d,0>f?-1:1);1E-6>Math.abs(d-c)||(0<this._navSphereRadius&&c<d&&(f=1-(1-c/d)*(1-this._navSphereRadius/b.length(a.center)),b.scale(a.center,f)),b.scale(e,-c/d),b.add(a.center,e,a.eye),d=!1,0<this._navSphereRadius&&(p.lookAt(a.eye,a.center,
a.up,l),this.createPickRay(this._dragBeginPoint,this._dragBeginPoint,l,k,g),b.normalize(b.subtract(g,a.eye)),this.intersectManifold(a.eye,g,this._navSphereRadius-m.earthRadius,this._targetOnSphere)||(this.closestPointOnSphereSilhouette(a.eye,k,this._navSphereRadius,this._targetOnSphere),d=!0),this.rotateCameraWithPointsOnSphere(this._navPickPoint,this._targetOnSphere,a,a,this._navSphereRadius),this.fixTargetUpVector()),this.applyConstraints(a),this.constrainTargetEyeByElevation(),this.targetAndCurrentChanged(),
u.set(this._dragBeginPoint,this._dragLastPoint),d&&(p.lookAt(a.eye,a.center,a.up,l),this._dragLastPoint=this.currentCamera.projectPoint(this._navPickPoint,l)),a=this._toYDownCoord(this._dragLastPoint),this.emit("update",a[0],a[1]))},stepAtPoint:function(c,a,d,f){b.set(a,q);a=b.length(q);b.subtract(this.targetCamera.eye,this.targetCamera.center,n);var h=b.length(n),e=h*c,e=(c=1>=c)&&e<this.minPoiDist?this.minPoiDist:this.limitAltitude(e,q,n,-h,c?-1:1);c=e/h;1E-6>Math.abs(h-e)||(f&&(h=b.length(this.targetCamera.center),
b.scale(this.targetCamera.center,(a+c*(h-a))/h)),b.scale(n,c),b.add(this.targetCamera.center,n,this.targetCamera.eye),f&&d&&(p.lookAt(this.targetCamera.eye,this.targetCamera.center,this.targetCamera.up,l),this.createPickRay(d,d,l,k,g),b.normalize(b.subtract(g,this.targetCamera.eye)),a<b.length(this.targetCamera.eye)&&this.intersectManifold(this.targetCamera.eye,g,a-m.earthRadius,this._targetOnSphere)?this.rotateCameraWithPointsOnSphere(q,this._targetOnSphere,this.targetCamera,this.targetCamera,a):
f=!1),this.applyConstraints(this.targetCamera),this.constrainTargetEyeByElevation(),f&&this.fixTargetUpVector(),this.navigation.currentHasAlmostReachedTarget()?this.targetAndCurrentChanged():this.targetAnimatedChanged(!1,{internalUpdate:!0}))}})});