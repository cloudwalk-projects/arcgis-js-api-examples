// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("../../../core/declare ../../../core/Accessor ../../../core/Evented ../../../core/promiseUtils ../../../core/watchUtils ../../../core/HandleRegistry ../../../geometry/Point ../../../geometry/support/webMercatorUtils ../../../geometry/SpatialReference ../support/sunUtils ../support/earthUtils ./EnvironmentRenderer".split(" "),function(f,r,s,k,g,t,l,u,m,h,n,v){var e=new Date,p={hours:0,minutes:0,seconds:0},q=[0.5773502691896258,-0.5773502691896258,0.5773502691896258];f=f([r,s],{declaredClass:"esri.views.3d.environment.SceneViewEnvironmentManager",
referencePointUpdateDelay:200,referencePointUpdateInterval:3E3,referencePointUpdateDistThreshold:1E6,properties:{updating:{dependsOn:["noReferencePositionQueries"],readOnly:!0,get:function(){return!this.noReferencePositionQueries&&(!!this._referencePosUpdateQuery||!!this._referencePosMapCoordsRequested)}},noReferencePositionQueries:{},view:{},_environmentRenderer:{}},constructor:function(){this._viewHandles=new t;this._environmentRenderer=null;this._viewConnected=this._trackingEnabled=this._preserveAbsoluteDateTime=
!1;this._referencePosResetPreserveAbsoluteTime=null;this._resetReferencePosition()},destroy:function(){this._viewHandles.destroy();this.disposeRendering()},disposeRendering:function(){this._environmentRenderer&&(this._environmentRenderer.destroy(),this._environmentRenderer=null);this._resetReferencePosition(!0)},updateReadyChange:function(a){a&&!this._viewConnected?(this._viewConnected=!0,this.connectView(this.view)):!a&&this._viewConnected&&(this._viewConnected=!1,this.disconnectView(this.view))},
connectView:function(a){this._environmentRenderer=new v({view:a});this._viewHandles.add([g.on(this.view,"environment.lighting","date-will-change",this._lightingDateHandler.bind(this)),this.view.watch("interacting,stationary",this._interactingStationaryHandler.bind(this)),this.view.watch("environment.lighting.directShadowsEnabled,environment.lighting.ambientOcclusionEnabled",this._updateRenderParamsHandler.bind(this)),this.view.watch("spatialReference",this._spatialReferenceHandler.bind(this)),g.init(this.view,
"viewingMode",this._viewingModeHandler.bind(this)),g.init(this.view,"environment.lighting.cameraTrackingEnabled",this._updateCameraTracking.bind(this),!0),this.watch("noReferencePositionQueries",this._cameraHandler.bind(this,null))]);this._updateRenderParamsHandler();this._updateLightParams();this._cameraHandler()},_updateCameraTracking:function(a){if(this._trackingEnabled=a)a=g.on(this,"view.navigation","currentViewChanged",this._cameraHandler.bind(this,null),this._cameraHandler.bind(this,null),
null,!0),this._viewHandles.add(a,"camera");else{if(a=this.get("view.environment.lighting"))a.positionTimezoneInfo.autoUpdated=!1;this._viewHandles.remove("camera")}},disconnectView:function(a){this.disposeRendering();this._viewHandles.removeAll()},_lightingDateHandler:function(a){if(a=a.date){var c=this.view.environment.lighting;if(!c.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;var b=this.view.spatialReference;if(!b.isWGS84&&!b.isWebMercator&&(b=this.view.camera.position,!this._referencePosMapCoords||
!this._referencePosMapCoords.equals(b))){this._requestReferencePositionUpdate(b);return}this._preupdateTracking(a);this._referencePosWGS84&&(b=n.positionToTimezone(this._referencePosWGS84,p),c.autoUpdate(null,b),this._trackingEnabled&&(c.positionTimezoneInfo.autoUpdated=!0))}this._updateLightParams(a)}},_preupdateTracking:function(a){!this._trackingEnabled&&this.get("view.environment.lighting.cameraTrackingEnabled")&&this._cameraHandler(a)},_cameraHandler:function(a){var c=this.view.camera;if(c){var b=
this.view.spatialReference;b.isWGS84||b.isWebMercator?this._cameraHandlerGlobal(c,a):this._cameraHandlerLocal(c,a)}},_cameraHandlerGlobal:function(a,c){var b=a.position;this._referencePosWGS84||(this._referencePosWGS84=new l({spatialReference:m.WGS84}));b.spatialReference.isWebMercator?u.webMercatorToGeographic(b,!1,this._referencePosWGS84):(this._referencePosWGS84.x=b.x,this._referencePosWGS84.y=b.y);this._referencePosWGS84.z=b.z;this._autoUpdateTimezone(b,c)||this._updateLightParams(c)},_cameraHandlerLocal:function(a,
c){var b=a.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(b))&&this._requestReferencePositionUpdate(b,!0);this.view.mapCoordsHelper&&this._referencePosWGS84&&(this._referencePosWGS84.z=b.z*this.view.mapCoordsHelper.unitInMeters,this._referencePosChanged())},_interactingStationaryHandler:function(){!this.view.interacting&&this.view.stationary&&this._executePendingReferencePositionUpdate()},_updateLightParams:function(a){var c=this.view.environment.lighting;
a=a||c.date;var c=this.view._stage,b;this._referencePosWGS84?(b=h.computeColorAndIntensity(a,this._referencePosWGS84),h.computeDirection(a,this._referencePosWGS84,this.view.viewingMode,b.diffuse.direction)):b={diffuse:{color:[1,1,1],intensity:0.5,direction:q},ambient:{color:[1,1,1],intensity:0.5}};c.setDirectionalLight(b.diffuse);c.setAmbientLight(b.ambient);this._updateRenderParamsHandler()},_autoUpdateTimezone:function(a,c){if(!this.view.get("environment.lighting.cameraTrackingEnabled"))return!1;
e.setTime((c||this.view.environment.lighting.date).getTime());var b=n.positionToTimezone(a,p),d=this.view.environment.lighting.positionTimezoneInfo;if(d.autoUpdated){if(d.hours===b.hours&&d.minutes===b.minutes&&d.seconds===b.seconds)return!1}else d=b;var f=e.getUTCHours()-(b.hours-d.hours),g=e.getUTCMinutes()-(b.minutes-d.minutes),d=e.getUTCSeconds()-(b.seconds-d.seconds);e.setUTCHours(f);e.setUTCMinutes(g);e.setUTCSeconds(d);return c?!1:this.view.environment.lighting.autoUpdate(e,b)},_updateRenderParamsHandler:function(){var a=
this.view._stage,c=!0;this._referencePosWGS84&&(c=h.computeShadowsEnabled(this._referencePosWGS84,this.view.viewingMode));a&&a.setRenderParams({shadowMap:this.view.environment.lighting.directShadowsEnabled&&c,ssao:this.view.environment.lighting.ambientOcclusionEnabled})},_spatialReferenceHandler:function(){this._resetReferencePosition()},_viewingModeHandler:function(a){this._resetReferencePosition()},_resetReferencePosition:function(a){this._cancelReferencePosUpdates();this._referencePosWGS84=this._referencePosResetPreserveAbsoluteTime=
this._referencePosMapCoordsRequested=this._referencePosMapCoords=null;a||this.notifyChange("updating")},_requestReferencePositionUpdate:function(a,c){if(this.view.mapCoordsHelper.canProject()&&!this.noReferencePositionQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(a):this._referencePosMapCoordsRequested=a.clone(),this._referencePosResetPreserveAbsoluteTime=!!c,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&!this.view.interacting&&this.view.stationary)){var b=
this,d=this._referencePosUpdateQuery=k.after(this.referencePointUpdateDelay).then(function(){if(b._referencePosUpdateQuery===d)return b._doReferencePositionUpdateQuery(function(){return b._referencePosUpdateQuery!==d})}).always(function(){b._referencePosUpdateQuery===d&&(b._referencePosUpdateQuery=null,b._referencePosUpdateTimer||b._executePendingReferencePositionUpdate(),b.notifyChange("updating"))}),e=this._referencePosUpdateTimer=k.after(this.referencePointUpdateInterval).then(function(){b._referencePosUpdateTimer===
e&&(b._referencePosUpdateTimer=null,b._referencePosUpdateQuery||b._executePendingReferencePositionUpdate())});this.notifyChange("updating")}},_doReferencePositionUpdateQuery:function(a){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1);this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone();this._referencePosMapCoordsRequested=this._referencePosResetPreserveAbsoluteTime=
null;return this.view.mapCoordsHelper.toGeographic(this._referencePosMapCoords).then(function(c){if(!a()&&!isNaN(c[0])&&!isNaN(c[1])){var b=this._referencePosMapCoords.z*this.view.mapCoordsHelper.unitInMeters;this._referencePosWGS84?(this._referencePosWGS84.x=c[0],this._referencePosWGS84.y=c[1],this._referencePosWGS84.z=b):this._referencePosWGS84=new l({x:c[0],y:c[1],z:b,spatialReference:m.WGS84});this._referencePosChanged()}}.bind(this))},_executePendingReferencePositionUpdate:function(){var a=this._referencePosMapCoordsRequested;
a&&this._requestReferencePositionUpdate(a,this._referencePosResetPreserveAbsoluteTime)},_referencePosChanged:function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84)||this._updateLightParams()},_exceedsReferencePosDistThreshold:function(a){return this._referencePosMapCoords?(a=this._referencePosMapCoords.distance(a),this.view.mapCoordsHelper&&(a*=this.view.mapCoordsHelper.unitInMeters),a>this.referencePointUpdateDistThreshold):!0},_cancelReferencePosUpdates:function(){this._referencePosUpdateTimer=
this._referencePosUpdateQuery=null}});f.FIXED_LIGHT_DIRECTION=q;return f});