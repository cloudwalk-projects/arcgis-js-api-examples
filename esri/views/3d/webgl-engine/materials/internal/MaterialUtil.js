// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["../../lib/IdGen","../../lib/gl-matrix","../../parts/Model","../../lib/Util","../../../../webgl/Util"],function(V,E,W,F,X){var x=E.vec3d,Y=E.mat4d,L=E.mat4,Q=F.VertexAttrConstants,g={};g.__Material_idGen=new V;g.__GLMaterial_id=0;g.IDENTITY=Y.identity();g.fill=function(a,c,b,e,f,d){if(void 0===f||3!==d)for(f=0;f<d;++f)b[e+f]=a[c+f];else{var t=a[c],n=a[c+1];a=a[c+2];b[e]=f[0]*t+f[4]*n+f[8]*a+f[12];b[e+1]=f[1]*t+f[5]*n+f[9]*a+f[13];b[e+2]=f[2]*t+f[6]*n+f[10]*a+f[14]}return d};var R=function(a,
c,b,e,f,d){for(var t=a.length,n=0;n<t;++n){for(var B=b*a[n],w=0;w<b;++w)e[f+w]=c[B+w];f+=d}};g.fillInterleaved=function(a,c,b,e,f,d,t,n){for(var B=X.getStride(f)/4,w=0;w<f.length;w++){var k=f[w],l=t+k.offset/4,k=k.name;if(!(null!=n&&null==n[k])){var h;switch(k){case "uv0":h=a.vertexAttr[k];null!=h&&R(a.faces.indices[k],h.data,h.size,d,l,B);break;case "region":h=a.vertexAttr[k];var k=a.faces.indices[k],g=h.data,m=h.size;h=d;var p=B;h=new Uint16Array(h.buffer);for(var l=2*l,p=2*p,u=k.length,r=0;r<u;++r){var v=
m*k[r],q;for(q=0;q<m;++q)h[l+q]=g[v+q];l+=p}break;case "color":h=a.vertexAttr[k];if(e&&e.color){k=a.faces.indices[k];g=h.data;m=e.color;h=h.size;p=d;u=B;p=new Uint8Array(p.buffer);l*=4;u*=4;r=k.length;for(v=0;v<r;++v){q=h*k[v];var s;for(s=0;s<h;++s)p[l+s]=g[q+s]*m[s];4>s&&(p[l+3]=255*m[3]);l+=u}}else{k=a.faces.indices[k];g=h.data;m=h.size;h=d;p=B;h=new Uint8Array(h.buffer);l*=4;p*=4;u=k.length;for(r=0;r<u;++r){v=m*k[r];for(q=0;q<m;++q)h[l+q]=g[v+q];4>q&&(h[l+3]=255);l+=p}}break;default:if(h=a.vertexAttr[k],
m=k===Q.POSITION?c:k===Q.NORMAL?b:void 0,void 0!==m&&3===h.size){k=a.faces.indices[k];g=h.data;h=d;p=B;u=k.length;for(r=0;r<u;++r)s=3*k[r],v=g[s],q=g[s+1],s=g[s+2],h[l]=m[0]*v+m[4]*q+m[8]*s+m[12],h[l+1]=m[1]*v+m[5]*q+m[9]*s+m[13],h[l+2]=m[2]*v+m[6]*q+m[10]*s+m[14],l+=p}else R(a.faces.indices[k],h.data,h.size,d,l,B)}}}};g.triangleVertexArrayToWireframeLines=function(a,c,b,e){for(b=Math.floor(b/3)-1;0<=b;b--){var f=c+3*b*e,d=c+6*b*e+5*e;this.fill(a,f,a,d,null,e);d-=e;this.fill(a,f+e,a,d,null,e);d-=
e;this.fill(a,f+e,a,d,null,e);d-=e;this.fill(a,f+2*e,a,d,null,e);d-=e;this.fill(a,f+2*e,a,d,null,e);d-=e;this.fill(a,f,a,d,null,e)}};var S=x.create(),Z=x.create(),$=x.create(),aa=x.create(),T=function(a,c,b,e,f){var d=a.getCenter();x.project(d,c,b,S);var d=x.dist2(S,d),t=a.getBSRadius();if(d<t*t){var d=a.getPrimitiveIndices(),t=a.getIndices(),n=a.getPosition(),g=d?d.length:t.length/3;if(1E4<g&&(a=a.getChildren(),void 0!==a)){for(d=0;8>d;++d)void 0!==a[d]&&T(a[d],c,b,e,f);return}a=n.size;var n=n.data,
w=c[0],k=c[1];c=c[2];var l=b[0]-w,h=b[1]-k;b=b[2]-c;for(var A=0;A<g;++A){var m=d?d[A]:A,p=a*t[3*m],u=a*t[3*m+1],r=a*t[3*m+2],v=n[p],q=n[p+1],p=n[p+2],s=n[u],D=n[u+1],u=n[u+2],E=n[r],F=n[r+1],r=n[r+2],G=s-v,H=D-q,I=u-p,J=E-v,z=F-q,C=r-p,K=h*C-z*b,M=b*J-C*l,L=l*z-J*h,y=G*K+H*M+I*L;if(!(y>-e&&y<e)){var y=1/y,N=w-v,O=k-q,P=c-p,K=y*(N*K+O*M+P*L);0>K||1<K||(M=O*I-H*P,I=P*G-I*N,G=N*H-G*O,H=y*(l*M+h*I+b*G),0>H||1<K+H||(J=y*(J*M+z*I+C*G),0<=J&&(z=Z,C=$,y=aa,x.set3(v,q,p,z),x.set3(s,D,u,C),x.set3(E,F,r,y),
x.subtract(C,z,C),x.subtract(y,z,y),x.normalize(x.cross(C,y,z)),f(J,z,m))))}}}};g.intersectTriangleGeometry=function(a,c,b,e,f,d,t){F.assert("triangle"===a.getData().getFaces()[c].type);T(a.getBoundingInfo(c),f,d,e.tolerance,t)};g.basicMaterialConstructor=function(a,c){var b=!0,e=0,f=g.__Material_idGen.gen(c);a.getId=function(){return f};var d;a.getParentStage=function(){return d};a.addParentStage=function(a){F.assert(void 0===d,"Material can only be added to a single Stage");d=a};a.removeParentStage=
function(a){d=void 0};a.setVisible=function(d){b!==d&&(b=d,a.notifyDirty("matChanged"))};a.isVisible=function(){return b};a.notifyDirty=function(b){d&&d.notifyDirty(W.ContentType.MATERIAL,a,b)};a.setRenderPriority=function(a){e=a;this.notifyDirty("matChanged")};a.getRenderPriority=function(){return e}};var A=g.aquireIfNotUndefined=function(a,c,b,e){return void 0===a?void 0:b.aquire(a,c,e)},D=g.releaseIfNotUndefined=function(a,c){void 0!==a&&c.release(a)},U=L.create();g.bindView=function(a,c,b){L.translate(c,
a,U);b.setUniformMatrix4fv("view",U)};g.bindCamPos=function(a,c,b){b.setUniform3f("camPos",c[3]-a[0],c[7]-a[1],c[11]-a[2])};g.basicGLMaterialConstructor=function(a,c){var b=g.__GLMaterial_id++;a.getId=function(){return b};a.getMaterialId=function(){return c.getId()};a.isVisible=function(){return c.isVisible()};a.getRenderPriority=function(){return c.getRenderPriority()}};g.singleTextureGLMaterialConstructor=function(a,c,b,e){var f=A(b.textureId,b.initTexture,c,e);a.updateTexture=function(a){b.textureId!==
a&&(D(b.textureId,c),b.textureId=a,f=A(b.textureId,b.initTexture,c,e))};a.renderTexture=function(a){(a=c.getTexture(b.textureId))&&(a.dirty&&a.redraw)&&a.redraw()};a.bindTexture=function(a,b){void 0!==f&&(b.setUniform1i("tex",0),a.bindTexture(f.getGLTexture()))};a.bindTextureSize=function(a,b){if(void 0!==f){var e=f.getGLTexture();b.setUniform2f("texSize",e.descriptor.width,e.descriptor.height)}};a.dispose=function(){D(b.textureId,c)}};g.multiTextureGLMaterialConstructor=function(a,c,b,e){for(var f=
e.length,d=Array(f),g=0;g<f;g++)d[g]=A(b[e[g][0]],b[e[g][1]],c);a.updateTextures=function(a){for(var g=0;g<f;g++){var w=b[e[g][0]],k=a[e[g][0]];w!==k&&(D(w,c),b[e[g][0]]=k,d[g]=A(k,b[e[g][1]],c))}};a.bindTextures=function(a,b){for(var c=0;c<f;c++)void 0!==d[c]&&(b.setUniform1i(e[c][2],c),a.bindTexture(d[c].getGLTexture(),c));a.setActiveTexture(0)};a.bindOneTexture=function(a,b,c){b.setUniform1i(e[c][2],c);a.bindTexture(d[c].getGLTexture(),c);a.setActiveTexture(0)};a.disposeTextures=function(){for(var a=
0;a<f;a++)D(b[e[a][0]],c)}};return g});