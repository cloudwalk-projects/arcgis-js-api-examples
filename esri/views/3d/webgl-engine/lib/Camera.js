// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["require","exports","./Util","./gl-matrix"],function(q,s,h,m){function l(b,a){return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]}function r(b,a){return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]}var d=m.vec3d,f=m.vec4d,g=m.mat4d;q=function(){function b(a,b,c){this._viewUp=d.create();this._viewForward=d.create();this._viewRight=d.create();this._viewport=f.create();this._padding=f.create();this._fov=55/180*Math.PI;this._near=0;this._far=1E3;this._viewDirty=!0;this._viewMatrix=g.create();this._projectionDirty=
!0;this._projectionMatrix=g.create();this._viewInverseTransposeMatrixDirty=!0;this._viewInverseTransposeMatrix=null;this._frustumPlanesDirty=!0;this._frustumPlanes=[f.create(),f.create(),f.create(),f.create(),f.create(),f.create()];this._fullViewport=null;this.aboveGround=!0;this._eye=d.create(a);this._center=d.create(b);this._up=void 0!==c?d.create(c):d.create([0,0,1]);this._padding=f.create()}Object.defineProperty(b.prototype,"eye",{get:function(){return this._eye},set:function(a){this._compareAndSetView(a,
this._eye)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"center",{get:function(){return this._center},set:function(a){this._compareAndSetView(a,this._center)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"up",{get:function(){return this._up},set:function(a){this._compareAndSetView(a,this._up)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"viewMatrix",{get:function(){this._ensureViewClean();return this._viewMatrix},set:function(a){g.set(a,
this._viewMatrix);this._viewDirty=!1;this._frustumPlanesDirty=this._viewInverseTransposeMatrixDirty=!0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"viewForward",{get:function(){this._ensureViewClean();return this._viewForward},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"viewUp",{get:function(){this._ensureViewClean();return this._viewUp},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"viewRight",{get:function(){this._ensureViewClean();
return this._viewRight},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"near",{get:function(){return this._near},set:function(a){this._near!==a&&(this._near=a,this._frustumPlanesDirty=this._projectionDirty=!0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"far",{get:function(){return this._far},set:function(a){this._far!==a&&(this._far=a,this._frustumPlanesDirty=this._projectionDirty=!0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"viewport",
{get:function(){return this._viewport},set:function(a){this.x=a[0];this.y=a[1];this.width=a[2];this.height=a[3]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"x",{get:function(){return this._viewport[0]},set:function(a){a+=this._padding[3];this._viewport[0]!==a&&(this._viewport[0]=a,this._frustumPlanesDirty=this._projectionDirty=!0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"y",{get:function(){return this._viewport[1]},set:function(a){a+=this._padding[2];
this._viewport[1]!==a&&(this._viewport[1]=a,this._frustumPlanesDirty=this._projectionDirty=!0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"width",{get:function(){return this._viewport[2]},set:function(a){a-=this._padding[1]+this._padding[3];this._viewport[2]!==a&&(this._viewport[2]=a,this._frustumPlanesDirty=this._projectionDirty=!0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"height",{get:function(){return this._viewport[3]},set:function(a){a-=this._padding[0]+
this._padding[2];this._viewport[3]!==a&&(this._viewport[3]=a,this._frustumPlanesDirty=this._projectionDirty=!0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"fullWidth",{get:function(){return this._viewport[2]+this._padding[1]+this._padding[3]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"fullHeight",{get:function(){return this._viewport[3]+this._padding[0]+this._padding[2]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"fullViewport",
{get:function(){this._fullViewport||(this._fullViewport=f.create());this._fullViewport[0]=this._viewport[0]-this._padding[3];this._fullViewport[1]=this._viewport[1]-this._padding[2];this._fullViewport[2]=this.fullWidth;this._fullViewport[3]=this.fullHeight;return this._fullViewport},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"aspect",{get:function(){return this.width/this.height},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"padding",{get:function(){return this._padding},
set:function(a){this._padding[0]===a[0]&&this._padding[1]===a[1]&&this._padding[2]===a[2]&&this._padding[3]===a[3]||(this._viewport[0]+=a[3]-this._padding[3],this._viewport[1]+=a[2]-this._padding[2],this._viewport[2]-=a[1]+a[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=a[0]+a[2]-(this._padding[0]+this._padding[2]),f.set(a,this._padding),this._frustumPlanesDirty=this._projectionDirty=!0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"projectionMatrix",{get:function(){if(this._projectionDirty){var a=
this.width,b=this.height,c=this.near*Math.tan(this.fovY/2),d=c*this.aspect;g.frustum(-d*(1+2*this._padding[3]/a),d*(1+2*this._padding[1]/a),-c*(1+2*this._padding[2]/b),c*(1+2*this._padding[0]/b),this.near,this.far,this._projectionMatrix);this._projectionDirty=!1}return this._projectionMatrix},set:function(a){g.set(a,this._projectionMatrix);this._projectionDirty=!1;this._frustumPlanesDirty=!0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"fov",{get:function(){return this._fov},
set:function(a){this._fov=a;this._frustumPlanesDirty=this._projectionDirty=!0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"fovX",{get:function(){return h.fovd2fovx(this._fov,this.width,this.height)},set:function(a){this._fov=h.fovx2fovd(a,this.width,this.height);this._frustumPlanesDirty=this._projectionDirty=!0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"fovY",{get:function(){return h.fovd2fovy(this._fov,this.width,this.height)},set:function(a){this._fov=
h.fovy2fovd(a,this.width,this.height);this._frustumPlanesDirty=this._projectionDirty=!0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"distance",{get:function(){return d.dist(this._center,this._eye)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"angleOfElevation",{get:function(){d.subtract(this._center,this._eye,n);d.normalize(n);var a=d.dot(this._center,n)/d.length(this._center);return Math.acos(h.clamp(a,-1,1))-0.5*Math.PI},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"frustumPoints",{get:function(){return this.computeFrustumPoints()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"frustumPlanes",{get:function(){this._frustumPlanesDirty&&(this._frustumPlanes=this._computeFrustumPlanes(this._frustumPlanes),this._frustumPlanesDirty=!1);return this._frustumPlanes},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"viewInverseTransposeMatrix",{get:function(){if(this._viewInverseTransposeMatrixDirty||
this._viewDirty)this._viewInverseTransposeMatrix||(this._viewInverseTransposeMatrix=g.create()),g.inverse(this.viewMatrix,this._viewInverseTransposeMatrix),g.transpose(this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1;return this._viewInverseTransposeMatrix},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"perPixelRatio",{get:function(){return Math.tan(this.fovX/2)/this.width},enumerable:!0,configurable:!0});b.prototype.copyFrom=function(a){d.set(a._eye,
this._eye);d.set(a._center,this._center);d.set(a._up,this._up);f.set(a._viewport,this._viewport);f.set(a._padding,this._padding);this._near=a._near;this._far=a._far;this._fov=a._fov;this.aboveGround=a.aboveGround;a._viewDirty?this._frustumPlanesDirty=this._viewDirty=!0:(g.set(a._viewMatrix,this._viewMatrix),d.set(a._viewRight,this._viewRight),d.set(a._viewUp,this._viewUp),d.set(a._viewForward,this._viewForward),this._viewDirty=!1);a._projectionDirty?this._frustumPlanesDirty=this._projectionDirty=
!0:(g.set(a._projectionMatrix,this._projectionMatrix),this._projectionDirty=!1);return this};b.prototype.copy=function(){var a=new b;a.copyFrom(this);return a};b.prototype.equals=function(a){return l(this._eye,a._eye)&&l(this._center,a._center)&&l(this._up,a._up)&&r(this._viewport,a._viewport)&&r(this._padding,a._padding)&&this._near===a._near&&this._far===a._far&&this._fov===a._fov};b.prototype.almostEquals=function(a,b){var c=d.dist(this.eye,this.center)*(b||5E-4),c=c*c,e;if(e=d.dist2(a.eye,this.eye)<
c){if(c=d.dist2(a.center,this.center)<c)if(c=0.001>Math.abs(a.fov-this.fov)){var f=a.padding,g=this.padding,c=g[0]-f[0];e=g[1]-f[1];var h=g[2]-f[2],f=g[3]-f[3],c=0.5>c*c+e*e+h*h+f*f}e=c}return e};b.prototype.markViewDirty=function(){this._frustumPlanesDirty=this._viewDirty=!0};b.prototype.computePixelSizeAt=function(a){return 2*d.dist(a,this._eye)*Math.tan(this.fovX/2)/this.width};b.prototype.computePixelSizeAtDist=function(a){return 2*a*Math.tan(this.fovX/2)/this.width};b.prototype.computeDistanceFromRadius=
function(a,b){return a/Math.tan(Math.min(this.fovX,this.fovY)/(2*(b||1)))};b.prototype.copyFrustumPlanes=function(a){if(!a){a=Array(6);for(var b=0;6>b;++b)a[b]=f.create()}for(var c=this.frustumPlanes,b=0;6>b;b++)f.set(c[b],a[b]);return a};b.prototype.computeFrustumPoints=function(a){if(!a){a=Array(8);for(var b=0;8>b;++b)a[b]=d.create()}h.matrix2frustum(this.viewMatrix,this.projectionMatrix,a);return a};b.prototype.setGLViewport=function(a){var b=this.viewport,c=this.padding;a.setViewport(b[0]-c[3],
b[1]-c[2],b[2]+c[1]+c[3],b[3]+c[0]+c[2])};b.prototype.projectPoint=function(a,b,c){void 0===c&&(c=!1);f.set4(a[0],a[1],a[2],1,e);g.multiplyVec4(this.viewMatrix,e);c&&(b[2]=-e[2]);g.multiplyVec4(this.projectionMatrix,e);d.scale(e,1/Math.abs(e[3]));a=this.fullViewport;b[0]=h.lerp(0,a[0]+a[2],0.5+0.5*e[0]);b[1]=h.lerp(0,a[1]+a[3],0.5+0.5*e[1]);c||(b[2]=0.5*(e[2]+1));return b};b.prototype.unprojectPoint=function(a,b,c){void 0===c&&(c=!1);if(c)return console.error("Camera.unprojectPoint() not yet implemented for linear Z"),
null;g.multiply(this.projectionMatrix,this.viewMatrix,p);if(!g.inverse(p))return null;c=this.fullViewport;e[0]=2*(a[0]-c[0])/c[2]-1;e[1]=2*(a[1]-c[1])/c[3]-1;e[2]=2*a[2]-1;e[3]=1;g.multiplyVec4(p,e);if(0===e[3])return null;b[0]=e[0]/e[3];b[1]=e[1]/e[3];b[2]=e[2]/e[3];return b};b.prototype.computeUpOnSphere=function(){d.subtract(this.center,this.eye,k);var a=d.length(this.center);1>a?d.set3(0,0,1,this.up):Math.abs(d.dot(k,this.center))>0.9999*d.length(k)*a||(d.cross(k,this.center,this.up),d.cross(this.up,
k,this.up),d.normalize(this.up))};b.prototype._compareAndSetView=function(a,b){l(a,b)||(d.set(a,b),this._frustumPlanesDirty=this._viewDirty=!0)};b.prototype._computeFrustumPlanes=function(a){if(!a){a=Array(6);for(var b=0;6>b;++b)a[b]=f.create()}h.matrix2frustumPlanes(this.viewMatrix,this.projectionMatrix,a);return a};b.prototype._ensureViewClean=function(){this._viewDirty&&(g.lookAt(this._eye,this._center,this._up,this._viewMatrix),d.set3(-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10],
this._viewForward),d.set3(this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9],this._viewUp),d.set3(this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8],this._viewRight),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)};return b}();var n=d.create(),e=f.create(),p=g.create(),k=d.create();return q});