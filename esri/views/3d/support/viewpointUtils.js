// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("../../../geometry/SpatialReference ../../../geometry/Geometry ../../../geometry/Point ../../../geometry/Extent ../../../geometry/support/webMercatorUtils ../../../core/Error ../../../core/promiseUtils ../../../Camera ../../../Viewpoint ../../../Graphic ../lib/glMatrix ./mathUtils ./projectionUtils ./cameraUtils ./aaBoundingBox ./aaBoundingRect ./intersectionUtils".split(" "),function(C,Y,w,Z,x,$,D,E,F,aa,s,P,t,k,p,Q,ba){function G(a){return 360-P.cyclicalDeg.normalize(a)}function z(a){return P.cyclicalDeg.normalize(360-
a)}function R(a,b,c){if(!b)return null;var d=a.spatialReference||C.WGS84,e;if(b.camera){e=b.get("camera.position.spatialReference");if(!x.canProject(e,d))return null;b=b.camera.clone();e.equals(d)||(a=x.project(b.position,d),b.position=a);return b}if((e=b.get("targetGeometry.spatialReference"))&&!x.canProject(e,d))return null;var f=a.navigation.currentCamera;e=k.internalToExternal(a,f);var h={noReset:!1};null!=b.rotation&&(e.heading=G(b.rotation),h.noReset=!0);null!=c&&(e.tilt=c);if(b.targetGeometry instanceof
w){var v=b.targetGeometry;c=b.targetGeometry.clone();b=null!=b.scale?k.scaleToDistance(a,b.scale,v.latitude):f.distance;b=k.eyeHeadingTiltForCenterPointAtDistance(a,e.heading,e.tilt,c,b,h);a=t.vectorToPoint(b.eye,a.renderSpatialReference,d);return new E(a,b.heading,b.tilt,e.fov)}return k.fromExtent(a,b.targetGeometry.extent,e,h)}function I(a,b,c,d){var e=c.scale;null==e&&null!=c.zoom&&(e=k.zoomToScale(a,c.zoom));null==e&&null!=c.distance&&(b=b.center||b,e=k.distanceToScale(a,c.distance,b.latitude));
null==e&&d&&(e="function"===typeof d?d():d);return e}function S(a,b,c,d,e){if(!(b&&c.position||b&&c.direction||c.position&&c.direction))return!1;var l=a.spatialReference||C.WGS84,h=a.renderSpatialReference,v=c.direction;b&&c.position&&(v=null);c.position&&t.pointToVector(c.position,g,h);b&&t.pointToVector(b,n,h);if(v){var m=new w(c.position||b);m.x+=v[0];m.y+=v[1];2<v.length&&(m.z+=v[2]);t.pointToVector(m,u,h);f.subtract(u,c.position?g:n)}c.position&&v?(e.camera.position=new w(c.position),k.directionToHeadingTilt(a,
g,u,d.up,e.camera),f.add(g,u,n),a.navigation.getCenterIntersectTerrain(g,n,n),e.targetGeometry=t.vectorToPoint(n,h,l),e.scale=k.distanceToScale(a,f.dist(g,n),e.targetGeometry.latitude)):b&&v?(e.targetGeometry=new w(b),e.scale=I(a,e.targetGeometry,c,function(){return k.computeScale(a,d)}),b=k.scaleToDistance(a,e.scale,b.latitude),f.scale(u,b/f.length(u),g),f.add(g,n),e.camera.position=t.vectorToPoint(g,h,l),k.directionToHeadingTilt(a,g,u,d.up,e.camera)):(e.targetGeometry=new w(b),e.camera.position=
new w(c.position),f.subtract(n,g,u),k.directionToHeadingTilt(a,g,u,d.up,e.camera),e.scale=k.distanceToScale(a,f.dist(g,n),e.targetGeometry.latitude));e.rotation=z(e.camera.heading);return!0}function J(a,b){var c=!1;null!=b.heading?(a.heading=b.heading,c=!0):null!=b.rotation&&(a.heading=G(b.rotation),c=!0);null!=b.tilt&&(a.tilt=b.tilt,c=!0);null!=b.fov&&(a.fov=b.fov);return c}function H(a,b,c){var d=a.spatialReference||C.WGS84;b=b||k.externalToInternal(a,c.camera);c.targetGeometry=t.vectorToPoint(b.center,
a.renderSpatialReference,d);c.scale=k.computeScale(a,b);c.rotation=z(c.camera.heading);return c}function K(a,b,c){if(b){var d=[];if(!b.hasZ&&a.basemapTerrain){var e;e=b.isInstanceOf(w)?b:b.centroid||b.center;l[2]=e?a.basemapTerrain.getElevation(e)||0:0}ca[b.declaredClass](b,function(a){d.push(a[0],a[1],a[2])},l);var f=d.length/3;if(0!==f&&(e=Array(d.length),t.bufferToBuffer(d,b.spatialReference,0,e,a.spatialReference,0,f))){b.hasZ&&(c.hasZ=!0);for(a=0;a<e.length;a+=3)b.hasZ?(l[0]=e[a+0],l[1]=e[a+
1],l[2]=e[a+2]):(l[0]=e[a+0],l[1]=e[a+1]),p.expand(c.boundingBox,l)}}}function da(a,b,c){return a.whenViewForGraphic(b).then(function(a){if(a&&a.whenGraphicBounds)return a.whenGraphicBounds(b)}).then(function(a){p.expand(c.boundingBox,a);isFinite(a[2])&&(c.hasZ=!0)}).otherwise(function(){K(a,b.geometry,c)})}function T(a,b,c){if(Array.isArray(b)&&2===b.length&&"number"===typeof b[0]&&"number"===typeof b[1])r.x=b[0],r.y=b[1],r.z=void 0,r.spatialReference=C.WGS84,K(a,r,c);else{if(b&&b.forEach){var d=
D.resolve();b.forEach(function(b){d=d.then(function(){return T(a,b,c)})});return d}if(b instanceof Y)K(a,b,c);else if(b instanceof aa)return da(a,b,c)}return D.resolve()}function ea(a,b,c,d){if(b.camera)return U(a,c,b.camera,d);d.scale=b.scale;d.rotation=b.rotation;d.targetGeometry=b.targetGeometry?b.targetGeometry.clone():null;d.camera=null;null!=c.heading?d.rotation=z(c.heading):null!=c.rotation&&(d.rotation=c.rotation);b=I(a,d.targetGeometry,c);null!=b&&(d.scale=b);d.camera=R(a,d,c.tilt);return d}
function U(a,b,c,d){d.camera=c.clone();d.camera.fov=a.camera.fov;b=a.spatialReference;c=d.camera.position.spatialReference;if(!x.canProject(c,b))return null;c.equals(b)||(b=x.project(d.camera.position,b),d.camera.position=b);return H(a,null,d)}function L(a,b,c,d){if(!c)return null;d.targetGeometry=c.clone();var e=a.navigation.getCameraIntersectTerrain();if(S(a,d.targetGeometry,b,e,d))return d;k.internalToExternal(a,e,d.camera);var p={noReset:!1};J(d.camera,b)&&(p.noReset=!0);d.scale=I(a,d.targetGeometry,
b);null==d.scale&&(t.pointToVector(c,l,a.renderSpatialReference),ba.frustumPoint(e.frustumPlanes,l)?d.scale=k.distanceToScale(a,f.dist(e.eye,l),c.latitude):d.scale=k.computeScale(a,e));return!k.fromCenterScale(a,d.targetGeometry,d.scale,d.camera,p,d.camera)?null:d}function fa(a,b,c,d){d.targetGeometry=c.clone();var e=a.navigation.getCameraIntersectTerrain();k.internalToExternal(a,e,d.camera);e={noReset:!1};J(d.camera,b)&&(e.noReset=!0);return!k.fromExtent(a,c,d.camera,e,d.camera)?null:d}function ga(a,
b){if(!b||!a.spatialReference)return null;var c={};if(null==b.declaredClass&&!Array.isArray(b)){for(var d in b)c[d]=b[d];b.center&&!c.target&&(c.target=b.center)}else c.target=b;return c}function A(a){a&&(a.rotation=z(a.camera.heading));return D.resolve(a)}var f=s.vec3d,M=s.mat3d,V=s.mat4d,g=f.create(),n=f.create(),u=f.create(),N={heading:0,tilt:0},l=f.create(),W=V.create(),O=M.create(),B=p.create(),ha=Q.create(),r=new w;s=function(a,b,c){for(var d=a.hasZ,e=0;e<a.rings.length;e++)for(var f=a.rings[e],
h=0;h<f.length;h++)c[0]=f[h][0],c[1]=f[h][1],d&&(c[2]=f[h][2]),b(c)};var ca={"esri.geometry.Point":function(a,b,c){c[0]=a.x;c[1]=a.y;a.hasZ&&(c[2]=a.z);b(c)},"esri.geometry.Polygon":s,"esri.geometry.Circle":s,"esri.geometry.Polyline":function(a,b,c){for(var d=a.hasZ,e=0;e<a.paths.length;e++)for(var f=a.paths[e],h=0;h<f.length;h++)c[0]=f[h][0],c[1]=f[h][1],d&&(c[2]=f[h][2]),b(c)},"esri.geometry.Multipoint":function(a,b,c){var d=a.points;a=a.hasZ;for(var e=0;e<d.length;e++)c[0]=d[e][0],c[1]=d[e][1],
a&&(c[2]=d[e][2]),b(c)},"esri.geometry.Extent":function(a,b,c){a.hasZ?(b(f.set3(a.xmin,a.ymin,a.zmin,c)),b(f.set3(a.xmax,a.ymin,a.zmin,c)),b(f.set3(a.xmin,a.ymax,a.zmin,c)),b(f.set3(a.xmax,a.ymax,a.zmin,c)),b(f.set3(a.xmin,a.ymin,a.zmax,c)),b(f.set3(a.xmax,a.ymin,a.zmax,c)),b(f.set3(a.xmin,a.ymax,a.zmax,c)),b(f.set3(a.xmax,a.ymax,a.zmax,c))):(b(f.set3(a.xmin,a.ymin,c[2],c)),b(f.set3(a.xmax,a.ymin,c[2],c)),b(f.set3(a.xmin,a.ymax,c[2],c)),b(f.set3(a.xmax,a.ymax,c[2],c)))}},X={create:function(a,b){var c=
ga(a,b);if(!c)return D.reject(new $("viewpointutils-create:no-target","Missing target for creating viewpoint"));var d=new F({camera:new E({fov:a.camera.fov})}),e=null!=c.scale||null!=c.zoom||null!=c.distance;if(c.target instanceof F)return A(ea(a,c.target,c,d));if(c.target instanceof E)return A(U(a,c,c.target,d));if(c.target instanceof Z){var g=c.target.xmin===c.target.xmax||c.target.ymin===c.target.ymax;return e||g?A(L(a,c,c.target.center,d)):A(fa(a,c,c.target,d))}var h={boundingBox:p.create(p.NEGATIVE_INFINITY),
spatialReference:a.spatialReference,hasZ:!1};return T(a,c.target,h).then(function(){if(isFinite(h.boundingBox[0])){p.center(h.boundingBox,l);r.x=l[0];r.y=l[1];r.z=l[2];r.spatialReference=a.spatialReference;var b;!isFinite(r.z)||!h.hasZ?(r.z=void 0,b=Q.isPoint(p.toRect(h.boundingBox,ha))):b=p.isPoint(h.boundingBox);if(e||b)return L(a,c,r,d);var m=r,g=h.boundingBox,q=X.DEFAULT_FRAME_COVERAGE;d.targetGeometry=m.clone();b=a.navigation.getCameraIntersectTerrain();var n=0;m.hasZ?n=m.z:a.basemapTerrain&&
(n=a.basemapTerrain.getElevation(m));f.set3(m.x,m.y,n,l);t.computeLinearTransformation(a.spatialReference,l,W,a.renderSpatialReference);V.toMat3(W,O);M.transpose(O);p.set(B,p.NEGATIVE_INFINITY);for(var m=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],s=0;s<m.length;s++){var y=m[s],x=g[y[2]];isFinite(x)||(x=n);f.set3(g[y[0]],g[y[1]],x,l);t.vectorToVector(l,a.spatialReference,l,a.renderSpatialReference);p.expand(B,M.multiplyVec3(O,l))}g=p.width(B);n=p.height(B);m=p.depth(B);y=1/Math.tan(b.fovX/
2);s=1/Math.tan(b.fovY/2);y=0.5*Math.sqrt(g*g+m*m)*Math.max(s,y)+0.5*n;g=0.5*n*s+0.5*Math.max(g,m);q=Math.max(y,g)/q;k.internalToExternal(a,b,d.camera);b={noReset:!1};J(d.camera,c)&&(b.noReset=!0);d.scale=k.distanceToScale(a,q,d.targetGeometry.latitude);b=k.fromCenterScale(a,d.targetGeometry,d.scale,d.camera,b,d.camera)?d:null;return b}b=a.navigation.getCameraIntersectTerrain();S(a,null,c,b,d)?b=d:c.position?(f.set(b.viewForward,u),k.directionToHeadingTilt(a,b.eye,u,b.up,N),d.camera.position=new w(c.position),
b=d.camera,q=N.heading,g=c.heading,null==g&&null!=c.rotation&&(g=G(c.rotation)),null==g&&q&&(g="function"===typeof q?q():q),b.heading=g,b=d.camera,q=N.tilt,q=null!=c.tilt?c.tilt:null!=q?"function"===typeof q?q():q:void 0,b.tilt=q,b=H(a,null,d)):(b=t.vectorToPoint(b.center,a.renderSpatialReference,r,a.spatialReference),b=L(a,c,b,d));return b}).then(function(a){return A(a)})},rotationToHeading:G,headingToRotation:z,toCamera:R,fromCamera:function(a,b,c){c||(c=new F);c.camera=b.clone();return H(a,null,
c)},fromInternalCamera:function(a,b,c){c||(c=new F({camera:new E}));k.internalToExternal(a,b,c.camera);return H(a,b,c)},DEFAULT_FRAME_COVERAGE:0.66};return X});