// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["../../../core/arrayUtils","../webgl-engine/lib/Util"],function(x,s){return function(q,y,z,r,k){function l(){return"workers: "+e+", queues: "+f.map(function(a){return a.length})}var d=0,h={},f=[],e=[],m=[],c=[],n=0,g=0,p;for(p in r)f[d]=[],e[d]=0,c[d]={requests:0,size:0,duration:0,speed:0},m[d]=r[p],h[p]=d++,g+=r[p];var t=f.length,d=0;this.setWorkerQuota=function(a){s.assert(x.equals(Object.keys(this.typeWorkerAllication),Object.keys(a)));this.typeWorkerAllication=a;g=0;for(var b in a)m[h[b]]=
a[b],g+=a[b]};this.setWorkerFunc=function(a){q=a};this.push=function(a){var b=h[a.clientType];n<g?(e[b]++,n++,k&&console.log("queue start type "+b+", "+l()),q(a,u)):(f[b].push(a),k&&console.log("queue push type "+b+", "+l()))};this._getStatsForType=function(a){a=h[a];return{quota:m[a],workers:e[a],queueSize:f[a].length,requestStats:c[a]}};this.removeTasks=function(a,b){for(var c=[],d=f[h[b]],e=0;e<d.length;e++){var g=d[e];-1<a.indexOf(g)||c.push(g)}f[h[b]]=c};this.workerCancelled=function(a){v(a);
a._cancelledInQueue=!0};this.clear=function(){for(var a=0;a<f.length;a++)f[a]=[]};var v=function(a){var b=h[a.clientType];e[b]--;n--;c[b].requests++;c[b].size+=a.size||0;c[b].duration+=a.duration||0;c[b].speed=0<c[b].duration?c[b].size/c[b].duration:0;s.assert(0<=e[b]);a=d;b=!1;do e[a]<m[a]&&w(a)&&(b=!0),a=(a+1)%t;while(!b&&a!=d);if(!b){do w(a)&&(b=!0),a=(a+1)%t;while(!b&&a!=d)}!b&&k&&console.log("queue sink, "+l());d=a},w=function(a){for(;0<f[a].length;){if(q(f[a].shift(),u))return k&&console.log("queue startqueued clientType "+
a+", "+l()),e[a]++,n++,!0;k&&console.log("queue task cancelled, "+l())}return!1},u=function(a){a._cancelledInQueue||(y.apply(z,arguments),v(a))}}});