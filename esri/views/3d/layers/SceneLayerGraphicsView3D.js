// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ./graphics/Graphics3DLayerViewCore ./support/LayerViewUpdatingPercentage ../../layers/LayerView ../../../Graphic ../../../geometry/Point ../../../geometry/Polygon ../../../geometry/Polyline ../../../renderers/support/renderingInfoUtils ../../../core/Collection ../../../core/HandleRegistry ../../../core/promiseUtils ../lib/glMatrix ./i3s/I3SUtil ./i3s/I3SBinaryReader ../support/PreallocArray ../support/projectionUtils ../support/aaBoundingBox".split(" "),
function(x,$,M,g,n,N,O,P,H,Q,R,S,T,U,V,y,W,E,X,L,Y,t){x=function(x){function b(){x.call(this);this._nodesAddedToStage={};this.loadedGraphics=new U;this.supportsDraping=!0;this._overlayUpdating=null;this._handles=new V}M(b,x);b.prototype.initialize=function(){var a=this;E.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode);this._handles.add([this.layer.watch("renderer",function(d,e){return a._rendererChange(d,e)}),this.layer.watch("objectIdFilter",function(){return a._objectIdFilterChange()})]);
this._layerViewCore=new N({owner:this,layer:this.layer,spatialIndexRequired:!1,labelingEnabled:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,verticalScaleEnabled:!0,updateSuspendResumeExtent:function(){return a._updateSuspendResumeExtent()},updateClippingExtent:function(d){return a._updateClippingExtent(d)},elevationChanged:function(d,e,c){return a._elevationChanged(d,e,c)}});this.addResolvingPromise(this._layerViewCore.initialize());this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);
this._createController()};b.prototype.destroy=function(){this._layerViewCore&&(this._layerViewCore.destroy(),this._layerViewCore=null);this._controller&&(this._controller.destroy(),this._controller=null);this._nodesAddedToStage=this._intersectingGraphicIds=this._elevationUpdateNodes=null;this._nodeDebugVisualizer&&(this._nodeDebugVisualizer.dispose(),this._nodeDebugVisualizer=null);this._handles&&(this._handles.destroy(),this._handles=null)};Object.defineProperty(b.prototype,"hasDraped",{get:function(){return this._layerViewCore.graphicsCore.hasDraped},
enumerable:!0,configurable:!0});b.prototype.whenGraphicAttributes=function(a,d){var e=this,c=a.attributes[this._getObjectIdField()];return E.whenGraphicAttributes(this.layer,a,c,d,function(){return e._findGraphic(a.uid)})};b.prototype.getGraphicsFromStageObject=function(a,d){if(!this.loadedGraphics)return y.reject();var e=a.getMetadata().graphicId,c=this.loadedGraphics.find(function(a){return a.uid===e}),b=this._getObjectIdField();return!c||!c.attributes||!c.attributes[b]?y.reject():y.resolve(c)};
b.prototype.whenGraphicBounds=function(a){return this._layerViewCore.graphicsCore.whenGraphicBounds(a)};b.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};b.prototype.isUpdating=function(){return this._controller&&this._controller.updating};b.prototype.getRenderingInfo=function(a){if((a=T.getRenderingInfo(a,{renderer:this.layer.renderer}))&&a.color){var d=a.color;d[0]/=255;d[1]/=255;d[2]/=255}return a};b.prototype._findGraphic=
function(a){for(var d=0,e=Object.keys(this._nodesAddedToStage);d<e.length;d++)for(var c=e[d],b=this._nodesAddedToStage[c].bundles,f=0;f<b.length;f++)for(var h=b[f],r=0;r<h.length;r++)if(h[r].graphics.some(function(d){return d.uid===a}))return{node:this._controller.nodeIndex[c],nodeId:c,bundleNr:f,index:r};return null};b.prototype._elevationChanged=function(a,d,e){t[2]=-Infinity;t[3]=Infinity;var c=t.fromRect(Z,a);null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new L(10));a=this._elevationUpdateNodes;
a.clear();this._controller&&this._controller.updateElevationChanged(c,d,a);d=a.length;this._intersectingGraphicIds||(this._intersectingGraphicIds=new L(10));c=this._intersectingGraphicIds;c.clear();for(var b=0;b<d;b++){var f=this._nodesAddedToStage[a.data[b].id];if(null!=f)for(var f=f.bundles,h=0;h<f.length;h++)for(var r=f[h],m=0;m<r.length;m++)for(var n=r[m].graphics,g=0;g<n.length;g++)c.push(n[g].uid)}e(this._intersectingGraphicIds.data,this._intersectingGraphicIds.length)};b.prototype._evaluateUpdatingState=
function(){};b.prototype._notifySuspendedChange=function(){};b.prototype._notifyDrapedDataChange=function(){this.notifyChange("hasDraped");this.emit("draped-data-change")};b.prototype._createController=function(){var a=this,d={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:this._isBundleAlreadyAddedToStage.bind(this),isOverMemory:this._isOverMemory.bind(this),removeNodeData:this._removeNodeData.bind(this),removeFeatures:this._removeFeatures.bind(this),getAddedFeatures:this._getAddedFeatures.bind(this),
getAddedNodeIDs:this._getAddedNodeIDs.bind(this),areAllBundlesLoaded:this._areAllBundlesLoaded.bind(this),wholeNodeSwitchEnabled:!0},e={traversalOptions:{initDepthFirst:!1,neighborhood:!1,perLevelTraversal:!0,allowPartialOverlaps:!1,errorMetricPreference:["distanceRangeFromDefaultCamera","screenSpaceRelative"],elevationInfo:this.layer.elevationInfo},getAllAddedFeatures:this._getAllAddedFeatures.bind(this),_nodeDebugVisualizer:this._nodeDebugVisualizer,getLoadedAttributes:this._getLoadedAttributes.bind(this),
setAttributeData:this._setAttributeData.bind(this)};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:d,layerViewOptionalFunctions:e}).then(function(d){a._controller=d;d.watch("rootNodeVisible",function(){a.notifyChange("suspended")})})};b.prototype._getAllAddedFeatures=function(){var a={};this.loadedGraphics.forEach(function(d){a[d._nodeId]=d._features});return a};b.prototype._addBundle=function(a,d,e,b,k,f,h){f=this._controller.crsIndex;var r=[],m=this._getObjectIdField();
null==this._nodesAddedToStage[a.id]&&(this._nodesAddedToStage[a.id]={bundles:[],attributeData:e?e.attributeData:null,loadedAttributes:e?e.loadedAttributes:null});this._nodesAddedToStage[a.id].bundles[h]=r;if(null==d)null!=k&&k.done();else{var g;if(this.layer.objectIdFilter){var n=this.layer.objectIdFilter.ids,x="include"===this.layer.objectIdFilter.method;g=function(a){return 0<=n.indexOf(a)===x}}e=[];for(var t=0;t<d.length;t++)for(var C=d[t],y=C.featureDataPositions[0],F=0;F<C.geometries.length;F++){var z=
[],p=C.features[F<C.features.length?F:0],v=p?{}:null;if(p&&p.id){if(g&&!g(p.id))continue;v[m]=p.id}var s=C.geometries[F],u=s.params.type,q=p=void 0;if("ArrayBufferView"===s.type){q=s.params.vertexAttributes.position;if(null==q)continue;p=new X.valueType2TypedArrayClassMap[q.valueType](b[a.geometryData[h].hrefConcat],q.byteOffset,q.count*q.valuesPerElement);q=q.valuesPerElement}else"Embedded"===s.type&&(p=s.params.vertexAttributes.position,q=3);var A=void 0;if("lines"===u){for(var s=[],l=0;l<p.length;l+=
q)s.push([p[l]+a.mbs[0],p[l+1]+a.mbs[1]]);u=new S(f);u.addPath(s);A=u;z.push(new H(A,null,v))}else if("points"===u)for(l=0;l<p.length;l+=q)A=new Q({x:p[l]+y[0],y:p[l+1]+y[1],z:2<q?p[l+2]+y[2]:void 0,spatialReference:f}),z.push(new H(A,null,v));else if("polygon"===u){A=u=new R(f);u._outlineSegments=[];for(var I=0;I<s.params.rings.length;I++){for(var B=s.params.rings[I],D=B.start,E=[],J=[],w=[-1,-1],G=0;G<B.segments.length;G+=2){var l=B.segments[G+0],K=B.segments[G+1];0===l||1===l?(-1===w[0]&&(w[0]=
D-B.start),w[1]=D+K-B.start):-1!==w[0]&&(J.push(w),w=[-1,-1]);for(l=D*q;l<(D+K)*q;l+=q)E.push([p[l]+a.mbs[0],p[l+1]+a.mbs[1]]);D+=K}-1!==w[0]&&J.push(w);A._outlineSegments.push(J);u.addRing(E);null!=B.inner&&console.warn("inner rings not yet supported")}z.push(new H(A,null,v))}for(v=0;v<z.length;v++)z[v].layer=this.layer;e.push.apply(e,z);r.push({features:C.features,graphics:z})}this.loadedGraphics.addMany(e);a=this._nodesAddedToStage[a.id];this._setBundleAttributes(a.bundles[h],a.loadedAttributes,
a.attributeData);k.done()}};b.prototype._areAllBundlesLoaded=function(a,d){var b=this._nodesAddedToStage[a.id];if(null==b)return!1;for(var c=0;c<a.featureData.length;c++){var k=b.bundles[c];if(null==k)return!1;if(!(d||null==a.features))for(var f=a.featureData[c].featureRange,h=a.features.length,r=f?f[1]:h-1,f=f?f[0]:0;f<=r;f++){var m;if(m=f<h){a:{for(m=k.length;m--;)for(var g=k[m].features,n=g.length;n--;)if(g[n].id===a.features[f].id){m=!0;break a}m=!1}m=!m}if(m)return!1}}return!0};b.prototype._isBundleAlreadyAddedToStage=
function(a,d){return null==this._nodesAddedToStage[a.id]?{alreadyLoaded:!1,wasPartiallyHidden:!1}:{alreadyLoaded:!!this._nodesAddedToStage[a.id].bundles[d],wasPartiallyHidden:!1}};b.prototype._isOverMemory=function(){return!1};b.prototype._removeFeatures=function(a,d){var b=this._nodesAddedToStage[a.id];if(null!=b){var b=b.bundles,c=[],k;for(k in b)for(var f=0;f<b[k].length;f++){var h=b[k][f],g=!1;if(null!=h){for(var m in h.features)if(-1!==d.indexOf(h.features[m].id)){g=!0;break}g&&(c.push.apply(c,
h.graphics),delete b[k][f])}}this.loadedGraphics.removeMany(c);for(k=0;k<b.length;k++)for(f=0;f<b[k].length;f++)if(h=b[k][f],null!=h&&0<h.graphics.length)return;this._removeNodeData(a)}};b.prototype._removeNodeData=function(a){var b=this._nodesAddedToStage[a.id];if(null!=b){var b=b.bundles,e=[],c;for(c in b)for(var k in b[c])e.push.apply(e,b[c][k].graphics);this.loadedGraphics.removeMany(e);delete this._nodesAddedToStage[a.id]}};b.prototype._getAddedFeatures=function(a){a=this._nodesAddedToStage[a];
if(null==a)return null;a=a.bundles;var b=[],e;for(e in a)for(var c=0;c<a[e].length;c++)b=b.concat(a[e][c].features);return b};b.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)};b.prototype._getLoadedAttributes=function(a){if(a=this._nodesAddedToStage[a.id])return a.loadedAttributes};b.prototype._setAttributeData=function(a,b,e){if(a=this._nodesAddedToStage[a.id])a.loadedAttributes=b,a.attributeData=e,this._setNodeAttributes(a,b,e),this._layerViewCore.labeling.layerLabelsEnabled()&&
this._layerViewCore.labeling.labelVisibilityChanged()};b.prototype._setNodeAttributes=function(a,b,e){a=a.bundles;for(var c in a)this._setBundleAttributes(a[c],b,e)};b.prototype._setBundleAttributes=function(a,b,e){for(var c=0;c<a.length;c++)for(var k=a[c],f=0;f<k.graphics.length;++f){var h=k.graphics[f];h.attributes||(h.attributes={});if(b)for(var g=0;g<b.length;++g){var m=b[g].name;h.attributes[m]=e[m][c]}}};b.prototype._updateSuspendResumeExtent=function(){this.layer.fullExtent?(this._suspendResumeExtent||
(this._suspendResumeExtent=W.vec4d.create()),Y.extentToBoundingRect(this.layer.fullExtent,this._suspendResumeExtent,this.view.spatialReference)||(this._suspendResumeExtent=null)):this._suspendResumeExtent=null;return this._suspendResumeExtent};b.prototype._updateClippingExtent=function(a){this._controller&&this._controller.updateClippingArea(a);return!1};b.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};b.prototype._rendererChange=function(a,b){var e=this,c=a?a.requiredFields:
[],g=b?b.requiredFields:[];c.length===g.length&&c.every(function(a,b){return c[b]===g[b]})||Object.keys(this._nodesAddedToStage).forEach(function(a){e._removeNodeData({id:a})})};b.prototype._objectIdFilterChange=function(){var a=this;Object.keys(this._nodesAddedToStage).forEach(function(b){a._removeNodeData({id:b})});this._controller&&this._controller.restartNodeLoading()};b.prototype.getStats=function(){var a=this.inherited(arguments)||{};a.nodecount=Object.keys(this._nodesAddedToStage).length;a.featurecount=
this.loadedGraphics.length;return a};g([n.property()],b.prototype,"loadedGraphics",void 0);g([n.property()],b.prototype,"layer",void 0);g([n.property()],b.prototype,"view",void 0);g([n.property()],b.prototype,"hasDraped",null);g([n.property()],b.prototype,"_controller",void 0);g([n.property({dependsOn:["_controller.updating"]})],b.prototype,"updating",void 0);g([n.property({aliasOf:"_controller.updatingPercentage"})],b.prototype,"updatingPercentageValue",void 0);return b=g([n.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],
b)}(n.declared(P,O));var Z=t.create(t.POSITIVE_INFINITY);return x});