// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["require","exports","../../lib/glMatrix"],function(A,n,w){function f(a){return null!==a&&void 0!==a}function l(a){return"number"===typeof a}function e(a,b){a&&a.push(b);r(b)}function h(a){s&&console.warn("[FastSymbolUpdates] "+a)}function r(a){s&&console.info("[FastSymbolUpdates] "+a)}function g(a,b,c,d){var p=a.minSize,m=a.maxSize;if(a.expression)return e(d,"Could not convert size info: expression not supported"),!1;if(a.useSymbolValue)return e(d,"Could not convert size info: useSymbolValue not supported"),
!1;if(f(a.field)){if(f(a.stops)){if(2===a.stops.length&&l(a.stops[0].size)&&l(a.stops[1].size))return b.minSize[c]=a.stops[0].size,b.maxSize[c]=a.stops[1].size,b.minDataValue[c]=a.stops[0].value,b.maxDataValue[c]=a.stops[1].value,b.type[c]=1,!0;e(d,"Could not convert size info: stops only supported with 2 elements");return!1}if(l(p)&&l(m)&&f(a.minDataValue)&&f(a.maxDataValue))return b.minSize[c]=p,b.maxSize[c]=m,b.minDataValue[c]=a.minDataValue,b.maxDataValue[c]=a.maxDataValue,b.type[c]=1,!0;"unknown"===
a.valueUnit?e(d,"Could not convert size info: proportional size not supported"):e(d,"Could not convert size info: scale-dependent size not supported");return!1}if(!f(a.field)){if(a.stops&&a.stops[0]&&l(a.stops[0].size))return b.minSize[c]=a.stops[0].size,b.maxSize[c]=a.stops[0].size,b.minDataValue[c]=0,b.maxDataValue[c]=1,b.type[c]=1,!0;if(l(p))return b.minSize[c]=p,b.maxSize[c]=p,b.minDataValue[c]=0,b.maxDataValue[c]=1,b.type[c]=1,!0}e(d,"Could not convert size info: unsupported variant of sizeInfo");
return!1}function x(a,b,c){if(a.normalizationField||a.valueRepresentation)return e(c,"Could not convert size info: unsupported property"),null;b.size||(b.size={minSize:[0,0,0],maxSize:[0,0,0],minDataValue:[0,0,0],maxDataValue:[0,0,0],type:[0,0,0]});var d;switch(a.axis){case "width":return(d=g(a,b.size,0,c))?b:null;case "height":return(d=g(a,b.size,2,c))?b:null;case "depth":return(d=g(a,b.size,1,c))?b:null;case "width-and-height":return(d=g(a,b.size,0,c))&&g(a,b.size,2,c),d?b:null;case null:case void 0:case "all":return(d=
(d=(d=g(a,b.size,0,c))&&g(a,b.size,1,c))&&g(a,b.size,2,c))?b:null;default:return e(c,'Could not convert size info: unknown axis "'+a.axis+'""'),null}}function y(a,b,c){for(var d=0;3>d;++d)1===a.type[d]&&(a.minSize[d]/=b.modelSize[d],a.maxSize[d]/=b.modelSize[d],a.type[d]=2),a.minSize[d]/=b.unitInMeters,a.maxSize[d]/=b.unitInMeters;if(0!==a.type[0])b=0;else if(0!==a.type[1])b=1;else if(0!==a.type[2])b=2;else return e(c,"No size axis contains a valid size or scale"),!1;for(d=0;3>d;++d)0===a.type[d]&&
(a.minSize[d]=a.minSize[b],a.maxSize[d]=a.maxSize[b],a.minDataValue[d]=a.minDataValue[b],a.maxDataValue[d]=a.maxDataValue[b],a.type[d]=a.type[b]);return!0}function q(a,b,c){a[4*b+0]=c.r/255;a[4*b+1]=c.g/255;a[4*b+2]=c.b/255;a[4*b+3]=c.a}function z(a,b,c){if(a.normalizationField)return e(c,"Could not convert color info: unsupported property"),null;if(a.stops){if(8<a.stops.length)return e(c,"Could not convert color info: too many color stops"),null;b.color={values:[],colors:[]};a=a.stops;for(c=0;8>
c;++c){var d=Math.min(c,a.length-1),d=a[d];b.color.values[c]=d.value;q(b.color.colors,c,d.color)}}else if(a.colors){if(!f(a.minDataValue)||!f(a.maxDataValue))return e(c,"Could not convert color info: missing data values"),null;if(2!==a.colors.length)return e(c,"Could not convert color info: invalid colors array"),null;b.color={values:[],colors:[]};b.color.values[0]=a.minDataValue;q(b.color.colors,0,a.colors[0]);b.color.values[1]=a.maxDataValue;q(b.color.colors,1,a.colors[1]);for(c=2;8>c;++c)b.color.values[c]=
a.maxDataValue,q(b.color.colors,c,a.colors[1])}else return e(c,"Could not convert color info: missing stops or colors"),null;return b}function t(a,b,c){if(!a)return null;s&&(c=c||[]);return(a=a.reduce(function(a,b){if(!a)return a;if(b.valueExpression)return e(c,"Could not convert visual variables: arcade expressions not supported"),null;var m=b.field;if(a.field){if(m&&m!==a.field)return e(c,"Could not convert visual variables: multiple fields in use"),null}else if(m)if("string"===typeof m)a.field=
m;else return e(c,"Could not convert visual variables: field is not a string"),null;switch(b.type){case "size":return x(b,a,c);case "color":return z(b,a,c);default:return e(c,"Could not convert visual variables: unsupported type "+b.type),null}},{field:null,size:null,color:null}))&&a.size&&!y(a.size,b,c)?null:a}function u(a,b){var c={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeMinDataValue:null,vvSizeMaxDataValue:null,vvSizeValue:null,vvAnchorValue:null,vvColorEnabled:!1,vvColorValues:null,
vvColorColors:null},d=a&&null!==a.size;a&&a.size?(c.vvSizeEnabled=!0,c.vvSizeMinSize=a.size.minSize,c.vvSizeMaxSize=a.size.maxSize,c.vvSizeMinDataValue=a.size.minDataValue,c.vvSizeMaxDataValue=a.size.maxDataValue):a&&d&&(c.vvSizeValue=b.transformation.scale);a&&d&&(c.vvAnchorValue=b.transformation.anchor);a&&a.color&&(c.vvColorEnabled=!0,c.vvColorValues=a.color.values,c.vvColorColors=a.color.colors);return c}var s=!1;n.convertVisualVariables=t;n.initFastSymbolUpdatesState=function(a,b,c){if(!b)return h("State not initialized, fast updates disabled (no shader support)"),
{enabled:!1};if(!a)return h("State not initialized, fast updates disabled (no renderer)"),{enabled:!1};if(a=t(a.visualVariables,c))return r("State initialized, fast updates enabled"),{enabled:!0,visualVariables:a,materialParameters:u(a,c),customTransformation:a&&null!==a.size};h("State not initialized, fast updates disabled (conversion failed)");return{enabled:!1}};n.updateFastSymbolUpdatesState=function(a,b,c){if(!b||!a.enabled)return!1;var d=a.visualVariables;b=t(b.visualVariables,c);if(!b)return h("State update failed (conversion failed)"),
!1;if(!!d.size!==!!b.size)return h("State update failed (size enabled/disabled)"),!1;if(!!d.color!==!!b.color)return h("State update failed (color enabled/disabled)"),!1;if(d.field!==b.field)return h("State update failed (field changed)"),!1;a.visualVariables=b;a.materialParameters=u(b,c);a.customTransformation=b&&null!==b.size;r("State updated");return!0};n.getMaterialParams=u;var v;(function(a){var b=w.mat4d,c=w.vec3,d=b.create(),e=c.create();a.evaluateModelTransform=function(a,c,g){if(!a.vvSizeEnabled)return g;
b.identity(d);if(a.vvSizeEnabled){for(var k=0;3>k;++k){var f=(c[0]-a.vvSizeMinDataValue[k])/(a.vvSizeMaxDataValue[k]-a.vvSizeMinDataValue[k]),h=e,l=k,n=a.vvSizeMinSize[k];f=0>f?0:1<f?1:f;h[l]=n+f*(a.vvSizeMaxSize[k]-a.vvSizeMinSize[k])}b.scale(d,e,d)}else b.scale(d,a.vvSizeValue,d);b.translate(d,a.vvAnchorValue,d);b.multiply(g,d,d);return d}})(v||(v={}));n.evaluateModelTransform=v.evaluateModelTransform});