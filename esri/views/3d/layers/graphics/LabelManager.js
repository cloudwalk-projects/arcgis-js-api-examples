// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("../../../../core/declare ../../../../core/watchUtils ../../support/PreallocArray ../../lib/glMatrix ../../webgl-engine/lib/Util ../../webgl-engine/materials/HUDMaterial".split(" "),function(Y,Z,M,k,T,$){function aa(a,b){return b.posView-a.posView}var D=k.mat4d,d=k.vec3d,r=k.vec2d,g=k.vec4d,F=T.lerp,U=T.VertexAttrConstants,G=[[-1,-1],[1,-1],[1,1],[-1,1]],N=g.create(),E=g.create(),O=g.create(),C=g.create(),J=r.create(),K=r.create(),L=g.create(),V=g.create(),ba=g.create(),H=d.create(),Q=r.create(),
R=g.create(),ca=d.create(),da=d.create(),W=D.create(),ea=d.create(),P=g.create(),I=new M(100);k=function(a,b){this.constructor=a;this.releaser=b;this.list=[];this.currentIndex=0};k.prototype.alloc=function(){this.currentIndex>=this.list.length&&this.list.push(this.constructor.apply(this,arguments));return this.list[this.currentIndex++]};k.prototype.freeAll=function(a){a=this.currentIndex;for(var b=this.releaser,l=this.list;0<=--a;)b(l[a]);this.currentIndex=0};var X=new k(function(){return{labelGraphics:null,
c3dGraphic:null,positions:[r.create(),r.create(),r.create(),r.create()],xMin:0,xMax:0,yMin:0,yMax:0,posView:0,layerView:null,labelId:0}},function(a){a.layerGraphics=null;a.c3dGraphic=null;a.layerView=null});return Y(null,{constructor:function(a){this.layerViews=[];this.view=a;this.stage=a._stage;this._deconflictTimeoutId=0;this._cameraListener=Z.on(a,"navigation","targetViewChanged",this._targetViewChanged.bind(this));this._viewReadyWatcher=a.watch("ready",function(a){!a&&this._deconflictTimeoutId&&
(clearTimeout(this._deconflictTimeoutId),this._deconflictTimeoutId=0)}.bind(this))},destroy:function(){this._cameraListener.remove();0!==this._deconflictTimeoutId&&(clearTimeout(this._deconflictTimeoutId),this._deconflictTimeoutId=0);this._viewReadyWatcher.remove()},addSceneServiceLayerView:function(a){this.layerViews.push(a)},setDirty:function(){this._deconflictLabelsTimeout(10)},setInitialLabelGraphicState:function(a){a.setVisibilityFlag("VISIBILITY_LABELMANAGER",!1)},removeSceneServiceLayerView:function(a){a=
this.layerViews.indexOf(a);0<=a&&this.layerViews.splice(a,1)},_drawPoly:function(a,b,l){a.beginPath();a.lineWidth="1";a.strokeStyle=l;a.moveTo(b[0][0],b[0][1]);for(l=1;4>l;l++)a.lineTo(b[l][0],b[l][1]),a.stroke();a.lineTo(b[0][0],b[0][1]);a.stroke();a.closePath()},_tmp_vec:r.create(),_doesIntersectExistingPoly:function(a){var b=this._tmp_vec,l=a.positions,d={},n,s,t,g,w,u,y,k,z,q,p,x,f,e;for(n=Math.floor(a.xMin/this._accBinsSizeX);n<=Math.floor(a.xMax/this._accBinsSizeX);n++)if(!(0>n||n>=this._accBinsNumX))for(s=
Math.floor(a.yMin/this._accBinsSizeY);s<=Math.floor(a.yMax/this._accBinsSizeY);s++)if(!(0>s||s>=this._accBinsNumY)){t=this._accBins[n][s];g=0;a:for(;g<t.length;g++)if(w=t.data[g],null==d[w.labelId]){d[w.labelId]=!0;w=w.positions;this._accNumTests++;for(k=0;2>k;k++){u=0===k?l:w;y=0===k?w:l;f=0;b:for(;4>f;f++){z=u[f];q=u[(f+1)%4];p=u[(f+2)%4];b[0]=q[0]-z[0];b[1]=q[1]-z[1];q=r.normalize(b);x=q[1];q[1]=q[0];q[0]=-x;x=q[0]*z[0]+q[1]*z[1];e=q[0]*p[0]+q[1]*p[1]<x;for(z=0;4>z;z++)if(p=y[z],p=q[0]*p[0]+q[1]*
p[1],e&&p<x||!e&&p>x)continue b;continue a}}return!0}}return!1},_accBinsNumX:15,_accBinsNumY:20,_accBinsSizeX:0,_accBinsSizeY:0,_accBins:null,_accNumTests:0,_initBins:function(a,b){var l,d,n;if(null==this._accBins){this._accBins=[];for(l=0;l<this._accBinsNumX;l++){this._accBins.push([]);n=this._accBins[this._accBins.length-1];for(d=0;d<this._accBinsNumY;d++)n.push(new M(10))}}for(l=0;l<this._accBinsNumX;l++)for(d=0;d<this._accBinsNumY;d++)this._accBins[l][d].clear();this._accBinsSizeX=a/this._accBinsNumX;
this._accBinsSizeY=b/this._accBinsNumY;this._accNumTests=0},_addToBins:function(a){var b,d;for(b=Math.floor(a.xMin/this._accBinsSizeX);b<=Math.floor(a.xMax/this._accBinsSizeX);b++)if(!(0>b||b>=this._accBinsNumX))for(d=Math.floor(a.yMin/this._accBinsSizeY);d<=Math.floor(a.yMax/this._accBinsSizeY);d++)0>d||d>=this._accBinsNumY||this._accBins[b][d].push(a)},_accDrawDebug:function(a){var b=[r.create(),r.create(),r.create(),r.create()],d=0,g,n,s,t,k,w,u;for(g=0;g<this._accBinsNumX;g++)for(n=0;n<this._accBinsNumY;n++)s=
this._accBins[g][n],d+=s.length,t=g*this._accBinsSizeX,k=(g+1)*this._accBinsSizeX,w=n*this._accBinsSizeY,u=(n+1)*this._accBinsSizeY,b[0][0]=t,b[0][1]=w,b[1][0]=k,b[1][1]=w,b[2][0]=k,b[2][1]=u,b[3][0]=t,b[3][1]=u,a.fillText(s.length.toFixed(),t+5,w+15),this._drawPoly(a,b,"blue");a.fillText("total totalShownLabels: "+d,70,40)},_targetViewChanged:function(){this._deconflictLabelsTimeout()},_deconflictLabelsTimeout:function(a){0===this._deconflictTimeoutId&&(this._deconflictTimeoutId=setTimeout(this._deconflictLabels.bind(this),
a||200))},_deconflictLabels:function(){var a=this.view;clearTimeout(this._deconflictTimeoutId);this._deconflictTimeoutId=0;X.freeAll();var b=a.navigation.targetCamera,l=b.viewMatrix,k=1/Math.tan(b.fovX/2),n=b.projectionMatrix,s=b.fullWidth,t=b.fullHeight;I.clear();for(var S={},w=!1,u=0;u<this.layerViews.length;u++){var y=this.layerViews[u];if(null!=y.layerLabelsEnabled&&y.layerLabelsEnabled()&&!(null==y.getGraphics3DGraphics||null==y.getGraphics3DGraphicsKeys)){w||(this._initBins(s,t),w=!0);for(var M=
y.getGraphics3DGraphics(),z=y.getGraphics3DGraphicsKeys(),q=0;q<z.length;q++){var p=M[z[q]];if(!(null==p._labelGraphics||1>p._labelGraphics.length)&&p.areVisibilityFlagsSet(void 0,"VISIBILITY_LABELMANAGER")){var x=p._labelGraphics[0],f=x.stageObject,e=f.getGeometryRecord(0);if(null!=e){var h=e.materials[0];if(!(null==h||!(h instanceof $)||null==e.origin)){var a=l,f=f.getCenter(),c=e.origin.vec3;g.set4(f[0]-c[0],f[1]-c[1],f[2]-c[2],1,N);D.translate(a,c,W);a=W;D.multiplyVec4(a,N,E);for(var A=e.geometry.getData().getVertexAttr()[U.AUXPOS1],
c=0;3>c;c++)E[c]+=A.data[c];D.multiplyVec4(n,E,O);g.scale(O,1/Math.abs(O[3]),C);r.set2(F(0,s,0.5+0.5*C[0]),F(0,t,0.5+0.5*C[1]),Q);if(-1>C[0]||-1>C[1]||-1>C[2]||1<=C[0]||1<=C[1]){a=!1;for(e=0;e<p._labelGraphics.length;e++)a=a||p._labelGraphics[e].setVisibilityFlag("VISIBILITY_LABELMANAGER",!1);a&&(S[y]=!0)}else{c=h.getParams();h=e.geometry.getData().getVertexAttr()[U.SIZE].data;r.subtract(c.anchorPos,[0.5,0.5],J);r.scale(c.screenOffset,0.5,K);e=X.alloc();if(c.direction){var m=d.set3(x.geometry.normal[0],
x.geometry.normal[1],x.geometry.normal[2],ca),A=d.normalize(d.subtract(b.eye,b.center,L),L),v=d.normalize(d.set(c.direction,da)),B,x=0;d.scale(v,d.dot(v,A),H);d.subtract(A,H,H);d.normalize(H);B=Math.abs(d.dot(H,m));0.985>Math.abs(d.dot(A,v))&&0.5>B?0.422>B?(A=v,B=m,x=0.5):(A=v,B=ea,d.cross(v,H,B),x=d.dot(B,m)/2):(A=v,B=d.normalize(d.cross(m,v)));m=2*(d.dist(b.eye,f)/k/b.width);f=m*c.screenMinMaxSize[0];v=m*c.screenMinMaxSize[1];c.worldScale?(m=1,0<f&&f>h[1]&&(m=f/h[1]),0<v&&h[1]>v&&(m=v/h[1])):m=
0.5*O[3]/s;for(c=0;4>c;c++)g.set(N,P),d.add(P,d.scale(A,G[c][0]*h[0]*m,V)),d.add(P,d.scale(B,(G[c][1]+x)*h[1]*m,ba)),D.multiplyVec4(a,P,L),f=D.multiplyVec4(n,L,V),g.scale(f,1/Math.abs(f[3]),f),e.positions[c][0]=F(0,s,0.5+0.5*f[0]),e.positions[c][1]=t-F(0,t,0.5+0.5*f[1])}else if(c.worldScale){m=2*(d.dist(b.eye,f)/k/b.width);f=m*c.screenMinMaxSize[0];v=m*c.screenMinMaxSize[1];m=1;0<f&&f>h[1]&&(m=f/h[1]);0<v&&h[1]>v&&(m=v/h[1]);for(c=0;4>c;c++)R[0]=E[0]+(0.5*G[c][0]-J[0])*h[0]*m,R[1]=E[1]+(0.5*G[c][1]-
J[1])*h[1]*m,f=D.multiplyVec4(n,R,L),g.scale(f,1/Math.abs(f[3]),f),e.positions[c][0]=F(0,s,0.5+0.5*f[0])+K[0],e.positions[c][1]=t-F(0,t,0.5+0.5*f[1])-K[1]}else{a=d.dist(b.eye,N);for(c=0;4>c;c++)e.positions[c][0]=Q[0]+(0.5*G[c][0]-J[0])*h[0]+K[0],e.positions[c][1]=t-Q[1]+(0.5*G[c][1]+J[1])*h[1]-K[1]}a=E[2];p.areVisibilityFlagsSet("VISIBILITY_LABELMANAGER",void 0)&&(a*=0.7);e.labelId=I.length;e.xMin=Number.MAX_VALUE;e.yMin=Number.MAX_VALUE;e.xMax=-Number.MAX_VALUE;e.yMax=-Number.MAX_VALUE;for(h=0;4>
h;h++)e.xMin=Math.min(e.positions[h][0],e.xMin),e.yMin=Math.min(e.positions[h][1],e.yMin),e.xMax=Math.max(e.positions[h][0],e.xMax),e.yMax=Math.max(e.positions[h][1],e.yMax);e.labelGraphics=p._labelGraphics;e.c3dGraphic=p;e.posView=a;e.layerView=y;I.push(e)}}}}}}}I.sort(aa);for(u=0;u<I.length;u++){b=I.data[u];a=!1;y=b.layerView;if(this._doesIntersectExistingPoly(b))for(c=0;c<b.labelGraphics.length;c++)a=a||b.labelGraphics[c].setVisibilityFlag("VISIBILITY_LABELMANAGER",!1);else{this._addToBins(b);
for(c=0;c<b.labelGraphics.length;c++)a=a||b.labelGraphics[c].setVisibilityFlag("VISIBILITY_LABELMANAGER",!0)}a&&b.c3dGraphic.isDraped()&&(S[y]=!0);Object.keys(S).forEach(function(a){a.emit&&a.emit("draped-data-change")})}}})});