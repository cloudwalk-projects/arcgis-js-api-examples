// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("../../../../core/declare ../../../../core/screenUtils ../../../../Color ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./Graphics3DIconSymbolLayer ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/TextTexture ../../webgl-engine/materials/HUDMaterial".split(" "),function(q,w,x,y,z,u,h,A,B,C,D,v){var E=[1,1,1],F=[0,0,1],t=u.perObjectElevationAligner;q=q([y],{_prepareResources:function(){var a=this.symbol;
this._anchor=-1<A.VALID_ANCHOR_STRINGS.indexOf(a.anchor)?a.anchor:"center";this.resolve()},destroy:function(){this.isFulfilled()||this.reject()},createGraphics3DGraphic:function(a,c,f,e){var b=a.geometry,l=!1;if("polyline"===b.type)b=h.placePointOnPolyline(b),l=!0;else if("polygon"===b.type)b=h.placePointOnPolygon(b);else if("extent"===b.type)b=b.get("center");else if("point"!==b.type)return this._logWarning("unsupported geometry type for text symbol: "+b.type),null;var d=this._context.layer.id+"_label_"+
a.uid,k=c.text||this.symbol.text;if(!k||1>k.length)return null;var r=this._getGraphicElevationInfo(a);return this._createAs3DShape(this.symbol,b,k,r,d,a.uid,c,f,e,l)},layerPropertyChanged:function(a,c,f){if("opacity"===a)console.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");else if("elevationInfo"===a){this._updateElevationInfo();if(c)for(var e in c){a=c[e];var b=a._graphics[f];b&&this.updateGraphicElevationInfo(a.graphic,b)}return!0}return!1},updateGraphicElevationInfo:function(a,
c){var f=this._context,e=this._getGraphicElevationInfo(a);c.elevationAligner=e.mode!==h.ELEV_MODES.ABSOLUTE_HEIGHT?t:null;c.elevationInfo.set(e);t(c,f.elevationProvider,f.renderCoordsHelper)},_defaultElevationInfoNoZ:function(){return G},_getGraphicElevationInfo:function(a){var c=this.inherited(arguments);c.mode===h.ELEV_MODES.ON_THE_GROUND?(c.mode=h.ELEV_MODES.RELATIVE_TO_GROUND,c.offset=1/this._context.renderCoordsHelper.unitInMeters,c.featureExpression={value:0}):c.mode===h.ELEV_MODES.RELATIVE_TO_GROUND&&
(0===c.offset&&!a.geometry.get("hasZ"))&&(c.offset=1/this._context.renderCoordsHelper.unitInMeters);return c},_createAs3DShape:function(a,c,f,e,b,l,d,k,r,g){var n=d.centerOffset||[0,0,0,1],p=d.screenOffset||[0,0],q=d.translation||[0,0,0,0],s=d.anchor||this._anchor||"center";this._anchor=s;var m=a.material?x.toUnitRGB(a.material.color):E,t={shadowColor:0.35<0.299*m[0]+0.587*m[1]+0.114*m[2]?"black":"white",shadowBlur:1};d=null!=r;a=new D(f,{size:w.pt2px(a.size)||12,color:m,font:{family:a.font&&a.font.family?
a.font.family:"Arial",weight:a.font&&a.font.weight?a.font.weight:"normal",style:a.font&&a.font.style?a.font.style:"normal"},canvasStyle:t},b,d);f=d?r.addTextTexture(a):null;m=this._getMaterialOpacity();p={textureId:d?f.texture.getId():a.getId(),texCoordScale:a.getTexcoordScale(),occlusionTest:!0,screenOffset:p,anchorPos:s,polygonOffset:!0,color:[1,1,1,m],transparent:1>m};g&&(p.shaderPolygonOffset=1E-4);g=null;s=JSON.stringify(p);null!=k?(g=k.getMaterial(s),null==g?(g=new v(p,b),k.addMaterial(s,g)):
d&&g.setTextureDirty()):g=new v(p,b);d=[g];g=[a.getTextWidth(),a.getTextHeight()];n=C.createPointGeometry(F,q,void 0,g,!1,n,f?f.uvMinMax:null);n=[new B(n,b)];b=h.createStageObjectForPoint.call(this,c,n,[d],null,null,e,b,this._context.layer.id,l,!0);l=null;e.mode!==h.ELEV_MODES.ABSOLUTE_HEIGHT&&(l=u.perObjectElevationAligner);e=new z(this,b,n,null==k?d:null,null==r?[a]:null,l,e);h.extendPointGraphicElevationInfo(e,c,this._context.elevationProvider);return e}});var G={mode:h.ELEV_MODES.RELATIVE_TO_GROUND,
offset:0};return q});