// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("../../../../core/declare ../../../../core/screenUtils ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DDrapedGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./lineUtils ./graphicUtils ../../../../geometry/Polygon ../../../../Color ../../lib/glMatrix ../../support/aaBoundingBox ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/lib/Util ./earcut/earcut".split(" "),
function(u,E,F,G,H,v,l,q,I,J,K,x,r,t,L,y,z,A,M,w,B){var s=w.VertexAttrConstants;w=x.vec3d;var p=x.mat4d;u=u([F],{_prepareResources:function(){this._prepareFillResources();this._prepareOutlineResources();this.resolve()},_prepareFillResources:function(){var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),b={color:b,transparent:1>b[3]||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0};this._material=new M(b,a+"_colormat");this._context.stage.add(t.ModelContentType.MATERIAL,
this._material)},_prepareOutlineResources:function(){var a=this.symbol.outline;if(this._hasOutline=!(!a||!a.size||!a.color))a={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:E.pt2px(this.symbol.outline.size)},2<a.width?(this._outlineMaterial=q.createRibbonMaterial(a),this._isOutlineNativeLineMaterial=!1):(this._outlineMaterial=q.createNativeMaterial(a),this._isOutlineNativeLineMaterial=!0),this._context.stage.add(t.ModelContentType.MATERIAL,this._outlineMaterial)},destroy:function(){this.isFulfilled()||
this.reject();this._material&&(this._context.stage.remove(t.ModelContentType.MATERIAL,this._material.getId()),this._material=null);this._outlineMaterial&&(this._context.stage.remove(t.ModelContentType.MATERIAL,this._outlineMaterial.getId()),this._outlineMaterial=null)},createGraphics3DGraphic:function(a,b){var k=a.geometry;if("polyline"!==k.type&&"polygon"!==k.type&&"extent"!==k.type)return this._logWarning("unsupported geometry type for fill symbol: "+k.type),null;var k="graphic"+a.uid,h=this._getVertexOpacityAndColor(b,
Uint8Array,255),c=this._getGraphicElevationInfo(a);return c.mode===l.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(a,h,c,k):this._createAs3DShape(a,h,c,k,a.uid)},layerPropertyChanged:function(a,b,k){if("opacity"===a)return b=this._material.getColor(),b[3]=this._getMaterialOpacity(),this._material.setColor(b),this._material.setTransparent(1>b[3]),this._outlineMaterial&&(this._isOutlineNativeLineMaterial?(b=this._outlineMaterial.getColor(),b[3]=this._getOutlineOpacity(),this._outlineMaterial.setColor(b)):
(b=this._outlineMaterial.getParameterValues(),b.color[3]=this._getOutlineOpacity(),this._outlineMaterial.setParameterValues({color:b.color}))),!0;if("elevationInfo"===a){a=this._elevationInfo.mode;this._updateElevationInfo();var h=this._elevationInfo.mode;if(null==a||null==h)return!1;var c=l.ELEV_MODES;if(a===c.ON_THE_GROUND&&h===c.ON_THE_GROUND)return!0;if(a!==h&&(a===c.ON_THE_GROUND||h===c.ON_THE_GROUND))return!1;a=h===c.RELATIVE_TO_GROUND?v.perVertexElevationAligner:null;var h=this._context.elevationProvider,
c=this._context.renderCoordsHelper,e;for(e in b){var f=b[e],g=f._graphics[k];g&&(f=f.graphic,g.elevationAligner=a,g.elevationInfo.set(this._getGraphicElevationInfo(f)),v.perVertexElevationAligner(g,h,c))}return!0}return!1},setDrawOrder:function(a,b,k){this._material&&(this._material.setRenderPriority(a+b/2),k[this._material.getId()]=!0);this._outlineMaterial&&(this._outlineMaterial.setRenderPriority(a),k[this._outlineMaterial.getId()]=!0)},_createAs3DShape:function(a,b,k,h,c){var e=this._getPolyGeometry(a),
f=e.hasZ;a=!1;var g;null!=e.rings?(a=!0,g=e.rings):g=e.paths;if(0===g.length)return this._logWarning("no paths found for line symbol"),null;g=this._getOutlineGeometry(e,g);e=l.getGeometryVertexData3D(g,f,e.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,k);d.idHint=h;d.color=b;d.isRings=a;d.data=e;var C;this._hasOutline&&(C=new e.vertexData.constructor(e.vertexData));d.outNum=0;d.outGeometries=[];d.outTransforms=[];d.outMaterials=[];this._createAs3DShapeFill(d);
d.data.vertexData=C;this._createAs3DShapeOutline(d);if(0===d.outNum)return null;b=new L({geometries:d.outGeometries,materials:d.outMaterials,transformations:d.outTransforms,castShadow:!1,metadata:{layerId:this._context.layer.id,graphicId:c},idHint:h});h=null;k.mode===l.ELEV_MODES.RELATIVE_TO_GROUND&&(h=v.perVertexElevationAligner);return new G(this,b,d.outGeometries,null,null,h,k)},_createAs3DShapeFill:function(a){for(var b=a.data.geometryData.polygons,k=a.data.eleVertexData,h=a.data.vertexData,c=
0;c<b.length;++c){var e=b[c],f=e.count,g=e.index;if(this._context.clippingExtent&&(l.computeBoundingBox(k,g,f,m),l.boundingBoxClipped(m,this._context.clippingExtent)))continue;var d=new Float64Array(k.buffer,3*g*k.BYTES_PER_ELEMENT,3*f),N=new Float64Array(h.buffer,3*g*h.BYTES_PER_ELEMENT,3*f),e=e.holeIndices.map(function(a){return a-g}),e=B(d,e,3);0!==e.length&&(l.chooseOrigin(h,g,f,n),l.subtractCoordinates(h,g,f,n),f=this._createFillGeometry(e,0,N,d,a.color,!1),f=new y(f,a.idHint),f.singleUse=!0,
d=p.identity(),p.translate(d,n,d),a.outGeometries.push(f),a.outMaterials.push([this._material]),a.outTransforms.push(d),a.outNum++)}},_createAs3DShapeOutline:function(a){if(this._hasOutline)for(var b=a.data.geometryData.outlines,k=a.data.eleVertexData,h=a.data.vertexData,c=0;c<b.length;++c){var e=b[c],f=e.index,g=e.count;if(this._context.clippingExtent&&(l.computeBoundingBox(k,f,g,m),l.boundingBoxClipped(m,this._context.clippingExtent)))continue;l.chooseOrigin(h,f,g,n);l.subtractCoordinates(h,f,g,
n);e=new Float64Array(k.buffer,3*f*k.BYTES_PER_ELEMENT,3*g);f=new Float64Array(h.buffer,3*f*h.BYTES_PER_ELEMENT,3*g);f=q.createPolylineGeometry(f,e,a.isRings,D,0,!1);f=new y(f,a.idHint+"outline"+c);f.singleUse=!0;e=p.identity();p.translate(e,n,e);a.outGeometries.push(f);a.outMaterials.push([this._outlineMaterial]);a.outTransforms.push(e);a.outNum++}},_createAsOverlay:function(a,b,k,h){k=this._getPolyGeometry(a);a=!1;var c;null!=k.rings?(a=!0,c=k.rings):c=k.paths;c=this._getOutlineGeometry(k,c);if(0===
c.length)return null;this._material.setRenderPriority(this._symbolLayerOrder+this._symbolLayerOrderDelta/2);this._hasOutline&&this._outlineMaterial.setRenderPriority(this._symbolLayerOrder);k=l.getGeometryVertexDataDraped(c,k.spatialReference,this._context.overlaySR);d.idHint=h;d.color=b;d.isRings=a;d.data=k;var e;this._hasOutline&&(e=new k.vertexData.constructor(k.vertexData));d.outNum=0;d.outGeometries=[];d.outBoundingBox=r.create(r.NEGATIVE_INFINITY);this._createAsOverlayFill(d);d.data.vertexData=
e;this._createAsOverlayOutline(d);return 0<d.outNum?new H(this,d.outGeometries,null,null,d.outBoundingBox):null},_createAsOverlayFill:function(a){for(var b=a.data.vertexData,k=a.data.geometryData.polygons,h=0;h<k.length;++h){var c=k[h],e=c.count,f=c.index,g=new Float64Array(b.buffer,3*f*b.BYTES_PER_ELEMENT,3*e),c=c.holeIndices.map(function(a){return a-f}),g=B(g,c,3);if(0!==g.length&&(l.computeBoundingBox(b,f,e,m),!l.boundingBoxClipped(m,this._context.clippingExtent))){r.expand(a.outBoundingBox,m);
l.chooseOrigin(b,f,e,n);l.subtractCoordinates(b,f,e,n);l.setZ(b,f,e,this._getDrapedZ());e=p.identity();p.translate(e,n,e);g=this._createFillGeometry(g,f,b,null,a.color,!0);c=new A(g);c.material=this._material;var d=m;c.center=[0.5*(d[0]+d[3]),0.5*(d[1]+d[4]),0];c.bsRadius=0.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]));c.transformation=e;c.name=a.idHint;c.uniqueName=a.idHint+"#"+g.id;a.outGeometries.push(c);a.outNum++}}},_createAsOverlayOutline:function(a){if(this._hasOutline)for(var b=
a.data.vertexData,d=a.data.geometryData.outlines,h=0;h<d.length;++h){var c=d[h],e=c.index,c=c.count;l.computeBoundingBox(b,e,c,m);if(!l.boundingBoxClipped(m,this._context.clippingExtent)){r.expand(a.outBoundingBox,m);l.chooseOrigin(b,e,c,n);l.subtractCoordinates(b,e,c,n);l.setZ(b,e,c,this._getDrapedZ());c=new Float64Array(b.buffer,3*e*b.BYTES_PER_ELEMENT,3*c);e=p.identity();p.translate(e,n,e);var c=q.createPolylineGeometry(c,null,a.isRings,D,0,!0),f=new A(c);f.material=this._outlineMaterial;var g=
m;f.center=[0.5*(g[0]+g[3]),0.5*(g[1]+g[4]),0];f.bsRadius=0.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1]));f.transformation=e;f.name=a.idHint+"outline";f.uniqueName=a.idHint+"outline#"+c.id;a.outGeometries.push(f);a.outNum++}}},_getOutlineGeometry:function(a,b){return a._outlineSegments?q.createOutlineGeometryFromSegments(b,a._outlineSegments):b},_getOutlineOpacity:function(){return this._getLayerOpacity()*this.symbol.outline.color.a},_getOutlineColor:function(){var a=this.symbol.outline.color,
b=this._getOutlineOpacity();return I.mixinColorAndOpacity(K.toUnitRGB(a),b)},_getPolyGeometry:function(a){a=a.geometry;"extent"===a.type&&(a=J.fromExtent(a));return a},_createFillGeometry:function(a,b,d,h,c,e){for(var f=a.length,g=new Uint32Array(f),l=new Uint32Array(f),m=0;m<f;m++)g[m]=a[m]+b,l[m]=0;b={};a={};b[s.POSITION]=g;b[s.COLOR]=l;a[s.POSITION]={size:3,data:d};a[s.COLOR]={size:4,data:c};h&&(a.mapPos={size:3,data:h},b.mapPos=g);d=[{type:"triangle",indices:b,positionKey:s.POSITION}];return e?
{faces:d[0],vertexAttr:a,id:z.getNewId().toString()}:new z(d,a)}});var m=r.create(),n=w.create(),D=new Float32Array([255,255,255,255]),d={idHint:null,color:null,isRings:!1,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};return u});