// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/_base/lang dojo/Deferred ../../../../request ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Util ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/materials/Material ../../webgl-engine/lib/Texture ../../support/aaBoundingBox".split(" "),function(G,z,ta,ia,V,ja,A,W,ka,la,ma,na,oa,H){function t(c,b){var a=[],e=[],f=[],k=[],q=[],fa=[],Z="meshsymbol_"+c.model.name,g=c.textureDefinitions,
ga={},I;for(I in g){var B=g[I],m=B.images[0].data;X(m,"symbol resources must have embedded texture data (at the moment)");var r="/textureDefinitions/"+I,m=new oa(B.encoding+";base64,"+m,Z,{noUnpackFlip:!0});q.push(m);ga[r]={engineTexObj:m,transparent:"rgba"===B.channels}}g=c.model.geometries;I=c.materialDefinitions;for(B=0;B<g.length;B++){r=g[B];if(!r.params.components){var m=r,u=m.params;X(u.material);u.components=[{id:1,material:m.params.material,texture:m.params.texture,region:m.params.texture}];
u.faces&&(u.faces.componentIndices=[u.faces.position.count])}var m=r.params.components,C=m.length,u=r.params.faces,J=r.params.vertexAttributes,n=r.params.topology||"Indexed",K={},L;for(L in J){var D=J[L],l=D.values;X(D.values,"symbol resources with external geometry bin not yet supported");if(b.bakeTransformations){if("position"===L){var d=r.transformation,l=l.slice(0);ha(l,3,0,l.length,pa,d)}if("normal"===L){d=qa.create();l=l.slice(0);var s=d,h=r.transformation,v=h[0],M=h[1],N=h[2],E=h[3],O=h[4],
P=h[5],Q=h[6],F=h[7],w=h[8],x=h[9],y=h[10],p=h[11],R=h[12],S=h[13],T=h[14],h=h[15],z=v*P-M*O,A=v*Q-N*O,t=v*F-E*O,G=M*Q-N*P,$=M*F-E*P,aa=N*F-E*Q,ba=w*S-x*R,ca=w*T-y*R,w=w*h-p*R,da=x*T-y*S,x=x*h-p*S,y=y*h-p*T;if(p=z*y-A*x+t*da+G*w-$*ca+aa*ba)p=1/p,s[0]=(P*y-Q*x+F*da)*p,s[1]=(Q*w-O*y-F*ca)*p,s[2]=(O*x-P*w+F*ba)*p,s[3]=(N*x-M*y-E*da)*p,s[4]=(v*y-N*w+E*ca)*p,s[5]=(M*w-v*x-E*ba)*p,s[6]=(S*aa-T*$+h*G)*p,s[7]=(T*t-R*aa-h*A)*p,s[8]=(R*$-S*t+h*z)*p;ha(l,3,0,l.length,ra,d)}}K[L]={data:l,size:D.valuesPerElement}}J=
void 0;D=Array(C);if("Indexed"===n){var J=u.componentIndices,V;for(V in u);}else"PerAttributeArray"!==n?console.warn("I3S symbol loader: unsupported topology type "+n):1!==C&&console.warn("I3S symbol loader: if topology is not Indexed, only single component geometries are supported");f.push([]);for(C=0;C<m.length;C++){n=m[C];l={type:"triangle",positionKey:"position",indices:{}};if(J)for(var ea in u)"componentIndices"!==ea&&(d=u[ea],X(d.values,"symbol resources with external geometry bin not yet supported"),
l.indices[ea]=new Uint32Array(d.values));else{d=K.position.data.length/K.position.size;s=new Uint32Array(d);for(v=0;v<d;v++)s[v]=v;var d=s,H;for(H in K)l.indices[H]=d}D[C]=l;l=void 0;n.texture&&(l=ga[n.texture].engineTexObj.getId());d=k[n.material]?k[n.material][n.texture]:null;d||(d=n.material.substring(n.material.lastIndexOf("/")+1),d=I[d].params,1===d.transparency&&(d.transparency=0),l={ambient:d.diffuse,diffuse:d.diffuse,specular:d.specular,shininess:d.shininess,opacity:1-d.transparency,transparent:0<
d.transparency,textureId:l,doubleSided:!0,cullFace:"none",flipV:!1},b.materialParamsMixin&&ia.mixin(l,b.materialParamsMixin),d=new na(l,Z),k[n.material]||(k[n.material]={}),k[n.material][n.texture]=d,e.push(d));f[B].push(d)}m=new la(new ma(D,K),Z);r=Y.create(r.transformation);b.bakeTransformations&&Y.identity(r);a.push(m);fa.push(r)}return{stageResources:(U={},U[W.ModelContentType.TEXTURE]=q,U[W.ModelContentType.MATERIAL]=e,U[W.ModelContentType.GEOMETRY]=a,U),geometryTransformations:fa,materialsByComponent:f,
pivotOffset:c.model.pivotOffset};var U}function ra(c,b,a){var e=b[0],f=b[1];b=b[2];c[0]=e*a[0]+f*a[3]+b*a[6];c[1]=e*a[1]+f*a[4]+b*a[7];c[2]=e*a[2]+f*a[5]+b*a[8];return c}function pa(c,b,a){var e=b[0],f=b[1];b=b[2];var k=a[3]*e+a[7]*f+a[11]*b+a[15]||1;c[0]=(a[0]*e+a[4]*f+a[8]*b+a[12])/k;c[1]=(a[1]*e+a[5]*f+a[9]*b+a[13])/k;c[2]=(a[2]*e+a[6]*f+a[10]*b+a[14])/k;return c}function ha(c,b,a,e,f,k){b||(b=3);a||(a=0);e=e?Math.min(e*b+a,c.length):c.length;for(var q=sa;a<e;a+=b)q[0]=c[a],q[1]=c[a+1],q[2]=c[a+
2],f(q,q,k),c[a]=q[0],c[a+1]=q[1],c[a+2]=q[2];return c}var Y=A.mat4d,qa=A.mat3d;G=A.vec3d;var X=ka.assert;z.fetch=function(c,b){b=b||{};if(b.streamDataSupplier){var a=b.streamDataSupplier.request(c,"json"),e=new V(function(){return b.streamDataSupplier.cancelRequest(a)});a.then(function(a,c){var f=t(c,b);e.resolve(f)},function(){e.reject()});return e.promise}var f=ja(c),k=new V(function(){return f.cancel()});f.then(function(a){a=t(a.data,b);k.resolve(a)},function(){k.reject()});return k.promise};
z.computeBoundingBox=function(c){var b=c.stageResources[W.ModelContentType.GEOMETRY];c=c.geometryTransformations;for(var a=H.create(H.NEGATIVE_INFINITY),e=[0,0,0],f=[0,0,0],k=0;k<b.length;k++)for(var q=b[k],t=0,z=q.getNumGroups();t<z;++t){var g=q.getBoundingInfo(t);Y.multiplyVec3(c[k],g.getBBMin(),e);Y.multiplyVec3(c[k],g.getBBMax(),f);for(g=0;3>g;++g){if(e[g]>f[g]){var A=e[g];e[g]=f[g];f[g]=A}a[g]=Math.min(a[g],e[g]);a[g+3]=Math.max(a[g+3],f[g])}}return a};z.createStageResources=t;var sa=G.create()});