// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["require","exports","./GoogPriorityQueue","../../support/PromiseLightweight","../../../../core/urlUtils"],function(r,s,l,m,h){return function(){function f(b,a,c,d,g,e,n,f,p,h,q,k){void 0===k&&(k={initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1});this.baseURL=b;this.startNodeUrl=a;this.rootId=c;this.poi=d;this.nodeIndex=g;this.streamDataSupplier=e;this.viewportQueries=n;this.processNodeIndexDocument=f;this.finishedLevelCallback=p;this.debugVis=h;this.logger=q;this.traversalOptions=k;
this.queues=[];this.knownNodes=new Set;this.dataLoadingPerLevel=[];this.numIndicesLoading=this.currentLevel=0;this.cancelled=this.queueTraversalEnabled=!1}f.prototype.start=function(){var b=this;this._nodeTraversalState={};this._nodeIsVisibleCached={};this.dataLoadingPerLevel=[];this.currentLevel=0;this.rootUrl=h.makeAbsolute(this.startNodeUrl,this.baseURL);this.traversalOptions.initDepthFirst?(this.initPromise=new m.Promise,this.getNode(this.rootUrl,this.rootId,this.initQueryCallback.bind(this),
this.initQueryErrback.bind(this)),this.initPromise.then(function(){b.cancelled||(b.queueTraversalEnabled=!0)})):(this.enqueue(0,{id:this.rootId,hrefConcat:this.rootUrl},0),this.queueTraversalEnabled=!0)};f.prototype.initQueryErrback=function(){this.initPromise.done()};f.prototype.continueTraversal=function(b){var a=this;if(this.queueTraversalEnabled){b=null==b?5:b;for(var c=0;c<this.queues.length;c++)if(!(this.traversalOptions.perLevelTraversal&&this.currentLevel!==c)){for(var d=this.queues[c];0<
b--&&!d.isEmpty();)(function(b){var c=a.queues[b].dequeue();a.dataLoadingPerLevel[b]++;var d=function(){a.dataLoadingPerLevel[b]--};a.getNode(c.hrefConcat,c.id,function(c,e){null==e.parentNode?(a.nodeTraversalState(e.id),a.enqueueConnected(c,e,b),a.processNodeIndexDocument(e,void 0).then(d,d)):a.getNode(a.concatHref(e.parentNode,c),e.parentNode.id,function(f,h){a.nodeTraversalState(e.id);a.enqueueConnected(c,e,b);a.processNodeIndexDocument(e,h).then(d,d)})},d)})(c);this.traversalOptions.perLevelTraversal&&
(d.isEmpty()&&0===this.dataLoadingPerLevel[c])&&(this.finishedLevelCallback.call(null,this.currentLevel),this.currentLevel++)}}};f.prototype.isQueueTraversalEnabled=function(){return this.queueTraversalEnabled};f.prototype.getQueueSize=function(){for(var b=0,a=0;a<this.queues.length;a++)b+=this.queues[a].getCount();return b};f.prototype.cancel=function(){this.queueTraversalEnabled=!1;for(var b=0;b<this.queues.length;b++)this.queues[b].clear();this.cancelled=!0};f.prototype.isLoading=function(){return 0<
this.numIndicesLoading||0<this.getQueueSize()};f.prototype.nodeIsVisible=function(b){if(null!=this._nodeIsVisibleCached[b.id])return this._nodeIsVisibleCached[b.id];this._nodeIsVisibleCached[b.id]=this.viewportQueries.isNodeVisible(b);return this._nodeIsVisibleCached[b.id]};f.prototype.nodeTraversalState=function(b){if(null!=this._nodeTraversalState[b])return this._nodeTraversalState[b];var a=this.nodeIndex[b];if(null==a)return null;var c=null,d=!1;if(null!=a.parentNode){c=this.nodeIndex[a.parentNode.id];
if(null==c)return null;var g=this._nodeTraversalState[c.id];null!=g&&(d=g.nodeIsTooHighLOD)}var g=this.viewportQueries.hasLOD(a),e=this.viewportQueries.isTooHighLOD(a),c=this.viewportQueries.isChosenLOD(a,c,e,d);this._nodeTraversalState[a.id]={visited:!0,nodeHasLOD:g,nodeIsTooHighLOD:e,isChosenLOD:c};return this._nodeTraversalState[b]};f.prototype.getNode=function(b,a,c,d){var g=this;this.numIndicesLoading++;this.nodeIndex[a]?(c(b,this.nodeIndex[a]),this.numIndicesLoading--):this.streamDataSupplier.request(b,
"json").then(function(a,b){g.nodeIndex[b.id]=b;b.baseUrl=a;c(a,b);g.numIndicesLoading--},function(a){null!=d&&d(a);g.loadErrorCallback(b);g.numIndicesLoading--})};f.prototype.initQueryCallback=function(b,a){if(this.cancelled)this.initPromise.done();else if(this.nodeTraversalState(a.id),this.enqueueConnected(b,a,0),this.isLeafNode(a))this.initPromise.done();else{for(var c=1E9,d=void 0,g=0;g<a.children.length;++g){var e=a.children[g];if(this.nodeIsVisible(e)&&(!this.viewportQueries.hasLOD(a)||!this.viewportQueries.isTooHighLOD(a))){var f=
this.viewportQueries.distToPOI(e,this.poi);f<c&&(c=f,d=e)}}d?(c=h.makeAbsolute(d.href,b),this.getNode(c,d.id,this.initQueryCallback.bind(this),this.initQueryErrback.bind(this))):this.initPromise.done()}};f.prototype.isLeafNode=function(b){return null==b.children};f.prototype.concatHref=function(b,a){return h.makeAbsolute(b.href,a)};f.prototype.enqueue=function(b,a,c){this.traversalOptions.perLevelTraversal||(c=0);for(this.knownNodes.add(a.id);this.queues.length<=c;)this.queues.push(new l.goog.structs.PriorityQueue),
this.dataLoadingPerLevel.push(0);this.queues[c].enqueue(b,a)};f.prototype.enqueueConnected=function(b,a,c){if(!this.cancelled&&null!=a){var d=this.nodeTraversalState(a.id);if(a.id!==this.rootId&&null!=a.parentNode&&!this.knownNodes.has(a.parentNode.id)){var g={id:a.parentNode.id,hrefConcat:this.concatHref(a.parentNode,b)};this.enqueue(this.viewportQueries.distToPOI(a.parentNode,this.poi),g,c-1)}else a.id===this.rootId&&(!this.knownNodes.has(a.id)&&this.nodeIsVisible(a))&&this.enqueue(this.viewportQueries.distToPOI(a,
this.poi),{id:a.id,hrefConcat:b},c);if(a.children)for(var e=0,f=a.children;e<f.length;e++){var h=f[e],g=this.nodeIsVisible(h);if(!this.knownNodes.has(h.id)&&(!d.nodeHasLOD||!d.nodeIsTooHighLOD)&&g)g={id:h.id,hrefConcat:this.concatHref(h,b)},this.enqueue(this.viewportQueries.distToPOI(h,this.poi),g,c+1)}if(this.traversalOptions.neighborhood&&a.neighbors){d=0;for(a=a.neighbors;d<a.length;d++)e=a[d],g=this.nodeIsVisible(e),!this.knownNodes.has(e.id)&&g&&(g={id:e.id,hrefConcat:this.concatHref(e,b)},this.enqueue(this.viewportQueries.distToPOI(e,
this.poi),g,c))}}};f.prototype.loadErrorCallback=function(b){this.logger.warn("Error loading node: "+b)};return f}()});