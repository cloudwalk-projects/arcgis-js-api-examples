// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ./LODInfo ./TileKey ./TileSpan ./TileCoverage".split(" "),function(x,y,s,q,r,v){var w=function(){function e(b,c,d,a,f,m,h,k){this.x=b;this.ymin=c;this.ymax=d;this.invM=a;this.leftAdjust=f;this.rightAdjust=m;this.leftBound=h;this.rightBound=k}e.create=function(b,c){b[1]>c[1]&&(d=[c,b],b=d[0],c=d[1]);var d=b[0],a=b[1],f=c[0],m=c[1],h=f-d,k=m-a,k=0!==k?h/k:0,n=(Math.ceil(a)-a)*k,t=(Math.floor(a)-a)*k;return new e(d,Math.floor(a),Math.ceil(m),k,0>h?n:t,0>h?t:n,0>h?f:d,0>h?d:f);
var d};e.prototype.incrRow=function(){this.x+=this.invM};e.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)};e.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)};return e}(),p=[[0,0],[0,0],[0,0],[0,0]];return function(){function e(b,c){var d=this;this.scales=[];this._lodInfos=null;this._infoByScale={};this._infoByLevel={};var a=b.lods.slice();a.sort(function(b,a){return a.scale-b.scale});var f=this._lodInfos=a.map(function(a){return s.create(b,
a,c)});a.forEach(function(b,a){d._infoByLevel[b.level]=f[a];d._infoByScale[b.scale]=f[a];d.scales[a]=b.scale},this);this._wrap=b.spatialReference.isWrappable}e.prototype.getTileTopLeft=function(b,c){var d=this._infoByLevel[c.level];return!d?b:d.getTileTopLeft(b,c)};e.prototype.getTileBottomRight=function(b,c){var d=this._infoByLevel[c.level];return!d?b:d.getTileBottomRight(b,c)};e.prototype.getTileResolution=function(b){b=this._infoByLevel[b.level];return!b?-1:b.resolution};e.prototype.getTileParentId=
function(b){b=q.from(b);var c=this._lodInfos.indexOf(this._infoByLevel[b.level])-1;return 0>c?null:this.getTileIdAtParent(this._lodInfos[c],b)};e.prototype.getTileIdAtParent=function(b,c){var d=q.from(c),a=this._infoByLevel[d.level];if(b.resolution<a.resolution)throw Error("Cannot calculate parent tile. destination LOD's resolution "+b.resolution+" is not a parent resolution of "+a.resolution);return b.resolution===a.resolution?d.id:q.getId(b.level,Math.floor(d.row*a.resolution/b.resolution+0.01),
Math.floor(d.col*a.resolution/b.resolution+0.01),d.world)};e.prototype.getTileCoverage=function(b){var c=this.getClosestInfoForScale(b.scale),d=this._wrap,a;a=Infinity;var f=-Infinity,m,h,k=[];p[0][0]=p[0][1]=p[1][1]=p[3][0]=0;p[1][0]=p[2][0]=b.size[0];p[2][1]=p[3][1]=b.size[1];for(var n=p.map(function(a){b.toMap(a,a);a[0]=c.getColumnForX(a[0]);a[1]=c.getRowForY(a[1]);return a}),e=[],l=3,g=0;4>g;g++)n[g][1]!==n[l][1]&&(l=w.create(n[g],n[l]),a=Math.min(l.ymin,a),f=Math.max(l.ymax,f),void 0===e[l.ymin]&&
(e[l.ymin]=[]),e[l.ymin].push(l)),l=g;if(null==a||null==f||100<f-a)return null;for(n=[];a<f;){null!=e[a]&&(n=n.concat(e[a]));m=Infinity;h=-Infinity;for(g=n.length-1;0<=g;g--)l=n[g],m=Math.min(m,l.getLeftCol()),h=Math.max(h,l.getRightCol());m=Math.floor(m);h=Math.floor(h);if(a>=c.first[1]&&a<=c.last[1])if(d)if(c.size[0]<c.worldSize[0]){g=Math.floor(m/c.worldSize[0]);for(l=Math.floor(h/c.worldSize[0]);g<=l;g++)k.push(new r(a,Math.max(c.getFirstColumnForWorld(g),m),Math.min(c.getLastColumnForWorld(g),
h)))}else k.push(new r(a,m,h));else m>c.last[0]||h<c.first[0]||(m=Math.max(m,c.first[0]),h=Math.min(h,c.last[0]),k.push(new r(a,m,h)));a+=1;for(g=n.length-1;0<=g;g--)l=n[g],l.ymax>=a?l.incrRow():n.splice(g,1)}return new v(c,k)};e.prototype.intersects=function(b,c){var d=q.from(c),a=this._infoByLevel[d.level],f=b.lodInfo;if(f.resolution>a.resolution){var e=q.fromId(this.getTileIdAtParent(f,d)),h=f.denormalizeCol(e.col,e.world);return b.spans.some(function(a){return a.row===e.row&&a.colFrom<=h&&a.colTo>=
h})}if(f.resolution<a.resolution){var k=b.spans.reduce(function(a,b){a[0]=Math.min(a[0],b.row);a[1]=Math.max(a[1],b.row);a[2]=Math.min(a[2],b.colFrom);a[3]=Math.max(a[3],b.colTo);return a},[Infinity,-Infinity,Infinity,-Infinity]),n=k[0],p=k[1],l=k[2],k=k[3],g=a.denormalizeCol(d.col,d.world),r=f.getColumnForX(a.getXForColumn(g)),s=f.getRowForY(a.getYForRow(d.row)),g=f.getColumnForX(a.getXForColumn(g+1))-1,a=f.getRowForY(a.getYForRow(d.row+1))-1;return!(r>k||g<l||s>p||a<n)}var u=f.denormalizeCol(d.col,
d.world);return b.spans.some(function(a){return a.row===d.row&&a.colFrom<=u&&a.colTo>=u})};e.prototype.getClosestInfoForScale=function(b){var c=this.scales;this._infoByScale[b]||(b=c.reduce(function(c,a,e,m){return Math.abs(a-b)<Math.abs(c-b)?a:c},c[0]));return this._infoByScale[b]};return e}()});