// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/accessorSupport/decorators ../../../../core/Collection ../../../../core/HandleRegistry ../../../../core/promiseUtils ../../../../core/Error ../../../../renderers/support/renderingInfoUtils ../../../../Graphic ../../../layers/GraphicsView ../../engine/graphics/GFXSurface ../../engine/graphics/GFXGroup ../../engine/graphics/GFXObject ../../../../layers/graphics/QueryEngine".split(" "),
function(x,y,p,g,e,q,r,k,s,l,t,u,v,m,h,w){return function(n){function b(){for(var a=this,c=[],d=0;d<arguments.length;d++)c[d-0]=arguments[d];n.apply(this,c);this._handles=new r;this._backgroundGroup=new m;this._frontGroup=new m;this._frontObjects=new Map;this._backgroundObjects=new Map;this._queryEngine=new w;this._scale=0;this.container=new v;this.layer=null;this.container.addChild(this._backgroundGroup);this.container.addChild(this._frontGroup);this.watch("graphics",function(){return a._reset()});
this.watch("renderer",function(){return a._resymbolize()});this.watch("layer",function(){return a._setObjectId()});this.watch("mapView.scale, mapView.stationary",function(){return a._applyScale()})}p(b,n);b.prototype.queryGraphics=function(){return this._queryEngine?this._queryEngine.queryFeatures():this._rejectQuery()};b.prototype.queryFeatures=function(a){return this._queryEngine?this._queryEngine.queryFeatures(a):this._rejectQuery()};b.prototype.queryObjectIds=function(a){return this._queryEngine?
this._queryEngine.queryObjectIds(a):this._rejectQuery()};b.prototype.queryFeatureCount=function(a){return this._queryEngine?this._queryEngine.queryFeatureCount(a):this._rejectQuery()};b.prototype.queryExtent=function(a){return this._queryEngine?this._queryEngine.queryExtent(a):this._rejectQuery()};b.prototype.hitTest=function(a,c){var d=this.container.hitTest(a,c);return d?k.resolve(d.graphic):null};b.prototype._reset=function(){var a=this;this._handles.remove("graphics");this.graphics&&(this.graphics.forEach(this._add,
this),this._queryEngine.features=this.graphics,this._handles.add(this.graphics.on("change",function(c){return a._graphicsChangeHandler(c)}),"graphics"))};b.prototype._applyScale=function(){var a=this.get("mapView.scale"),c=this.get("mapView.stationary");a!==this._scale&&c&&(this._scale=a,this._resymbolize())};b.prototype._resymbolize=function(){var a=this;this.graphics&&this.graphics.forEach(function(c){return a._resymbolizeGraphic(c)})};b.prototype._add=function(a){if(!this._frontObjects.has(a)){var c=
l.getRenderingInfo(a,{renderer:this.renderer,viewingMode:"map",scale:this.mapView.state.scale,resolution:this.mapView.state.resolution});if(c){var d=new h;d.graphic=a;d.renderingInfo=c;this._frontObjects.set(a,d);this._frontGroup.addChild(d);var b=c.renderer&&c.renderer.backgroundFillSymbol;b&&d.isPolygonMarkerSymbol&&(d=new h,d.graphic=a,d.renderingInfo=null!=c.outlineSize?{symbol:b,size:[c.outlineSize,c.outlineSize,c.outlineSize]}:{symbol:b},this._backgroundObjects.set(a,d),this._backgroundGroup.addChild(d))}}};
b.prototype._remove=function(a){var c=this._frontObjects.get(a);c&&(this._frontObjects.delete(a),this._frontGroup.removeChild(c),this._backgroundObjects.has(a)&&(c=this._backgroundObjects.get(a),this._backgroundObjects.delete(a),this._backgroundGroup.removeChild(c)))};b.prototype._resymbolizeGraphic=function(a){if(this._frontObjects.has(a)){var c=l.getRenderingInfo(a,{renderer:this.renderer,viewingMode:"map",scale:this.mapView.state.scale,resolution:this.mapView.state.resolution}),d=this._frontObjects.get(a);
d.renderingInfo=c;var b=c.renderer&&c.renderer.backgroundFillSymbol,f=this._backgroundObjects.get(a);b&&d.isPolygonMarkerSymbol?(f||(f=new h,f.graphic=a,this._backgroundObjects.set(a,f),this._backgroundGroup.addChild(f)),f.renderingInfo=null!=c.outlineSize?{symbol:b,size:[c.outlineSize,c.outlineSize,c.outlineSize]}:{symbol:b}):!b&&f&&(this._backgroundObjects.delete(a),this._backgroundGroup.removeChild(f))}};b.prototype._setObjectId=function(){this._queryEngine.objectIdField=this.layer.objectIdField};
b.prototype._rejectQuery=function(){return k.reject(new s("GraphicsLayerView2D","Not ready to execute query"))};b.prototype._graphicsChangeHandler=function(a){for(var c=a.removed,b=0,e=a.added;b<e.length;b++)a=e[b],this._add(a);for(b=0;b<c.length;b++)a=c[b],this._remove(a)};g([e.property()],b.prototype,"container",void 0);g([e.property(),e.cast(q.ofType(t))],b.prototype,"graphics",void 0);g([e.property()],b.prototype,"layer",void 0);g([e.property()],b.prototype,"mapView",void 0);return b=g([e.subclass("esri.views.2d.layers.support.FeaturesView2D")],
b)}(e.declared(u))});