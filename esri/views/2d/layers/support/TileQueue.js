// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["../../../../core/declare","dojo/_base/lang"],function(l,m){var n=function(){this.requests=[]};return l(null,{constructor:function(b){m.mixin(this,b);this._scales=[];this._scaleBins={};this._levelToScale={};b.tileInfo.lods.forEach(function(b){this._levelToScale[b.level]=b.scale},this);this._requestIds={}},_minScale:0,_maxScale:-1,_scales:null,_scaleBins:null,_levelToScale:null,_requestIds:null,add:function(b,c){if(!this.contains(b)){var a=this._levelToScale[c.tile.level];this._maxScale<this._minScale?
this._minScale=this._maxScale=a:(a<this._minScale&&(this._minScale=a),a>this._maxScale&&(this._maxScale=a));var d=this._scaleBins[a];d||(this._scales.push(a),this._scales.sort(this._sortNumbers),d=this._scaleBins[a]=new n);d.requests.push(c);this._requestIds[b]=c}},get:function(b){var c=[],a=this.state.scale,d=this.state.x,l=this.state.y,g=this._scales,h=this.tileInfo,e,k,f;for(null==b&&(b=1);c.length<b&&this._minScale<=this._maxScale;){f=this._scaleBins[a];if(!f){if(a<this._minScale)a=this._minScale;
else if(a>this._maxScale)a=this._maxScale;else{e=1;for(k=g.length;e<k;e++)a<g[e]&&(a=a-g[e-1]<g[e]-a?g[e-1]:g[e])}f=this._scaleBins[a]}k=1/a/h.size[1];e=1/a/h.size[0];for(f.requests.sort(this._sortRequests((d-h.origin.x)*e,(h.origin.y-l)*k));c.length<b&&0<f.requests.length;)c.push(this._remove(f,a,f.requests[0]))}return c},contains:function(b){return void 0!==this._requestIds[b]},remove:function(b){b=this._requestIds[b];var c,a;b&&(c=this._levelToScale[b.tile.level],a=this._scaleBins[c],this._remove(a,
c,b));return b},isEmpty:function(){return this._minScale>this._maxScale},_remove:function(b,c,a){b.requests.splice(b.requests.indexOf(a),1);b.requests.length||(this._scales.splice(this._scales.indexOf(c),1),delete this._scaleBins[c],this._scales.sort(),0<this._scales.length?(this._minScale=this._scales[0],this._maxScale=this._scales[this._scales.length-1]):(this._minScale=0,this._maxScale=-1));delete this._requestIds[a.id];return a},_sortNumbers:function(b,c){return b-c},_sortRequests:function(b,
c){return function(a,d){a=a.tile;d=d.tile;return Math.sqrt((b-a.c)*(b-a.c)+(c-a.row)*(c-a.row))-Math.sqrt((b-d.c)*(b-d.c)+(c-d.row)*(c-d.row))}}})});