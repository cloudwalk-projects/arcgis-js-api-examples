// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/HandleRegistry ../../../layers/support/ExportImageParameters ./LayerView2D ./support/ExportStrategy ../engine/GeoBitmap ../engine/Canvas2DContainer ../engine/GeoBitmapContainer".split(" "),function(t,u,h,k,f,l,m,n,p,q,r,s){return function(g){function a(){g.apply(this,arguments);this._handles=new l;this.container=new r}h(a,g);a.prototype.hitTest=
function(b,a){return null};a.prototype.update=function(b){this.strategy.update(b);this.notifyChange("updating")};a.prototype.attach=function(){var b=this;this._imageContainer=new s;this.container.addChild(this._imageContainer);this.strategy=new p(this._imageContainer,function(a){return b._fetchImage(a)},function(){return b.requestUpdate()},0,!1,2048,2048,!1);this._exportImageParameters=new m({layer:this.layer});this._handles.add(this._exportImageParameters.watch("version",function(a){b._exportImageVersion!==
a&&(b._exportImageVersion=a,b.requestUpdate())}))};a.prototype.detach=function(){this.container.removeChild(this._imageContainer);this.strategy.destroy();this._handles.removeAll();this._exportImageParameters.layer=null;this._exportImageParameters.destroy();this._exportImageParameters=null};a.prototype.moveStart=function(){};a.prototype.viewChange=function(){};a.prototype.moveEnd=function(){this.requestUpdate()};a.prototype.isUpdating=function(){return this.attached&&(this.strategy.updating||this.updateRequested)};
a.prototype.getPopupData=function(a){var c=this,d=this.view.scale;return this.layer.allSublayers.filter(function(a){var b=0===a.minScale||d<=a.minScale,c=0===a.maxScale||d>=a.maxScale;return a.popupTemplate&&a.visible&&b&&c}).map(function(d){var e=d.createQuery();e.geometry=a;e.outFields=c.getTemplateOutFields(d.popupTemplate);return d.queryFeatures(e).then(function(a){return a.features})})};a.prototype.getTemplateOutFields=function(a){if(!a||!a.fieldInfos)return["*"];var c=[];a.fieldInfos.forEach(function(a){var b=
a.fieldName&&a.fieldName.toLowerCase();b&&("shape"!==b&&0!==b.indexOf("relationships/"))&&c.push(a.fieldName)});return c};a.prototype._fetchImage=function(a){var c=this;this._exportImageParameters.scale!==this.view.scale&&(this._exportImageParameters.scale=this.view.scale,this._exportImageVersion=this._exportImageParameters.version);return this.layer.fetchImage(a).then(function(a){c.notifyChange("updating");return new q(a.img)})};return a=k([f.subclass("esri.views.2d.layers.MapImageLayerView2D")],
a)}(f.declared(n))});