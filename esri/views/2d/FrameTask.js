// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/Scheduler","./FrameBudget"],function(m,n,k,l){return function(){function d(b){var c=this;this.view=b;this._frameTaskHandle=null;this._layerViewsTrash=[];this._layerViewsToUpdate=[];this._layerViewsState={};this._budget=new l(this.budget);this._stationary=!0;this._updateParameters={budget:this._budget,state:this.view.state,devicePixelRatio:window.devicePixelRatio,stationary:!0};this.budget=6;this.prepare=function(){c._updateParameters.state=c.view.state;c._updateParameters.stationary=
c.view.stationary;c._budget.reset(c.budget)};this.update=function(){for(var b=c._budget,a=c.view,d=a.allLayerViews.toArray().filter(function(a){return null==a.layerViews}),g=d.length,f=a.state,e=0;e<d.length;e++)if(a=d[e],a.attached){var h=c._layerViewsState[a.uid];if(null==h||!c.stationary&&!a.moving)a.moving=!0,a.moveStart();h!==f.id&&a.viewChange();c.stationary&&a.moving&&(a.moving=!1,a.moveEnd());c._layerViewsState[a.uid]=f.id}f=c._layerViewsTrash;for(e=0;e<f.length;e++)a=f[e],a.attached&&(a.detach(),
a.attached=!1);f.length=0;if(!b.done){e=0;a:for(;e<g;e++){if(b.done)break a;a=d[e];a.attached||c._attachLayerView(a)}}d=c._layerViewsToUpdate;g=d.slice();a=c._updateParameters;for(c._layerViewsToUpdate.length=0;!b.done&&0<g.length;)g.shift().processUpdate(a);0<g.length&&d.unshift.apply(d,g);0===d.length&&0===f.length&&c._frameTaskHandle.pause()}}d.prototype.destroy=function(){this._allLayerViewsChangeHandle.remove();this._frameTaskHandle.remove()};Object.defineProperty(d.prototype,"stationary",{get:function(){return this._stationary},
set:function(b){this._stationary!==b&&(this._stationary=b,this.requestFrame())},enumerable:!0,configurable:!0});d.prototype.start=function(){var b=this;this._allLayerViewsChangeHandle=this.view.allLayerViews.on("change",function(c){Array.prototype.push.apply(b._layerViewsTrash,c.removed);b.requestFrame()});this._frameTaskHandle=k.addFrameTask(this);this._frameTaskHandle.pause()};d.prototype.stop=function(){this._allLayerViewsChangeHandle.remove();this._allLayerViewsChangeHandle=null;this._frameTaskHandle.pause()};
d.prototype.requestLayerViewUpdate=function(b){this._layerViewsToUpdate.push(b);this.requestFrame()};d.prototype.requestFrame=function(){this._frameTaskHandle&&this._frameTaskHandle.resume()};d.prototype._attachLayerView=function(b){b.attached||(b.attached=!0,b.attach())};d.prototype._detachLayerView=function(b){b.attached&&(b.detach(),b.attached=!1)};return d}()});