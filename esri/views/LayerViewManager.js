// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/accessorSupport/decorators ../core/Accessor ../core/Error ../core/HandleRegistry ../core/Scheduler ../core/promiseUtils ../core/watchUtils ./LayerViewFactory".split(" "),function(u,v,n,h,e,p,k,q,r,l,s,t){return function(m){function b(){var a=this;m.call(this);this._promisesMap=new Map;this._layerViewsMap=new Map;this._handles=new q;this.factory=new t;this.ready=!1;this.layersToLayerViews=function(){var a=
new Map;a.set("view.map.basemap.baseLayers","view.basemapView.baseLayerViews");a.set("view.map.ground.layers","view.groundView.layerViews");a.set("view.map.layers","view.layerViews");a.set("view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews");return a}();this._doWork=this._doWork.bind(this);this.refresh=this.refresh.bind(this);this._handles.add(s.init(this,"view.ready",function(c){return a.ready=c}));this._handles.add(this.watch(["view.map.basemap","view.map.ground","view.map.layers",
"ready"],this.refresh),"watcher")}n(b,m);b.prototype.destroy=function(){this.view=null;this.empty();this.factory.destroy();this.factory=null;this._handles.destroy();this._map=this._layerViewsMap=this._promisesMap=this._handles=null};b.prototype.empty=function(){this._layerViewsMap.forEach(this._disposeLayerView,this);this._promisesMap.forEach(function(a){return a.cancel()});this._layerViewsMap.clear();this._promisesMap.clear();this._refreshCollections()};b.prototype.refresh=function(){var a=this._handles;
a.remove("refresh");a.add(r.schedule(this._doWork),"refresh")};b.prototype.whenLayerView=function(a){this.refresh();this._doWork();return!this._promisesMap.has(a)?l.reject(new k("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:a})):this._promisesMap.get(a)};b.prototype._doWork=function(){var a=this,c=this._handles,b=this.get("view.map");this._map!==b&&(this.empty(),this._map=b);if(c.has("refresh")){c.remove("refresh");c.remove("collection-change");this.factory.paused=
!this.ready;var d=this._map&&this._map.allLayers;d&&(d.forEach(this._createLayerView,this),this._refreshCollections(),this._promisesMap.forEach(function(c,b){d.includes(b)||a._disposeLayerView(a._layerViewsMap.get(b),b)}),c.add(d.on("change",this.refresh),"collection-change"))}};b.prototype._refreshCollections=function(){var a=this;this.layersToLayerViews.forEach(function(c,b){a._populateLayerViewsOwners(a.get(b),a.get(c),a.view)})};b.prototype._populateLayerViewsOwners=function(a,c,b){var d=this;
if(!a||!c)c&&c.removeAll();else{var f=0;a.forEach(function(a){var g=d._layerViewsMap.get(a);g&&(g.layer=a,g.parent=b,c.getItemAt(f)!==g&&c.splice(f,0,g),a.layers&&d._populateLayerViewsOwners(a.layers,g.layerViews,g),f+=1)});f<c.length&&c.splice(f,c.length)}};b.prototype._createLayerView=function(a){var c=this,b=this.view,d=this.factory,f=this._layerViewsMap,e=this._promisesMap;f.has(a)?a.load():e.has(a)||(d=d.create(b,a).then(function(d){if(!c._map||!c._map.allLayers.some(function(b){return a===b}))throw new k("view:no-layerview-for-layer",
"The layer has been removed from the map",{layer:a});f.set(a,d);c._refreshCollections();a.emit("layerview-create",{view:b,layerView:d});b.emit("layerview-create",{layer:a,layerView:d});return l.resolve(d)}),e.set(a,d),d.always(this.refresh))};b.prototype._disposeLayerView=function(a,b){if(this._promisesMap.has(b)&&(this._promisesMap.get(b).cancel(),this._promisesMap.delete(b),a)){var e=a.layer,d=a.view;this.factory.dispose(a);a.layer=a.parent=a.view=null;this._layerViewsMap.delete(e);e.emit("layerview-destroy",
{view:d,layerView:a});d.emit("layerview-destroy",{layer:e,layerView:a})}};h([e.property()],b.prototype,"ready",void 0);h([e.property()],b.prototype,"view",void 0);return b=h([e.subclass("esri.views.LayerViewManager")],b)}(e.declared(p))});