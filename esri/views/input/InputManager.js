// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["require","exports","./keys","./recognizers","../../core/Logger"],function(n,r,p,s,t){var m=t.getLogger("esri.views.input");n=function(){function c(a,b){this._pointerCaptures=new Map;this._nameToGroup={};this._handlers=[];this._currentPropagation=null;this._sourceEvents=new Set;this._keyModifiers=new Set;this._activeKeyModifiers=new Set;this.primaryKey=p.primaryKey;this._browserEvents=a;this._browserEvents.onEventReceived=this._onEventReceived.bind(this);this._installRecognizers(b)}c.prototype.installHandlers=
function(a,b){var d=this;if(this._nameToGroup[a])m.error("There is already an InputHandler group registered under the name `"+a+"`");else if(0===b.length)m.error("Can't register a group of zero handlers");else{var e={name:a,handlers:b.map(function(a,b){return{handler:a,active:!0,removed:!1,priorityIndex:0,eventCallback:null,uninstallCallback:null}})};this._nameToGroup[a]=e;for(var g=function(a){var b=e.handlers[a];c._handlers.push(b);b.handler.onInstall({updateDependencies:function(){d.updateDependencies()},
emit:function(a,e){d._emitInputEvent(b.priorityIndex,a,e)},setPointerCapture:function(a,g){d._setPointerCapture(e,b,a,g)},setEventCallback:function(a){b.eventCallback=a},setUninstallCallback:function(a){b.uninstallCallback=a}})},c=this,f=e.handlers.length-1;0<=f;f--)g(f);this.updateDependencies()}};c.prototype.uninstallHandlers=function(a){var b=this._nameToGroup[a];b?(b.handlers.forEach(function(a){a.removed=!0;a.uninstallCallback()}),delete this._nameToGroup[a],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=
!0:this._garbageCollectRemovedHandlers()):m.error("There is no InputHandler group registered under the name `"+a+"`")};c.prototype.hasHandlers=function(a){return void 0!==this._nameToGroup[a]};c.prototype.updateDependencies=function(){var a=new Set,b=new Set;this._handlersPriority=[];for(var d=this._handlers.length-1;0<=d;d--){var e=this._handlers[d];e.priorityIndex=d;this._handlersPriority.push(e)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(d=this._handlersPriority.length-
1;0<=d;d--){e=this._handlersPriority[d];e.priorityIndex=d;var g=e.handler.hasSideEffects;if(!g)for(var c=0,f=e.handler.outgoingEventTypes;c<f.length;c++)if(a.has(f[c])){g=!0;break}if(g){c=0;for(f=e.handler.incomingEventMatches;c<f.length;c++){var h=f[c];a.add(h.eventType);for(var k=0,h=h.keyModifiers;k<h.length;k++){var q=h[k];p.isSystemModifier(q)||b.add(q)}}}e.active=g}this._sourceEvents=a;this._keyModifiers=b;0<this._pointerCaptures.size&&this._sourceEvents.add("pointer-capture-lost");0<this._keyModifiers.size&&
(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up"));this._browserEvents&&(this._browserEvents.activeEvents=this._sourceEvents)};c.prototype._onEventReceived=function(a,b){"pointer-capture-lost"===a&&this._pointerCaptures.delete(b.native.pointerId);this._updateKeyModifiers(a,b);this._emitInputEventFromSource(a,b)};c.prototype._updateKeyModifiers=function(a,b){var d=this;if(b){if("key-down"===a||"key-up"===a){var e=b.key;this._keyModifiers.has(e)&&("key-down"===a?this._activeKeyModifiers.add(e):
this._activeKeyModifiers.delete(e))}var e=b.native,c=function(a,b){b?d._activeKeyModifiers.add(a):d._activeKeyModifiers.delete(a)};c("Alt",!(!e||!e.altKey));c("Ctrl",!(!e||!e.ctrlKey));c("Shift",!(!e||!e.shiftKey));c("Meta",!(!e||!e.metaKey));c("Primary",this._activeKeyModifiers.has(this.primaryKey))}};c.prototype._installRecognizers=function(a){a||(a=s.defaults.map(function(a){return new a}));0<a.length&&this.installHandlers("default",a)};c.prototype._setPointerCapture=function(a,b,d,e){a=a.name+
"-"+b.priorityIndex;b=this._pointerCaptures[d.pointerId]||new Set;this._pointerCaptures[d.pointerId]=b;e?(b.add(a),1===b.size&&this._browserEvents&&this._browserEvents.setPointerCapture(d,!0)):(b.delete(a),0===b.size&&(this._pointerCaptures.delete(d.pointerId),this._browserEvents&&this._browserEvents.setPointerCapture(d,!1)))};c.prototype._garbageCollectRemovedHandlers=function(){this._handlers=this._handlers.filter(function(a){return!a.removed});this.updateDependencies()};c.prototype._emitInputEventFromSource=
function(a,b){this._emitInputEvent(0,a,b)};c.prototype._emitInputEvent=function(a,b,d){b=new u(b,d);this._currentPropagation?this._currentPropagation.addedEvents.push(b):this._doNewPropagation(a,b)};c.prototype._doNewPropagation=function(a,b){for(var d=this._currentPropagation={events:[b],addedEvents:[],currentHandler:this._handlersPriority[a],needsHandlerGarbageCollect:!1};d.currentHandler;){if(d.currentHandler.removed)d.needsHandlerGarbageCollect=!0;else{var e=d.events,c=[];d.addedEvents=[];for(var l=
0;l<e.length;l++){var f=e[l];d.currentHandler.active&&d.currentHandler.eventCallback(f,this._activeKeyModifiers);f.shouldStopPropagation()||c.push(f)}d.events=c.concat(d.addedEvents)}d.currentHandler=this._handlersPriority[d.currentHandler.priorityIndex+1]}d.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers();this._currentPropagation=null};c.prototype._compareHandlerPriority=function(a,b){if(a.handler.hasSideEffects!==b.handler.hasSideEffects)return a.handler.hasSideEffects?1:-1;for(var d=
0,e=a.handler.incomingEventMatches;d<e.length;d++)for(var c=e[d],l=function(a){if(c.eventType!==a.eventType)return"continue";var b=c.keyModifiers.filter(function(b){return-1!==a.keyModifiers.indexOf(b)});if(b.length===c.keyModifiers.length!==(b.length===a.keyModifiers.length))return{value:c.keyModifiers.length>a.keyModifiers.length?-1:1}},f=0,h=b.handler.incomingEventMatches;f<h.length;f++){var k=l(h[f]);if("object"===typeof k)return k.value}return a.priorityIndex>b.priorityIndex?-1:1};c.prototype._sortHandlersPriority=
function(a){for(var b=[],d=0;d<a.length;d++){for(var c=a[d],g=0;g<b.length&&0<=this._compareHandlerPriority(c,b[g]);)g++;b.splice(g,0,c)}return b};return c}();r.InputManager=n;var u=function(){function c(a,b){this.type=a;this.data=b;this._stopPropagation=!1;this.timestamp=Date.now()}c.prototype.stopPropagation=function(){this._stopPropagation=!0};c.prototype.shouldStopPropagation=function(){return this._stopPropagation};return c}()});