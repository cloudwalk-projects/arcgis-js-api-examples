// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/accessorSupport/decorators dojo/_base/lang ../../core/Accessor ../../core/watchUtils ../../core/HandleRegistry".split(" "),function(q,r,k,f,d,l,m,n,p){return function(g){function a(b){g.call(this);this.isDone=!1;this.extent=this.spatialReference=null;this.mapCollectionPaths=a.DefaultMapCollectionPaths.slice();this._handles=new p;this._waitTask=null;this._isStarted=!1}k(a,g);a.prototype.normalizeCtorArgs=
function(b){b=l.mixin({},b);this._set("view",b.view);delete b.view;return b};a.prototype.initialize=function(){var b=this;this.watch("mapCollectionPaths",function(){b._isStarted&&(b.reset(),b.start())})};a.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null,this._isStarted=!1);this._cancelLoading()};a.prototype.reset=function(){this._handles.removeAll();this._isStarted=!1;this._set("spatialReference",null);this._set("extent",null);this._set("isDone",!1)};a.prototype.start=
function(){this._handles.removeAll();this._isStarted=!0;for(var b=this._updateLayerChange.bind(this),a=0;a<this.mapCollectionPaths.length;a++)this._handles.add(n.on(this.view,"map."+this.mapCollectionPaths[a],"change",b,b,b))};a.prototype.supportedSpatialReferenceForLayer=function(b){if(b.spatialReference&&this.view.isSpatialReferenceSupported(b.spatialReference,b))return b.spatialReference};a.prototype._ownerNameFromCollectionName=function(b){var a=b.lastIndexOf(".");return-1===a?"view":"view."+
b.slice(0,a)};a.prototype._ensureLoadedOwnersFromCollectionName=function(b){b=this._ownerNameFromCollectionName(b).split(".");for(var a,c=0;c<b.length;c++){a=this.get(b.slice(0,c+1).join("."));if(!a)break;if(a.load&&!a.isFulfilled())return{owner:null,loading:a.load()}}return{owner:a}};a.prototype._cancelLoading=function(){this._waitTask=null};a.prototype._updateWhen=function(a){var h=this,c=!0,e=!1,d=a.always(function(){c?e=!0:d===h._waitTask&&h._update()}),c=!1;e||(this._waitTask=d);return e};a.prototype._updateLayerChange=
function(){this.spatialReference||this.isDone&&this._set("isDone",!1);this._update()};a.prototype._update=function(){this._cancelLoading();if(!this.isDone){for(var a=!1,d=0;d<this.mapCollectionPaths.length;d++){var c="map."+this.mapCollectionPaths[d],e=this._ensureLoadedOwnersFromCollectionName(c);if(e.loading&&!this._updateWhen(e.loading)){a=!0;break}if((e=e.owner)&&(!e.isRejected||!e.isRejected()))if((c=this.view.get(c))&&this._processSpatialReferenceSources(c)){a=!0;break}}a||this._set("isDone",
!0);this.isDone&&!this.spatialReference&&this.defaultSpatialReference&&this._set("spatialReference",this.defaultSpatialReference)}};a.prototype._processSpatialReferenceSources=function(a){for(var d=0;d<a.length;d++){var c=a.getItemAt(d);if(c.load&&!c.isFulfilled()&&!this._updateWhen(c.load()))return!0;if(!c.load||c.isResolved()){var e=c.fullExtent,f=this.supportedSpatialReferenceForLayer(c);(f||!this.extent)&&e&&this._set("extent",e);if(f)return this._set("spatialReference",f),this._set("isDone",
!0),!0;if(c.layers&&this._processSpatialReferenceSources(c.layers))return!0}}return!1};a.DefaultMapCollectionPaths=["basemap.baseLayers","layers","ground.layers","basemap.referenceLayers"];f([d.property({readOnly:!0})],a.prototype,"isDone",void 0);f([d.property({readOnly:!0})],a.prototype,"view",void 0);f([d.property({readOnly:!0})],a.prototype,"spatialReference",void 0);f([d.property({readOnly:!0})],a.prototype,"extent",void 0);f([d.property()],a.prototype,"mapCollectionPaths",void 0);f([d.property()],
a.prototype,"defaultSpatialReference",void 0);return a=f([d.subclass("esri.views.support.DefaultsFromMap")],a)}(d.declared(m))});