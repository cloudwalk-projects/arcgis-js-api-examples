// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports dojo/_base/kernel dojo/_base/lang dojo/_base/url dojo/Deferred ../../kernel ../../config ../../request ../Logger ../urlUtils ./WorkerFallbackImpl".split(" "),function(q,D,u,v,w,r,x,e,y,z,h,n){function A(){if(!B){var c=void 0;try{c=new Worker(l)}catch(b){m.warn("Failed to create Worker. Fallback to execute module in main thread",event),c=new n}return s(c)}if(!p){var c=new w(l),k=e.defaults?e.defaults.io.corsEnabledServers:e.request.corsEnabledServers;-1===k.indexOf(c.host)&&
k.push(c.host);p=y(l,{responseType:"text"})}return p.then(function(b){var a;try{a=new Worker(URL.createObjectURL(new Blob([b.data],{type:"text/javascript"})))}catch(d){m.warn("Failed to create Worker. Fallback to execute module in main thread",d),a=new n}return s(a)})}function s(c){function b(a){if(a&&a.data&&a.data.type)if(a=a.data.type,"\x3cworker-loaded\x3e"===a){a=c;var d;null!=e["default"]?(d=v.mixin({},e),delete d["default"],d=JSON.parse(JSON.stringify(d))):d=JSON.parse(JSON.stringify(e));a.postMessage({type:"\x3cconfigure\x3e",
configure:{esriConfig:d,dojoConfig:{async:!0,baseUrl:C,locale:u.locale,has:{"esri-cors":1,"dojo-test-sniff":0,"config-deferredInstrumentation":0},paths:{esri:"esri",dojo:"dojo",dojox:"dojox",dstore:"dstore",moment:"moment"}},loaderUrl:t}})}else"\x3cworker-configured\x3e"===a&&(c.removeEventListener("message",b),c.removeEventListener("error",k),f.resolve(c))}function k(a){a.preventDefault();c.removeEventListener("message",b);c.removeEventListener("error",k);m.warn("Failed to create Worker. Fallback to execute module in main thread",
a);c=new n;c.addEventListener("message",b);c.addEventListener("error",k)}var f=new r;c.addEventListener("message",b);c.addEventListener("error",k);return f.promise}var m=z.getLogger("esri.core.workers"),l=h.makeAbsolute(q.toUrl("./worker.js")),t=h.makeAbsolute(q.toUrl("dojo/dojo.js")),C=h.makeAbsolute("../../",t)+"/",B=!h.hasSameOrigin(l,location.href),p=null;return function(){function c(b,c,f){var a=this;this.connections=b;this.index=c;this.workerInitCallback=f;this.msgCount=0;this.outgoingJobs=
{};this.incomingJobs={};this.incomingStaticJobs={};A().then(function(b){a.worker=b;a.worker.addEventListener("message",a.message.bind(a));a.worker.addEventListener("error",function(a){a.preventDefault();m.error(a)});a.workerInitCallback(a.index)})}c.prototype.terminate=function(){this.worker.terminate()};c.prototype.openConnection=function(b,c){return this.invoke("\x3copen-connection\x3e",{path:b},void 0,c)};c.prototype.closeConnection=function(b){this.invoke("\x3cclose-connection\x3e",void 0,void 0,
b)};c.prototype.invoke=function(b,c,f,a){var d=this,g=++this.msgCount,e=new r(function(b){d.worker.postMessage({type:"\x3ccancel\x3e",id:g,connection:a,data:{reason:b}});d.outgoingJobs[g]&&delete d.outgoingJobs[g]});this.outgoingJobs[g]=e;this.worker.postMessage({type:b,id:g,connection:a,data:c},f);return e.promise};c.prototype.message=function(b){var c=this;if(b&&b.data){var f=b.data.type;if(f){var a=b.data,d=b.data.id;if("\x3cresponse\x3e"===f&&d){if(b=this.outgoingJobs[d])delete this.outgoingJobs[d],
a.error?b.reject(a.error):b.resolve(a.data)}else if("\x3ccancel\x3e"===f&&d)(b=this.incomingJobs[d])&&b.cancel(a.data.reason),a.staticMsg&&(b=this.incomingStaticJobs[d])&&b.cancel(a.data.reason);else if("\x3cstatic-message\x3e"===f){var g=a.staticMsg;b=x.workerMessages[g];!b||"function"!==typeof b?this.worker.postMessage({type:"\x3cstatic-message\x3e",staticMsg:g,id:d,error:b+" message type is not available on the kernel!"}):(a=b.call(this,a.data),this.incomingStaticJobs[d]=a,a.then(function(a){c.worker.postMessage({type:"\x3cstatic-message\x3e",
staticMsg:g,id:d,data:a.data},a.buffers)}).otherwise(function(a){a||(a="Error encountered at method"+g);(!a.dojoType||"cancel"!==a.dojoType)&&c.worker.postMessage({type:"\x3cstatic-message\x3e",staticMsg:g,id:d,error:a})}).always(function(){delete c.incomingStaticJobs[d]}))}else{var e=a.connection;if(b=this.connections[e])if(b=b.client){var h=b[f];"function"===typeof h&&(a=h.call(b,a.data),this.incomingJobs[d]=a,a.then(function(a){c.worker.postMessage({type:"\x3cresponse\x3e",id:d,connection:e,error:a.error,
data:a.data},a.buffers)}).otherwise(function(a){a||(a="Error encountered at method"+f);(!a.dojoType||"cancel"!==a.dojoType)&&c.worker.postMessage({type:"\x3cresponse\x3e",id:d,connection:e,error:a})}).always(function(){delete c.incomingJobs[d]}))}}}}};return c}()});