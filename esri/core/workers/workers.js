// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports dojo/Deferred dojo/promise/all ../promiseUtils ./Connection ./JobProxy".split(" "),function(B,h,r,s,n,t,u){function v(a,b){for(var c=[],f=0,w=e.length;f<w;f++)c.push(e[f].openConnection(a,b));return s(c).then(function(a){})}function x(a){k[a]=!0;if(!l&&k.every(function(a){return a})){for(var b in g)(a=m[b])&&g[b].resolve(a);g={};l=!0}}function y(a){var b=z++;a=new t(a,b);var c=new r;m[b]=a;l?c.resolve(a):g[b]=c;return c.promise}var A=Math.max((navigator.hardwareConcurrency||
2)-1,2),l=!1,e=[],k=[],p=0,z=0,m={},g={},q=!1;h.open=function(a,b){if(!1===q){for(var c=0;c<A;++c){var f=new u(m,c,x);e.push(f);k.push(!1)}q=!0}return y(a).then(function(a){return v(b,a.id).then(function(){return a}).otherwise(function(a){return n.reject(a)})})};h.terminate=function(){for(var a=0,b=e.length;a<b;a++)e[a].terminate();e=[];k=[];l=!1};h.closeConnection=function(a){if(a)if(m[a.id]&&delete m[a.id],l)for(var b=0,c=e.length;b<c;b++)e[b].closeConnection(a.id);else if(b=g[a.id])b.promise.cancel(),
delete g[a.id]};h.invoke=function(a,b,c,f,g){var d=null;f&&(d=f.id);if(null===d&&(d=p=(p+1)%e.length,!k[d]&&!e.some(function(a,b,c){d=(d+1)%c.length;return k[d]})))return n.reject(Error("No worker available"));a=e[d].invoke(a,b,c,g);f&&(f.id=d);return a};h.broadcast=function(a,b,c,f){for(var g=[],d=0,h=e.length;d<h;d++)k[d]&&g.push(e[d].invoke(a,b,c,f));return g}});