// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("dojo/has ../ObjectPool ../ArrayPool ../Scheduler ../lang ./Cache ./OldValues ./Property ./once ./ensureType ./introspect ./chainWatch".split(" "),function(q,r,n,w,x,t,y,z,s,u,l,A){var B=Object.prototype.hasOwnProperty,C=0,D=new r(function(){this.fn=null;this.removed=this.isExecuting=!1},function(){this.fn=null}),v=new r(function(){this.callbacks=this.oldValue=null},function(){this.oldValue=null;this.callbacks=n.release(this.callbacks);this.callbacks=null});q=function(a){this.uid="propertoire_"+
C++;this.obj=a;this.properties=Object.create(l.getProperties(a));this.cache=new t;this.watchers=Object.create(null);this.bindings=Object.create(null);this.defaults=null;this.access=Object.create(null);this._notificationsPool=new r(function(){},function(){});this.notifications=this._notificationsPool.acquire();this.cursors={}};q.prototype={obj:null,properties:null,notifyHdls:null,cache:null,watchers:null,bindings:null,initialized:!1,notifications:null,ctorArgs:null,timer:null,_boundDispatch:null,initialize:function(){this.initialized=
!0;this.notifyHdls=l.installPropertyNotifiers(this.obj);this.dispatch()},destroy:function(){this.notifyHdls&&this.notifyHdls.forEach(function(a){return a.remove()},this);this.timer&&this.timer.remove();var a=this.watchers;Object.getOwnPropertyNames(a).forEach(function(c){a[c].callbacks.forEach(function(a){a.removed=!0})});var b=this.cursors;Object.getOwnPropertyNames(b).forEach(function(a){var d=b[a];if(d){for(;0<d.length;)d.pop().moveBackward(this,a);b[a]=null}},this);this.cache.destroy();this.defaults&&
this.defaults.destroy();this.access=this.defaults=this.notifications=this.bindings=this.watchers=this.cache=this.properties=this.notifyHdls=this.timer=this.obj=null},getFromCache:function(a){var b=this.cache,c=this.defaults,d=this.properties[a];return b.has(a)?b.get(a):c&&c.has(a)?c.get(a):d.value},get:function(a,b){var c=this.cache,d=this.defaults;if(c){if(c.has(a)&&!c.isDirty(a))return c.get(a);var e=this.obj,g=this._defineProperty(a),f=g.getter,h=g.getterArity;if(c.has(a))!b&&this.propertyWillChange(a),
d=c.get(a),f&&(d=h?f.call(e,d):f.call(e)),c.set(a,d),this.propertyHasChanged(a,d);else if(f)!b&&this.propertyWillChange(a),d=h?f.call(e,g.value):f.call(e),c.set(a,d),this.propertyHasChanged(a,d);else return d&&d.has(a)?d.get(a):g.value;return d}},set:function(a,b){var c=this._defineProperty(a),d=c.getter,e=c.setter,g=c.setterArity,f=this.obj,h=this.cache;this.propertyWillChange(a);this.propertyInvalidated(a);b=u(b,c.type);if(e){if(b=2===g?e.call(f,b,this.getFromCache(a)):e.call(f,b),void 0!==b||!d)h.set(a,
b),this.propertyHasChanged(a,b)}else h.set(a,b),this.propertyHasChanged(a,b)},setDefault:function(a,b){var c=this.defaults;c||(this.defaults=c=new t);var d=this._defineProperty(a,!0),e=d.getter,g=d.setter,f=d.getterArity,h=d.setterArity,m=this.obj,k=this.cache.has(a);b=u(b,d.type);k&&c.set(a,b);k||(g&&(b=2===h?g.call(m,b,c.get(a)):g.call(m,b),e&&(b=f?e.call(m,void 0):e.call(m))),this.initialized||c.set(a,b),this.propertyWillChange(a),c.set(a,b),this.propertyHasChanged(a,b))},hasBindings:function(a){a=
this.bindings[a];return null!=a&&0<a.length},hasWatchers:function(a){a=this.watchers[a];return null!=a&&0<a.callbacks.length},bind:function(a,b){var c=this.bindings[a];c?c.push(b):(this._defineProperty(a,!0),this.bindings[a]=c=[b]);return{remove:s(function(){c.splice(c.indexOf(b),1)})}},propertyInvalidated:function(a){var b=this.cursors[a];b&&b.forEach(function(b){b.propertyInvalidated(this,a)},this)},propertyCommitted:function(a){var b=this.cursors[a];b&&b.forEach(function(b){b.propertyCommitted(this,
a)},this)},addCursor:function(a,b){var c=this.cursors[a];c||(this.cursors[a]=c=[]);c.push(b)},removeCursor:function(a,b){var c=this.cursors[a];this.cursors[a]&&(c.splice(c.indexOf(b),1),0===c.length&&(this.cursors[a]=null))},propertyDependencyMayChange:function(a,b){this._propertyWillChange(a);this.propertyInvalidated(a)},propertyWillChange:function(a){var b=this.properties[a].chain,c,d;if(b){c=0;for(d=b.length;c<d;c++)this._propertyWillChange(b[c])}this._propertyWillChange(a)},_propertyWillChange:function(a){var b=
this.cache,c=this.bindings[a],d=this.watchers[a],e=d&&d.callbacks,g=d&&d.oldValues,f=this.notifications[a],h=e&&0<e.length,m=this.initialized&&!this.timer,k=null;if(c)for(var k=0,l=c.length;k<l;k++)c[k]();h&&(f||(f=this.notifications[a]=n.acquire(),d.isDirty=!0),d.isDirty&&(d.isDirty=!1,k=v.acquire(),k.oldValue=this.get(a,!0),k.callbacks=n.copy(e),f.push(k),g&&(b.set(a,g.add(this.obj[a])),b.setDirty(a))),m&&(this._boundDispatch||(this._boundDispatch=this.dispatch.bind(this)),this.timer=w.schedule(this._boundDispatch)));
b.setDirty(a)},propertyHasChanged:function(a,b){if(this.hasBindings(a))for(var c=this.bindings[a],d=0,e=c.length;d<e;d++)c[d](b);this.propertyCommitted(a,b)},internalGet:function(a){return this.get(a,!0)},watch:function(a,b){var c=this.obj,d=this.properties,e=this.watchers[a],g;Array.isArray(a)?g=a:-1<a.indexOf(",")&&(g=a.split(/\s*,\s*/));if(g){for(var f=n.acquire(),c=0;a=g[c++];)f.push(this.watch(a,b));return{handles:f,remove:s(function(){for(var a=0,b=f.length;a<b;a++)f[a].remove();n.release(f)})}}if(-1<
a.indexOf("."))return A(c,a,b);var h=D.acquire();h.fn=b;e?(e.isDirty=!0,e.callbacks.push(h)):(this._defineProperty(a),this.get(a,!0),this.watchers[a]=e={isDirty:!0,callbacks:[h]},d[a].copy&&(e.oldValues=new y(d[a].copy)));return{remove:s(function(){h.removed=!0;e.callbacks.splice(e.callbacks.indexOf(h),1)})}},dispatch:function(){this.timer=null;var a=this.obj,b=this.notifications,c=this.watchers,d,e,g,f,h,m,k,l;this.notifications=this._notificationsPool.acquire();var p=n.acquire();for(e in b)if(f=
b[e]){b[e]=null;p.length=0;k=this.get(e);l=c[e].oldValues;for(h=0;g=f[h];h++){if(!x.equals(g.oldValue,k))for(m=0;d=g.callbacks[m];m++)!d.isExecuting&&(!d.removed&&-1===p.indexOf(d))&&(p.push(d),d.isExecuting=!0,d.fn.call(a,k,g.oldValue,e,a),d.isExecuting=!1);v.release(g)}l&&l.reset();n.release(f)}this._notificationsPool.release(b);n.release(p)},_defineProperty:function(a,b){var c=this.obj,d=this.properties,e=d[a],g,f=!1;if(e)return e;var h=l.getPropertyOwner(c,a);h&&(e=l(h).mixin.properties[a]);e||
(B.call(this.obj,a)&&(g=this.obj[a],delete this.obj[a],f=!0),b?e=l.defineProperty(this.obj,a):(e=new z(a,{value:l.getPropertyOwnerValue(c,a)}),Object.defineProperty(c,a,e.getDescriptor())),f&&this.cache.set(a,g));return d[a]=e}};return q});