// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define(["./ArrayPool","./ObjectPool","./nextTick","./requestAnimationFrame","./now"],function(l,d,n,p,k){var g=["prepare","preRender","render","postRender","update"],q=new d(function(){this.isActive=!0;this.callback=null},function(){this.isActive=!1;this.callback=null}),r=function(){},s=function(){this.item.isActive=!1;m.release(this)},h={time:0,deltaTime:0,spendInFrame:0,spendInTask:0},m=new d(function(){this.remove=s;this.item=null},function(){this.remove=r;this.item=null});d=function(){this._boundDispatch=
this._dispatch.bind(this);this.willDispatch=!1;this._queue=l.acquire();this._frameTasks=l.acquire();this._phaseTasks={};this._previousFrameTime=-1;for(var a=0;a<g.length;a++)this._phaseTasks[g[a]]=l.acquire();this._boundAnimationFrame=this._animationFrame.bind(this);this.executing=!1;this._animationFrameRequestId=null};d.prototype={schedule:function(a){var b=q.acquire();b.callback=a;this._schedule(b);a=m.acquire();a.item=b;return a},_dispatch:function(){for(var a=this._queue;a.length;){var b=a.shift();
b.isActive&&(b.isActive=!1,b.callback())}this.willDispatch=!1},_schedule:function(a){this._queue.push(a);this.willDispatch||(this.willDispatch=!0,n(this._boundDispatch))},addFrameTask:function(a){var b={phases:a,paused:!1,pausedAt:0,epoch:-1,dt:0,ticks:-1,removed:!1};this._frameTasks.push(b);for(var e=0;e<g.length;e++){var c=g[e];a[c]&&this._phaseTasks[c].push(b)}this._animationFrameRequestId||(this._previousFrameTime=-1,this._requestAnimationFrame());return{isPaused:function(){return b.paused},remove:function(){b.removed=
!0},pause:function(){b.paused=!0;b.pausedAt=k()},resume:function(){b.paused=!1;-1!==b.epoch&&(b.epoch+=k()-b.pausedAt)}}},clearFrameTasks:function(){for(var a=0;a<this._frameTasks.length;a++)this._frameTasks[a].removed=!0},_purge:function(){for(var a=0;a<this._frameTasks.length;){var b=this._frameTasks[a];a++;if(b.removed){this._frameTasks.splice(a-1,1);for(var e=0;e<g.length;e++){var c=g[e];if(b.phases[c]){var c=this._phaseTasks[c],d=c.indexOf(b);-1!==d&&c.splice(d,1)}}}}},_animationFrame:function(a){this._animationFrameRequestId=
null;this.executing=!0;0<this._frameTasks.length&&this._requestAnimationFrame();a=k();0>this._previousFrameTime&&(this._previousFrameTime=a);var b=a-this._previousFrameTime;this._previousFrameTime=a;for(var e=0;e<this._frameTasks.length;e++){var c=this._frameTasks[e];-1!==c.epoch&&(c.dt=b)}for(e=0;e<g.length;e++)for(var b=g[e],d=this._phaseTasks[b],f=0;f<d.length;f++)c=d[f],!c.paused&&!c.removed&&(0===e&&c.ticks++,-1===c.epoch&&(c.epoch=a),h.time=a,h.deltaTime=c.dt,h.spendInFrame=k()-a,h.spendInTask=
a-c.epoch,c.phases[b].call(c,h));this._purge();this.executing=!1},_requestAnimationFrame:function(){this._animationFrameRequestId=p(this._boundAnimationFrame)}};var f=new d;d.schedule=function(a){return f.schedule(a)};d.addFrameTask=function(a){return f.addFrameTask(a)};d.clearFrameTasks=function(){return f.clearFrameTasks()};Object.defineProperty(d,"executing",{get:function(){return f.executing}});d.instance=f;return d});