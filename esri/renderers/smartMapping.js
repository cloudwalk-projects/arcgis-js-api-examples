// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.
//>>built
define("esri/renderers/smartMapping","require module dojo/_base/array dojo/_base/lang dojo/has dojo/Deferred dojo/DeferredList dojo/promise/all dojo/when dojo/on ../kernel ../Color ../numberUtils ../promiseList ../lang ../styles/type ../styles/size ../styles/choropleth ../styles/heatmap ../styles/predominance ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ./UniqueValueRenderer ./ClassBreaksRenderer ./HeatmapRenderer ./BlendRenderer ./utils dojo/i18n!../nls/jsapi".split(" "),
function(Z,ua,r,B,va,u,G,wa,S,xa,ya,w,H,za,Aa,$,K,L,aa,T,Ba,U,Ca,Da,M,Ea,Fa,y,Ga){function l(a,c){a.reject(Error(c))}function ba(a,c){if(a.loaded)c.call();else xa.once(a,"load",c)}function v(a,c,b,d){var e;switch(b){case "point":e=new Ba;e.setColor(c);e.setSize(null!=d?d:a.size);c=new U;c.setColor(a.outline.color);c.setWidth(a.outline.width);e.setOutline(c);break;case "line":e=new U;e.setColor(c);e.setWidth(null!=d?d:a.width);break;case "polygon":e=new Ca,e.setColor(c),c=new U,c.setColor(a.outline.color),
c.setWidth(a.outline.width),e.setOutline(c)}return e}function D(a){a=a.geometryType;"esriGeometryPoint"===a||"esriGeometryMultipoint"===a?a="point":"esriGeometryPolyline"===a?a="line":"esriGeometryPolygon"===a&&(a="polygon");return a}function V(a,c){var b=a.scheme;b=b?$.cloneScheme(b):(b=$.getSchemes({theme:a.theme||ca,basemap:a.basemap,geometryType:c}))&&b.primaryScheme;return b}function da(a,c){return a.label<c.label?-1:a.label>c.label?1:0}function ea(a,c){return a.value<c.value?-1:a.value>c.value?
1:0}function Ha(a,c){var b=c.count-a.count;0===b&&(b=da(a,c));return b}function Ia(a,c){var b=c.count-a.count;0===b&&(b=ea(a,c));return b}function Ja(a,c,b){var d;B.isFunction(c)?d=c:"count"===c?(d=Ia,b&&b.codedValues&&(d=Ha)):"value"===c&&(d=ea,b&&b.codedValues&&(d=da));d&&a.sort(d)}function fa(a,c,b){var d=b.layer,e=b.field,f=B.isFunction(e),g=e&&!f?d.getField(e):null,h=g?d.getDomain(g.name):null,m,k=-1,p,l=null==b.numTypes?10:-1===b.numTypes?a.length:b.numTypes,f=null==b.showOthers?!0:b.showOthers,
n=null==b.sortBy?"count":b.sortBy,s=b&&b.labelCallback,t=D(d),q=V(b,t),d=new Da(null,e),e=b.predominanceScheme,u=b.useSizeInfo,w,x;if(e){var C=(w="polygon"===t)&&u,F=e.sizeInfo,u=u?w?F.marker:F:null;if(F=C&&F?F.background:null)d.backgroundFillSymbol=v(F,F.color,"polygon");w=x=w?C?u.size:null:"line"===t?e.width:e.size;q=e;t=C?"point":t}var I={domain:h,fieldInfo:g};r.forEach(a,function(a,c){I.value=a.value;a.label=y.createUniqueValueLabel(I);s&&(a.label=s(a));null===a.value&&(k=c)});-1<k&&(p=a.splice(k,
1)[0]);Ja(a,n,h);g&&g.type===J&&(I.dateFormatInterval=y.calculateDateFormatInterval(r.map(r.filter(a,function(a,c){return c<l}),function(a){return a.value})));m=A.createColors(q.colors,a.length);r.forEach(a,function(a,c){I.value=a.value;a.label=y.createUniqueValueLabel(I);s&&(a.label=s(a));a.symbol=v(q,m[c],t,x)});b.valueExpression&&(d.setValueExpression(b.valueExpression),d.valueExpressionTitle=b.valueExpressionTitle);d.legendOptions=b.legendOptions;m=A.createColors(q.colors,l);for(g=0;g<l;g++)(h=
a[g])&&d.addValue({value:h.value,label:h.label,symbol:v(q,m[g],t,x)});f&&(d.defaultSymbol=v(q,q.noDataColor,t,w),d.defaultLabel=E.other);p&&(p.symbol=v(q,q.noDataColor,t,w),a.push(p));c&&c.widthInfo&&d.setVisualVariables([c.widthInfo]);return{renderer:d,uniqueValueInfos:a,othersStartIndex:d.infos.length===a.length?-1:d.infos.length,scheme:e?T.cloneScheme(e):V(b,t)}}function N(a,c,b){var d=a.scheme;d=d?L.cloneScheme(d):(d=L.getSchemes({theme:b||a.theme||Ka,basemap:a.basemap,geometryType:c}))&&d.primaryScheme;
return d}function W(a){var c=a.avg,b=c-a.stddev,d=c+a.stddev;b<a.min&&(b=a.min);d>a.max&&(d=a.max);a=H.round([b,d],{strictBounds:!0});b=a[0];d=a[1];a=[b,b+(c-b)/2,c,c+(d-c)/2,d];return H.round(a,{strictBounds:!0})}function La(a,c,b){var d=(c-a)/(b-1),e,f=[a];for(e=1;e<=b-2;e++)f.push(a+e*d);f.push(c);return H.round(f,{strictBounds:!0})}function O(a,c,b,d){var e,f;a=a.statisticsPlugin.getSuggestedDataRange({statistics:c,isDate:b});if(a.defaultStatistics)e=a.min,f=a.max;else if(d&&(null==c.avg||!c.stddev))e=
c.min,f=c.max;return null!=e?[e,f]:null}function ga(a,c,b,d,e){var f=null==d.useDefaultStatistics?!0:d.useDefaultStatistics;if(a&&!a.count&&!f)l(e,"smartMapping.createColorInfo: cannot create renderer when statistics.count is 0.");else{var g=d.layer,h=d.field,m=B.isFunction(h),k=(m=h&&!m?g.getField(h):null)&&m.type===J,m=D(g),p=N(d,m),z=d.semiContinuous,n,s,t,q=c&&c.classBreakInfos,u=q&&q.length,v=c?u:5;if(p){var x=c&&-1<p.id.indexOf("seq-")?ha(p,{length:v}):A.createColors(p.colors,v);if(x.length<
v)l(e,"smartMapping.createColorInfo: not enough colors in the scheme.");else{if(c){n=[];var C;1===u?(s=[q[0].minValue,q[0].maxValue],n=[0,1],C=A.createColors(x,v)[0],t=[C,new w(C)]):z?(s=[],t=[],r.forEach(q,function(a,c){var d=0.1*(a.maxValue-a.minValue);0===c?s.push(a.minValue):s.push(a.minValue+d);c===u-1?s.push(a.maxValue):s.push(a.maxValue-d);C=new w(x[c]);t.push(C);t.push(new w(C));n.push(2*c);n.push(2*c+1)})):(s=r.map(q,function(a,c){n.push(c);return(a.minValue+a.maxValue)/2}),t=A.createColors(x,
v));s=H.round(s,{strictBounds:!0})}else s=(f=f?O(g,a,k,!0):null)?La(f[0],f[1],5):W(a),n=[0,2,4],t=A.createColors(x,v);b={type:"colorInfo",field:h,valueExpression:d.valueExpression,valueExpressionTitle:d.valueExpressionTitle,normalizationField:b,stops:y.createColorStops({values:s,isDate:k,dateFormatOptions:k?y.timelineDateFormatOptions:null,colors:t,labelIndexes:n}),legendOptions:d.legendOptions};e.resolve({colorInfo:b,statistics:a,classBreaks:c,scheme:N(d,m)})}}else l(e,"smartMapping.createColorInfo: unable to find the specified scheme.")}}
function ia(a,c,b,d){var e=null==b.useDefaultStatistics?!0:b.useDefaultStatistics;if(a&&!a.count&&!e)l(d,"smartMapping.createOpacityInfo: cannot create opacityInfo when statistics.count is 0.");else{var f=b.layer,g=b.field,h=g&&!B.isFunction(g)?f.getField(g):null,m=h&&h.type===J,k=(h=b.useStdDev)?W(a):null,f=(e=e?O(f,a,m,h):null)||(h?[k[0],k[4]]:[a.min,a.max]);d.resolve({opacityInfo:{type:"opacityInfo",field:g,valueExpression:b.valueExpression,valueExpressionTitle:b.valueExpressionTitle,normalizationField:c,
stops:[{value:f[0],opacity:0.3},{value:f[1],opacity:0.7}],legendOptions:b.legendOptions},statistics:a,defaultStatistics:!!e})}}function P(a,c){var b=a.scheme;b=b?K.cloneScheme(b):(b=K.getSchemes({theme:a.theme||Ma,basemap:a.basemap,geometryType:c}))&&b.primaryScheme;return b}function ja(a,c){var b;switch(c){case "point":b=[a.minSize,a.maxSize];break;case "line":b=[a.minWidth,a.maxWidth];break;case "polygon":b=[a.marker.minSize,a.marker.maxSize]}return b}function ka(a,c,b,d,e){var f=null==d.useDefaultStatistics?
!0:d.useDefaultStatistics,g=c&&[c.minSize,c.maxSize];if(a&&!a.count&&!f)l(e,"smartMapping.createSizeInfo: cannot create renderer when statistics.count is 0.");else{var h=d.layer,m=d.field,k=m&&!B.isFunction(m)?h.getField(m):null,p=k&&k.type===J,k=D(h),z=P(d,k),g=g||ja(z,k),n=(z=d.useStdDev)?W(a):null,h=(f=f?O(h,a,p,z):null)||(z?[n[0],n[4]]:[a.min,a.max]);e.resolve({sizeInfo:{type:"sizeInfo",field:m,valueExpression:d.valueExpression,valueExpressionTitle:d.valueExpressionTitle,valueUnit:"unknown",normalizationField:b,
legendOptions:d.legendOptions,minSize:g[0],maxSize:g[1],minDataValue:h[0],maxDataValue:h[1]},statistics:a,defaultStatistics:!!f,suggestedSizeRange:c,scheme:P(d,k)})}}function Q(a,c,b){var d,e=[],f=1/(b+1);for(d=1;d<=b;d++)e.push(w.blendColors(a,c,f*d));return e}function la(a,c){var b=[];if(1===c)b=[a[0]];else if(2===c)b=[a[0],a[2]];else if(3===c)b=a;else{var d=c-a.length,b=d/2;0===d%2?(d=Q(a[0],a[1],b),b=Q(a[1],a[2],b)):(d=Q(a[0],a[1],Math.floor(b)),b=Q(a[1],a[2],Math.ceil(b)));b=[a[0]].concat(d).concat([a[1]]).concat(b).concat([a[2]])}return b}
function ha(a,c,b){var d,e=c.length,f=-1;b&&r.some(c,function(a,c){a.hasAvg&&(f=c);return-1<f});if(-1<f){var g=a.colors;a=f+1;c=e-f;b=g.slice(0,3);g=g.slice(2);b.reverse();b=la(b,a);g=la(g,c);b.reverse();d=[].concat(b).concat(g.slice(1))}else if((a=a.colorsForClassBreaks)&&0<a.length)if(r.some(a,function(a){a.numClasses===e&&(d=a.colors);return!!d}),!d&&(b=a[a.length-1],a=e-b.numClasses,0<a)){c=b.colors[b.numClasses-1];d=b.colors.splice(0);for(b=1;b<=a;b++)d.push(c)}d&&(d=A.createColors(d,d.length));
return d}function Na(a,c,b,d){var e=b.field,f=D(b.layer),g=null==b.showOthers?!0:b.showOthers,h=b.classificationMethod||"equal-interval",m="standard-deviation"===h,k=b.normalizationType,p,z,n,s=a.classBreakInfos;(p=N(b,f,"high-to-low"))?(z=ha(p,s),!z||z.length!=s.length?l(d,"smartMapping.createClassedColorRenderer: unable to find suitable colors for number of classes."):(n=new M(null,e),b.valueExpression&&(n.setValueExpression(b.valueExpression),n.valueExpressionTitle=b.valueExpressionTitle),n.legendOptions=
b.legendOptions,n.classificationMethod=h,n.normalizationType=k,n.normalizationField="field"===k?b.normalizationField:void 0,n.normalizationTotal="percent-of-total"===k?a.normalizationTotal:void 0,g&&(n.defaultSymbol=v(p,p.noDataColor,f),n.defaultLabel=E.other),r.forEach(s,function(a,c){n.addBreak({minValue:a.minValue,maxValue:a.maxValue,symbol:v(p,z[c],f),label:a.label})}),m||y.setLabelsForClassBreaks({classBreaks:n.infos,classificationMethod:h,normalizationType:k,round:!0}),c&&c.widthInfo&&n.setVisualVariables([c.widthInfo]),
a.renderer=n,a.scheme=N(b,f,"high-to-low"),d.resolve(a))):l(d,"smartMapping.createClassedColorRenderer: unable to find suitable style scheme.")}function ma(a){var c=new u,b=a.layer,d=null==a.useDefaultBreaks?!0:a.useDefaultBreaks,e=a.optimizeOutline,f=[b.statisticsPlugin.getClassBreaks(a)];e&&f.push(b.statisticsPlugin.getSuggestedOutline("object"===typeof e?e:null));(new G(f)).then(function(f){var h=f[0];f=f[1];var m=e&&f[0]?f[1]:null;if(h[0]||d&&!b.graphics.length){var h=h[1],k=d?O(b,h?{min:h.minValue,
max:h.maxValue}:{}):null;k&&(h=a.layer.statisticsPlugin.getClassBreaks(B.mixin(a,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:k[0],maxValue:k[1],normalizationTotal:k[0]+k[1]})));S(h).then(function(a){a.defaultStatistics=!!k;c.resolve({cbResponse:a,suggestedOutline:m})}).otherwise(function(){l(c,"smartMapping: error when calculating default class breaks.")})}else l(c,"smartMapping: error when calculating class breaks.")});return c.promise}function Oa(a,c,b,d){c=d||ja(a,
c);a=c[0];c=(c[1]-a)/(4<=b?b-1:b);var e=[];for(d=0;d<b;d++)e.push(a+c*d);return e}function X(a,c,b,d,e){var f=d.field,g=D(d.layer),h=null==d.showOthers?!0:d.showOthers,m=d.classificationMethod||"equal-interval",k=d.normalizationType,p=a.classBreakInfos,l=P(d,g),n=Oa(l,g,p.length,c),s="polygon"===g,t=s?l.marker:l;c=s?l.background:null;var q;q=new M(null,f);d.valueExpression&&(q.setValueExpression(d.valueExpression),q.valueExpressionTitle=d.valueExpressionTitle);q.legendOptions=d.legendOptions;q.classificationMethod=
m;q.normalizationType=k;q.normalizationField="field"===k?d.normalizationField:void 0;q.normalizationTotal="percent-of-total"===k?a.normalizationTotal:void 0;h&&(q.defaultSymbol=v(t,t.noDataColor,s?"point":g),q.defaultLabel=E.other);c&&(q.backgroundFillSymbol=v(c,c.color,g));r.forEach(p,function(a,c){q.addBreak({minValue:a.minValue,maxValue:a.maxValue,symbol:v(t,t.color,s?"point":g,n[c]),label:a.label})});"standard-deviation"!==m&&y.setLabelsForClassBreaks({classBreaks:q.infos,classificationMethod:m,
normalizationType:k,round:!0});b&&b.widthInfo&&q.setVisualVariables([b.widthInfo]);a.renderer=q;a.scheme=P(d,g);e.resolve(a)}function Y(a){var c=a.scheme;c=c?aa.cloneScheme(c):(c=aa.getSchemes({theme:a.theme||Pa,basemap:a.basemap}))&&c.primaryScheme;return c}function na(a,c,b){var d=null==c.useDefaultStatistics?!0:c.useDefaultStatistics;if(!a.count&&!d)l(b,"smartMapping.createHeatmapRenderer: cannot create renderer when statistics.count is 0.");else{var e=a.fieldOffset,f=null==c.blurRadius?10:c.blurRadius,
g=null==c.minRatio?0.01:c.minRatio,h=null==c.maxRatio?1:c.maxRatio,m=null==c.fadeToTransparent?!0:c.fadeToTransparent,k=Y(c).colors,p=k.length,z=(d=!a.count&&d)?[0,100]:[a.min,a.max],n=new Ea;n.setBlurRadius(f);n.setField(c.field);null!=e&&n.setFieldOffset(e);n.setMinPixelIntensity(z[0]);n.setMaxPixelIntensity(z[1]);var e=k[0],s=[{ratio:0,color:new w([e.r,e.g,e.b,0])},{ratio:oa,color:new w([e.r,e.g,e.b,0])},{ratio:m?g:oa,color:e}],t=(h-g)/(p-1),k=A.createColors(k,p);r.forEach(k,function(a,c){s.push({ratio:g+
t*c,color:a})});n.setColorStops(s);b.resolve({renderer:n,statistics:a,defaultStatistics:d,scheme:Y(c)})}}function Qa(a,c){var b=a.scheme;b=b?T.cloneScheme(b):(b=T.getSchemes({theme:a.theme||ca,basemap:a.basemap,geometryType:c}))&&b.primaryScheme;return b}function Ra(a,c){var b={};r.forEach(a,function(a){var e=c.getField(a.name);b[a.name]=a.label||e&&e.alias||a.name});return function(a){return b[a.value]}}function Sa(a){return function(c,b){var d=r.indexOf(a,c.value),e=r.indexOf(a,b.value);return d-
e}}function Ta(a,c,b,d,e){var f=new u,g=a.layer;g.statisticsPlugin.getPredominantCategories({fields:c}).always(function(h){if(!h||!h.predominantCategoryInfos)h={predominantCategoryInfos:r.map(c,function(a){return{value:a,count:0}})};var m=fa(h.predominantCategoryInfos,e,{layer:g,valueExpression:d.valueExpression,labelCallback:Ra(a.fields,g),numTypes:-1,showOthers:a.showOthers,sortBy:Sa(c),predominanceScheme:b,useSizeInfo:a.includeSizeInfo});m.predominantCategoryInfos=m.uniqueValueInfos;delete m.uniqueValueInfos;
m.source=h.source;f.resolve(m)});return f.promise}function Ua(a,c,b,d){var e=new u;A.createSizeInfo({layer:a.layer,valueExpression:d.valueExpression,sqlExpression:d.statisticsQuery.sqlExpression,sqlWhere:d.statisticsQuery.sqlWhere,scheme:b,optimizeForScale:a.optimizeForScale}).then(function(a){a.sizeInfo.legendOptions={title:E.sumOfCategories};e.resolve(a)}).otherwise(function(a){l(e,"smartMapping.createPredominanceRenderer: error when calculating statistics for visual variable(size).")});return e.promise}
function Va(a,c,b){var d=new u;a.layer.statisticsPlugin.getFieldStatistics({valueExpression:b.valueExpression,sqlExpression:b.statisticsQuery.sqlExpression,sqlWhere:b.statisticsQuery.sqlWhere}).then(function(a){var f=null==a.avg||null==a.stddev,g=100*(1/c.length),h=f?100:a.avg+1.285*a.stddev;100<h&&(h=100);g=H.round([g,h],{strictBounds:!0});d.resolve({opacityInfo:{type:"opacityInfo",valueExpression:b.valueExpression,stops:[{value:g[0],opacity:0.15},{value:g[1],opacity:1}],legendOptions:{title:E.strengthOfPredominance}},
statistics:a,defaultStatistics:f})}).otherwise(function(a){l(d,"smartMapping.createPredominanceRenderer: error when calculating statistics for visual variable(opacity).")});return d.promise}function Wa(a,c,b,d){var e=D(a.layer),f=Qa(a,e);a.layer.statisticsPlugin.getPredominanceExpressions({fields:c}).then(function(e){var h=Ta(a,c,f,e.predominantCategory,b),m,k;a.includeSizeInfo&&(m=Ua(a,c,f.sizeInfo,e.size));a.includeOpacityInfo&&(k=Va(a,c,e.opacity));za([h,m,k]).then(function(a){var c=a[0],b=a[1],
e=a[2];a=[];if(c instanceof Error)l(d,"smartMapping.createPredominanceRenderer: unable to create unique-value renderer.");else{if(m){if(b instanceof Error){l(d,"smartMapping.createPredominanceRenderer: unable to create visual variable for symbol size.");return}a.push(y.cloneSizeInfo(b.sizeInfo));delete b.scheme;c.size=b}if(k){if(e instanceof Error){l(d,"smartMapping.createPredominanceRenderer: unable to create visual variable for symbol opacity.");return}a.push(y.cloneOpacityInfo(e.opacityInfo));
c.opacity=e}if(a.length){if(b=c.renderer.visualVariables)Array.prototype.push.apply(b,a),a=b;c.renderer.setVisualVariables(a)}d.resolve(c)}})}).otherwise(function(a){l(d,"smartMapping.createPredominanceRenderer: unable to generate expressions.")})}function pa(a,c,b){var d=a;if("string"===typeof a)(a=b.getField(a))&&a.type===J&&(d=b.getFieldLabel(a.name));else if("number"===typeof a||a instanceof Date)b=-1<r.indexOf(Xa,c)?null:"date",d=y.formatDate(a,{selector:b});return d}function Ya(a,c,b){var d=
c.startTime,e=c.endTime,f=c.layer;f.statisticsPlugin.getAgeExpressions({startTime:d,endTime:e,units:a.units}).then(function(c){var h=a.units,m="ageInfo_"+h;a.legendOptions={title:Aa.substitute({units:h,startTime:pa(d,h,f),endTime:pa(e,h,f)},E[m])};B.mixin(a,c);b.resolve(a)}).otherwise(function(a){l(b,"smartMapping.createAgeInfo: unable to generate expressions to calculate age.")})}function qa(a,c){var b,d,e,f,g,h,m,k,l={};b=r.filter(a,function(a){d=a.name;e=d.toLowerCase();if(h=d!==c&&-1===r.indexOf(ra,
e))m=m||(-1<r.indexOf(sa,a.type)?d:null),k=k||("esriFieldTypeString"===a.type?d:null);return h});r.forEach(b,function(a){d=a.name;e=d.toLowerCase();(f=-1<r.indexOf(sa,a.type))&&(l=ta(d,e,Za,l,"number"));if(!l.rank||"string"===l.fieldType)(g="esriFieldTypeString"===a.type)&&(l=ta(d,e,$a,l,"string"))});return l.fieldName||m||k}function ta(a,c,b,d,e){var f,g=-1;f=-1;var h,g=r.indexOf(b,c);for(h=0;h<b.length;h++)if(-1<c.indexOf(b[h])){f=h;break}c=g;if(-1<c&&(!d.rank||d.fieldType!==e||"exact"===d.matchType&&
d.fieldType===e&&d.rank>c))d={rank:c,matchType:"exact",fieldType:e,fieldName:a};else if(-1<f&&(!d.rank||d.fieldType===e&&"contains"===d.matchType&&d.rank>f))d={rank:f,matchType:"contains",fieldType:e,fieldName:a};return d}var A={},R=Math.pow(2,53)-1,E=Ga.smartMapping,ca="default",Ka="high-to-low",Ma="default",Pa="default",oa=0.01,ab=/(https?:)?\/\/services.*\.arcgis\.com/i,ra="id fips fid objectid _objectid __objectid x y lat long latitude longitude shape shape_length shape_leng shape_area perimeter stretched_value fnode_ tnode_ lpoly_ rpoly_ poly_ subclass rings_ok rings_nok st_length(shape) st_area(shape)".split(" "),
Za="count percent sum elevation value valore valoare total gesamt score income age expected average median size cost expenditure revenue profit growth sale quantity population price unit length width difference distance".split(" "),$a="type name status class category code value label zone symbol color owner district group species rating score party".split(" "),J="esriFieldTypeDate",sa=["esriFieldTypeInteger","esriFieldTypeDouble","esriFieldTypeSingle","esriFieldTypeSmallInteger"],Xa=["hours","minutes",
"seconds"],x=Z.toAbsMid?Z.toAbsMid("../plugins/FeatureLayerStatistics"):ua.id.replace(/\/[^\/]*$/ig,"/")+"../plugins/FeatureLayerStatistics";B.mixin(A,{createColors:function(a,c){var b=[],d=a.length,e;for(e=0;e<c;e++)b.push(new w(a[e%d]));return b},createTypeRenderer:function(a){var c=new u;if(!a||!a.layer||!a.field&&!a.valueExpression||!a.scheme&&!a.basemap)return l(c,"smartMapping.createTypeRenderer: missing parameters."),c.promise;var b=a.layer,d=a.optimizeOutline;b.addPlugin(x).then(function(){var e=
[b.statisticsPlugin.getUniqueValues({field:a.field,valueExpression:a.valueExpression,includeAllCodedValues:a.includeAllCodedValues})];d&&e.push(b.statisticsPlugin.getSuggestedOutline("object"===typeof d?d:null));(new G(e)).then(function(b){var e=b[0];b=b[1];b=d&&b[0]?b[1]:null;e[0]?(e=e[1],b=fa(e.uniqueValueInfos,b,a),b.source=e.source,b.partialData=e.partialData,c.resolve(b)):l(c,"smartMapping.createTypeRenderer: error when calculating unique values.")})}).otherwise(function(a){l(c,"smartMapping.createTypeRenderer: error when adding feature layer statistics plugin.")});
return c.promise},createColorInfo:function(a){var c=new u;if(!a||!a.layer||!a.field&&!a.valueExpression&&!a.sqlExpression)return l(c,"smartMapping.createColorInfo: missing parameters."),c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0;a.statistics?ga(a.statistics,null,d,a,c):b.addPlugin(x).then(function(){var f="group-similar"===a.theme||a.scheme&&0===a.scheme.id.indexOf("group-similar/");(f?b.statisticsPlugin.getClassBreaks({field:a.field,valueExpression:a.valueExpression,classificationMethod:"natural-breaks",
numClasses:a.numGroups||5,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue}):b.statisticsPlugin.getFieldStatistics({field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue})).then(function(b){var e,m;f?e=b:m=b;ga(m,e,d,a,c)}).otherwise(function(a){l(c,f?"smartMapping.createColorInfo: error when calculating class breaks.":"smartMapping.createColorInfo: error when calculating field statistics.")})}).otherwise(function(a){l(c,
"smartMapping.createColorInfo: error when adding feature layer statistics plugin.")});return c.promise},createColorRenderer:function(a){var c=new u;if(!a||!a.layer||!a.field&&!a.valueExpression&&!a.sqlExpression)return l(c,"smartMapping.createColorRenderer: missing parameters."),c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0,f=a.optimizeOutline;b.addPlugin(x).then(function(){var g=[A.createColorInfo(a)];f&&g.push(b.statisticsPlugin.getSuggestedOutline("object"===typeof f?f:null));
(new G(g)).then(function(b){var g=b[0];b=b[1];b=f&&b[0]?b[1]:null;if(g[0]){var g=g[1],k=a.field,p=D(a.layer),r=null==a.showOthers?!0:a.showOthers,n=L.cloneScheme(g.scheme),k=new M(null,k);a.valueExpression&&k.setValueExpression(a.valueExpression);r&&(k.defaultSymbol=v(n,n.noDataColor,p),k.defaultLabel=E.other);k.addBreak({minValue:-R,maxValue:R,symbol:v(n,n.noDataColor,p)});k.normalizationType=e;k.normalizationField=d;p=[y.cloneColorInfo(g.colorInfo)];b&&b.widthInfo&&p.push(b.widthInfo);k.setVisualVariables(p);
c.resolve({renderer:k,colorInfo:y.cloneColorInfo(g.colorInfo),statistics:g.statistics,classBreaks:g.classBreaks,scheme:L.cloneScheme(g.scheme)})}else l(c,"smartMapping.createColorRenderer: error when calculating colorInfo.")})}).otherwise(function(a){l(c,"smartMapping.createColorRenderer: error when adding feature layer statistics plugin.")});return c.promise},createOpacityInfo:function(a){var c=new u;if(!a||!a.layer||!a.field&&!a.valueExpression&&!a.sqlExpression)return l(c,"smartMapping.createOpacityInfo: missing parameters."),
c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0;a.statistics?ia(a.statistics,d,a,c):b.addPlugin(x).then(function(){b.statisticsPlugin.getFieldStatistics({field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue,features:a.features}).then(function(b){ia(b,d,a,c)}).otherwise(function(a){l(c,"smartMapping.createOpacityInfo: error when calculating field statistics.")})}).otherwise(function(a){l(c,
"smartMapping.createOpacityInfo: error when adding feature layer statistics plugin.")});return c.promise},createBlendRenderer:function(a){var c=new u,b=this,d,e=[],f={},g=[],h=[],m=a.opacityValueCombinationMethod||"avg",k={};if(!a||!a.layer||!a.blendedFields)return l(c,"smartMapping.createBlendRenderer: missing parameters."),c.promise;a.basemap=a.basemap||"topo";e=D(a.layer);d=V({basemap:a.basemap},e);d.colors=[new w("#e60000"),new w("#0000e6"),new w("#00e600"),new w("#e67300"),new w("#a900e6")];
k.fields=[];k.normalizationField=a.normalizationField;k.blendMode=a.blendMode||"source-over";k.symbol=v(d,d.noDataColor,a.markers?"point":e);f.layer=a.layer;f.normalizationField=a.normalizationField;f.useStdDev=a.useStdDev||!1;e=r.map(a.blendedFields,function(a,c){k.fields.push({field:a,color:d.colors[c]});f.field=a;return b.createOpacityInfo(f)});wa(e).then(function(b){h[0]=b[0].opacityInfo.stops[0].value;h[1]=b[1].opacityInfo.stops[1].value;r.forEach(b.slice(0,1),function(a){var c=a.opacityInfo.stops[0].value,
b=a.opacityInfo.stops[1].value;"union"===m?(h[0]=c<h[0]?c:h[0],h[1]=b>h[1]?b:h[1]):"avg"===m&&(h[0]+=a.opacityInfo.stops[0].value,h[1]+=a.opacityInfo.stops[1].value)});g[0]={value:"avg"===m?h[0]/b.length:h[0],opacity:a.minOpacity?a.minOpacity:b[0].opacityInfo.stops[0].opacity};g[1]={value:"avg"===m?h[1]/b.length:h[1],opacity:a.maxOpacity?a.maxOpacity:b[0].opacityInfo.stops[1].opacity};k.opacityStops=g;c.resolve({renderer:new Fa(k),scheme:d,opacityInfos:b})});return c.promise},createSizeInfo:function(a){var c=
new u;if(!a||!a.layer||!a.field&&!a.valueExpression&&!a.sqlExpression)return l(c,"smartMapping.createSizeInfo: missing parameters."),c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0,f=a.optimizeForScale;a.statistics?ka(a.statistics,null,d,a,c):b.addPlugin(x).then(function(){var g=[b.statisticsPlugin.getFieldStatistics({field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue})];
f&&g.push(b.statisticsPlugin.getSuggestedSizeRange({optimizeForScale:!0===f?"map-scale":f}));(new G(g)).then(function(b){var e=b[0];b=f&&b[1];b=f&&b[0]?b[1]:null;e[0]?ka(e[1],b,d,a,c):l(c,"smartMapping.createSizeInfo: error when calculating field statistics.")})}).otherwise(function(a){l(c,"smartMapping.createSizeInfo: error when adding feature layer statistics plugin.")});return c.promise},createSizeRenderer:function(a){var c=new u;if(!a||!a.layer||!a.field&&!a.valueExpression&&!a.sqlExpression)return l(c,
"smartMapping.createSizeRenderer: missing parameters."),c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0,f=a.optimizeOutline;b.addPlugin(x).then(function(){var g=[A.createSizeInfo(a)];f&&g.push(b.statisticsPlugin.getSuggestedOutline("object"===typeof f?f:null));(new G(g)).then(function(b){var g=b[0];b=b[1];b=f&&b[0]?b[1]:null;if(g[0]){var g=g[1],k=a.field,p=D(a.layer),r=null==a.showOthers?!0:a.showOthers,n=K.cloneScheme(g.scheme),s="polygon"===p,t=s?n.marker:n,n=s?n.background:null,
q="line"===p?t.noDataWidth:t.noDataSize,k=new M(null,k);a.valueExpression&&k.setValueExpression(a.valueExpression);r&&(k.defaultSymbol=v(t,t.noDataColor,s?"point":p,q),k.defaultLabel=E.other);k.addBreak({minValue:-R,maxValue:R,symbol:v(t,t.color,s?"point":p)});n&&(k.backgroundFillSymbol=v(n,n.color,p));k.normalizationType=e;k.normalizationField=d;p=[y.cloneSizeInfo(g.sizeInfo)];b&&b.widthInfo&&p.push(b.widthInfo);k.setVisualVariables(p);c.resolve({renderer:k,sizeInfo:y.cloneSizeInfo(g.sizeInfo),statistics:g.statistics,
defaultStatistics:g.defaultStatistics,suggestedSizeRange:g.suggestedSizeRange,scheme:K.cloneScheme(g.scheme)})}else l(c,"smartMapping.createSizeRenderer: error when calculating sizeInfo.")})}).otherwise(function(a){l(c,"smartMapping.createSizeRenderer: error when adding feature layer statistics plugin.")});return c.promise},createClassedColorRenderer:function(a){var c=new u,b=a.minValue,d=a.maxValue,e;if(!a||!a.layer||!a.field&&!a.valueExpression)return l(c,"smartMapping.createClassedColorRenderer: missing parameters."),
c.promise;e=null!=b&&null!=d;if(!e&&(null!=b||null!=d))return l(c,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),c.promise;a=B.mixin({analyzeData:!e},a);a.layer.addPlugin(x).then(function(){ma(a).then(function(b){Na(b.cbResponse,b.suggestedOutline,a,c)}).otherwise(function(a){l(c,"smartMapping.createClassedColorRenderer: error when calculating class breaks.")})}).otherwise(function(a){l(c,"smartMapping.createClassedColorRenderer: error when adding feature layer statistics plugin.")});
return c.promise},createClassedSizeRenderer:function(a){var c=new u,b=a.minValue,d=a.maxValue,e;if(!a||!a.layer||!a.field&&!a.valueExpression)return l(c,"smartMapping.createClassedSizeRenderer: missing parameters."),c.promise;e=null!=b&&null!=d;if(!e&&(null!=b||null!=d))return l(c,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),c.promise;a=B.mixin({analyzeData:!e},a);var f=a.layer;f.addPlugin(x).then(function(){ma(a).then(function(b){a.optimizeForScale?
f.statisticsPlugin.getSuggestedSizeRange().then(function(d){X(b.cbResponse,[d.minSize,d.maxSize],b.suggestedOutline,a,c)}).otherwise(function(d){X(b.cbResponse,null,b.suggestedOutline,a,c)}):X(b.cbResponse,null,b.suggestedOutline,a,c)}).otherwise(function(a){l(c,"smartMapping.createClassedSizeRenderer: error when calculating class breaks.")})}).otherwise(function(a){l(c,"smartMapping.createClassedSizeRenderer: error when adding feature layer statistics plugin.")});return c.promise},createHeatmapRenderer:function(a){var c=
new u;if(!a||!a.layer)return l(c,"smartMapping.createHeatmapRenderer: missing parameters."),c.promise;var b=a.layer;a.statistics?na(a.statistics,a,c):b.addPlugin(x).then(function(){b.statisticsPlugin.getHeatmapStatistics(a).then(function(b){na(b,a,c)}).otherwise(function(a){l(c,"smartMapping.createHeatmapRenderer: error when calculating heatmap statistics.")})}).otherwise(function(a){l(c,"smartMapping.createHeatmapRenderer: error when adding feature layer statistics plugin.")});return c.promise},
applyHeatmapScheme:function(a){if(!a||!a.renderer||!a.scheme)console.log("smartMapping.applyHeatmapScheme: missing parameters.");else{var c=Y({scheme:a.scheme});a=a.renderer;var b=a.colorStops,c=c.colors;if(b.length!==c.length+3)console.log("smartMapping.applyHeatmapScheme: incompatible number of colors in 'colors' and 'renderer.colorStops'.");else{var d;d=new w(c[0]);b=r.map(b,function(a){return B.mixin({},a)});b[0].color=new w([d.r,d.g,d.b,0]);b[1].color=new w([d.r,d.g,d.b,0]);b[2].color=d;for(d=
3;d<b.length;d++)b[d].color=c[d-3];a.setColorStops(b)}}},sampleSize:500,createPredominanceRenderer:function(a){var c=new u;if(!a||!a.layer||!(a.fields&&1<a.fields.length))return l(c,"smartMapping.createPredominanceRenderer: missing parameters."),c.promise;if(5<a.fields.length)return l(c,"smartMapping.createPredominanceRenderer: too many fields. Maximum supported is 5."),c.promise;var b=a.layer;b.addPlugin(x).then(function(){var d=r.map(a.fields,function(a){return a.name});ba(b,function(){var e=b.getOutFields()||
[],f=-1!==r.indexOf(e,"*"),g=a.optimizeOutline,f=f?null:r.filter(d,function(a){return-1===r.indexOf(e,a)});b.url&&!ab.test(b.url)?l(c,"smartMapping.createPredominanceRenderer: predominance renderer is not supported for this layer. Make sure the layer supports advanced SQL expressions and standardized queries."):f&&f.length?l(c,"smartMapping.createPredominanceRenderer: make sure the layer is configured to fetch all fields specified in parameters."):(g=g?b.statisticsPlugin.getSuggestedOutline("object"===
typeof g?g:null):null,S(g).always(function(b){b&&!b.widthInfo&&(b=null);Wa(a,d,b,c)}))})}).otherwise(function(a){l(c,"smartMapping.createPredominanceRenderer: error when adding feature layer statistics plugin.")});return c.promise},createAgeInfo:function(a){var c=new u;if(!a||!a.layer||!a.startTime||!a.endTime)return l(c,"smartMapping.createAgeInfo: missing parameters."),c.promise;var b=a.layer;b.addPlugin(x).then(function(){var d=a.units?{units:a.units}:b.statisticsPlugin.getSuggestedAgeUnits({startTime:a.startTime,
endTime:a.endTime});S(d).then(function(b){Ya(b,a,c)}).otherwise(function(a){l(c,"smartMapping.createAgeInfo: unable to calculate age units.")})}).otherwise(function(a){l(c,"smartMapping.createAgeInfo: error when adding feature layer statistics plugin.")});return c.promise},excludedFields:ra,getSuggestedField:function(a){var c=new u;if(!a||!(a.layer||a.fields&&a.objectIdField))return l(c,"smartMapping.getSuggestedField: missing parameters."),c.promise;a.layer?ba(a.layer,function(){c.resolve(qa(a.layer.fields,
a.layer.objectIdField))}):c.resolve(qa(a.fields,a.objectIdField));return c.promise}});va("extend-esri")&&B.setObject("renderer.smartMapping",A,ya);return A});