// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("dojo/_base/array dojo/_base/lang ../request ../geometry/Extent ../geometry/support/normalizeUtils ./Task ./support/FeatureSet".split(" "),function(k,c,f,l,g,m,h){return m.createSubclass({declaredClass:"esri.tasks.QueryTask",properties:{gdbVersion:{value:null,type:String},source:{value:null}},execute:function(b,d){return g.normalizeCentralMeridian(b.geometry?[b.geometry]:[]).then(function(a){a=this._encode(c.mixin({},this.parsedUrl.query,{f:"json"},b.toJSON({geometry:a&&a[0]})));if(this.source){var e=
{source:this.source.toJSON()};a.layer=JSON.stringify(e)}this.gdbVersion&&(a.gdbVersion=this.gdbVersion);a={query:a,callbackParamName:"callback"};if(this.requestOptions||d)a=c.mixin({},this.requestOptions,d,a);return f(this.parsedUrl.path+"/query",a)}.bind(this)).then(this._handleExecuteResponse)},executeRelationshipQuery:function(b,d){var a=this._encode(c.mixin({},this.parsedUrl.query,{f:"json"},b.toJSON()));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);a={query:a,callbackParamName:"callback"};
if(this.requestOptions||d)a=c.mixin({},this.requestOptions,d,a);return f(this.parsedUrl.path+"/queryRelatedRecords",a).then(this._handleExecuteRelationshipQueryResponse)},executeForIds:function(b,d){return g.normalizeCentralMeridian(b.geometry?[b.geometry]:[]).then(function(a){a=this._encode(c.mixin({},this.parsedUrl.query,{f:"json",returnIdsOnly:!0},b.toJSON({geometry:a&&a[0]})));if(this.source){var e={source:this.source.toJSON()};a.layer=JSON.stringify(e)}this.gdbVersion&&(a.gdbVersion=this.gdbVersion);
a={query:a,callbackParamName:"callback"};if(this.requestOptions||d)a=c.mixin({},this.requestOptions,d,a);return f(this.parsedUrl.path+"/query",a)}.bind(this)).then(this._handleExecuteForIdsResponse)},executeForCount:function(b,d){return g.normalizeCentralMeridian(b.geometry?[b.geometry]:[]).then(function(a){a=this._encode(c.mixin({},this.parsedUrl.query,{f:"json",returnIdsOnly:!0,returnCountOnly:!0},b.toJSON({geometry:a&&a[0]})));if(this.source){var e={source:this.source.toJSON()};a.layer=JSON.stringify(e)}this.gdbVersion&&
(a.gdbVersion=this.gdbVersion);a={query:a,callbackParamName:"callback"};if(this.requestOptions||d)a=c.mixin({},this.requestOptions,d,a);return f(this.parsedUrl.path+"/query",a)}.bind(this)).then(this._handleExecuteForCountResponse)},executeForExtent:function(b,d){return g.normalizeCentralMeridian(b.geometry?[b.geometry]:[]).then(function(a){a=this._encode(c.mixin({},this.parsedUrl.query,{f:"json",returnExtentOnly:!0,returnCountOnly:!0},b.toJSON({geometry:a&&a[0]})));if(this.source){var e={source:this.source.toJSON()};
a.layer=JSON.stringify(e)}this.gdbVersion&&(a.gdbVersion=this.gdbVersion);a={query:a,callbackParamName:"callback"};if(this.requestOptions||d)a=c.mixin({},this.requestOptions,d,a);return f(this.parsedUrl.path+"/query",a)}.bind(this)).then(this._handleExecuteForExtentResponse)},_handleExecuteResponse:function(b){return h.fromJSON(b.data)},_handleExecuteRelationshipQueryResponse:function(b){b=b.data;var d=b.geometryType,a=b.spatialReference,e={};k.forEach(b.relatedRecordGroups,function(b){var c={};c.geometryType=
d;c.spatialReference=a;c.features=b.relatedRecords;c=h.fromJSON(c);if(null!=b.objectId)e[b.objectId]=c;else for(var f in b)b.hasOwnProperty(f)&&"relatedRecords"!==f&&(e[b[f]]=c)});return e},_handleExecuteForIdsResponse:function(b){return b.data.objectIds},_handleExecuteForCountResponse:function(b){b=b.data;var c=b.features,a=b.objectIds;if(a)b=a.length;else{if(c)throw Error("Unable to perform query. Please check your parameters.");b=b.count}return b},_handleExecuteForExtentResponse:function(b){b=
b.data;if(b.hasOwnProperty("extent"))b.extent=l.fromJSON(b.extent);else{if(b.features)throw Error("Layer does not support extent calculation.");if(b.hasOwnProperty("count"))throw Error("Layer does not support extent calculation.");}return b}})});