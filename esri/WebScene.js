// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
require({cache:{"esri/core/accessorSupport/originUtils":function(){define(["require","exports","../MultiOriginJSONSupport"],function(m,p,n){p.updateOrigins=function(a){a&&a.writtenProperties&&a.writtenProperties.forEach(function(a){var c=a.target;a.newOrigin&&(a.oldOrigin!==a.newOrigin&&c.isInstanceOf(n))&&c.updateOrigin(a.propName,a.newOrigin)})}})},"esri/geometry/support/castUtils":function(){define(["../Point","../Polyline","../Polygon","../Multipoint","../Extent"],function(m,p,n,a,g){return{cast:function(c){return!c||
c.declaredClass?c||null:void 0!==c.x&&void 0!==c.y?new m(c):void 0!==c.paths?new p(c):void 0!==c.rings?new n(c):void 0!==c.points?new a(c):void 0!==c.xmin&&void 0!==c.ymin&&void 0!==c.xmax&&void 0!==c.ymax?new g(c):null}}})},"esri/webscene/Presentation":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/JSONSupport ../core/Collection ../core/collectionUtils ../core/accessorSupport/decorators ./Slide".split(" "),function(m,p,n,a,g,c,l,
f,b){var q=c.ofType(b);return function(c){function g(a){c.call(this,a);this.slides=new q}n(g,c);Object.defineProperty(g.prototype,"slides",{set:function(a){this._set("slides",l.referenceSetter(a,this._get("slides"),q))},enumerable:!0,configurable:!0});g.prototype.clone=function(){return new this.constructor({slides:this.slides.clone()})};g.sanitizeJSON=function(a){return{slides:void 0!==a.slides&&Array.isArray(a.slides)?a.slides.filter(function(a){return a&&!!a.viewpoint}).map(function(a){return b.sanitizeJSON(a)}):
[]}};a([f.property({type:q,json:{writable:!0}}),f.cast(l.castForReferenceSetter)],g.prototype,"slides",null);return g=a([f.subclass("esri.webscene.Presentation")],g)}(f.declared(g))})},"esri/webscene/Slide":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/accessorSupport/decorators ../Viewpoint ../Basemap ../support/basemapUtils ../core/JSONSupport ../core/lang ../core/Logger ../core/Collection ../core/collectionUtils ../core/promiseUtils ./Environment ./Lighting ./support/Description ./support/Title ./support/Thumbnail dojo/_base/lang dojo/promise/all ../views/3d/lib/glMatrix".split(" "),
function(m,p,n,a,g,c,l,f,b,q,F,r,G,t,v,H,B,C,y,z,I,J){var u=0,A=function(c){function b(){c.apply(this,arguments);this.id=""}n(b,c);b.prototype.clone=function(){return new b({id:this.id})};a([g.property({type:String,json:{writable:!0}})],b.prototype,"id",void 0);return b=a([g.subclass()],b)}(g.declared(b)),w=r.ofType(A),D=F.getLogger("esri.webscene.Slide");return function(b){function k(a){b.call(this,a);this._currentAnimation=null;this.id=Date.now().toString(16)+"-slide-"+u++;this.title=new C.default;
this.description=new B.default;this.thumbnail=new y.default;this.basemap=this.viewpoint=null;this.environment=new v;this.visibleLayers=new w}n(k,b);k.prototype.readBasemap=function(a,h){return!h.baseMap?null:l.fromJSON(h.baseMap)};k.prototype.writeBasemap=function(a,h,b){h.baseMap||(h.baseMap={});a.write(h.baseMap,b)};k.prototype.castBasemap=function(a){return f.ensureType(a)};Object.defineProperty(k.prototype,"visibleLayers",{set:function(a){this._set("visibleLayers",G.referenceSetter(a,this._get("visibleLayers"),
w))},enumerable:!0,configurable:!0});k.prototype.castVisibleLayers=function(a){return!a||"function"!==typeof a.map?a:a.map(function(a){if("string"===typeof a)return{id:a};if(a.id)return{id:a.id};D.warn('Invalid visible layer, expected { id }, Layer or "id"');return a})};k.prototype.clone=function(){return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||
null,basemap:this.basemap&&this.basemap.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})};k.prototype._updateVisibleLayersFrom=function(a){var h=this,b=[];return t.eachAlways(this._allLayers(a.map).map(function(h){return a.whenLayerView(h).then(function(a){a.visible&&b.push(new A({id:a.layer.id}))})}).toArray()).then(function(){h.visibleLayers.removeAll();h.visibleLayers.addMany(b)})};k.prototype.updateFrom=function(a,h){var b=this;
h=z.mixin({screenshot:z.mixin({format:"jpeg",quality:80,width:120,height:75},h&&h.screenshot)},h);return a.then(function(){b.viewpoint=a.viewpoint.clone();b.environment.lighting=H.prototype.clone.apply(a.environment.lighting);b.basemap=a.map.basemap&&a.map.basemap.clone()||null;return b._updateVisibleLayersFrom(a)}).then(function(){return a.takeScreenshot(h.screenshot)}).then(function(a){b.thumbnail=new y.default({url:a.dataURL});return b})};k.prototype.applyTo=function(a,h){var b=this,c=z.mixin({animate:!0},
h);return this._applyBasemap(a).then(function(){return I([b._applyViewpoint(a,c),b._applyLayerVisibility(a,c)])}).then(function(){return b})};k.prototype._applyBasemap=function(a){var b=this;return this.basemap?this.basemap.load().always(function(){a.map.basemap=f.clonePreservingTiledLayers(b.basemap,a.map.basemap)}):t.resolve()};k.prototype._allLayers=function(a){var b=new r;this._collectLayers(a,b);this._collectLayers(a.ground,b);return b};k.prototype._collectLayers=function(a,b){var c=this;a.layers.forEach(function(a){b.add(a);
a.layers&&c._collectLayers(a,b)})};k.prototype._applyLayerVisibility=function(a,b){var c=this;if(this.visibleLayers){var f=this._allLayers(a.map);if(b.applyToLayerViews)return t.eachAlways(f.map(function(b){return a.whenLayerView(b).then(function(a){a.visible=c.visibleLayers.some(function(K){return K.id===a.layer.id})})}).toArray());f.forEach(function(a){return a.visible=c.visibleLayers.some(function(b){return b.id===a.id})});return t.resolve()}};k.prototype._applyViewpoint=function(a,b){if(this.viewpoint){this.viewpoint.camera.fov=
a.camera.fov;if(b.animate){if(this.get("environment.lighting.date"))return this._animateToLighting(a,b).then(function(){});a.environment.lighting=this.environment.lighting.clone();return a.goTo(this.viewpoint,b).then(function(){})}a.viewpoint=this.viewpoint;a.environment.lighting=this.environment.lighting.clone()}return t.resolve()};k.prototype._animateToLighting=function(a,b){var c=this,f;"global"===a.viewingMode&&(f=this._animateLightingWithCamera(a));this._currentAnimation&&(this._currentAnimation.stop(),
this._currentAnimation=null);a.environment.lighting.cameraTrackingEnabled=!1;a.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled;null!=this.environment.lighting.displayUTCOffset&&(a.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);this._currentAnimation=a.goTo(this.viewpoint,b);this._currentAnimation.then(function(b){f&&f.remove();c._currentAnimation===b&&(a.environment.lighting.cameraTrackingEnabled=!0);"finished"===b.state&&
(a.environment.lighting=c.environment.lighting.clone())});return this._currentAnimation};k.prototype._getTime=function(a){var b=a.getTime();a=3600*a.getUTCHours()+60*a.getUTCMinutes()+a.getUTCSeconds();return[b,a]};k.prototype._setTime=function(a,b,c){a.setTime(b);a.setUTCHours(c/3600);a.setUTCMinutes(c%3600/60);a.setUTCSeconds(c%3600%60);return a};k.prototype._animateLightingWithCamera=function(a){var b=this,c=J.vec3d,f=this._getTime(new Date(a.environment.lighting.date.toString())),g=f[0],e=f[1],
f=this._getTime(this.environment.lighting.date),K=f[0],d=f[1],L=a.renderCoordsHelper,O=[0,0,0];L.toRenderCoords(a.camera.position,O);var l=[0,0,0];L.toRenderCoords(this.viewpoint.camera.position,l);var M=[0,0,0],k=new Date;return a.watch("camera",function(f){L.toRenderCoords(f.position,M);f=c.dist2(O,M);var q=c.dist2(l,M),n=0;0!==f+q&&(n=f/(f+q));a.environment.lighting.date=b._setTime(k,g+(K-g)*n,e+(d-e)*n)})};k.createFrom=function(a,b){return(new this).updateFrom(a,b)};k.sanitizeJSON=function(a){var b;
b=void 0!==a.visibleLayers&&Array.isArray(a.visibleLayers)?q.clone(a.visibleLayers):[];b={id:a.id||"",title:a.title||{text:""},thumbnail:a.thumbnail||{url:""},viewpoint:a.viewpoint,baseMap:a.baseMap,visibleLayers:b};void 0!==a.description&&(b.description=a.description);void 0!==a.environment&&(b.environment=v.sanitizeJSON(a.environment));return b};a([g.property({json:{writable:!0}})],k.prototype,"id",void 0);a([g.property({type:C.default,json:{writable:!0}})],k.prototype,"title",void 0);a([g.property({type:B.default,
json:{writable:!0}})],k.prototype,"description",void 0);a([g.property({type:y.default,json:{writable:!0}})],k.prototype,"thumbnail",void 0);a([g.property({type:c,json:{writable:!0}})],k.prototype,"viewpoint",void 0);a([g.property({json:{writeTo:"baseMap"}})],k.prototype,"basemap",void 0);a([g.read("basemap",["baseMap"])],k.prototype,"readBasemap",null);a([g.write("basemap")],k.prototype,"writeBasemap",null);a([g.cast("basemap")],k.prototype,"castBasemap",null);a([g.property({type:w,json:{writable:!0}})],
k.prototype,"visibleLayers",null);a([g.cast("visibleLayers")],k.prototype,"castVisibleLayers",null);a([g.property({type:v,json:{writable:!0}})],k.prototype,"environment",void 0);return k=a([g.subclass("esri.webscene.Slide")],k)}(g.declared(b))})},"esri/webscene/Environment":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/JSONSupport ../core/accessorSupport/decorators ./Lighting".split(" "),function(m,p,n,a,g,c,l){return function(f){function b(a){f.call(this,
a);this.lighting=new l}n(b,f);b.prototype.clone=function(){return new b({lighting:l.prototype.clone.call(this.lighting)})};b.sanitizeJSON=function(a){return{lighting:a.lighting?l.sanitizeJSON(a.lighting):(new l).toJSON()}};a([c.property({type:l,json:{writable:!0}})],b.prototype,"lighting",void 0);return b=a([c.subclass("esri.webscene.Environment")],b)}(c.declared(g))})},"esri/webscene/Lighting":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/JSONSupport ../core/accessorSupport/decorators".split(" "),
function(m,p,n,a,g,c){return function(g){function f(a){g.call(this,a);this.date=null;this.directShadowsEnabled=!1;this.displayUTCOffset=null}n(f,g);f.prototype.readDate=function(a,c){return null!=c.datetime&&new Date(c.datetime)||null};f.prototype.writeDate=function(a,c){null!=a&&(c.datetime=a.getTime())};f.prototype.readDirectShadowsEnabled=function(a,c){return!!c.directShadows};f.prototype.writedirectShadowsEnabled=function(a,c){a&&(c.directShadows=!0)};f.prototype.writeDisplayUTCOffset=function(a,
c){null!=a&&(c.displayUTCOffset=a)};f.prototype.clone=function(){return new f({date:null!=this.date?new Date(this.date.getTime()):null,directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null})};f.sanitizeJSON=function(a){var c={datetime:a.datetime};void 0!==a.directShadows&&(c.directShadows=!!a.directShadows);void 0!==a.displayUTCOffset&&(c.displayUTCOffset=a.displayUTCOffset);return c};a([c.property({type:Date})],f.prototype,"date",void 0);
a([c.read("date",["datetime"])],f.prototype,"readDate",null);a([c.write("date")],f.prototype,"writeDate",null);a([c.property({type:Boolean})],f.prototype,"directShadowsEnabled",void 0);a([c.read("directShadowsEnabled",["directShadows"])],f.prototype,"readDirectShadowsEnabled",null);a([c.write("directShadowsEnabled")],f.prototype,"writedirectShadowsEnabled",null);a([c.property({type:Number,json:{writable:!0}})],f.prototype,"displayUTCOffset",void 0);a([c.write("displayUTCOffset")],f.prototype,"writeDisplayUTCOffset",
null);return f=a([c.subclass("esri.webscene.Lighting")],f)}(c.declared(g))})},"esri/webscene/support/Description":function(){define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/JSONSupport ../../core/accessorSupport/decorators".split(" "),function(m,p,n,a,g,c){m=function(g){function f(){g.apply(this,arguments);this.text=""}n(f,g);f.prototype.clone=function(){return new f({text:this.text})};a([c.property({type:String,json:{writable:!0}})],
f.prototype,"text",void 0);return f=a([c.subclass("esri.webscene.support.Description")],f)}(c.declared(g));Object.defineProperty(p,"__esModule",{value:!0});p.default=m})},"esri/webscene/support/Title":function(){define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/JSONSupport ../../core/accessorSupport/decorators".split(" "),function(m,p,n,a,g,c){m=function(g){function f(){g.apply(this,arguments);this.text=""}n(f,g);f.prototype.clone=function(){return new f({text:this.text})};
a([c.property({type:String,json:{writable:!0}})],f.prototype,"text",void 0);return f=a([c.subclass("esri.webscene.support.Title")],f)}(c.declared(g));Object.defineProperty(p,"__esModule",{value:!0});p.default=m})},"esri/webscene/support/Thumbnail":function(){define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/JSONSupport ../../core/accessorSupport/decorators".split(" "),function(m,p,n,a,g,c){m=function(g){function f(){g.apply(this,arguments);
this.url=""}n(f,g);f.prototype.clone=function(){return new f({url:this.url})};a([c.property({type:String,json:{writable:!0}})],f.prototype,"url",void 0);return f=a([c.subclass("esri.webscene.support.Thumbnail")],f)}(c.declared(g));Object.defineProperty(p,"__esModule",{value:!0});p.default=m})},"esri/webscene/InitialViewProperties":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../Viewpoint ../core/Accessor ../geometry/SpatialReference ./Environment ../core/accessorSupport/decorators".split(" "),
function(m,p,n,a,g,c,l,f,b){return function(c){function m(a){c.call(this,a);this.environment=new f;this.viewpoint=this.spatialReference=null}n(m,c);Object.defineProperty(m.prototype,"viewingMode",{set:function(a){"local"!==a&&"global"!==a||this._set("viewingMode",a)},enumerable:!0,configurable:!0});m.prototype.clone=function(){return new m({environment:this.environment.clone(),spatialReference:this.spatialReference?this.spatialReference.clone():null,viewingMode:this.viewingMode,viewpoint:this.viewpoint?
this.viewpoint.clone():null})};a([b.property({type:f})],m.prototype,"environment",void 0);a([b.property({type:l})],m.prototype,"spatialReference",void 0);a([b.property()],m.prototype,"viewingMode",null);a([b.property({type:g})],m.prototype,"viewpoint",void 0);return m=a([b.subclass("esri.webscene.InitialViewProperties")],m)}(b.declared(c))})},"*noref":1}});
define("require exports ./core/tsSupport/declareExtendsHelper ./core/tsSupport/decorateHelper ./core/tsSupport/paramHelper ./Map ./core/Error ./core/requireUtils ./core/promiseUtils ./core/JSONSupport ./core/Loadable ./core/urlUtils ./core/Logger ./core/accessorSupport/read ./core/accessorSupport/originUtils ./support/groundUtils ./Basemap ./Viewpoint ./kernel ./geometry/support/jsonUtils ./geometry/support/castUtils ./geometry/Geometry ./geometry/SpatialReference ./webscene/Presentation ./webscene/InitialViewProperties ./webscene/Environment ./portal/PortalItem ./portal/Portal dojo/_base/lang ./core/accessorSupport/decorators".split(" "),function(m,
p,n,a,g,c,l,f,b,q,F,r,G,t,v,H,B,C,y,z,I,J,u,A,w,D,N,k,s,h){var E=G.getLogger("esri.webscene"),x={major:1,minor:5};Object.freeze(x);return function(c){function e(a){c.call(this);this.basemapElevationLayerIds=[];this.clippingArea=null;this.clippingEnabled=!1;this.authoringAppVersion=this.authoringApp=this.resourceInfo=this.portalItem=this.initialViewProperties=this.presentation=this.sourceVersion=null;this._isAuthoringAppVersionSetByUser=this._isAuthoringAppSetByUser=!1}n(e,c);e.prototype.initialize=
function(){this.otherwise(function(a){E.error("#load()","Failed to load web scene",a)});if(this.resourceInfo){var a=void 0;try{a=this._validateJSON(this.resourceInfo)}catch(d){this.addResolvingPromise(b.reject(d));return}this.read(a);this.addResolvingPromise(this._validateSpatialReference())}};e.prototype.getDefaults=function(a){return s.mixin(this.inherited(arguments),{presentation:{},initialViewProperties:{}})};e.prototype.readBasemap=function(a,d,b){if(!d.baseMap)return null;a=s.mixin({},d.baseMap);
delete a.elevationLayers;d=new B;d.resourceInfo=a;d.read(a,{origin:"web-scene",portal:b&&b.portal});return d};e.prototype.writeBasemap=function(a,d,b){var c=this;a&&(d.baseMap||(d.baseMap={}),a.write(d.baseMap,b),d.baseMap.elevationLayers=[]);this.ground&&(a=this.ground.layers.filter(function(a){return!c._groundLayerIsOperational(a)&&c.verifyWriteLayer(a,b)}).map(function(a){return a.write(null,b)}),0<a.length&&(d.baseMap||(d.baseMap={id:"basemap",title:"Basemap"}),d.baseMap.elevationLayers=a.toArray()))};
e.prototype.readClippingArea=function(a){return a&&a.geometry?z.fromJSON(a.geometry):null};e.prototype.writeClippingArea=function(a,d){d.clippingArea||(d.clippingArea={});d.clippingArea.geometry=a.toJSON()};e.prototype.readClippingEnabled=function(a,d){return d.clippingArea?!!d.clippingArea.clip:!1};e.prototype.writeClippingEnabled=function(a,d){this.clippingArea&&(d.clippingArea||(d.clippingArea={}),d.clippingArea.clip=a)};e.prototype.writeLayers=function(a,d,b){var c=this,e=s.mixin({},b,{layerContainerType:"ground"}),
f=s.mixin({},b,{layerContainerType:"operational-layers"});b=this.ground.layers.filter(function(a){return c._groundLayerIsOperational(a)&&c.verifyWriteLayer(a,e)}).map(function(a){return a.write(null,e)});b.addMany(a.filter(function(a){return c.verifyWriteLayer(a,f)}).map(function(a){return a.write(null,f)}));b=b.filter(function(a){return!!a});d.operationalLayers=b.toArray()};e.prototype.verifyWriteLayer=function(a,d){return!a.write?(d&&d.messages.push(new l("layer:unsupported","Layers ("+a.title+
", "+a.id+") of type '"+a.declaredClass+"' cannot be persisted in web scenes",{layer:a})),!1):!0};e.prototype.readSourceVersion=function(a,d){var b=d.version.split("."),c=b[1];return{major:parseInt(b[0],10),minor:parseInt(c,10)}};e.prototype.writeSourceVersion=function(a,d){d.version=x.major+"."+x.minor};Object.defineProperty(e.prototype,"authoringApp",{set:function(a){this._isAuthoringAppSetByUser=!0;this._set("authoringApp",a)},enumerable:!0,configurable:!0});e.prototype.writeAuthoringApp=function(a,
d){d.authoringApp=a&&this._isAuthoringAppSetByUser?a:"ArcGIS API for JavaScript"};Object.defineProperty(e.prototype,"authoringAppVersion",{set:function(a){this._isAuthoringAppVersionSetByUser=!0;this._set("authoringAppVersion",a)},enumerable:!0,configurable:!0});e.prototype.writeAuthoringAppVersion=function(a,d){d.authoringAppVersion=a&&this._isAuthoringAppVersionSetByUser?a:y.version};e.prototype.writePresentation=function(a,d,b){var c=this;a=a.write({},b);a.slides.forEach(function(a){a.visibleLayers=
a.visibleLayers.filter(function(a){var d=c.ground.layers.find(function(d){return d.id===a.id});return!d||c._groundLayerIsOperational(d)})});d.presentation=a};e.prototype.readInitialViewProperties=function(a,d){var b={};d.initialState&&d.initialState.environment&&(b.environment=D.fromJSON(d.initialState.environment));d.spatialReference&&(b.spatialReference=u.fromJSON(d.spatialReference));b.viewingMode=d.viewingMode||"global";d.initialState&&d.initialState.viewpoint&&(b.viewpoint=C.fromJSON(d.initialState.viewpoint));
return new w(b)};e.prototype.writeInitialViewProperties=function(a,d,b){if(a){var c={};a.environment&&(c.environment=a.environment.write({},b));a.viewpoint&&(c.viewpoint=a.viewpoint.toJSON());0!==Object.keys(c).length&&(d.initialState=c);d.spatialReference=a.spatialReference?a.spatialReference.toJSON():u.WebMercator.toJSON();d.viewingMode=null!=a.viewingMode?a.viewingMode:"global"}};e.prototype.load=function(){this.addResolvingPromise(this._loadFromSource());return this};e.prototype.toJSON=function(){return this.write(null,
{origin:"web-scene"})};e.prototype.read=function(a,d){var b=this;d=s.mixin({},d,{origin:"web-scene"});var c=this._isAuthoringAppVersionSetByUser,e=this._isAuthoringAppSetByUser,f=arguments;t.readLoadable(this,a,function(d){return b.inherited(f,[a,d])},d);e||(this._isAuthoringAppSetByUser=!1);c||(this._isAuthoringAppVersionSetByUser=!1);if(a.baseMap&&Array.isArray(a.baseMap.elevationLayers)){var g=a.baseMap.elevationLayers.map(function(a){return{id:a.id}});this.presentation.slides.forEach(function(a){a.visibleLayers.addMany(g)})}return this};
e.prototype.write=function(a,d){if("loaded"!==this.loadStatus){var b=new l("webscene:not-loaded","Web scene must be loaded before it can be serialized");E.error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus);throw b;}d=s.mixin({},d,{origin:"web-scene"});return this.inherited(arguments,[a,d])};e.prototype.save=function(a){var d=this;if(!this.portalItem)return E.error("save(): requires the .portalItem property to be set"),b.reject(new l("webscene:portal-item-not-set",
"Portal item to save to has not been set on the WebScene"));if("Web Scene"!==this.portalItem.type)return b.reject(new l("webscene:portal-item-wrong-type",'Portal item needs to have type "Web Scene"'));var c;return this.load().then(function(){return d._loadBasemaps()}).then(function(){c={origin:"web-scene",url:d.portalItem.itemUrl&&r.urlToObject(d.portalItem.itemUrl),messages:[],portal:d.portalItem.portal||k.getDefault(),writtenProperties:[]};var e=d.write(null,c),f=d._verifySave(c,a);if(f)return b.reject(f);
d._makeRelativeStyleUrls(e,d.portalItem.itemUrl);d._updateTypeKeywords(d.portalItem);return d.portalItem.update({data:e})}).then(function(){v.updateOrigins(c);return b.resolve(d.portalItem)})};e.prototype.saveAs=function(a,d){var c=this;if(!a)return E.error("saveAs(portalItem): requires a portal item parameter"),b.reject(new l("webscene:portal-item-required","saveAs requires a portal item to save to"));if(a.type&&"Web Scene"!==a.type||a.id)return b.reject(new l("webscene:portal-item-already-exists",
"WebScene can only saveAs to a new and empty portal item"));var e=a.portal||k.getDefault();if(!e.user)return b.reject(new l("portal:not-signed-in","Not signed in"));var f,g;return this.load().then(function(){return c._loadBasemaps()}).then(function(){if(c.portalItem&&c.containsRelativeStyleUrls())return b.reject(new l("webscene:failed-to-copy-embedded-resources","Copying of embedded resources is currently not supported"));f={origin:"web-scene",url:null,messages:[],portal:e,writtenProperties:[]};g=
c.write(null,f);var h=c._verifySave(f,d);if(h)return b.reject(h);a.type="Web Scene";c._updateTypeKeywords(a);return e.user.addItem({item:a,folder:d&&d.folder,data:g})}).then(function(){c.portalItem=a;q.prototype.read.call(c,{version:g.version,authoringApp:g.authoringApp,authoringAppVersion:g.authoringAppVersion},{name:"web-scene",url:a.itemUrl&&r.urlToObject(a.itemUrl)});v.updateOrigins(f);return b.resolve(a)})};e.prototype._verifySave=function(a,d){var b=a.messages.filter(function(a){return"error"===
a.type});d&&d.ignoreUnsupported&&(b=b.filter(function(a){return"layer:unsupported"!==a.name&&"symbol:unsupported"!==a.name&&"property:unsupported"!==a.name}));if(b.length)return new l("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:b})};e.prototype.updateFrom=function(a,d){void 0===d&&(d={});d.environmentExcluded||(this.initialViewProperties.environment=D.prototype.clone.apply(a.environment));d.viewpointExcluded||
(this.initialViewProperties.viewpoint=a.viewpoint.clone());this.initialViewProperties.spatialReference=a.spatialReference.clone();this.initialViewProperties.viewingMode=a.viewingMode;a.clippingArea?a.clippingArea!==this.clippingArea&&(this.clippingArea=a.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1;a.map===this&&a.allLayerViews.forEach(function(a){a.layer.visible=a.visible})};e.prototype.containsRelativeStyleUrls=function(){return this.portalItem&&this.portalItem.id&&this.portalItem.itemUrl?
this._makeRelativeStyleUrls(this.toJSON(),this.portalItem.itemUrl):!1};e.prototype.isDefaultGroundLayer=function(a){var d=H.groundElevationLayers["world-elevation"];return a.id===d.id&&r.normalize(a.url)===r.normalize(d.url)};e.prototype._groundLayerIsOperational=function(a){return"esri.layers.ElevationLayer"!==a.declaredClass||-1===this.basemapElevationLayerIds.indexOf(a.id)&&!this.isDefaultGroundLayer(a)||this.presentation.slides.some(function(d){return!d.visibleLayers.some(function(d){return d.id===
a.id})})?!0:!1};e.prototype._loadFromSource=function(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):this._loadBasemaps()};e.prototype._readAndLoadFromJSON=function(a,d){var b=this._validateJSON(a,d&&d.url&&d.url.path);this.read(b,d);return this._loadFromJSON(b,d)};e.prototype._loadFromJSON=function(a,d){var c=this;return this._validateSpatialReference().then(function(){return f.when(m,"./portal/support/layersCreator")}).then(function(e){var f=
[],g=a.operationalLayers,h=[];a.baseMap&&Array.isArray(a.baseMap.elevationLayers)&&(h.push.apply(h,a.baseMap.elevationLayers),c.basemapElevationLayerIds=a.baseMap.elevationLayers.map(function(a){return a.id}));var l=function(a){a.layers&&(a.layers=a.layers.filter(l));return"ArcGISTiledElevationServiceLayer"===a.layerType?(h.push(a),!1):!0};g&&(g=g.filter(l));var m={context:s.mixin({},d,{layerContainerType:"operational-layers"})};c.portalItem&&(m.context.portal=c.portalItem.portal||k.getDefault());
if(0<h.length){var n=s.mixin({},m,{context:s.mixin({},m.context,{layerContainerType:"ground"})});n.defaultLayerType="ArcGISTiledElevationServiceLayer";f.push.apply(f,e.populateOperationalLayers(c.ground.layers,h,n))}g&&0<g.length&&f.push.apply(f,e.populateOperationalLayers(c.layers,g,m));return b.eachAlways(f).then(function(){})}).then(function(){return c._loadBasemaps()})};e.prototype._loadBasemaps=function(){var a=[];this.basemap&&a.push(this.basemap.load());this.presentation.slides.forEach(function(d){d.basemap&&
a.push(d.basemap.load())});return b.eachAlways(a).then(function(){})};e.prototype._loadFromItem=function(a){var d=this;return a.load().otherwise(function(a){throw new l("webscene:load-portal-item","Failed to load portal item",{error:a});}).then(function(){if("Web Scene"!==a.type)throw new l("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:a.type});}).then(function(){return a.fetchData()}).then(function(b){d.resourceInfo=b;return d._readAndLoadFromJSON(b,
{origin:"web-scene",url:r.urlToObject(a.itemUrl),portal:a.portal||k.getDefault()})})};e.prototype._validateSpatialReference=function(){var a=this.initialViewProperties,d=a.spatialReference||u.WebMercator,c;if("local"!==a.viewingMode){if(!d.isWGS84&&!d.isWebMercator)return b.reject(new l("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator or WGS84 GCS are supported",{spatialReference:d,viewingMode:a.viewingMode}));c=function(a){return!a||
a.isWGS84||a.isWebMercator}}else{if(d.isGeographic)return b.reject(new l("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:d,viewingMode:a.viewingMode}));c=function(a){return!a||a.equals(d)}}var f=function(a){return a&&(a.camera&&a.camera.position&&a.camera.position.spatialReference||a.targetGeometry&&a.targetGeometry.spatialReference)},e=f(a.viewpoint);return e&&!c(e)?
b.reject(new l("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:e,sceneSpatialReference:d,viewingMode:a.viewingMode})):(e=this.presentation.slides.find(function(a){return!c(f(a.viewpoint))}))?(e=f(e.viewpoint),b.reject(new l("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",
{slideSpatialReference:e,sceneSpatialReference:d,viewingMode:a.viewingMode}))):b.resolve()};e.prototype._validateVersion=function(a){var d=a.split("."),b=d[0],d=d[1],c=/^\s*\d+\s*$/;if(!b||!b.match||!b.match(c))throw new l("webscene:invalid-version","Expected major version to be a number, but got '${version}'",{version:a});if(!d||!d.match||!d.match(c))throw new l("webscene:invalid-version","Expected minor version to be a number, but got '${version}'",{version:a});a=parseInt(b,10);c=parseInt(d,10);
if(a!==x.major)throw new l("webscene:unsupported-version","Required major webscene version is '"+x.major+"', but got '${version.major}.${version.minor}'",{version:{major:b,minor:d}});return{major:a,minor:c}};e.prototype._validateJSON=function(a,d){void 0===d&&(d=null);var b=this._sanitizeJSON(a,d),c=this._validateVersion(b.version);b.version=c.major+"."+c.minor;1===c.major&&2>=c.minor&&(b.spatialReference=u.WebMercator.toJSON());return b};e.prototype._sanitizeJSON=function(a,d){void 0===d&&(d=null);
var b={version:a.version||"",baseMap:a.baseMap,operationalLayers:a.operationalLayers,authoringApp:a.authoringApp||"",authoringAppVersion:a.authoringAppVersion||"",viewingMode:a.viewingMode||"global",presentation:a.presentation&&A.sanitizeJSON(a.presentation)||{},initialState:a.initialState,spatialReference:a.spatialReference||u.WebMercator.toJSON(),clippingArea:a.clippingArea};this._makeAbsoluteStyleUrls(b,d);return b};e.prototype._forEachSymbolResourceUrl=function(a,d){if(!Array.isArray(a.operationalLayers))return!1;
var b=!1,c=function(a,c){var e=a[c];if(e){var f=d(e);f!==e&&(a[c]=f,b=!0)}},e=function(a,b){a&&a.styleUrl&&c(a,"styleUrl");a&&a.symbolLayers&&a.symbolLayers.forEach(function(a){a.resource&&a.resource.href&&c(a.resource,"href")})};a.operationalLayers.forEach(function(a){if(a=a.layerDefinition&&a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer)switch(a.type){case "simple":e(a.symbol,d);break;case "uniqueValue":c(a,"styleUrl");e(a.defaultSymbol,d);Array.isArray(a.uniqueValueInfos)&&
a.uniqueValueInfos.forEach(function(a){e(a.symbol,d)});break;case "classBreaks":e(a.defaultSymbol,d),Array.isArray(a.classBreakInfos)&&a.classBreakInfos.forEach(function(a){e(a.symbol,d)})}});return b};e.prototype._makeAbsoluteStyleUrls=function(a,b){return!b?!1:this._forEachSymbolResourceUrl(a,function(a){return r.makeAbsolute(a,b,{preserveProtocolRelative:!0})})};e.prototype._makeRelativeStyleUrls=function(a,b){return!b?!1:this._forEachSymbolResourceUrl(a,function(a){var c=r.makeRelative(a,b);return c&&
0!==c.indexOf("../")?c:a})};e.prototype._updateTypeKeywords=function(a){"local"===this.initialViewProperties.viewingMode?a.typeKeywords?-1===a.typeKeywords.indexOf("ViewingMode-Local")&&a.typeKeywords.push("ViewingMode-Local"):a.typeKeywords=["ViewingMode-Local"]:"global"===this.initialViewProperties.viewingMode&&a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter(function(a){return"ViewingMode-Local"!==a}));a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter(function(a,b,c){return c.indexOf(a)===
b}))};e.fromJSON=function(a){return new this({resourceInfo:a})};e.VERSION=x;a([h.property({json:{writeNull:!0}})],e.prototype,"basemap",void 0);a([h.read("basemap",["baseMap"])],e.prototype,"readBasemap",null);a([h.write("basemap")],e.prototype,"writeBasemap",null);a([h.property({type:J}),h.cast(I.cast)],e.prototype,"clippingArea",void 0);a([h.read("clippingArea")],e.prototype,"readClippingArea",null);a([h.write("clippingArea")],e.prototype,"writeClippingArea",null);a([h.property({type:Boolean})],
e.prototype,"clippingEnabled",void 0);a([h.read("clippingEnabled",["clippingArea"])],e.prototype,"readClippingEnabled",null);a([h.write("clippingEnabled")],e.prototype,"writeClippingEnabled",null);a([h.property()],e.prototype,"layers",void 0);a([h.write("layers")],e.prototype,"writeLayers",null);a([h.property({readOnly:!0,json:{writeNull:!0}})],e.prototype,"sourceVersion",void 0);a([h.read("sourceVersion",["version"])],e.prototype,"readSourceVersion",null);a([h.write("sourceVersion")],e.prototype,
"writeSourceVersion",null);a([h.property({type:String,json:{writeNull:!0}})],e.prototype,"authoringApp",null);a([h.write("authoringApp")],e.prototype,"writeAuthoringApp",null);a([h.property({type:String,json:{writeNull:!0}})],e.prototype,"authoringAppVersion",null);a([h.write("authoringAppVersion")],e.prototype,"writeAuthoringAppVersion",null);a([h.property({type:A})],e.prototype,"presentation",void 0);a([h.write("presentation")],e.prototype,"writePresentation",null);a([h.property({type:w})],e.prototype,
"initialViewProperties",void 0);a([h.read("initialViewProperties",["initialState.environment","spatialReference","viewingMode","initialState.viewpoint"])],e.prototype,"readInitialViewProperties",null);a([h.write("initialViewProperties")],e.prototype,"writeInitialViewProperties",null);a([h.property({type:N})],e.prototype,"portalItem",void 0);a([h.property()],e.prototype,"resourceInfo",void 0);a([g(0,h.cast(N))],e.prototype,"saveAs",null);return e=a([h.subclass("esri.WebScene")],e)}(h.declared(c,F,
q))});