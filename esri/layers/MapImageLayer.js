// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/accessorSupport/decorators dojo/_base/lang dojo/io-query dojo/Deferred dojo/errors/CancelError ../core/promiseUtils ../config ../request ./DynamicLayer ./mixins/ArcGISDynamicMapService ./mixins/OperationalLayer ./mixins/PortalLayer".split(" "),function(x,y,n,b,c,h,p,q,r,l,s,k,t,u,v,w){return function(m){function a(d,a){m.call(this);this.alwaysRefetch=!1;this.legendEnabled=!0;this.operationalLayerType=
"ArcGISMapServiceLayer";this.type="map-image"}n(a,m);a.prototype.normalizeCtorArgs=function(d,a){return"string"===typeof d?h.mixin({url:d},a):d};a.prototype.load=function(){var d=this;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]}).then(function(){return d._fetchService()}));return this};a.prototype.readLegendEnabled=function(d,a){return null!=a.showLegend?a.showLegend:!0};a.prototype.writeLegendEnabled=function(d,a){d||(a.showLegend=!1)};a.prototype.getImageUrl=function(a,
c){var b=this,f=this.parsedUrl.path+"/export",e=h.mixin({},this.parsedUrl.query,this.createExportImageParameters(a),{f:"image",token:this.token,_ts:this.alwaysRefetch?(new Date).getTime():null}),g=f+"?"+p.objectToQuery(e);g.length>s.request.maxUrlLength?(e.f="json",k(f,{query:e,responseType:"json",callbackParamName:"callback"}).then(function(a){return a.data.href+"?token\x3d"+b.token}).then(c)):c(g)};a.prototype.fetchImage=function(a){var c=this,b,f,e=new q(function(){b&&b.cancel()});10.3>this.version&&
delete a.rotation;var g=l.wrapCallback(function(b){return c.getImageUrl(a,b)});b=g;g.then(function(a){f=a;return b=a=k(f,{responseType:"image"})}).then(function(b){e.resolve({options:a,img:b.data})}).otherwise(function(a){e.reject(a instanceof r?a:Error("Unable to load image: "+f))});return e.promise};a.prototype._fetchService=function(){var a=this;return l.resolve().then(function(){return a.resourceInfo?{ssl:!1,data:a.resourceInfo}:k(a.parsedUrl.path,{query:h.mixin({f:"json"},a.parsedUrl.query),
responseType:"json",callbackParamName:"callback"})}).then(function(b){b.ssl&&(a.url=a.url.replace(/^http:/i,"https:"));a.read(b.data,{origin:"service",url:a.parsedUrl})})};b([c.property()],a.prototype,"alwaysRefetch",void 0);b([c.property({type:Boolean})],a.prototype,"legendEnabled",void 0);b([c.read("legendEnabled",["showLegend"])],a.prototype,"readLegendEnabled",null);b([c.write("legendEnabled")],a.prototype,"writeLegendEnabled",null);b([c.property()],a.prototype,"operationalLayerType",void 0);
b([c.property({json:{readable:!1}})],a.prototype,"type",void 0);return a=b([c.subclass("esri.layers.MapImageLayer")],a)}(c.declared(t,u,v,w))});