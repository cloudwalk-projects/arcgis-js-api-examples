// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterFormats/Lerc2Codec",[],function(){var B={unstuff:function(b,a,d,c,f,h,k,m){var n=(1<<d)-1,e=0,g,l=0,p,q;g=4*b.length-Math.ceil(d*c/8);b[b.length-1]<<=8*g;if(f)for(g=0;g<c;g++)0===l&&(q=b[e++],l=32),l>=d?(p=q>>>l-d&n,l-=d):(l=d-l,p=(q&n)<<l&n,q=b[e++],l=32-l,p+=q>>>l),a[g]=f[p];else{f=Math.ceil((m-h)/k);for(g=0;g<c;g++)0===l&&(q=b[e++],l=32),l>=d?(p=q>>>l-d&n,l-=d):(l=d-l,p=(q&n)<<l&n,q=b[e++],l=32-l,p+=q>>>l),a[g]=p<f?h+p*k:m}},unstuffLUT:function(b,a,d,c,f,h){var k=(1<<
a)-1,m=0,n=0,e=0,g=e=0,l,p=[],n=4*b.length-Math.ceil(a*d/8);b[b.length-1]<<=8*n;for(var q=Math.ceil((h-c)/f),n=0;n<d;n++)0===e&&(l=b[m++],e=32),e>=a?(g=l>>>e-a&k,e-=a):(e=a-e,g=(l&k)<<e&k,l=b[m++],e=32-e,g+=l>>>e),p[n]=g<q?c+g*f:h;p.unshift(c);return p},unstuff2:function(b,a,d,c,f,h,k,m){var n=(1<<d)-1,e=0,g,l=0,p=0,q,t,r;if(f)for(g=0;g<c;g++)0===l&&(t=b[e++],l=32,p=0),l>=d?(q=t>>>p&n,l-=d,p+=d):(r=d-l,q=t>>>p&n,t=b[e++],l=32-r,q|=(t&(1<<r)-1)<<d-r,p=r),a[g]=f[q];else{f=Math.ceil((m-h)/k);for(g=0;g<
c;g++)0===l&&(t=b[e++],l=32,p=0),l>=d?(q=t>>>p&n,l-=d,p+=d):(r=d-l,q=t>>>p&n,t=b[e++],l=32-r,q|=(t&(1<<r)-1)<<d-r,p=r),a[g]=q<f?h+q*k:m}return a},unstuffLUT2:function(b,a,d,c,f,h){for(var k=(1<<a)-1,m=0,n=0,e=0,g=0,l=0,p=0,q,t=[],r=Math.ceil((h-c)/f),n=0;n<d;n++)0===g&&(q=b[m++],g=32,p=0),g>=a?(l=q>>>p&k,g-=a,p+=a):(e=a-g,l=q>>>p&k,q=b[m++],g=32-e,l|=(q&(1<<e)-1)<<a-e,p=e),t[n]=l<r?c+l*f:h;t.unshift(c);return t},originalUnstuff:function(b,a,d,c){var f=(1<<d)-1,h=0,k,m=0,n,e;k=4*b.length-Math.ceil(d*
c/8);b[b.length-1]<<=8*k;for(k=0;k<c;k++)0===m&&(e=b[h++],m=32),m>=d?(n=e>>>m-d&f,m-=d):(m=d-m,n=(e&f)<<m&f,e=b[h++],m=32-m,n+=e>>>m),a[k]=n;return a},originalUnstuff2:function(b,a,d,c){var f=(1<<d)-1,h=0,k,m=0,n=0,e,g,l;for(k=0;k<c;k++)0===m&&(g=b[h++],m=32,n=0),m>=d?(e=g>>>n&f,m-=d,n+=d):(l=d-m,e=g>>>n&f,g=b[h++],m=32-l,e|=(g&(1<<l)-1)<<d-l,n=l),a[k]=e;return a}},v={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(b){for(var a=65535,d=65535,c=b.length,f=Math.floor(c/2),h=0;f;){var k=359<=
f?359:f,f=f-k;do a+=b[h++]<<8,d+=a+=b[h++];while(--k);a=(a&65535)+(a>>>16);d=(d&65535)+(d>>>16)}c&1&&(d+=a+=b[h]<<8);return((d&65535)+(d>>>16)<<16|(a&65535)+(a>>>16))>>>0},readHeaderInfo:function(b,a){var d=a.ptr,c=new Uint8Array(b,d,6),f={};f.fileIdentifierString=String.fromCharCode.apply(null,c);if(0!==f.fileIdentifierString.lastIndexOf("Lerc2",0))throw"Unexpected file identifier string (expect Lerc2 ): "+f.fileIdentifierString;d+=6;c=new DataView(b,d,52);f.fileVersion=c.getInt32(0,!0);d+=4;3<=
f.fileVersion&&(f.checksum=c.getUint32(4,!0),d+=4);c=new DataView(b,d,48);f.height=c.getUint32(0,!0);f.width=c.getUint32(4,!0);f.numValidPixel=c.getUint32(8,!0);f.microBlockSize=c.getInt32(12,!0);f.blobSize=c.getInt32(16,!0);f.imageType=c.getInt32(20,!0);f.maxZError=c.getFloat64(24,!0);f.zMin=c.getFloat64(32,!0);f.zMax=c.getFloat64(40,!0);d+=48;a.headerInfo=f;a.ptr=d;if(3<=f.fileVersion&&(d=this.computeChecksumFletcher32(new Uint8Array(b,d-48,f.blobSize-14)),d!==f.checksum))throw"Checksum failed.";
return!0},readMask:function(b,a){var d=a.ptr,c=a.headerInfo,f=c.width*c.height,h=c.numValidPixel,k=new DataView(b,d,4),c={};c.numBytes=k.getUint32(0,!0);d+=4;if((0===h||f===h)&&0!==c.numBytes)throw"invalid mask";if(0===h)h=new Uint8Array(Math.ceil(f/8)),c.bitset=h,k=new Uint8Array(f),a.pixels.resultMask=k,d+=c.numBytes;else if(0<c.numBytes){var h=new Uint8Array(Math.ceil(f/8)),k=new DataView(b,d,c.numBytes),m=k.getInt16(0,!0),n=2,e=0,g=0;do{if(0<m)for(;m--;)h[e++]=k.getUint8(n++);else{g=k.getUint8(n++);
for(m=-m;m--;)h[e++]=g}m=k.getInt16(n,!0);n+=2}while(n<c.numBytes);if(-32768!==m||e<h.length)throw"Unexpected end of mask RLE encoding";k=new Uint8Array(f);for(n=n=m=0;n<f;n++)n&7?(m=h[n>>3],m<<=n&7):m=h[n>>3],m&128&&(k[n]=1);a.pixels.resultMask=k;c.bitset=h;d+=c.numBytes}a.ptr=d;a.mask=c;return!0},readDataOneSweep:function(b,a,d){var c=a.ptr,f=a.headerInfo,h=f.width*f.height,f=f.numValidPixel*v.getDateTypeSize(f.imageType);if(d===Uint8Array)b=new Uint8Array(b,c,f);else{var k=new ArrayBuffer(f);(new Uint8Array(k)).set(new Uint8Array(b,
c,f));b=new d(k)}if(b.length===h)a.pixels.resultPixels=b;else{a.pixels.resultPixels=new d(h);for(k=k=d=0;k<h;k++)a.pixels.resultMask[k]&&(a.pixels.resultPixels[k]=b[d++])}a.ptr=c+f;return!0},readHuffman:function(b,a,d){var c=a.headerInfo,f=c.width*c.height,h=this.HUFFMAN_LUT_BITS_MAX,c=new DataView(b,a.ptr,16);a.ptr+=16;if(2>c.getInt32(0,!0))throw"unsupported Huffman version";var k=c.getInt32(4,!0),m=c.getInt32(8,!0),n=c.getInt32(12,!0);if(m>=n)return!1;var e=new Uint32Array(n-m);v.decodeBits(b,a,
e);for(var g=[],l,p,c=m;c<n;c++)l=c-(c<k?0:k),g[l]={first:e[c-m],second:null};c=b.byteLength-a.ptr;e=Math.ceil(c/4);e=new ArrayBuffer(4*e);(new Uint8Array(e)).set(new Uint8Array(b,a.ptr,c));b=new Uint32Array(e);var e=0,q,t=0;q=b[0];for(c=m;c<n;c++)l=c-(c<k?0:k),p=g[l].first,0<p&&(g[l].second=q<<e>>>32-p,32-e>=p?(e+=p,32===e&&(e=0,t++,q=b[t])):(e+=p-32,t++,q=b[t],g[l].second|=q>>>32-e));for(var r=0===a.headerInfo.imageType?128:0,y=a.headerInfo.height,A=a.headerInfo.width,s=0,w=0,z=new C,c=0;c<g.length;c++)void 0!==
g[c]&&(s=Math.max(s,g[c].first));w=s>=h?h:s;30<=s&&console.log("WARning, large NUM LUT BITS IS "+s);for(var h=[],u,c=m;c<n;c++)if(l=c-(c<k?0:k),p=g[l].first,0<p)if(q=[p,l],p<=w){l=g[l].second<<w-p;u=1<<w-p;for(m=0;m<u;m++)h[l|m]=q}else{l=g[l].second;u=z;for(m=p-1;0<=m;m--)(p=l>>>m&1)?(u.right||(u.right=new C),u=u.right):(u.left||(u.left=new C),u=u.left),0===m&&!u.val&&(u.val=q[1])}var k=a.pixels.resultMask,x,g=n=0;0<e&&(t++,e=0);q=b[t];d=new d(f);if(a.headerInfo.numValidPixel===A*y)for(c=m=0;c<y;c++)for(l=
0;l<A;l++,m++){f=0;g=x=q<<e>>>32-w;32-e<w&&(g=x|=b[t+1]>>>64-e-w);if(h[g])f=h[g][1],e+=h[g][0];else{x=q<<e>>>32-s;32-e<s&&(x|=b[t+1]>>>64-e-s);u=z;for(g=0;g<s;g++)if(u=(p=x>>>s-g-1&1)?u.right:u.left,!u.left&&!u.right){f=u.val;e=e+g+1;break}}32<=e&&(e-=32,t++,q=b[t]);f-=r;f=0<l?f+n:0<c?f+d[m-A]:f+n;f&=255;n=d[m]=f}else for(c=m=0;c<y;c++)for(l=0;l<A;l++,m++)if(k[m]){f=0;g=x=q<<e>>>32-w;32-e<w&&(g=x|=b[t+1]>>>64-e-w);if(h[g])f=h[g][1],e+=h[g][0];else{x=q<<e>>>32-s;32-e<s&&(x|=b[t+1]>>>64-e-s);u=z;for(g=
0;g<s;g++)if(u=(p=x>>>s-g-1&1)?u.right:u.left,!u.left&&!u.right){f=u.val;e=e+g+1;break}}32<=e&&(e-=32,t++,q=b[t]);f-=r;f=0<l&&k[m-1]?f+n:0<c&&k[m-A]?f+d[m-A]:f+n;f&=255;n=d[m]=f}a.pixels.resultPixels=d;a.ptr=a.ptr+4*(t+1)+(0<e?4:0)},decodeBits:function(b,a,d,c){var f=a.headerInfo.fileVersion,h=0,k=new DataView(b,a.ptr,5),m=k.getUint8(0);h++;var n=m>>6,e=0===n?4:3-n,g=0<(m&32)?!0:!1,n=m&31,m=0;if(1===e)m=k.getUint8(h),h++;else if(2===e)m=k.getUint16(h,!0),h+=2;else if(4===e)m=k.getUint32(h,!0),h+=
4;else throw"Invalid valid pixel count type";c=c||0;var e=2*a.headerInfo.maxZError,l,p,q;if(g){a.counter.lut++;q=k.getUint8(h);h++;g=Math.ceil((q-1)*n/8);l=Math.ceil(g/4);l=new ArrayBuffer(4*l);p=new Uint8Array(l);a.ptr+=h;p.set(new Uint8Array(b,a.ptr,g));h=new Uint32Array(l);a.ptr+=g;for(k=0;q-1>>>k;)k++;g=Math.ceil(m*k/8);l=Math.ceil(g/4);l=new ArrayBuffer(4*l);p=new Uint8Array(l);p.set(new Uint8Array(b,a.ptr,g));b=new Uint32Array(l);a.ptr+=g;a=3<=f?B.unstuffLUT2(h,n,q-1,c,e,a.headerInfo.zMax):
B.unstuffLUT(h,n,q-1,c,e,a.headerInfo.zMax);3<=f?B.unstuff2(b,d,k,m,a):B.unstuff(b,d,k,m,a)}else a.counter.bitstuffer++,k=n,a.ptr+=h,0<k&&(g=Math.ceil(m*k/8),l=Math.ceil(g/4),l=new ArrayBuffer(4*l),p=new Uint8Array(l),p.set(new Uint8Array(b,a.ptr,g)),b=new Uint32Array(l),a.ptr+=g,3<=f?B.unstuff2(b,d,k,m,!1,c,e,a.headerInfo.zMax):B.unstuff(b,d,k,m,!1,c,e,a.headerInfo.zMax))},readTiles:function(b,a,d){var c=a.headerInfo,f=c.width,h=c.height,k=c.microBlockSize,c=c.imageType,m=Math.ceil(f/k),n=Math.ceil(h/
k);a.pixels.numBlocksY=n;a.pixels.numBlocksX=m;for(var e=a.pixels.ptr=0,g=0,l=0,p=0,q=0,t=0,r=0,y=0,A=e=0,s=0,w=0,r=r=e=r=0,z,u=new d(k*k),h=h%k||k,x=f%k||k,l=0;l<n;l++){q=l!==n-1?k:h;for(p=0;p<m;p++){t=p!==m-1?k:x;s=l*f*k+p*k;w=f-t;r=b.byteLength-a.ptr;g=new DataView(b,a.ptr,Math.min(10,r));z={};r=0;y=g.getUint8(0);r++;e=y>>6&255;A=y>>2&15;if(A!==(p*k>>3&15))throw"integrity issue";y&=3;if(3<y)throw a.ptr+=r,"Invalid block encoding ("+y+")";if(2===y)a.counter.constant++,a.ptr+=r;else if(0===y){a.counter.uncompressed++;
a.ptr+=r;r=q*t*v.getDateTypeSize(c);e=b.byteLength-a.ptr;r=r<e?r:e;e=new ArrayBuffer(r);g=new Uint8Array(e);g.set(new Uint8Array(b,a.ptr,r));z=new d(e);r=0;if(a.pixels.resultMask)for(e=0;e<q;e++){for(g=0;g<t;g++)a.pixels.resultMask[s]&&(a.pixels.resultPixels[s]=z[r++]),s++;s+=w}else for(e=0;e<q;e++){for(g=0;g<t;g++)a.pixels.resultPixels[s++]=z[r++];s+=w}a.ptr+=r*v.getDateTypeSize(c)}else if(e=v.getDataTypeUsed(c,e),z=v.getOnePixel(z,r,e,g),r+=v.getDateTypeSize(e),3===y)if(a.ptr+=r,a.counter.constantoffset++,
a.pixels.resultMask)for(e=0;e<q;e++){for(g=0;g<t;g++)a.pixels.resultMask[s]&&(a.pixels.resultPixels[s]=z),s++;s+=w}else for(e=0;e<q;e++){for(g=0;g<t;g++)a.pixels.resultPixels[s++]=z;s+=w}else if(a.ptr+=r,v.decodeBits(b,a,u,z),r=0,a.pixels.resultMask)for(e=0;e<q;e++){for(g=0;g<t;g++)a.pixels.resultMask[s]&&(a.pixels.resultPixels[s]=u[r++]),s++;s+=w}else for(e=0;e<q;e++){for(g=0;g<t;g++)a.pixels.resultPixels[s++]=u[r++];s+=w}}}},formatFileInfo:function(b){return{fileIdentifierString:b.headerInfo.fileIdentifierString,
fileVersion:b.headerInfo.fileVersion,imageType:b.headerInfo.imageType,height:b.headerInfo.height,width:b.headerInfo.width,numValidPixel:b.headerInfo.numValidPixel,microBlockSize:b.headerInfo.microBlockSize,blobSize:b.headerInfo.blobSize,maxZError:b.headerInfo.maxZError,pixelType:v.getPixelType(b.headerInfo.imageType),eofOffset:b.eofOffset,mask:b.mask?{numBytes:b.mask.numBytes}:null,pixels:{numBlocksX:b.pixels.numBlocksX,numBlocksY:b.pixels.numBlocksY,maxValue:b.headerInfo.zMax,minValue:b.headerInfo.zMin,
noDataValue:b.noDataValue}}},constructConstantSurface:function(b){var a=b.headerInfo.zMax,d=b.headerInfo.height*b.headerInfo.width,c=0;if(b.pixels.resultMask)for(c=0;c<d;c++)b.pixels.resultMask[c]&&(b.pixels.resultPixels[c]=a);else for(c=0;c<d;c++)b.pixels.resultPixels[c]=a},getDataTypeArray:function(b){switch(b){case 0:b=Int8Array;break;case 1:b=Uint8Array;break;case 2:b=Int16Array;break;case 3:b=Uint16Array;break;case 4:b=Int32Array;break;case 5:b=Uint32Array;break;case 6:b=Float32Array;break;case 7:b=
Float64Array;break;default:b=Float32Array}return b},getPixelType:function(b){switch(b){case 0:b="S8";break;case 1:b="U8";break;case 2:b="S16";break;case 3:b="U16";break;case 4:b="S32";break;case 5:b="U32";break;case 6:b="F32";break;case 7:b="F64";break;default:b="F32"}return b},isValidPixelValue:function(b,a){if(null===a||void 0===a)return!1;var d;switch(b){case 0:d=-128<=a&&127>=a;break;case 1:d=0<=a&&255>=a;break;case 2:d=-32768<=a&&32767>=a;break;case 3:d=0<=a&&65536>=a;break;case 4:d=-2147483648<=
a&&2147483647>=a;break;case 5:d=0<=a&&4294967296>=a;break;case 6:d=-3.4027999387901484E38<=a&&3.4027999387901484E38>=a;break;case 7:d=4.9E-324<=a&&1.7976931348623157E308>=a;break;default:d=!1}return d},getDateTypeSize:function(b){var a=0;switch(b){case 0:case 1:a=1;break;case 2:case 3:a=2;break;case 4:case 5:case 6:a=4;break;case 7:a=8;break;default:a=b}return a},getDataTypeUsed:function(b,a){var d=b;switch(b){case 2:case 4:d=b-a;break;case 3:case 5:d=b-2*a;break;case 6:d=0===a?b:1===a?2:1;break;
case 7:d=0===a?b:b-2*a+1;break;default:d=b}return d},getOnePixel:function(b,a,d,c){b=0;switch(d){case 0:b=c.getInt8(a);break;case 1:b=c.getUint8(a);break;case 2:b=c.getInt16(a,!0);break;case 3:b=c.getUint16(a,!0);break;case 4:b=c.getInt32(a,!0);break;case 5:b=c.getUInt32(a,!0);break;case 6:b=c.getFloat32(a,!0);break;case 7:b=c.getFloat64(a,!0);break;default:throw"the decoder does not understand this pixel type";}return b}},C=function(b,a,d){this.val=b;this.left=a;this.right=d};return{decode:function(b,
a){a=a||{};var d=a.maskData||null===a.maskData,c=a.noDataValue,f=0,h={};h.ptr=a.inputOffset||0;h.pixels={};if(v.readHeaderInfo(b,h)){var f=h.headerInfo,k=v.getDataTypeArray(f.imageType);if(d)h.pixels.resultMask=a.maskData,h.ptr+=4;else if(!v.readMask(b,h))return;d=f.width*f.height;h.pixels.resultPixels=new k(d);h.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0};if(0!==f.numValidPixel)if(f.zMax===f.zMin)v.constructConstantSurface(h);else{var m=new DataView(b,h.ptr,
2),n=m.getUint8(0,!0);h.ptr++;n?v.readDataOneSweep(b,h,k):1<f.fileVersion&&1>=f.imageType&&1E-5>Math.abs(f.maxZError-0.5)?(m=m.getUint8(1,!0),h.ptr++,m?v.readHuffman(b,h,k):v.readTiles(b,h,k)):v.readTiles(b,h,k)}h.eofOffset=h.ptr;a.inputOffset?(k=h.headerInfo.blobSize+a.inputOffset-h.ptr,1<=Math.abs(k)&&(h.eofOffset=a.inputOffset+h.headerInfo.blobSize)):(k=h.headerInfo.blobSize-h.ptr,1<=Math.abs(k)&&(h.eofOffset=h.headerInfo.blobSize));k={width:f.width,height:f.height,pixelData:h.pixels.resultPixels,
minValue:f.zMin,maxValue:f.zMax,maskData:h.pixels.resultMask};if(h.pixels.resultMask&&v.isValidPixelValue(f.imageType,c)){m=h.pixels.resultMask;for(f=0;f<d;f++)m[f]||(k.pixelData[f]=c);k.noDataValue=c}h.noDataValue=c;a.returnFileInfo&&(k.fileInfo=v.formatFileInfo(h));return k}},getBandCount:function(b){for(var a=0,d=0,c={ptr:0,pixels:{}};d<b.byteLength-58;)v.readHeaderInfo(b,c),d+=c.headerInfo.blobSize,a++,c.ptr=d;return a}}});