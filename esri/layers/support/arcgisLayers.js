// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports dojo/_base/lang dojo/when ./arcgisLayerUrl ../../core/promiseUtils ../../core/requireUtils ../../request ../../core/Error ./arcgisLayerUrl".split(" "),function(h,k,d,q,r,e,l,m,s,t){function u(b,a){return b.sublayerIds.map(function(c){return new b.Constructor(d.mixin({},a,{layerId:c,sublayerTitleMode:"service-name"}))})}function v(b){var a=t.parse(b);if(!a)return e.reject(new s("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:b}));var c=a.serverType,
n=a.sublayer;switch(c){case "MapServer":c=null!=n?"FeatureLayer":w(b).then(function(a){return a?"TileLayer":"MapImageLayer"});break;case "ImageServer":c=f(b).then(function(a){var b=a.tileInfo&&a.tileInfo.format;return a.tileInfo?b&&"LERC"===b.toUpperCase()&&a.cacheType&&"elevation"===a.cacheType.toLowerCase()?"ElevationLayer":"TileLayer":"ImageryLayer"});break;case "SceneServer":c=f(a.url.path).then(function(a){var b={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",
PointCloud:"PointCloudLayer"};return a&&(Array.isArray(a.layers)&&0<a.layers.length)&&(a=a.layers[0].layerType,null!=b[a])?b[a]:"SceneLayer"});break;default:c={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"}[c]}var x={FeatureLayer:!0,SceneLayer:!0},g={parsedUrl:a,Constructor:null,sublayerIds:null},d;return q(c).then(function(a){d=a;if(x[a]&&null==n)return y(b).then(function(a){1!==a.length&&(g.sublayerIds=a)})}).then(function(){return l.when(h,p+"/"+d)}).then(function(a){g.Constructor=
a;return g})}function y(b){return f(b).then(function(a){return a&&Array.isArray(a.layers)?a.layers.map(function(a){return a.id}).reverse():[]})}function w(b){return f(b).then(function(a){return a.tileInfo})}function z(b,a){var c=b.Constructor.prototype.declaredClass;return"esri.layers.FeatureLayer"===c||"esri.layers.StreamLayer"===c?d.mixin({returnZ:!0,outFields:["*"]},a):a}function f(b){return m(b,{responseType:"json",callbackParamName:"callback",query:{f:"json"}}).then(function(a){return a.data})}
var p="..";k.fromUrl=function(b){return v(b.url).then(function(a){var c=z(a,d.mixin({},b.properties,{url:b.url}));return a.sublayerIds?l.when(h,p+"/GroupLayer").then(function(b){var d=new b({title:a.parsedUrl.title});u(a,c).forEach(function(a){return d.add(a)});return e.resolve(d)}):e.resolve(new a.Constructor(c))})};k.fetchServerVersion=function(b){if(!r.test(b))return e.reject();b=b.replace(/(.*\/rest)\/.*/i,"$1")+"/info";return m(b,{query:{f:"json"},responseType:"json",callbackParamName:"callback"}).then(function(a){return a.data&&
a.data.currentVersion?a.data.currentVersion:e.reject()})}});