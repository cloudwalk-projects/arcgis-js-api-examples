// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/paramHelper ../../core/accessorSupport/decorators dojo/io-query ../../core/Collection ../../core/JSONSupport ../../core/Logger ../../core/lang ../../core/accessorSupport/ensureType ../../renderers/support/jsonUtils ../../tasks/QueryTask ../../tasks/support/Query ../../PopupTemplate ./LabelClass ./layerSourceUtils".split(" "),function(z,A,l,e,m,c,n,p,q,r,g,s,t,u,h,v,w,f){var x=
r.getLogger("esri.layers.support.Sublayer"),y=0;return function(k){function a(){k.apply(this,arguments);this._sublayersHandles=null}l(a,k);Object.defineProperty(a.prototype,"definitionExpression",{get:function(){return this._get("definitionExpression")},set:function(b){this._setAndNotifyLayer("definitionExpression",b)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"id",{get:function(){var b=this._get("id");return null==b?y++:b},set:function(b){this._set("id",b)},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"labelingInfo",{get:function(){return this._get("labelingInfo")},set:function(b){this._setAndNotifyLayer("labelingInfo",b)},enumerable:!0,configurable:!0});a.prototype.writeLabelingInfo=function(b,a,d){if((!d||d.writeAsDynamic)&&b&&b.length)a.layerDefinition={drawingInfo:{labelingInfo:b.map(function(b){return b.write({},d)})}}};Object.defineProperty(a.prototype,"labelsVisible",{get:function(){return this._get("labelsVisible")},set:function(b){this._setAndNotifyLayer("labelsVisible",
b)},enumerable:!0,configurable:!0});a.prototype.writeLabelsVisible=function(b,a,d){if(!d||d.writeAsDynamic)a.showLabels=b};Object.defineProperty(a.prototype,"legendEnabled",{get:function(){return this._get("legendEnabled")},set:function(b){this._set("legendEnabled",b)},enumerable:!0,configurable:!0});a.prototype.writeLegendEnabled=function(b,a,d){b||(a.showLegend=!1)};Object.defineProperty(a.prototype,"layer",{set:function(b){this._set("layer",b);this.sublayers&&this.sublayers.forEach(function(a){return a.layer=
b})},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"minScale",{get:function(){return this._get("minScale")},set:function(b){this._set("minScale",b)},enumerable:!0,configurable:!0});a.prototype.readMinScale=function(b,a){return a.minScale||a.layerDefinition&&a.layerDefinition.minScale||0};a.prototype.writeMinScale=function(b,a,d){if(d&&d.writeOverridesOnly&&(d=d&&d.serviceSublayer)&&d.minScale===b&&d.maxScale===this.maxScale)return;a.minScale=b};Object.defineProperty(a.prototype,
"maxScale",{get:function(){return this._get("maxScale")},set:function(b){this._set("maxScale",b)},enumerable:!0,configurable:!0});a.prototype.readMaxScale=function(b,a){return a.maxScale||a.layerDefinition&&a.layerDefinition.maxScale||0};a.prototype.writeMaxScale=function(b,a,d){if(d&&d.writeOverridesOnly&&(d=d&&d.serviceSublayer)&&d.maxScale===b&&d.minScale===this.minScale)return;a.maxScale=b};Object.defineProperty(a.prototype,"opacity",{get:function(){return this._get("opacity")},set:function(b){this._setAndNotifyLayer("opacity",
b)},enumerable:!0,configurable:!0});a.prototype.readOpacity=function(b,a){return 1-0.01*a.layerDefinition.drawingInfo.transparency};a.prototype.writeOpacity=function(b,a,d){if(!d||d.writeAsDynamic)a.layerDefinition={drawingInfo:{transparency:100-100*b}}};a.prototype.writeParent=function(b,a,d){if(!d||!d.writeOverridesOnly)a.parentLayerId=!this.parent||this.parent===this.layer?-1:this.parent.id};Object.defineProperty(a.prototype,"popupTemplate",{get:function(){return this._get("popupTemplate")},set:function(b){this._set("popupTemplate",
b)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"renderer",{get:function(){return this._get("renderer")},set:function(b){this._setAndNotifyLayer("renderer",b)},enumerable:!0,configurable:!0});a.prototype.readRenderer=function(b,a,d){if(b=a.layerDefinition.drawingInfo.renderer||void 0)(b=t.read(b,a,d)||void 0)||x.error("Failed to create renderer",{rendererDefinition:a.drawingInfo.renderer,layer:this,context:d});return b};a.prototype.writeRenderer=function(b,a,d){if(!d||d.writeAsDynamic)a.layerDefinition=
{drawingInfo:{renderer:b.toJSON()}}};Object.defineProperty(a.prototype,"source",{get:function(){return this._get("source")||{mapLayerId:this.id,type:f.MAPLAYER}},set:function(b){this._setAndNotifyLayer("source",b)},enumerable:!0,configurable:!0});a.prototype.writeSource=function(b,a,d){if(!d||d.writeAsDynamic||!d.writeOverridesOnly)a.layerDefinition={source:f.sourceToJSON(b)}};Object.defineProperty(a.prototype,"sublayers",{set:function(a){var c=this,d=this._get("sublayers");d&&(d.forEach(function(a){a.parent=
null;a.layer=null}),this._sublayersHandles.forEach(function(a){return a.remove()}),this._sublayersHandles=null);a&&(a.forEach(function(a){a.parent=c;a.layer=c.layer}),this._sublayersHandles=[a.on("after-add",function(a){a=a.item;a.parent=c;a.layer=c.layer}),a.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})]);this._set("sublayers",a)},enumerable:!0,configurable:!0});a.prototype.castSublayers=function(b){return s.default(p.ofType(a),b)};a.prototype.writeSublayers=function(a,c,d){if(!d||
!d.writeOverridesOnly)c.subLayerIds=this.get("sublayers.length")?this.sublayers.map(function(a){return a.id}).toArray().reverse():null};Object.defineProperty(a.prototype,"title",{get:function(){return this._get("title")},set:function(a){this._set("title",a)},enumerable:!0,configurable:!0});a.prototype.writeTitle=function(a,c,d){if(d&&d.writeOverridesOnly&&(d=d&&d.serviceSublayer)&&d.title===a)return;c.name=a};Object.defineProperty(a.prototype,"url",{get:function(){var a=this.layer,c=this.source;if(!a)return null;
if(f.isMapLayerSource(c))return a.parsedUrl.path+"/"+c.mapLayerId;c={layer:JSON.stringify({source:f.sourceToJSON(this.source)})};return a.parsedUrl.path+"/dynamicLayer?"+n.objectToQuery(c)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"visible",{get:function(){return this._get("visible")},set:function(a){this._setAndNotifyLayer("visible",a)},enumerable:!0,configurable:!0});a.prototype.writeVisible=function(a,c,d){if(d&&d.writeOverridesOnly&&(d=d&&d.serviceSublayer)&&d.visible===
a)return;c.defaultVisibility=a};a.prototype.clone=function(){var b=new a;this.hasOwnProperty("definitionExpression")&&(b.definitionExpression=this.definitionExpression);this.hasOwnProperty("id")&&(b.id=this.id);this.hasOwnProperty("labelingInfo")&&(b.labelingInfo=g.clone(this.labelingInfo));this.hasOwnProperty("labelsVisible")&&(b.labelsVisible=this.labelsVisible);this.hasOwnProperty("legendEnabled")&&(b.legendEnabled=this.legendEnabled);this.hasOwnProperty("visible")&&(b.visible=this.visible);this.hasOwnProperty("layer")&&
(b.layer=this.layer);this.hasOwnProperty("minScale")&&(b.minScale=this.minScale);this.hasOwnProperty("maxScale")&&(b.maxScale=this.maxScale);this.hasOwnProperty("opacity")&&(b.opacity=this.opacity);this.hasOwnProperty("parent")&&(b.parent=this.parent);this.hasOwnProperty("popupTemplate")&&(b.popupTemplate=this.popupTemplate.clone());this.hasOwnProperty("renderer")&&(b.renderer=this.renderer.clone());this.hasOwnProperty("source")&&(b.source=g.clone(this.source));this.hasOwnProperty("sublayers")&&(b.sublayers=
this.sublayers.clone());this.hasOwnProperty("title")&&(b.title=this.title);return b};a.prototype.createQuery=function(){return new h({returnGeometry:!0,where:this.definitionExpression||"1\x3d1"})};a.prototype.queryFeatures=function(a){var c=this;void 0===a&&(a=this.createQuery());return(new u({url:this.url})).execute(a).then(function(a){a&&a.features&&a.features.forEach(function(a){a.popupTemplate=c.popupTemplate});return a})};a.prototype.toExportImageJSON=function(){var a={id:this.id,source:f.sourceToJSON(this.source)};
this.definitionExpression&&(a.definitionExpression=this.definitionExpression);if(this.renderer||this.labelingInfo||null!=this.opacity||null!=this.labelsVisible){var c=a.drawingInfo={};this.renderer&&(c.renderer=this.renderer.toJSON());null!=this.labelsVisible&&(c.showLabels=this.labelsVisible);!1!==this.labelsVisible&&this.labelingInfo&&(c.labelingInfo=this.labelingInfo);null!=this.opacity&&(c.transparency=100-100*this.opacity)}return a};a.prototype._setAndNotifyLayer=function(a,c){var d=this.layer;
this._get(a)!==c&&(this._set(a,c),d&&d.emit("sublayer-update",{propertyName:a}))};e([c.property({value:null,json:{readFrom:"layerDefinition.definitionExpression",writeTo:"layerDefinition.definitionExpression"}})],a.prototype,"definitionExpression",null);e([c.property({json:{writeAlways:!0}})],a.prototype,"id",null);e([c.property({value:null,type:[w],json:{readFrom:"layerDefinition.drawingInfo.labelingInfo"}})],a.prototype,"labelingInfo",null);e([c.write("labelingInfo")],a.prototype,"writeLabelingInfo",
null);e([c.property({json:{readFrom:"showLabels"}})],a.prototype,"labelsVisible",null);e([c.write("labelsVisible")],a.prototype,"writeLabelsVisible",null);e([c.property({value:!0,type:Boolean,json:{readFrom:"showLegend"}})],a.prototype,"legendEnabled",null);e([c.write("showLegend")],a.prototype,"writeLegendEnabled",null);e([c.property({value:null})],a.prototype,"layer",null);e([c.property({value:0,json:{writable:!0,writeWith:["maxScale"]}})],a.prototype,"minScale",null);e([c.read("portal-item","minScale",
["minScale","layerDefinition.minScale"])],a.prototype,"readMinScale",null);e([c.write("minScale")],a.prototype,"writeMinScale",null);e([c.property({value:0,json:{writable:!0,writeWith:["minScale"]}})],a.prototype,"maxScale",null);e([c.read("portal-item","maxScale",["maxScale","layerDefinition.maxScale"])],a.prototype,"readMaxScale",null);e([c.write("maxScale")],a.prototype,"writeMaxScale",null);e([c.property()],a.prototype,"opacity",null);e([c.read("opacity",["layerDefinition.drawingInfo.transparency"])],
a.prototype,"readOpacity",null);e([c.write("opacity")],a.prototype,"writeOpacity",null);e([c.property({json:{writeNull:!0}})],a.prototype,"parent",void 0);e([c.write("parent")],a.prototype,"writeParent",null);e([c.property({value:null,type:v,json:{readFrom:"popupInfo",writeTo:"popupInfo"}})],a.prototype,"popupTemplate",null);e([c.property({value:null,json:{writeTo:"layerDefinition.drawingInfo.renderer"}})],a.prototype,"renderer",null);e([c.read("renderer",["layerDefinition.drawingInfo.renderer"])],
a.prototype,"readRenderer",null);e([c.write("renderer")],a.prototype,"writeRenderer",null);e([c.property({cast:f.castSource,json:{read:f.sourceFromJSON,readFrom:"layerDefinition.source"}})],a.prototype,"source",null);e([c.write("source")],a.prototype,"writeSource",null);e([c.property({value:null,json:{writeNull:!0}})],a.prototype,"sublayers",null);e([c.cast("sublayers")],a.prototype,"castSublayers",null);e([c.write("sublayers")],a.prototype,"writeSublayers",null);e([c.property({value:null,json:{readFrom:"name",
writeAlways:!0,writeNull:!0}})],a.prototype,"title",null);e([c.write("title")],a.prototype,"writeTitle",null);e([c.property({readOnly:!0,dependsOn:["layer","source"]})],a.prototype,"url",null);e([c.property({value:!0,json:{readFrom:"defaultVisibility"}})],a.prototype,"visible",null);e([c.write("visible")],a.prototype,"writeVisible",null);e([m(0,c.cast(h))],a.prototype,"queryFeatures",null);return a=e([c.subclass("esri.layers.support.Sublayer")],a)}(c.declared(q))});