// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("require dojo/_base/lang dojo/io-query ../Graphic ../PopupTemplate ../request ../core/lang ../core/kebabDictionary ../core/MultiOriginJSONSupport ../core/sniff ../core/Collection ../core/Error ../core/Logger ../core/HandleRegistry ../core/promiseUtils ../core/requireUtils ../core/urlUtils ../geometry/Extent ../geometry/SpatialReference ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/support/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/support/arcadeUtils ../renderers/support/jsonUtils ../renderers/support/styleUtils ../tasks/support/FeatureSet ../tasks/support/Query ./Layer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/ScaleRangeLayer ./mixins/ArcGISService ./graphics/sources/MemorySource ./support/Field ./support/FeatureType ./support/LabelClass ./support/arcgisLayerUrl".split(" "),
function(t,l,u,C,v,D,E,k,F,w,m,e,n,G,h,x,f,y,H,I,J,K,s,z,L,A,M,N,O,P,Q,R,S,T,U,p,V,W,X,q){var B=k({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",absoluteHeight:"absolute-height"});k=k({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});var Y=n.getLogger("esri.layers.FeatureLayer");n=function(a,b){var c=O.fromJSON(b.featureSet);return new p({layer:this,items:c&&c.features||
[]})};var r=Q.createSubclass([R,S,T,U,F],{declaredClass:"esri.layers.FeatureLayer",viewModulePaths:{"2d":"../views/2d/layers/FeatureLayerView2D","3d":"../views/3d/layers/FeatureLayerView3D"},constructor:function(){this._handles=new G},normalizeCtorArgs:function(a,b){return"string"===typeof a?l.mixin({},{url:a},b):a},load:function(){var a;a=this.source&&(Array.isArray(this.source)||this.source.isInstanceOf&&this.source.isInstanceOf(m));a=this.portalItem&&a?h.resolve():this.loadFromPortal({supportedTypes:["Feature Service",
"Feature Collection"]}).always(function(){if(this.url&&null==this.layerId&&/FeatureServer\/*$/i.test(this.url))return this._fetchFirstLayerId().then(function(a){null!=a&&(this.layerId=a)}.bind(this))}.bind(this)).then(function(){if(!this.url&&!this._hasMemorySource())throw new e("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this.createGraphicsSource().then(this._initLayerProperties.bind(this))}.bind(this));this.addResolvingPromise(a)},
_handles:null,_rndProps:"field field2 field3 normalizationField rotationInfo.field proportionalSymbolInfo.field proportionalSymbolInfo.normalizationField colorInfo.field colorInfo.normalizationField".split(" "),_visVariableProps:["field","normalizationField"],controllerModulePaths:{"0":"./graphics/controllers/SnapshotController",1:{"2d":"./graphics/controllers/OnDemandController","3d":"./graphics/controllers/OnDemandController"},2:"./graphics/controllers/SelectionController",6:"./graphics/controllers/AutoController"},
properties:{advancedQueryCapabilities:{json:{readFrom:["supportsStatistics","supportsAdvancedQueries"],read:function(a,b){return a||{supportsPagination:!1,supportsQueryWithDistance:!1,supportsReturningQueryExtent:!1,supportsStatistics:b.supportsStatistics,supportsOrderBy:b.supportsAdvancedQueries,supportsDistinct:b.supportsAdvancedQueries}}}},allowGeometryUpdates:{json:{read:function(a){return null==a?!0:a}}},allRenderers:{readOnly:!0,dependsOn:["loaded","renderer","fields"],get:function(){return this._getAllRenderers(this.renderer)}},
capabilities:{json:{read:function(a){return a&&a.split(",").map(function(a){return a.trim()})}}},copyright:{value:null,json:{readFrom:["copyrightText"],read:function(a,b){return b.copyrightText}}},definitionExpression:{value:null,json:{origins:{service:{readable:!1}},write:function(a,b){a&&(b.layerDefinition={definitionExpression:a})}}},defaultSymbol:{json:{read:s.read}},editable:{value:!1,get:function(){return this.userIsAdmin||this._hasMemorySource()||this._get("editable")},json:{readFrom:["capabilities"],
read:function(a,b){b.capabilities&&(a=-1!==b.capabilities.toLowerCase().indexOf("editing"));return!!a}}},elevationInfo:{value:null,json:{read:function(a){a=E.clone(a);a.mode=B.fromJSON(a.mode);return a},write:function(a,b){if(a&&(a.mode||a.offset||a.featureExpression)){var c={};a.mode&&(c.mode=B.toJSON(a.mode));a.offset&&(c.offset=a.offset);a.featureExpression&&(c.featureExpression=a.featureExpression);b.layerDefinition={elevationInfo:c}}}}},fields:{value:null,type:[V]},fullExtent:{value:null,type:y,
json:{readFrom:["extent"],read:function(a,b){return b.extent&&y.fromJSON(b.extent)}}},gdbVersion:null,generalizeForScale:4E3,geometryType:{json:{read:k.fromJSON}},hasAttachments:{value:!1,readOnly:!0,get:function(){return!this._hasMemorySource()&&this._get("hasAttachments")}},hasM:!1,hasZ:!1,id:{json:{origins:{service:{readable:!1},portalItem:{readable:!1}}}},isTable:{value:!1,readOnly:!0,json:{readFrom:["type"],read:function(a,b){return"Table"===b.type}}},labelsVisible:{value:!1,json:{readFrom:["showLabels"],
read:function(a,b){return!!b.showLabels},write:function(a,b){a&&(b.showLabels=a)}}},labelingInfo:{value:null,json:{readFrom:["drawingInfo.labelingInfo"],read:function(a,b,c){a=b.drawingInfo&&b.drawingInfo.labelingInfo;if(!a)return null;var d=/\[([^\[\]]+)\]/ig,g,Z=function(a,c){var d=this.getField(c,b.fields);return"["+(d&&d.name||c)+"]"}.bind(this);return a.map(function(a){var b=new X;b.read(a,c);if(g=b.labelExpression)b.labelExpression=g.replace(d,Z);return b})},write:function(a,b,c){a&&(b.layerDefinition=
{drawingInfo:{labelingInfo:a.map(function(a){return a.write({},c)})}})}}},layerId:{json:{origins:{service:{readFrom:["id"],read:function(a,b){return b.id}}},readable:!1}},legendEnabled:{value:!0,json:{readFrom:["showLegend"],read:function(a,b){return null!=b.showLegend?b.showLegend:!0},write:function(a,b){a||(b.showLegend=!1)}}},maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxRecordCount:null,maxVertexCountForAuto:25E4,minScale:{json:{readFrom:["minScale","effectiveMinScale"],read:function(a,
b){return b.effectiveMinScale||a},writeTo:"layerDefinition.minScale"}},maxScale:{json:{readFrom:["maxScale","effectiveMaxScale"],read:function(a,b){return b.effectiveMaxScale||a},writeTo:"layerDefinition.maxScale"}},mode:{dependsOn:["source"],get:function(){return r.MODE_SNAPSHOT}},objectIdField:{json:{readFrom:["fields"],read:function(a,b){a||b.fields.some(function(b){"esriFieldTypeOID"===b.type&&(a=b.name);return!!a});return a}}},operationalLayerType:"ArcGISFeatureLayer",outFields:{value:null,dependsOn:["requiredFields"],
get:function(){var a=this._get("outFields"),b=this.requiredFields;a?-1===a.indexOf("*")&&b.forEach(function(b){-1===a.indexOf(b)&&a.push(b)}):a=b;this.loaded&&(a=a.filter(function(a){return"*"===a||!!this.getField(a)},this),a=a.map(function(a){return"*"===a?a:this.getField(a).name},this));return a},set:function(a){var b=this.requiredFields;a?-1===a.indexOf("*")&&b.forEach(function(b){-1===a.indexOf(b)&&a.push(b)}):a=b;this.loaded&&(a=a.filter(function(a){return"*"===a||!!this.getField(a)},this),a=
a.map(function(a){return"*"===a?a:this.getField(a).name},this));this._set("outFields",a)}},parsedUrl:{dependsOn:["layerId"],get:function(){var a=this.url?f.urlToObject(this.url):null;null!=this.layerId&&null!=a&&(a.path=f.join(a.path,this.layerId.toString()));return a}},popupEnabled:{value:!0,json:{readFrom:["disablePopup"],read:function(a,b){return null!=b.disablePopup?!b.disablePopup:!0},write:function(a,b){a||(b.disablePopup=!0)}}},popupTemplate:{value:null,type:v,json:{readFrom:["popupInfo"],
read:function(a,b){return b.popupInfo?v.fromJSON(b.popupInfo):null},write:function(a,b){a&&(b.popupInfo=a.toJSON())}}},relationships:null,renderer:{set:function(a){var b=this._getAllRenderers(a);this._fixRendererFields(b);this._set("renderer",a)},json:{readFrom:["drawingInfo.renderer","defaultSymbol","type"],read:function(a,b,c){var d;if(a=b.drawingInfo&&b.drawingInfo.renderer||void 0)(a=M.read(a,b,c)||void 0)||Y.error("Failed to create renderer",{rendererDefinition:b.drawingInfo.renderer,layer:this,
context:c});else if(b.defaultSymbol)s.read(b.defaultSymbol,b,c),b.types&&b.types.length?(a=new L({defaultSymbol:d,field:b.typeIdField}),b.types.forEach(function(b){a.addUniqueValueInfo(b.id,s.read(b.symbol,b,c))})):a=new z({symbol:d});else if("Table"!==b.type){switch(b.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":d=new I;break;case "esriGeometryPolyline":d=new J;break;case "esriGeometryPolygon":d=new K}a=d&&new z({symbol:d})}return a},writeTo:"layerDefinition.drawingInfo.renderer"}},
requiredFields:{dependsOn:["allRenderers"],get:function(){var a=this.timeInfo,b=[this.objectIdField,this.typeIdField,this.editFieldsInfo&&this.editFieldsInfo.creatorField,a&&a.startTimeField,a&&a.endTimeField,this.trackIdField],c=this._rndProps,d=[];this.allRenderers.forEach(function(a){c.forEach(function(c){b.push(l.getObject(c,!1,a))});a.valueExpression&&(d=d.concat(A.extractFieldNames(a.valueExpression)));a.visualVariables&&a.visualVariables.forEach(function(a){this._visVariableProps.forEach(function(c){b.push(a[c])});
a.valueExpression&&(d=d.concat(A.extractFieldNames(a.valueExpression)))},this)},this);b=b.concat(d);b=b.concat(this.dataAttributes);return b.filter(function(a,b,c){return!!a&&c.indexOf(a)===b&&"function"!==typeof a})}},returnM:!1,returnZ:!1,source:{json:{origins:{portalItem:{readFrom:["featureSet"],read:n},webMap:{readFrom:["featureSet"],read:n}}},cast:function(a){return a&&(Array.isArray(a)||a.isInstanceOf&&a.isInstanceOf(m))?new p({layer:this,items:a}):a},set:function(a){var b=this._get("source");
b!==a&&(b&&(b.isInstanceOf&&b.isInstanceOf(p))&&this._resetMemorySource(b),a&&(a.isInstanceOf&&a.isInstanceOf(p))&&this._initMemorySource(a),this._set("source",a))}},supportsCoordinatesQuantization:!1,serviceDefinitionExpression:{json:{origins:{service:{readFrom:["definitionExpression"],read:function(a,b){return b.definitionExpression}}}}},spatialReference:{json:{readFrom:["extent"],read:function(a,b){return(a=b.extent&&b.extent.spatialReference)&&H.fromJSON(a)}}},title:{json:{origins:{portalItem:{readFrom:["title",
"name"],read:function(a,b){return b.name?this._readTitleFromName(b.name):"item-title"!==this.sublayerTitleMode?void 0:a}},service:{readFrom:["name"],read:function(a,b){return this._readTitleFromName(b.name)}}}}},sublayerTitleMode:{type:String,value:"item-title"},trackIdField:{json:{readFrom:["timeInfo.trackIdField"],read:function(a,b){return b.timeInfo.trackIdField}}},type:{value:"feature",json:{readable:!1}},typeIdField:{json:{read:function(a,b){if(a){var c=this.getField(a,b.fields);c&&(a=c.name)}return a}}},
types:{json:{read:function(a,b){var c=b.editFieldsInfo,d=c&&c.creatorField,g=c&&c.editorField;return a&&a.map(function(a){a=new W(a);this._fixTemplates(a.templates,d);this._fixTemplates(a.templates,g);return a},this)}}},url:{set:function(a){var b=f.urlToObject(a),c=q.parse(b.path);c&&null!=c.sublayer&&(null==this.layerId&&(this.layerId=c.sublayer),b=u.objectToQuery(b.query),a=c.url.path,b&&(a=a+"?"+b));this._set("url",a)},json:{write:function(a,b){a&&f.isProtocolRelative(a)&&(a="https:"+a);a&&(b.url=
a);if(null!=this.layerId){var c=f.urlToObject(a);c&&(b.url=f.join(c.path,""+this.layerId),c.query&&Object.keys(c.query)&&(b.url+="?"+u.objectToQuery(c.query)))}}}},userIsAdmin:!1,version:{json:{readFrom:"currentVersion capabilities drawingInfo hasAttachments htmlPopupType relationships timeInfo typeIdField types".split(" "),read:function(a,b){(a=b.currentVersion)||(a=b.hasOwnProperty("capabilities")||b.hasOwnProperty("drawingInfo")||b.hasOwnProperty("hasAttachments")||b.hasOwnProperty("htmlPopupType")||
b.hasOwnProperty("relationships")||b.hasOwnProperty("timeInfo")||b.hasOwnProperty("typeIdField")||b.hasOwnProperty("types")?10:9.3);return a}}}},createGraphicsSource:function(){return this._hasMemorySource()?(this.emit("graphics-source-create",{graphicsSource:this.source}),h.resolve(this.source)):x.when(t,"./graphics/sources/FeatureLayerSource").then(function(a){return new a({layer:this})}.bind(this)).then(function(a){this.emit("graphics-source-create",{graphicsSource:a});return a}.bind(this))},createGraphicsController:function(a){var b=
this.controllerModulePaths[this.mode],c=a.layerView,d=m.ofType(C),g=this.source,f=g&&g.isInstanceOf&&g.isInstanceOf(m),k=l.mixin(a.options||{},{layer:this,layerView:c,graphics:f?g:new d});if(f)return h.resolve(k);"object"===typeof b&&(b=b[c.view.type]);return b?x.when(t,b).then(function(a){return new a(k)}.bind(this)).then(function(a){this.emit("graphics-controller-create",{graphicsController:a});return a}.bind(this)):h.reject(new e("Layer mode",'Module path not found for controller type: "'+this.mode+
'"'))},createQuery:function(){var a=new P;a.returnGeometry=!0;a.returnZ=this.hasZ&&this.returnZ||null;a.returnM=this.hasM&&this.returnM||null;a.outFields=this.outFields;a.where=this.definitionExpression||"1\x3d1";a.multipatchOption="multipatch"===this.geometryType?"xyFootprint":null;return a},getField:function(a,b){var c;if(b=b||this.fields)a=a.toLowerCase(),b.some(function(b){b&&b.name.toLowerCase()===a&&(c=b);return!!c});return c},graphicChanged:function(a){this.emit("graphic-update",a)},queryFeatures:function(a){var b=
this;a=a||this.createQuery();if(!this.source.queryFeatures)return h.reject(new e("FeatureLayer","Layer source does not support queryFeatures capability"));var c=this.popupTemplate;return this.source.queryFeatures(a).then(function(a){a&&a.features&&a.features.forEach(function(a){a.popupTemplate=c;a.layer=b});return a})},queryObjectIds:function(a){a=a||this.createQuery();return this.source.queryObjectIds?this.source.queryObjectIds(a):h.reject(new e("FeatureLayer","Layer source does not support queryObjectIds capability"))},
queryFeatureCount:function(a){a=a||this.createQuery();return this.source.queryFeatureCount?this.source.queryFeatureCount(a):h.reject(new e("FeatureLayer","Layer source does not support queryFeatureCount capability"))},queryExtent:function(a){a=a||this.createQuery();return this.source.queryExtent?this.source.queryExtent(a):h.reject(new e("FeatureLayer","Layer source does not support queryExtent capability"))},read:function(a,b){switch(b&&b.origin){case "web-map":this.inherited(arguments,[{outFields:["*"]},
b]);break;case "web-scene":this.inherited(arguments,[{mode:r.MODE_SNAPSHOT,returnZ:!0,outFields:["*"]},b])}var c=a.featureCollection;if(c){var d=c.layers;d&&1===d.length&&(this.inherited(arguments,[d[0].layerDefinition,b]),this.inherited(arguments,[d[0],b]),null!=c.showLegend&&this.inherited(arguments,[{showLegend:c.showLegend},b]))}else a.layerDefinition&&this.inherited(arguments,[a.layerDefinition,b]);this.inherited(arguments,[a,b]);return this},write:function(a,b){if(b&&"web-scene"===b.origin&&
b.messages){if(!this.url)return b.messages.push(new e("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' require a url to a service to be written to web scenes",{layer:this})),null;if(this.isTable)return b.messages.push(new e("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using a Table source cannot written to web scenes",{layer:this})),null}return this.inherited(arguments)},_fetchFirstLayerId:function(){return D(this.url,
{query:{f:"json"},callbackParamName:"callback",responseType:"json"}).then(function(a){if(a.data&&Array.isArray(a.data.layers)&&0<a.data.layers.length)return a.data.layers[0].id})},_initLayerProperties:function(a){this.source||(this.source=a);a.url&&(this.url=a.url);a.layerDefinition&&this.read({layerDefinition:a.layerDefinition},{origin:"service",url:this.parsedUrl});this._verifySource();this._verifyFields();this._fixSymbolUrls();this._fixRendererFields(this._getAllRenderers(this.renderer));this.useQueryTimestamp=
(w("ie")||w("safari"))&&this.editable&&10.02>this.version;this.watch("token",function(){this._fixSymbolUrls()}.bind(this));return N.loadStyleRenderer(this,{origin:"service"})},_fixSymbolUrls:function(){var a=this.renderer;if(!this._hasMemorySource()&&a){var b=this.token,c=[a.symbol,a.defaultSymbol];(a=a.classBreakInfos||a.uniqueValueInfos)&&a.forEach(function(a){c.push(a.symbol)});c.forEach(function(a){var c=a&&a.url;c&&(b&&-1!==c.search(/https?\:/i)&&-1===c.indexOf("?token\x3d"))&&(a.url+="?token\x3d"+
b)})}},_getAllRenderers:function(a){var b=[];a&&[a,a.trackRenderer,a.observationRenderer,a.latestObservationRenderer].forEach(function(a){a&&(b.push(a),a.rendererInfos&&a.rendererInfos.forEach(function(a){a.renderer&&b.push(a.renderer)}))});return b},_fixRendererFields:function(a){var b=this.fields;a&&b&&a.forEach(function(a){this._fixFieldName(this._rndProps,a);a.visualVariables&&a.visualVariables.forEach(function(a){this._fixFieldName(this._visVariableProps,a)},this)},this)},_fixFieldName:function(a,
b){a&&a.forEach(function(a){var d=l.getObject(a,!1,b);(d=d&&"function"!==typeof d&&this.getField(d))&&l.setObject(a,d.name,b)},this)},_verifyFields:function(){var a=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+a+")");!this.isTable&&(!this._hasMemorySource()&&-1===a.search(/\/FeatureServer\//i)&&(!this.fields||!this.fields.some(function(a){return"geometry"===a.type})))&&console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+
a+")")},_fixTemplates:function(a,b){a&&a.forEach(function(a){(a=a.prototype&&a.prototype.attributes)&&b&&delete a[b]})},_verifySource:function(){if(this._hasMemorySource()){if(this.url)throw new e("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url");var a=["geometryType","fields","objectIdField"];if(!a.every(function(a){return this.hasOwnProperty(a)},this))throw new e("feature-layer:missing-property","FeatureLayer created as feature collection requires properties: "+
a.join(),{requiredProperties:a});}else{if(this.isTable)throw new e("feature-layer:source-type-not-supported","The table feature service type is not yet supported",{sourceType:"Table"});if(!this.url)throw new e("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source");}},_initMemorySource:function(a){a.forEach(function(a){a.layer=this}.bind(this));this._handles.add([a.on("after-add",function(a){a.item.layer=this}.bind(this)),a.on("after-remove",function(a){a.item.layer=
null}.bind(this))],"fl-source")},_resetMemorySource:function(a){a.forEach(function(a){a.layer=null}.bind(this));this._handles.remove("fl-source")},_hasMemorySource:function(){return!(this.url||!this.source)},_readTitleFromName:function(a){var b=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return this.url?q.titleFromUrlAndName(this.url,a):a;if(a=a||this.url&&q.parse(this.url).title)return"item-title-and-service-name"===this.sublayerTitleMode&&b&&(a=b+" - "+a),q.cleanTitle(a)}});
l.mixin(r,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,MODE_AUTO:6});return r});