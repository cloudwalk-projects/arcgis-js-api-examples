// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.
//>>built
define("dojo/_base/lang dojo/sniff dojo/number dojo/Deferred dstore/Csv ../../../core/Accessor ../../../core/Error ../../../core/Promise ../../../core/urlUtils ../../../core/promiseUtils ../../../geometry/Extent ../../support/Field ../../../tasks/support/FeatureSet ../../../request".split(" "),function(p,q,r,s,t,u,g,v,w,m,x,y,z,A){var B=["small-integer","integer","single","double","long"],C="lat latitude y ycenter latitude83 latdecdeg POINT-Y".split(" "),D="lon lng long longitude x xcenter longitude83 longdecdeg POINT-X".split(" "),
E=[","," ",";","|","\t"];return u.createSubclass([v],{properties:{parsedUrl:{get:function(){return this.url?w.urlToObject(this.url):null}},delimiter:null,fields:[],latitudeField:null,longitudeField:null,layerDefinition:null,outFields:null,url:null},initialize:function(){this.addResolvingPromise(this._fetchCSV())},queryFeatures:function(a){return m.resolve(z.fromJSON(this._featureSetJSON))},queryFeatureCount:function(a){a=this._featureSetJSON&&this._featureSetJSON.features;return m.resolve(a?a.length:
0)},_updateUrl:function(a){a&&(this.url=this.url.replace(/^http:/i,"https:"))},_fetchCSV:function(){return A(this.parsedUrl.path,{query:this.parsedUrl.query,responseType:"text"}).then(function(a){this._updateUrl(a.ssl);return this._processCSV(a.data)}.bind(this))},_isValidDate:function(a,b){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return!1;var c=!0;if(q("chrome")&&/\d+\W*$/.test(b)){var h=b.match(/[a-zA-Z]{2,}/);if(h){for(var c=!1,e=0,k=h.length,g=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!c&&
e<=k&&!(c=!g.test(h[e]));)e++;c=!c}}return c},_getCSVExtent:function(a){var b;a.forEach(function(c){c.geometry&&(b?(b.xmin=Math.min(b.xmin,c.geometry.x),b.ymin=Math.min(b.ymin,c.geometry.y),b.xmax=Math.max(b.xmax,c.geometry.x),b.ymax=Math.max(b.ymax,c.geometry.y)):b=new x(c.geometry.x,c.geometry.y,c.geometry.x,c.geometry.y))});b&&(0>=b.width&&0>=b.height)&&(b=null);return b},_readFirstLine:function(a){var b=a.indexOf("\n");return p.trim(a.substr(0,b))},_detectDelimiter:function(a){if(!this.delimiter){var b=
0,c="";E.forEach(function(h){var e=a.split(h).length;e>b&&(b=e,c=h)});this.delimiter=c}},_readFieldNames:function(a){return a.split(this.delimiter)},_createLayerDefinition:function(a){this.layerDefinition||(this.layerDefinition={name:"csv",geometryType:"esriGeometryPoint",fields:[]});this.fields&&(this.layerDefinition.fields=this.fields.map(function(b){return b.toJSON()}));var b=this.layerDefinition.fields;if(!this.layerDefinition.objectIdField){for(var c=0;c<b.length;c++)if("esriFieldTypeOID"===
b[c].type){this.layerDefinition.objectIdField=b[c].name;break}this.layerDefinition.objectIdField||(b.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1}),this.layerDefinition.objectIdField="__OBJECTID")}a.forEach(function(c){b.some(function(b){return c===b.name})||b.push({name:c,alias:c,type:c===this.latitudeField||c===this.longitudeField?"esriFieldTypeDouble":"esriFieldTypeString"})},this)},_getCoordinateFields:function(a){var b,c;a.forEach(function(a){var e;e=C.indexOf(a.toLowerCase());
-1!==e&&!b&&(b=a);e=D.indexOf(a.toLowerCase());-1!==e&&!c&&(c=a)});this.latitudeField=this.latitudeField||b;this.longitudeField=this.longitudeField||c},_createFeatureSet:function(a){var b=[],c=[],h=[],e=this.latitudeField,k=this.longitudeField,g=this.fields.filter(function(b){return b.name!==this.layerDefinition.objectIdField},this).map(function(b){return b.name});this.fields.forEach(function(b){"date"===b.type?c.push(b.name):-1<B.indexOf(b.type)&&h.push(b.name)});var l;-1===this.outFields.indexOf("*")&&
(l=this.outFields);var n=new t;n.delimiter=this.delimiter;n.fieldNames=g;n.newline="\n";a=n.parse(a);var m=0;a.shift();a.forEach(function(a){for(var d in a)if(d===e||d===k||!l||-1<l.indexOf(d))if(-1<c.indexOf(d)){var f=new Date(a[d]);a[d]=this._isValidDate(f,a[d])?f.getTime():null}else{if(-1<h.indexOf(d)){f=r.parse(a[d]);if((d===e||d===k)&&(isNaN(f)||181<Math.abs(f)))f=parseFloat(a[d]);isNaN(f)?a[d]=null:a[d]=f}}else delete a[d];d=a[e];f=a[k];a[this.layerDefinition.objectIdField]=m;m++;var g={attributes:a};
null!==f&&(null!==d&&!isNaN(d)&&!isNaN(f))&&(l&&-1===l.indexOf(e)&&delete a[e],l&&-1===l.indexOf(k)&&delete a[k],g.geometry={x:f,y:d});b.push(g)},this);this._featureSetJSON={features:b,geometryType:"esriGeometryPoint",spatialReference:{wkid:4326}}},_processCSV:function(a){var b=new s,c=this._readFirstLine(a);if(!c)return b.reject(new g("CSVSource","CSV is empty"));this._detectDelimiter(c);if(!this.delimiter)return b.reject(new g("CSVSource","Unable to detect the delimiter from CSV"));c=this._readFieldNames(c);
this._getCoordinateFields(c);if(!this.latitudeField||!this.longitudeField)return b.reject(new g("CSVSource","Unable to identify latitudeField and/or longitudeField from CSV"));this._createLayerDefinition(c);this.fields=this.layerDefinition.fields.map(function(a){return y.fromJSON(a)},this);this._createFeatureSet(a);if(a=this._getCSVExtent(this._featureSetJSON.features))this.layerDefinition.extent=a.toJSON();return b.resolve()}})});